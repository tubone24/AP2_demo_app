ap2_shopping_agent         | INFO:     172.67.69.85:53497 - "OPTIONS /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:29.397505Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:53497 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:29.418305Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Created new session in DB: session_1761729806775_59uphh", "module": "agent", "function": "_get_or_create_session", "line": 1875}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:29.418848Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:29.424646Z", "level": "INFO", "logger": "agent", "message": "[Langfuse] Created new handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1568}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:31.985283Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:31.997399Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:37.254696Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:32729 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:37.265991Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=ask_intent", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:37.267181Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:23:37.267334Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:24:18.076910Z", "level": "INFO", "logger": "agent", "message": "[_create_intent_mandate] Reconstructed intent: かわいい グッズを購入したい。10000円以内", "module": "agent", "function": "_create_intent_mandate", "line": 1657}
ap2_shopping_agent         | [2025-10-29 09:24:18,075] INFO in services.shopping_agent.langgraph_shopping_flow: [collect_intent_node] LLM result: {'intent': 'かわいいグッズを購入したい', 'max_amount': 10000, 'keywords': ['かわいい', 'グッズ']}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:24:18.077468Z", "level": "INFO", "logger": "agent", "message": "[_build_intent_mandate_from_session] Constructed natural_language_description: かわいいグッズを購入したい。10000円以内", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1715}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:24:18.077824Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] IntentMandate created (fallback mode): id=intent_462960b4, intent='かわいいグッズを購入したい...'", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1734}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:24:18.081154Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] User public key not available yet (will be provided by frontend): 公開鍵ファイルが見つかりません: /app/v2/keys/usr_577b4cbdb15e4f5d_public.pem", "module": "agent", "function": "_create_intent_mandate", "line": 1668}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:24:20.021821Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:24:20.026036Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:31.223206Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:23466 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:31.230460Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=intent_complete_ask_shipping", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:31.231284Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:31.231444Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | [2025-10-29 09:26:31,559] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='{"recipient":"あ","postal_code":"あ","city":"あ","region":"あ","address_line1":"あ","country":"あ"}', session['step']='select_cp', is_digit=False
ap2_shopping_agent         | [2025-10-29 09:26:31,560] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-29 09:26:31,560] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-29 09:26:31,560] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: Presenting 2 Credential Providers to user
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:32.743044Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=select_cp", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:32.746870Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=select_cp", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.283304Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:23466 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.295939Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=select_cp", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.296468Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.296536Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | [2025-10-29 09:26:34,306] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='1', session['step']='select_cp', is_digit=True
ap2_shopping_agent         | [2025-10-29 09:26:34,306] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-29 09:26:34,306] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-29 09:26:34,306] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: User selected Credential Provider
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP Name: AP2 Demo Credential Provider
ap2_shopping_agent         | [2025-10-29 09:26:34,520] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 6-7: Requesting payment methods from CP
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.521653Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment methods from Credential Provider (http://credential_provider:8003) for user: usr_577b4cbdb15e4f5d", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2202}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:26:34.611726Z", "level": "INFO", "logger": "provider", "message": "[get_payment_methods] Retrieved 2 payment methods for user: usr_577b4cbdb15e4f5d", "module": "provider", "function": "get_payment_methods", "line": 612}
ap2_credential_provider    | INFO:     172.18.0.11:45762 - "GET /payment-methods?user_id=usr_577b4cbdb15e4f5d HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.618989Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Retrieved 2 payment methods from Credential Provider", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2220}
ap2_shopping_agent         | [2025-10-29 09:26:34,619] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 7: Received 2 payment methods from CP
ap2_shopping_agent         |   Payment Methods: ['pm_1486a851', 'pm_54832f24']
ap2_shopping_agent         | [2025-10-29 09:26:34,830] INFO in services.shopping_agent.langgraph_shopping_flow: [fetch_carts_node] AP2 Step 8-12: Fetching cart candidates from Merchant Agent
ap2_shopping_agent         | [2025-10-29 09:26:34,837] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting cart candidates from Merchant Agent for IntentMandate: intent_462960b4
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.846115Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.848577Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 866, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_462960b4\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-29T09:24:18.076663Z\",\"id\":\"intent_462960b4\",\"intent_expiry\":\"2025-10-29T10:2", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.849230Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:26:34.865640Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_shopping_agent         | [2025-10-29 09:26:34,866] INFO in v2.common.a2a_handler:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [A2A送信] レスポンス作成
ap2_shopping_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_shopping_agent         |   送信先: did:ap2:agent:merchant_agent
ap2_shopping_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_shopping_agent         |   データID: intent_462960b4
ap2_shopping_agent         |   署名: あり
ap2_shopping_agent         |   タイムスタンプ: 2025-10-29T09:26:34.838631Z
ap2_shopping_agent         |   ペイロード: {
ap2_shopping_agent         |   "intent_mandate": {
ap2_shopping_agent         |     "id": "intent_462960b4",
ap2_shopping_agent         |     "type": "IntentMandate",
ap2_shopping_agent         |     "version": "0.2",
ap2_shopping_agent         |     "user_id": "usr_577b4cbdb15e4f5d",
ap2_shopping_agent         |     "natural_language_description": "かわいいグッズを購入したい。10000円以内",
ap2_shopping_agent         |     "user_cart_confirmation_required": true,
ap2_shopping_agent         |     "merchants": null,
ap2_shopping_agent         |     "skus": null,
ap2_shopping_agent         |     "requires_refundability": false,
ap2_shopping_agent         |     "intent_expiry": "2025-10-29T10:24:18.076663Z",
ap2_shopping_agent         |     "created_at": "2025-10-29T09:24:18.076663Z",
ap2_shopping_agent         |     "user_public_key": null
ap2_shopping_agent         |   },
ap2_shopping_agent         |   "shipping_address": {
ap2_shopping_agent         |     "recipient": "あ",
ap2_shopping_agent         |     "postal_code": "あ",
ap2_shopping_agent         |     "city": "あ",
ap2_shopping_agent         |     "region": "あ",
ap2_shopping_agent         |     "address_line1": "あ",
ap2_shopping_agent         |     "country": "あ"
ap2_shopping_agent         |   }
ap2_shopping_agent         | }
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-29 09:26:34,866] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Intent A2A message created: message_id=6b3a570a-d722-4e1b-9e2d-5d1931252603, intent_mandate_id=intent_462960b4
ap2_shopping_agent         | [2025-10-29 09:26:34,867] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: 6b3a570a-d722-4e1b-9e2d-5d1931252603
ap2_shopping_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_shopping_agent         |   ペイロード: {
ap2_shopping_agent         |   "id": "intent_462960b4",
ap2_shopping_agent         |   "type": "IntentMandate",
ap2_shopping_agent         |   "version": "0.2",
ap2_shopping_agent         |   "user_id": "usr_577b4cbdb15e4f5d",
ap2_shopping_agent         |   "natural_language_description": "かわいいグッズを購入したい。10000円以内",
ap2_shopping_agent         |   "user_cart_confirmation_required": true,
ap2_shopping_agent         |   "merchants": null,
ap2_shopping_agent         |   "skus": null,
ap2_shopping_agent         |   "requires_refundability": false,
ap2_shopping_agent         |   "intent_expiry": "2025-10-29T10:24:18.076663Z",
ap2_shopping_agent         |   "created_at": "2025-10-29T09:24:18.076663Z",
ap2_shopping_agent         |   "user_public_key": null
ap2_shopping_agent         | }
ap2_shopping_agent         | ================================================================================
ap2_merchant_agent         | [2025-10-29 09:26:34,914] INFO in v2.common.base_agent:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message
ap2_merchant_agent         |   受信メッセージ: ID=6b3a570a-d722-4e1b-9e2d-5d1931252603
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [2025-10-29 09:26:34,916] INFO in v2.common.a2a_handler:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [A2A受信] メッセージID: 6b3a570a-d722-4e1b-9e2d-5d1931252603
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   送信先: did:ap2:agent:merchant_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_merchant_agent         |   データID: intent_462960b4
ap2_merchant_agent         |   タイムスタンプ: 2025-10-29T09:26:34.838631Z
ap2_merchant_agent         |   ペイロード: {
ap2_merchant_agent         |   "intent_mandate": {
ap2_merchant_agent         |     "id": "intent_462960b4",
ap2_merchant_agent         |     "type": "IntentMandate",
ap2_merchant_agent         |     "version": "0.2",
ap2_merchant_agent         |     "user_id": "usr_577b4cbdb15e4f5d",
ap2_merchant_agent         |     "natural_language_description": "かわいいグッズを購入したい。10000円以内",
ap2_merchant_agent         |     "user_cart_confirmation_required": true,
ap2_merchant_agent         |     "merchants": null,
ap2_merchant_agent         |     "skus": null,
ap2_merchant_agent         |     "requires_refundability": false,
ap2_merchant_agent         |     "intent_expiry": "2025-10-29T10:24:18.076663Z",
ap2_merchant_agent         |     "created_at": "2025-10-29T09:24:18.076663Z",
ap2_merchant_agent         |     "user_public_key": null
ap2_merchant_agent         |   },
ap2_merchant_agent         |   "shipping_address": {
ap2_merchant_agent         |     "recipient": "あ",
ap2_merchant_agent         |     "postal_code": "あ",
ap2_merchant_agent         |     "city": "あ",
ap2_merchant_agent         |     "region": "あ",
ap2_merchant_agent         |     "address_line1": "あ",
ap2_merchant_agent         |     "country": "あ"
ap2_merchant_agent         |   }
ap2_merchant_agent         | }
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.918471Z", "level": "DEBUG", "logger": "common.nonce_manager", "message": "Cleaned up 2 expired nonces", "module": "nonce_manager", "function": "_cleanup_expired", "line": 99}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.921450Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.922907Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 866, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_462960b4\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-29T09:24:18.076663Z\",\"id\":\"intent_462960b4\",\"intent_expiry\":\"2025-10-29T10:2", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.923193Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.939616Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant_agent         | [2025-10-29 09:26:34,939] INFO in v2.common.a2a_handler: [A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved
ap2_merchant_agent         | [2025-10-29 09:26:34,940] INFO in v2.common.a2a_handler: [A2A処理] ハンドラー実行中: type=ap2.mandates.IntentMandate, from=did:ap2:agent:shopping_agent
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.941197Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate", "module": "intent_handler", "function": "handle_intent_mandate", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.941335Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate with shipping_address (AP2 v0.1 compliant)", "module": "intent_handler", "function": "handle_intent_mandate", "line": 40}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.941365Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Searching products with intent: 'かわいいグッズを購入したい。10000円以内'", "module": "intent_handler", "function": "handle_intent_mandate", "line": 49}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.941391Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using provided shipping address: あ", "module": "intent_handler", "function": "handle_intent_mandate", "line": 55}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.942336Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using LangGraph AI engine for cart generation", "module": "intent_handler", "function": "handle_intent_mandate", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:26:34.954342Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Created new handler for session: 6a9f2fe4-3f9e-4f79-88fb-f3118fcbb8b6", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 289}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:27:25.474206Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] LLM result: {'primary_need': 'かわいいグッズを購入したい', 'budget_strategy': 'low', 'key_factors': ['かわいさ', '価格'], 'search_keywords': ['かわいい', 'グッズ', 'Tシャツ']}", "module": "intent_node", "function": "analyze_intent", "line": 124}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-29T09:27:25.560221Z", "level": "INFO", "logger": "main", "message": "[search_products] Searching with query: 'かわいい グッズ Tシャツ'", "module": "main", "function": "search_products", "line": 123}
ap2_meilisearch            | 2025-10-29T09:27:25.674432Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/search query_parameters= user_agent=python-httpx/0.28.1 status_code=200}: meilisearch: close time.busy=9.10ms time.idle=21.0ms
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-29T09:27:25.680568Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Search 'かわいい グッズ Tシャツ' returned 6 products", "module": "search_engine", "function": "search", "line": 187}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-29T09:27:25.721810Z", "level": "INFO", "logger": "main", "message": "[search_products] Returned 6 products for keywords: ['か わいい', 'グッズ', 'Tシャツ']", "module": "main", "function": "search_products", "line": 148}
ap2_merchant_agent_mcp     | INFO:     172.18.0.5:56124 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:27:25.726807Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool search_products executed successfully", "module": "mcp_client", "function": "call_tool", "line": 133}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:27:25.726914Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.search_node", "message": "[search_products] MCP returned 6 products", "module": "search_node", "function": "search_products", "line": 69}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-29T09:27:25.734755Z", "level": "INFO", "logger": "main", "message": "[check_inventory] Inventory: {'b8444ff4-1fec-4589-bf16-ef3639b59e61': 100, 'd3215ff6-8087-4622-8ec3-8a8a37101927': 30, 'f22bbef3-ac71-42dd-9487-bd626c3a24d3': 120, '8a4be9a4-b828-46d0-8921-ac6d1b1caf9a': 80, '16c5a5f5-bf3a-446c-834e-dfc8453bec8c': 100, '9540f8c0-b605-4599-9ae1-a3d4c82eaf8c': 70}", "module": "main", "function": "check_inventory", "line": 202}
ap2_merchant_agent_mcp     | INFO:     172.18.0.5:56124 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:27:25.736733Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool check_inventory executed successfully", "module": "mcp_client", "function": "call_tool", "line": 133}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:27:25.736784Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.inventory_node", "message": "[check_inventory] MCP checked 6 products", "module": "inventory_node", "function": "check_inventory", "line": 62}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.112776Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.optimization_node", "message": "[optimize_cart] LLM generated 3 cart plans", "module": "optimization_node", "function": "optimize_cart", "line": 164}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.118549Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Creating 3 unsigned CartMandates...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 66}
ap2_merchant_agent_mcp     | INFO:     172.18.0.5:35196 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.138295Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 133}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.138365Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_992938d9, plan=予算内プラン (1,650円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.140084Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 133}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.140110Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_e83c4b42, plan=高品質プラン (3,500円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.141701Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 133}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.141723Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_ac3e36a0, plan=シンプルプラン (800円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent_mcp     | INFO:     172.18.0.5:35196 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent_mcp     | INFO:     172.18.0.5:35196 - "POST / HTTP/1.1" 200 OK

ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.141747Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created 3 unsigned CartMandates, sending to Merchant for signature...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 116}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.142050Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Processing 3 CartMandates in parallel...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 330}
ap2_merchant               | [2025-10-29 09:29:02,187] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_992938d9
ap2_merchant               | [2025-10-29 09:29:02,193] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_e83c4b42
ap2_merchant               | [2025-10-29 09:29:02,193] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_ac3e36a0
ap2_merchant               | [2025-10-29 09:29:02,194] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_992938d9
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.195087Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.202596Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.208118Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=45ff60042ba135e8..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-29 09:29:02,230] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_e83c4b42
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.231021Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.231506Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.231908Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=49b8ecaf131e8ee7..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-29 09:29:02,232] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_ac3e36a0
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.232880Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.233348Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.233708Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=73e85f640738bcff..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.259374Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_992938d9", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.259836Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_992938d9 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.5:55380 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.266502Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_992938d9, plan=予算内プラン (1,650円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.266825Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: 予算内プラン (1,650円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.270662Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_ac3e36a0", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.271716Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_ac3e36a0 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.5:55384 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.275692Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_ac3e36a0, plan=シンプルプラン (800円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.275776Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: シンプルプラン (800円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.279338Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_e83c4b42", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-29T09:29:02.279851Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_e83c4b42 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.5:55382 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.282706Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_e83c4b42, plan=高品質プラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.282773Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: 高品質プラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.283002Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Parallel processing complete: 3 signed, 0 pending, 0 timeout, 0 rejected", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 353}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.283040Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built 3 signed CartMandates (pending: 0, timeout: 0)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 373}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.287332Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.ranking_node", "message": "[rank_and_select] Selected top 3 carts", "module": "ranking_node", "function": "rank_and_select", "line": 31}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.289906Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[create_cart_candidates] 3 carts ready (pre-signed via MCP)", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 313}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.289998Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Generated 3 cart candidates", "module": "intent_handler", "function": "handle_intent_mandate", "line": 98}
ap2_merchant_agent         | [2025-10-29 09:29:02,290] INFO in v2.common.a2a_handler: [A2A処理] ハンドラー完了: type=ap2.mandates.IntentMandate, result_type=ap2.responses.CartCandidates
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.291228Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.292085Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 7260, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.CartCandidates\",\"id\":\"d11a5898-1c4b-4471-a106-da1be3e2e643\",\"payload\":{\"cart_candidates\":[{\"artifactId\":\"artifact_b9fb05ec\",\"name\":\"予算内プラン (1,650円)\",\"parts\":[{\"data", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.292148Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:29:02.300211Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant_agent         | [2025-10-29 09:29:02,302] INFO in v2.common.a2a_handler:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [A2A送信] レスポンス作成
ap2_merchant_agent         |   送信元: did:ap2:agent:merchant_agent
ap2_merchant_agent         |   送信先: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.responses.CartCandidates
ap2_merchant_agent         |   データID: d11a5898-1c4b-4471-a106-da1be3e2e643
ap2_merchant_agent         |   署名: あり
ap2_merchant_agent         |   タイムスタンプ: 2025-10-29T09:29:02.290569Z
ap2_merchant_agent         |   ペイロード: {
ap2_merchant_agent         |   "intent_mandate_id": "intent_462960b4",
ap2_merchant_agent         |   "cart_candidates": [
ap2_merchant_agent         |     {
ap2_merchant_agent         |       "artifactId": "artifact_b9fb05ec",
ap2_merchant_agent         |       "name": "予算内プラン (1,650円)",
ap2_merchant_agent         |       "parts": [
ap2_merchant_agent         |         {
ap2_merchant_agent         |           "kind": "data",
ap2_merchant_agent         |           "data": {
ap2_merchant_agent         |             "ap2.mandates.CartMandate": {
ap2_merchant_agent         |               "contents": {
ap2_merchant_agent         |                 "id": "cart_992938d9",
ap2_merchant_agent         |                 "user_cart_confirmation_required": true,
ap2_merchant_agent         |                 "payment_request": {
ap2_merchant_agent         |                   "method_data": [],
ap2_merchant_agent         |                   "details": {
ap2_merchant_agent         |                     "id": "cart_992938d9",
ap2_merchant_agent         |                     "display_items": [
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "むぎぼーアクリルキーホルダー",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 800.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 2592000
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "むぎぼー靴下",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 850.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 2592000
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "消費税（10%）",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 165.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 0
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "送料",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 500.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 0
ap2_merchant_agent         |                       }
ap2_merchant_agent         |                     ],
ap2_shopping_agent         | [2025-10-29 09:29:02,329] INFO in services.shopping_agent.utils.merchant_integration:
ap2_merchant_agent         |                     "total": {
ap2_merchant_agent         |                       "label": "合計",
ap2_merchant_agent         |                       "amount": {

ap2_merchant_agent         |                         "value": 2315.0,
ap2_merchant_agent         |                         "currency": "JPY"

ap2_shopping_agent         | ================================================================================
ap2_merchant_agent         |                       }
ap2_merchant_agent         |                     }
ap2_merchant_agent         |                   },

ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信

ap2_merchant_agent         |                   "shipping_address": null
ap2_shopping_agent         |   Status: 200   },

ap2_shopping_agent         |   Response Body: {
ap2_shopping_agent         |   "header": {
ap2_shopping_agent         |     "message_id": "229c06f4-8c5a-47ee-8c32-9394e9801027",
ap2_shopping_agent         |     "sender": "did:ap2:agent:merchant_agent",
ap2_shopping_agent         |     "recipient": "did:ap2:agent:shopping_agent",
ap2_shopping_agent         |     "timestamp": "2025-10-29T09:29:02.290569Z",
ap2_merchant_agent         |                 "cart_expiry": "2025-10-29T10:29:02.135122Z",b04b9b68aad94902b",
ap2_merchant_agent         |                 "merchant_name": "Demo Merchant"
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiI0N2FjNDEzNS05MTYzLTQwNzEtYTM2MC1jOTdjOTJkMDk5MmMiLCJjYXJ0X2hhc2giOiI0NWZmNjAwNDJiYTEzNWU4NjQ3NWNmNzhiOTNmZWE5YjQyYWVlZTk2ZjUwY2Y5NWRjZGZiY2JhMWNlMjkwMjg3In0.MEQCIH5D8m8VytQIL_i3YSjkFOTaV11qkCmVW6qOsWUc1MoIAiAoFeS9UNviZSsl0wGMFnTBevslF_BW1Es8ykMpoYTTYw",
ap2_merchant_agent         |               "_metadata": {
ap2_merchant_agent         |                 "intent_mandate_id": null,
ap2_merchant_agent         |                 "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |                 "created_at": "2025-10-29T09:29:02.135215Z",
ap2_merchant_agent         |                 "cart_name": "予算内プラン (1,650円)",

ap2_shopping_agent         |     "schema_version": "0.2",
ap2_shopping_agent         |     "proof": {
ap2_shopping_agent         |       "algorithm": "ed25519",
ap2_shopping_agent         |       "signatureValue": "ZS8WthHxq8roRpDoFnlWXDNwAEVgHb4tIqG9Q+tY0fKqQM/E2BoFqx5WJuk0Um/sHKPpznWELw+R+t5b8j+jDg==",

ap2_merchant_agent         |                 "raw_items": [
ap2_merchant_agent         |                   {
ap2_shopping_agent         |       "publicKey": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVlOOU9NNE5heDdRajdUdEFWU25QL1k4V0RzYlg2VFRqdVVpSGtZUWNCK2c9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_merchant_agent         |                     "product_id": "b8444ff4-1fec-4589-bf16-ef3639b59e61",
ap2_merchant_agent         |                     "name": "むぎぼーアクリルキーホルダー",
ap2_merchant_agent         |                     "description": "かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。",
ap2_merchant_agent         |                     "quantity": 1,
ap2_merchant_agent         |                     "unit_price": {
ap2_shopping_agent         |       "kid": "did:ap2:agent:merchant_agent#key-2",

ap2_merchant_agent         |                       "currency": "JPY"


ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "total_price": {
ap2_merchant_agent         |                       "value": 800.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "image_url": null
ap2_merchant_agent         |                   },
ap2_shopping_agent         |       "proofPurpose": "authentication"

ap2_merchant_agent         |                   {
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "signature": null
ap2_shopping_agent         |   },

ap2_shopping_agent         |   "dataPart": {
ap2_merchant_agent         |                     "product_id": "16c5a5f5-bf3a-446c-834e-dfc8453bec8c",
ap2_shopping_agent         |     "id": "d11a5898-1c4b-4471-a106-da1be3e2e643",
ap2_shopping_agent         |     "payload": {
ap2_shopping_agent         |       "intent_mandate_id": "intent_46...


ap2_shopping_agent         | ================================================================================

ap2_shopping_agent         | [2025-10-29 09:29:02,331] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Received 3 cart candidates from Merchant Agent
ap2_merchant_agent         |                     "description": "むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。",
ap2_merchant_agent         |                     "quantity": 1,
ap2_merchant_agent         |                     "unit_price": {
ap2_merchant_agent         |                       "value": 850.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "total_price": {
ap2_merchant_agent         |                       "value": 850.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "image_url": null
ap2_merchant_agent         |                   }
ap2_merchant_agent         |                 ]
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "merchant_signature": {
ap2_merchant_agent         |                 "algorithm": "ED25519",
ap2_merchant_agent         |                 "value": "hkHueq+bzfpi/G82Cn0DT3doVjs+W9NsGSSC9DMCSjzkp6qhB5c7kD0vQZKmjzf0wClS7poVWruP95gJpNlqAA==",
ap2_merchant_agent         |                 "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_merchant_agent         |                 "signed_at": "2025-10-29T09:29:02.201727Z",
ap2_merchant_agent         |                 "key_id": "merchant"
ap2_merchant_agent         |               }
ap2_merchant_agent         |             }
ap2_merchant_agent         |           }
ap2_merchant_agent         |         }
ap2_merchant_agent         |       ]
ap2_merchant_agent         |     },
ap2_merchant_agent         |     {
ap2_merchant_agent         |       "artifactId": "artifact_4d739dbc",
ap2_merchant_agent         |       "name": "高品質プラン (3,500円)",
ap2_merchant_agent         |       "parts": [
ap2_merchant_agent         |         {
ap2_merchant_agent         |           "kind": "data",
ap2_merchant_agent         |           "data": {
ap2_merchant_agent         |             "ap2.mandates.CartMandate": {
ap2_merchant_agent         |               "contents": {
ap2_merchant_agent         |                 "id": "cart_e83c4b42",
ap2_merchant_agent         |                 "user_cart_confirmation_required": true,
ap2_merchant_agent         |                 "payment_request": {
ap2_merchant_agent         |                   "method_data": [],
ap2_merchant_agent         |                   "details": {
ap2_merchant_agent         |                     "id": "cart_e83c4b42",
ap2_merchant_agent         |                     "display_items": [
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "むぎぼー時計",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 3500.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 2592000
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "消費税（10%）",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 350.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 0
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "送料",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 500.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 0
ap2_merchant_agent         |                       }
ap2_merchant_agent         |                     ],
ap2_merchant_agent         |                     "total": {
ap2_merchant_agent         |                       "label": "合計",
ap2_merchant_agent         |                       "amount": {
ap2_merchant_agent         |                         "value": 4350.0,
ap2_merchant_agent         |                         "currency": "JPY"
ap2_merchant_agent         |                       }
ap2_merchant_agent         |                     }
ap2_merchant_agent         |                   },
ap2_merchant_agent         |                   "shipping_address": null
ap2_merchant_agent         |                 },
ap2_merchant_agent         |                 "cart_expiry": "2025-10-29T10:29:02.139425Z",
ap2_merchant_agent         |                 "merchant_name": "Demo Merchant"
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiI3NDcyN2JhNC1hNzA2LTQ4YzAtOTFjZC0yYzljYzVhYmFkZjgiLCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4In0.MEUCIG3NN8NR_Hx2pgHC89HX2uXzJBUAxyJVTv_Qd3MoC3AGAiEAkUiW-84BDq0dwbwOT7IXd9mOtuQjr7aG0T_CjquDcgs",
ap2_merchant_agent         |               "_metadata": {
ap2_merchant_agent         |                 "intent_mandate_id": null,
ap2_merchant_agent         |                 "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |                 "created_at": "2025-10-29T09:29:02.139437Z",
ap2_merchant_agent         |                 "cart_name": "高品質プラン (3,500円)",
ap2_merchant_agent         |                 "cart_description": "高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。",
ap2_merchant_agent         |                 "raw_items": [
ap2_merchant_agent         |                   {
ap2_merchant_agent         |                     "product_id": "d3215ff6-8087-4622-8ec3-8a8a37101927",
ap2_merchant_agent         |                     "name": "むぎぼー時計",
ap2_merchant_agent         |                     "description": "むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。",
ap2_merchant_agent         |                     "quantity": 1,
ap2_merchant_agent         |                     "unit_price": {
ap2_merchant_agent         |                       "value": 3500.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "total_price": {
ap2_merchant_agent         |                       "value": 3500.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "image_url": null
ap2_merchant_agent         |                   }
ap2_merchant_agent         |                 ]
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "merchant_signature": {
ap2_merchant_agent         |                 "algorithm": "ED25519",
ap2_merchant_agent         |                 "value": "zmYyvWThTHowgk/I6vAQ3y7ZBo6ferrNKgUncTv4FOQIfcGtv2wFMruPvliV8NDWhhEzg6JKpvZO2BwF29yCCQ==",
ap2_merchant_agent         |                 "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_merchant_agent         |                 "signed_at": "2025-10-29T09:29:02.231452Z",
ap2_merchant_agent         |                 "key_id": "merchant"
ap2_merchant_agent         |               }
ap2_merchant_agent         |             }
ap2_merchant_agent         |           }
ap2_merchant_agent         |         }
ap2_merchant_agent         |       ]
ap2_merchant_agent         |     },
ap2_merchant_agent         |     {
ap2_merchant_agent         |       "artifactId": "artifact_c4d1ec36",
ap2_merchant_agent         |       "name": "シンプルプラン (800円)",
ap2_merchant_agent         |       "parts": [
ap2_merchant_agent         |         {
ap2_merchant_agent         |           "kind": "data",
ap2_merchant_agent         |           "data": {
ap2_merchant_agent         |             "ap2.mandates.CartMandate": {
ap2_merchant_agent         |               "contents": {
ap2_merchant_agent         |                 "id": "cart_ac3e36a0",
ap2_merchant_agent         |                 "user_cart_confirmation_required": true,
ap2_merchant_agent         |                 "payment_request": {
ap2_merchant_agent         |                   "method_data": [],
ap2_merchant_agent         |                   "details": {
ap2_merchant_agent         |                     "id": "cart_ac3e36a0",
ap2_merchant_agent         |                     "display_items": [
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "むぎぼーアクリルキーホルダー",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 800.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 2592000
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "消費税（10%）",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 80.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 0
ap2_merchant_agent         |                       },
ap2_merchant_agent         |                       {
ap2_merchant_agent         |                         "label": "送料",
ap2_merchant_agent         |                         "amount": {
ap2_merchant_agent         |                           "value": 500.0,
ap2_merchant_agent         |                           "currency": "JPY"
ap2_merchant_agent         |                         },
ap2_merchant_agent         |                         "refund_period": 0
ap2_merchant_agent         |                       }
ap2_merchant_agent         |                     ],
ap2_merchant_agent         |                     "total": {
ap2_merchant_agent         |                       "label": "合計",
ap2_merchant_agent         |                       "amount": {
ap2_merchant_agent         |                         "value": 1380.0,
ap2_merchant_agent         |                         "currency": "JPY"
ap2_merchant_agent         |                       }
ap2_merchant_agent         |                     }
ap2_merchant_agent         |                   },
ap2_merchant_agent         |                   "shipping_address": null
ap2_merchant_agent         |                 },
ap2_merchant_agent         |                 "cart_expiry": "2025-10-29T10:29:02.140845Z",
ap2_merchant_agent         |                 "merchant_name": "Demo Merchant"
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiJjNTdmMTA3NC1mODNmLTQ1YjMtODcwNS0wNGVlZjkwY2RiZWEiLCJjYXJ0X2hhc2giOiI3M2U4NWY2NDA3MzhiY2ZmNTJiNmE2NDYxYjc5MDllYzJlNTVhNTJlMWEwYjdiMGMxYzYzM2Y3ZDZhNjM2YTg5In0.MEYCIQDb4cRSQVQj65wnWCPvj9mjiFwKK7PfuXZdiszORblfNwIhAONs_XQyzMYLtPoab4bycjC_pb-_eOhvJfYTf_fTU-Bp",
ap2_merchant_agent         |               "_metadata": {
ap2_merchant_agent         |                 "intent_mandate_id": null,
ap2_merchant_agent         |                 "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |                 "created_at": "2025-10-29T09:29:02.140854Z",
ap2_merchant_agent         |                 "cart_name": "シンプルプラン (800円)",
ap2_merchant_agent         |                 "cart_description": "1商品で最小限の予算でかわいいアイテムを購入できます。",
ap2_merchant_agent         |                 "raw_items": [
ap2_merchant_agent         |                   {
ap2_merchant_agent         |                     "product_id": "b8444ff4-1fec-4589-bf16-ef3639b59e61",
ap2_merchant_agent         |                     "name": "むぎぼーアクリルキーホルダー",
ap2_merchant_agent         |                     "description": "かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。",
ap2_merchant_agent         |                     "quantity": 1,
ap2_merchant_agent         |                     "unit_price": {
ap2_merchant_agent         |                       "value": 800.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "total_price": {
ap2_merchant_agent         |                       "value": 800.0,
ap2_merchant_agent         |                       "currency": "JPY"
ap2_merchant_agent         |                     },
ap2_merchant_agent         |                     "image_url": null
ap2_merchant_agent         |                   }
ap2_merchant_agent         |                 ]
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "merchant_signature": {
ap2_merchant_agent         |                 "algorithm": "ED25519",
ap2_merchant_agent         |                 "value": "dpc0r2X4dnnomQCt4ohahBszNYSRC/tehREScryA+yPD92IPB8fM+VwKTWZJ9llnFQIP2+VypVvEeVKfW11EBw==",
ap2_merchant_agent         |                 "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_merchant_agent         |                 "signed_at": "2025-10-29T09:29:02.233293Z",
ap2_merchant_agent         |                 "key_id": "merchant"
ap2_merchant_agent         |               }
ap2_merchant_agent         |             }
ap2_merchant_agent         |           }
ap2_merchant_agent         |         }
ap2_merchant_agent         |       ]
ap2_merchant_agent         |     }
ap2_merchant_agent         |   ],
ap2_merchant_agent         |   "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |   "merchant_name": "むぎぼーショップ"
ap2_merchant_agent         | }
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [2025-10-29 09:29:02,303] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.CartCandidates, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | INFO:     172.18.0.11:58066 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:29:03.083169Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:29:03.090433Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1888}
ap2_redis                  | 1:M 29 Oct 2025 09:32:15.062 * 1 changes in 3600 seconds. Saving...
ap2_redis                  | 1:M 29 Oct 2025 09:32:15.094 * Background saving started by pid 3611
ap2_redis                  | 3611:C 29 Oct 2025 09:32:15.134 * DB saved on disk
ap2_redis                  | 3611:C 29 Oct 2025 09:32:15.134 * Fork CoW for RDB: current 0 MB, peak 0 MB, average 0 MB
ap2_redis                  | 1:M 29 Oct 2025 09:32:15.200 * Background saving terminated with success
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "OPTIONS /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.275516Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.281274Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=cart_selection", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.281663Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.281848Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.310206Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.313391Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.345938Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:16.353226Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "OPTIONS /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.007728Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.008582Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.008821Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] Received CartMandate signature: cart_id=None, session_id=session_1761729806775_59uphh", "module": "agent", "function": "submit_cart_signature", "line": 1200}
ap2_shopping_agent         | [2025-10-29 09:42:20,008] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying CartMandate WebAuthn signature: user_id=usr_577b4cbdb15e4f5d
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.055232Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: et9d3nUkGZvEXePq...", "module": "provider", "function": "verify_attestation", "line": 512}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.055371Z", "level": "INFO", "logger": "provider", "message": "  User: usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_attestation", "line": 513}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.055408Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 514}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.056696Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.057578Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.057611Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.057622Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.057637Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.058103Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.058133Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.059215Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.067693Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.075341Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準 拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 532}
ap2_credential_provider    | [2025-10-29 09:42:20,077] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: None
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:20.078120Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] No payment_method.token in mandate (likely IntentMandate signature), skipping Payment Network call", "module": "provider", "function": "verify_attestation", "line": 560}
ap2_credential_provider    | [2025-10-29 09:42:20,084] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=unknown, verified=True, agent_token=None...
ap2_credential_provider    | INFO:     172.18.0.11:53332 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | [2025-10-29 09:42:20,091] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Sent WebAuthn verification request to Credential Provider: user_id=usr_577b4cbdb15e4f5d
ap2_shopping_agent         | [2025-10-29 09:42:20,091] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ WebAuthn signature verified successfully: counter=0, attestation_type=passkey
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.096559Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.096878Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] CartMandate signed by user: cart_id=None, webauthn_assertion saved", "module": "agent", "function": "submit_cart_signature", "line": 1240}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "POST /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.108326Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.113286Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.114721Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.114806Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | [2025-10-29 09:42:20,328] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 13-14: Presenting payment methods to user
ap2_shopping_agent         |   Available Methods: 2
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.898767Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:20.905033Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.977287Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.978554Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=payment_method_selection", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.978826Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.978865Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | [2025-10-29 09:42:21,986] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 15-18: Tokenizing payment method
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         |   Payment Method ID: pm_1486a851
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.987492Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment method tokenization for: pm_1486a851", "module": "agent", "function": "_tokenize_payment_method", "line": 2238}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.987539Z", "level": "INFO", "logger": "agent", "message": "\n================================================================================\n[ShoppingAgent → CredentialProvider] トークン化リクエスト送信\n  URL: http://credential_provider:8003/payment-methods/tokenize\n  User ID: usr_577b4cbdb15e4f5d\n  Payment Method ID: pm_1486a851\n================================================================================", "module": "agent", "function": "_tokenize_payment_method", "line": 2242}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:21.997268Z", "level": "INFO", "logger": "provider", "message": "[tokenize_payment_method] Generated secure token for payment method: pm_1486a851", "module": "provider", "function": "tokenize_payment_method", "line": 753}
ap2_credential_provider    | INFO:     172.18.0.11:53332 - "POST /payment-methods/tokenize HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.998796Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent ← CredentialProvider] トークン化レスポン ス受信: status=200", "module": "agent", "function": "_tokenize_payment_method", "line": 2262}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:21.998837Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Payment method tokenized: pm_1486a851 → tok_d17a83ca_WlkUFJ8...", "module": "agent", "function": "_tokenize_payment_method", "line": 2272}
ap2_shopping_agent         | [2025-10-29 09:42:21,998] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 17-18: Received tokenized payment method
ap2_shopping_agent         |   Token: tok_d17a83ca_WlkUFJ8...
ap2_shopping_agent         | [2025-10-29 09:42:21,999] INFO in services.shopping_agent.utils.payment_helpers: [_extract_payment_amount_from_cart] CartMandate structure: has_contents=True, has_payment_request=True, has_details=True, has_total=True, total_amount={'value': 4350.0, 'currency': 'JPY'}
ap2_shopping_agent         | [2025-10-29 09:42:21,999] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-29 09:42:22,002] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: 49b8ecaf131e8ee7...
ap2_shopping_agent         | [2025-10-29 09:42:22,002] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: 2497a5d6b8bc7b9d...
ap2_shopping_agent         | [2025-10-29 09:42:22,003] ERROR in v2.common.user_authorization: Failed to extract public key from WebAuthn assertion: attestationObject not found in assertion
ap2_shopping_agent         | Traceback (most recent call last):
ap2_shopping_agent         |   File "/app/v2/common/user_authorization.py", line 156, in extract_public_key_from_webauthn_assertion
ap2_shopping_agent         |     raise ValueError("attestationObject not found in assertion")
ap2_shopping_agent         | ValueError: attestationObject not found in assertion
ap2_shopping_agent         | [2025-10-29 09:42:22,005] WARNING in v2.common.user_authorization: [create_user_authorization_vp] No attestationObject, and no public_key_cose provided
ap2_shopping_agent         | [2025-10-29 09:42:22,005] WARNING in v2.common.user_authorization: [create_user_authorization_vp] No public key available, cnf claim not added
ap2_shopping_agent         | [2025-10-29 09:42:22,005] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2148, cart_hash=49b8ecaf131e8ee7..., payment_hash=2497a5d6b8bc7b9d...
ap2_shopping_agent         | [2025-10-29 09:42:22,005] INFO in services.shopping_agent.utils.payment_helpers: [_generate_user_authorization_for_payment] Generated user_authorization VP: length=2148
ap2_shopping_agent         | [2025-10-29 09:42:22,005] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] transaction_type=human_not_present (no strong authentication detected)
ap2_shopping_agent         | [2025-10-29 09:42:22,005] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Performing risk assessment...
ap2_shopping_agent         | [2025-10-29 09:42:22,006] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Invalid amount value: 4350.0
ap2_shopping_agent         | [2025-10-29 09:42:22,006] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Failed to parse amounts for constraint check
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:22.010731Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created with user_authorization: has_user_auth=True", "module": "agent", "function": "_create_payment_mandate", "line": 2007}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:22.010791Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created: amount=4350.0 JPY, payment_method=Visa ****3333, token=tok_d17a83ca_WlkUFJ8..., risk_score=1", "module": "agent", "function": "_create_payment_mandate", "line": 2012}
ap2_shopping_agent         | [2025-10-29 09:42:22,006] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Failed to parse amount for pattern check
ap2_shopping_agent         | [2025-10-29 09:42:22,009] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Assessment completed: risk_score=1, recommendation=approve, fraud_indicators=['card_not_present_transaction']
ap2_shopping_agent         | [2025-10-29 09:42:22,010] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Risk assessment completed: score=1, recommendation=approve, indicators=['card_not_present_transaction']
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:22.065403Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:22.069339Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "OPTIONS /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.767738Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.770567Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Verifying attestation for PaymentMandate: payment_12f0c181", "module": "agent", "function": "submit_payment_attestation", "line": 1352}
ap2_shopping_agent         | [2025-10-29 09:42:24,770] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying PaymentMandate attestation: payment_id=payment_12f0c181
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777058Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: et9d3nUkGZvEXePq...", "module": "provider", "function": "verify_attestation", "line": 512}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777143Z", "level": "INFO", "logger": "provider", "message": "  User: usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_attestation", "line": 513}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777172Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 514}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777213Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777314Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777386Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777430Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777480Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777523Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777550Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.777609Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.779966Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.783820Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準 拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 532}
ap2_credential_provider    | [2025-10-29 09:42:24,783] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: usr_577b4cbdb15e4f5d
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.784036Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] PaymentMandate contains payment_method.token, calling Payment Network (Step 23)", "module": "provider", "function": "verify_attestation", "line": 551}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.784422Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Requesting Agent Token from Payment Network: payment_mandate_id=payment_12f0c181", "module": "provider", "function": "_request_agent_token_from_network", "line": 1787}
ap2_payment_network        | [2025-10-29 09:42:24,861] INFO in network: [DemoPaymentNetwork] Received tokenization request: payment_mandate_id=payment_12f0c181, payment_method_token=tok_d17a83ca_WlkUFJ8...
ap2_payment_network        | [2025-10-29 09:42:24,865] INFO in services.payment_network.utils.token_helpers: [DemoPaymentNetwork] Issued Agent Token: agent_tok_demopaymentnetwork_b47..., expires_at=2025-10-29T10:42:24.863089+00:00
ap2_payment_network        | INFO:     172.18.0.13:40514 - "POST /network/tokenize HTTP/1.1" 200 OK
ap2_credential_provider    | [2025-10-29 09:42:24,873] INFO in httpx: HTTP Request: POST http://payment_network:8005/network/tokenize "HTTP/1.1 200 OK"
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.874660Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Received Agent Token from Payment Network: agent_tok_demopaymentnetwork_b47..., network_name=DemoPaymentNetwork", "module": "provider", "function": "_request_agent_token_from_network", "line": 1812}
ap2_credential_provider    | [2025-10-29 09:42:24,878] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=usr_577b4cbdb15e4f5d, verified=True, agent_token=agent_tok_demopaymentnetwork_b47...
ap2_credential_provider    | INFO:     172.18.0.11:53332 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | [2025-10-29 09:42:24,880] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ PaymentMandate attestation verified: payment_id=payment_12f0c181
ap2_shopping_agent         | [2025-10-29 09:42:24,880] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Retrieving public key from Credential Provider: credential_id=et9d3nUkGZvEXePq..., user_id=usr_577b4cbdb15e4f5d
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.880878Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Attestation verified, processing payment...", "module": "agent", "function": "submit_payment_attestation", "line": 1372}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:24.885801Z", "level": "INFO", "logger": "provider", "message": "[get_passkey_public_key] Public key retrieved: credential_id=et9d3nUkGZvEXePq..., user_id=usr_577b4cbdb15e4f5d", "module": "provider", "function": "get_passkey_public_key", "line": 1476}
ap2_credential_provider    | INFO:     172.18.0.11:53332 - "POST /passkey/get-public-key HTTP/1.1" 200 OK
ap2_shopping_agent         | [2025-10-29 09:42:24,887] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ Public key retrieved: credential_id=et9d3nUkGZvEXePq...
ap2_shopping_agent         | [2025-10-29 09:42:24,887] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-29 09:42:24,887] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: 49b8ecaf131e8ee7...
ap2_shopping_agent         | [2025-10-29 09:42:24,887] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: 41a2312e3ce57fd3...
ap2_shopping_agent         | [2025-10-29 09:42:24,890] INFO in v2.common.user_authorization: [create_user_authorization_vp] Restored public key from COSE format
ap2_shopping_agent         | [2025-10-29 09:42:24,890] INFO in v2.common.user_authorization: [create_user_authorization_vp] cnf claim with JWK added to Issuer JWT
ap2_shopping_agent         | [2025-10-29 09:42:24,890] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2408, cart_hash=49b8ecaf131e8ee7..., payment_hash=41a2312e3ce57fd3...
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.890750Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] SD-JWT-VC user_authorization generated: user_id=usr_577b4cbdb15e4f5d, vp_length=2408", "module": "agent", "function": "submit_payment_attestation", "line": 1416}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.895406Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1888}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.895624Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] PaymentMandate signed by user: payment_id=payment_12f0c181, next_step=payment_execution", "module": "agent", "function": "submit_payment_attestation", "line": 1437}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "POST /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.902476Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | INFO:     172.67.69.85:23855 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.903413Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761729806775_59uphh, step=webauthn_signature_requested", "module": "agent", "function": "_get_or_create_session", "line": 1853}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.903631Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761729806775_59uphh)", "module": "agent", "function": "event_generator", "line": 998}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.903668Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761729806775_59uphh", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1571}
ap2_shopping_agent         | [2025-10-29 09:42:24,930] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting payment processing via Merchant Agent for PaymentMandate: payment_12f0c181
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.931139Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.931347Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 5897, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_12f0c181\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。\",\"cart_name\":\"高品質プラン (3,500", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.931416Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:24.932428Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_shopping_agent         | [2025-10-29 09:42:24,932] INFO in v2.common.a2a_handler:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [A2A送信] レスポンス作成
ap2_shopping_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_shopping_agent         |   送信先: did:ap2:agent:merchant_agent
ap2_shopping_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_shopping_agent         |   データID: payment_12f0c181
ap2_shopping_agent         |   署名: あり
ap2_shopping_agent         |   タイムスタンプ: 2025-10-29T09:42:24.930917Z
ap2_shopping_agent         |   ペイロード: {
ap2_shopping_agent         |   "payment_mandate": {
ap2_shopping_agent         |     "payment_mandate_contents": {
ap2_shopping_agent         |       "payment_mandate_id": "payment_12f0c181",
ap2_shopping_agent         |       "payment_details_id": "order_610b9058",
ap2_shopping_agent         |       "payment_details_total": {
ap2_shopping_agent         |         "label": "Total",
ap2_shopping_agent         |         "amount": {
ap2_shopping_agent         |           "value": 4350.0,
ap2_shopping_agent         |           "currency": "JPY"
ap2_shopping_agent         |         }
ap2_shopping_agent         |       },
ap2_shopping_agent         |       "payment_response": {
ap2_shopping_agent         |         "methodName": "basic-card",
ap2_shopping_agent         |         "details": {
ap2_shopping_agent         |           "cardholderName": "Demo User",
ap2_shopping_agent         |           "cardNumber": "****3333",
ap2_shopping_agent         |           "cardSecurityCode": "***",
ap2_shopping_agent         |           "cardBrand": "Visa",
ap2_shopping_agent         |           "expiryMonth": "03",
ap2_shopping_agent         |           "expiryYear": "2029",
ap2_shopping_agent         |           "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",
ap2_shopping_agent         |           "tokenized": true
ap2_shopping_agent         |         }


ap2_merchant_agent         | [2025-10-29 09:42:24,955] INFO in v2.common.base_agent:
ap2_shopping_agent         |       },


ap2_shopping_agent         |       "merchant_agent": "did:ap2:merchant:mugibo_merchant",
ap2_shopping_agent         |       "timestamp": "2025-10-29T09:42:21.999430Z"

ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message

ap2_merchant_agent         |   受信メッセージ: ID=41a3326c-b664-432c-abd1-c17a5899dace
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [2025-10-29 09:42:24,957] INFO in v2.common.a2a_handler:
ap2_shopping_agent         |     },
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [A2A受信] メッセージID: 41a3326c-b664-432c-abd1-c17a5899dace
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   送信先: did:ap2:agent:merchant_agent
ap2_shopping_agent         |     "user_authorization": "eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakUzTXpBNU5EUXNJbVY0Y0NJNk1UYzJNVGN6TVRJME5Dd2libUptSWpveE56WXhOek13T1RRMExDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUo0WkhGdFowSlVXRjlvU25CZlVVTjBUa1I1Um1SVE0zZHpRVXR1ZFZCNGJGOTFNRTVsTkd4S05FTk5JaXdpYVdGMElqb3hOell4TnpNd09UUTBMQ0
aR1ExT0dWak5ETmtNbVF6WW1NM05qVTNaR1l3T1dWbU1EaGpaV0kxWVNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lORGxpT0dWallXWXhNekZsT0dWbE56TmhNamd4T0RFMk5EQmxOV0kyTlRFNU5XTTBaakZrTjJRME56TXhPRFkxWmpZek1UUTFZVEkyTm1Vd1l6RXpPQ0lzSWpReFlUSXpNVEpsTTJObE5UZG1aRE5sTTJVNE5UTTFOalEwTlRKaFlXWm1ZVEEyTkRNM05EUm1aVEl4T0dNNE1UUmlaRE16WW1NeVlqYzVNek0yWVdFaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IaE5iVmwzV1hwRk5FMVRTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVkzcE5SR3N3VFdwck5VNHpNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lHazRtaGdxRXctN3hCb21NNldfVVR3UXllUC1qdEY1MDN2czNqX1M3UDZKQWlBaTVWNHRqbFBTai1kVzlFRmhYb2UwMmRUQ1R1RGV5R3F3UGtMVVpoUHFadyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHhNbVl3WXpFNE1TSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UY3pNRGswTWprNU4zMCJ9LCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4IiwicGF5bWVudF9oYXNoIjoiNDFhMjMxMmUzY2U1N2ZkM2UzZTg1MzU2NDQ1MmFhZmZhMDY0Mzc0NGZlMjE4YzgxNGJkMzNiYzJiNzkzMzZhYSJ9",
ap2_merchant_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_merchant_agent         |   データID: payment_12f0c181
ap2_merchant_agent         |   タイムスタンプ: 2025-10-29T09:42:24.930917Z

ap2_shopping_agent         |     "agent_involved": true,

ap2_merchant_agent         |   ペイロード: {


ap2_shopping_agent         |     "transaction_type": "human_not_present",
ap2_merchant_agent         |   "payment_mandate": {
ap2_shopping_agent         |     "id": "payment_12f0c181",
ap2_shopping_agent         |     "cart_mandate_id": "cart_e83c4b42",


ap2_shopping_agent         |     "intent_mandate_id": "intent_462960b4",
ap2_merchant_agent         |     "payment_mandate_contents": {


ap2_merchant_agent         |       "payment_mandate_id": "payment_12f0c181",


ap2_shopping_agent         |     "payer_id": "usr_577b4cbdb15e4f5d",
ap2_shopping_agent         |     "payee_id": "did:ap2:merchant:mugibo_merchant",
ap2_shopping_agent         |     "amount": {
ap2_shopping_agent         |       "value": 4350.0,
ap2_shopping_agent         |       "currency": "JPY"
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "payment_method": {
ap2_shopping_agent         |       "type": "basic-card",

ap2_shopping_agent         |       "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",
ap2_shopping_agent         |       "last4": "3333",
ap2_shopping_agent         |       "brand": "Visa",

ap2_shopping_agent         |       "expiry_month": "03",
ap2_shopping_agent         |       "expiry_year": "2029"
ap2_merchant_agent         |         "label": "Total",
ap2_merchant_agent         |         "amount": {
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "risk_score": 1,350.0,


ap2_shopping_agent         |     "fraud_indicators": [

ap2_shopping_agent         |       "card_not_present_transaction"


ap2_shopping_agent         |     ]
ap2_shopping_agent         |   },
ap2_shopping_agent         |   "cart_mandate": {
ap2_shopping_agent         |     "contents": {
ap2_merchant_agent         |         }
ap2_shopping_agent         |       "id": "cart_e83c4b42",
ap2_merchant_agent         |       },fig   w Enable Watch

ap2_merchant_agent         |         "methodName": "basic-card",
ap2_shopping_agent         |       "user_cart_confirmation_required": true,


ap2_merchant_agent         |         "details": {
ap2_shopping_agent         |       "payment_request": {




ap2_shopping_agent         |         "method_data": [],



ap2_merchant_agent         |           "cardNumber": "****3333",
ap2_shopping_agent         |         "details": {



ap2_shopping_agent         |           "id": "cart_e83c4b42",
ap2_merchant_agent         |           "cardSecurityCode": "***",



ap2_merchant_agent         |           "cardBrand": "Visa",

ap2_shopping_agent         |             {


ap2_merchant_agent         |           "expiryMonth": "03",
ap2_shopping_agent         |               "label": "むぎぼー時計",
ap2_merchant_agent         |           "expiryYear": "2029",

ap2_shopping_agent         |               "amount": {




ap2_merchant_agent         |           "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",
ap2_shopping_agent         |                 "value": 3500.0,
ap2_merchant_agent         |           "tokenized": true
ap2_merchant_agent         |         }
ap2_merchant_agent         |       },

ap2_merchant_agent         |       "merchant_agent": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |       "timestamp": "2025-10-29T09:42:21.999430Z"
ap2_shopping_agent         |                 "currency": "JPY"

ap2_merchant_agent         |     "user_authorization": "eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakUzTXpBNU5EUXNJbVY0Y0NJNk1UYzJNVGN6TVRJME5Dd2libUptSWpveE56WXhOek13T1RRMExDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUo0WkhGdFowSlVXRjlvU25CZlVVTjBUa1I1Um1SVE0zZHpRVXR1ZFZCNGJGOTFNRTVsTkd4S05FTk5JaXdpYVdGMElqb3hOell4TnpNd09UUTBMQ0p6WkY5b1lYTm9Jam9pWXpFeFptRmxORGMwWkRkak56STFZVGN3T0RnelpUaGhPVEE1WmpNellUQTBaR1ExT0dWak5ETmtNbVF6WW1NM05qVTNaR1l3T1dWbU1EaGpaV0kxWVNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lORGxpT0dWallXWXhNekZsT0dWbE56TmhNamd4T0RFMk5EQmxOV0kyTlRFNU5XTTBaakZrTjJRME56TXhPRFkxWmpZek1UUTFZVEkyTm1Vd1l6RXpPQ0lzSWpReFlUSXpNVEpsTTJObE5UZG1aRE5sTTJVNE5UTTFOalEwTlRKaFlXWm1ZVEEyTkRNM05EUm1aVEl4T0dNNE1UUmlaRE16WW1NeVlqYzVNek0yWVdFaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IaE5iVmwzV1hwRk5FMVRTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVkzcE5SR3N3VFdwck5VNHpNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lHazRtaGdxRXctN3hCb21NNldfVVR3UXllUC1qdEY1MDN2czNqX1M3UDZKQWlBaTVWNHRqbFBTai1kVzlFRmhYb2UwMmRUQ1R1RGV5R3F3UGtMVVpoUHFadyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHhNbVl3WXpFNE1TSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UY3pNRGswTWprNU4zMCJ9LCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4IiwicGF5bWVudF9oYXNoIjoiNDFhMjMxMmUzY2U1N2ZkM2UzZTg1MzU2NDQ1MmFhZmZhMDY0Mzc0NGZlMjE4YzgxNGJkMzNiYzJiNzkzMzZhYSJ9",
ap2_payment_processor      | [2025-10-29 09:42:25,017] INFO in v2.common.base_agent:
ap2_payment_processor      | ================================================================================
ap2_shopping_agent         |               },



ap2_payment_processor      | [Payment Processor] A2Aエンドポイント: POST /a2a/message
ap2_shopping_agent         |               "refund_period": 2592000
ap2_merchant_agent         |     "agent_involved": true,



ap2_payment_processor      |   受信メッセージ: ID=071c8e7b-04eb-4299-a4ef-cae3021aa2c0
ap2_payment_processor      |   送信元: did:ap2:agent:merchant_agent
ap2_payment_processor      |   タイプ: ap2.mandates.PaymentMandate
ap2_payment_processor      | ================================================================================
ap2_shopping_agent         |             },
ap2_shopping_agent         |             {

ap2_shopping_agent         |               "label": "消費税（10%）",
ap2_merchant_agent         |     "transaction_type": "human_not_present",
ap2_payment_processor      | [2025-10-29 09:42:25,018] INFO in v2.common.a2a_handler:
ap2_payment_processor      | ================================================================================
ap2_shopping_agent         |               "amount": {
ap2_shopping_agent         |                 "value": 350.0,


ap2_merchant_agent         |     "cart_mandate_id": "cart_e83c4b42",
ap2_payment_processor      | [A2A受信] メッセージID: 071c8e7b-04eb-4299-a4ef-cae3021aa2c0
ap2_merchant_agent         |     "intent_mandate_id": "intent_462960b4",
ap2_payment_processor      |   送信元: did:ap2:agent:merchant_agent

ap2_payment_processor      |   送信先: did:ap2:agent:payment_processor

ap2_merchant_agent         |     "payer_id": "usr_577b4cbdb15e4f5d",
ap2_merchant_agent         |     "payee_id": "did:ap2:merchant:mugibo_merchant",
ap2_shopping_agent         |                 "currency": "JPY"
ap2_shopping_agent         |               },
ap2_merchant_agent         |     "amount": {
ap2_merchant_agent         |       "value": 4350.0,
ap2_merchant_agent         |       "currency": "JPY"
ap2_payment_processor      |   タイプ: ap2.mandates.PaymentMandate
ap2_payment_processor      |   データID: payment_12f0c181
ap2_payment_processor      |   タイムスタンプ: 2025-10-29T09:42:24.969076Z

ap2_shopping_agent         |               "refund_period": 0
ap2_shopping_agent         |             },
ap2_shopping_agent         |             {

ap2_shopping_agent         |               "label": "送料",
ap2_shopping_agent         |               "amount": {
ap2_shopping_agent         |                 "value": 500.0,
ap2_shopping_agent         |                 "currency": "JPY"
ap2_shopping_agent         |               },

ap2_merchant_agent         |     },
ap2_merchant_agent         |     "payment_method": {
ap2_merchant_agent         |       "type": "basic-card",
ap2_merchant_agent         |       "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",

ap2_payment_processor      |   ペイロード: {
ap2_payment_processor      |   "payment_mandate": {
ap2_payment_processor      |     "payment_mandate_contents": {

ap2_payment_processor      |       "payment_mandate_id": "payment_12f0c181",
ap2_payment_processor      |       "payment_details_id": "order_610b9058",
ap2_payment_processor      |       "payment_details_total": {
ap2_shopping_agent         |               "refund_period": 0

ap2_merchant_agent         |       "last4": "3333",

ap2_payment_processor      |         "label": "Total",
ap2_payment_processor      |         "amount": {
ap2_payment_processor      |           "value": 4350.0,
ap2_payment_processor      |           "currency": "JPY"
ap2_payment_processor      |         }

ap2_shopping_agent         |             }
ap2_shopping_agent         |           ],

ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:25.061337Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Verifying token for payer: usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_credentials", "line": 1551}
ap2_credential_provider    | {"timestamp": "2025-10-29T09:42:25.062727Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Token verified: payment_method_id=pm_1486a851, user_id=usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_credentials", "line": 1588}
ap2_credential_provider    | INFO:     172.18.0.9:37258 - "POST /credentials/verify HTTP/1.1" 200 OK
ap2_merchant_agent         |       "brand": "Visa",

ap2_shopping_agent         |           "total": {
ap2_payment_processor      |       },
ap2_payment_processor      |       "payment_response": {
ap2_shopping_agent         |             "label": "合計",
ap2_shopping_agent         |             "amount": {
ap2_merchant_agent         |       "expiry_month": "03",
ap2_merchant_agent         |       "expiry_year": "2029"
ap2_merchant_agent         |     },
ap2_merchant_agent         |     "risk_score": 1,
ap2_merchant_agent         |     "fraud_indicators": [


ap2_shopping_agent         |               "value": 4350.0,
ap2_shopping_agent         |               "currency": "JPY"

ap2_merchant_agent         |       "card_not_present_transaction"
ap2_payment_processor      |         "methodName": "basic-card",
ap2_shopping_agent         |             } w Enable Watch


ap2_shopping_agent         |           }


ap2_merchant_agent         |     ]   "details": {
ap2_shopping_agent         |         },




ap2_shopping_agent         |         "shipping_address": null
ap2_shopping_agent         |       },
ap2_payment_processor      |           "cardholderName": "Demo User",


ap2_merchant_agent         |   },
ap2_shopping_agent         |       "cart_expiry": "2025-10-29T10:29:02.139425Z",
ap2_payment_processor      |           "cardNumber": "****3333",


ap2_shopping_agent         |       "merchant_name": "Demo Merchant"
ap2_merchant_agent         |   "cart_mandate": {


ap2_merchant_agent         |     "contents": {





ap2_payment_processor      |           "cardSecurityCode": "***",
ap2_merchant_agent         |       "id": "cart_e83c4b42",
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiI3NDcyN2JhNC1hNzA2LTQ4YzAtOTFjZC0yYzljYzVhYmFkZjgiLCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4In0.MEUCIG3NN8NR_Hx2pgHC89HX2uXzJBUAxyJVTv_Qd3MoC3AGAiEAkUiW-84BDq0dwbwOT7IXd9mOtuQjr7aG0T_CjquDcgs",
ap2_shopping_agent         |     "_metadata": {


ap2_shopping_agent         |       "intent_mandate_id": null,
ap2_shopping_agent         |       "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_payment_processor      |           "cardBrand": "Visa",9T09:29:02.139437Z",



ap2_payment_processor      |           "expiryMonth": "03",
ap2_payment_processor      |           "expiryYear": "2029",
ap2_payment_processor      |           "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",
ap2_merchant_agent         |       "user_cart_confirmation_required": true,


ap2_merchant_agent         |       "payment_request": {

ap2_payment_processor      |           "tokenized": true



ap2_payment_processor      |         }
ap2_payment_processor      |       },
ap2_payment_processor      |       "merchant_agent": "did:ap2:merchant:mugibo_merchant",
ap2_payment_processor      |       "timestamp": "2025-10-29T09:42:21.999430Z"
ap2_payment_processor      |     },


ap2_payment_processor      |     "user_authorization": "eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakUzTXpBNU5EUXNJbVY0Y0NJNk1UYzJNVGN6TVRJME5Dd2libUptSWpveE56WXhOek13T1RRMExDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUo0WkhGdFowSlVXRjlvU25CZlVVTjBUa1I1Um1SVE0zZHpRVXR1ZFZCNGJGOTFNRTVsTkd4S05FTk5JaXdpYVdGMElqb3hOell4TnpNd09UUTBMQ0p6WkY5b1lYTm9Jam9pWXpFeFptRmxORGMwWkRkak56STFZVGN3T0RnelpUaGhPVEE1WmpNellUQTBaR1ExT0dWak5ETmtNbVF6WW1NM05qVTNaR1l3T1dWbU1EaGpaV0kxWVNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lORGxpT0dWallXWXhNekZsT0dWbE56TmhNamd4T0RFMk5EQmxOV0kyTlRFNU5XTTBaakZrTjJRME56TXhPRFkxWmpZek1UUTFZVEkyTm1Vd1l6RXpPQ0lzSWpReFlUSXpNVEpsTTJObE5UZG1aRE5sTTJVNE5UTTFOalEwTlRKaFlXWm1ZVEEyTkRNM05EUm1aVEl4T0dNNE1UUmlaRE16WW1NeVlqYzVNek0yWVdFaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IaE5iVmwzV1hwRk5FMVRTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVkzcE5SR3N3VFdwck5VNHpNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lHazRtaGdxRXctN3hCb21NNldfVVR3UXllUC1qdEY1MDN2czNqX1M3UDZKQWlBaTVWNHRqbFjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHhNbVl3WXpFNE1TSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UY3pNRGswTWprNU4zMCJ9LCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4IiwicGF5bWVudF9oYXNoIjoiNDFhMjMxMmUzY2U1N2ZkM2UzZTg1MzU2NDQ1MmFhZmZhMDY0Mzc0NGZlMjE4YzgxNGJkMzNiYzJiNzkzMzZhYSJ9",
ap2_shopping_agent         |       "cart_description": "高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。",
ap2_merchant_agent         |         "method_data": [],
ap2_payment_processor      |     "agent_involved": true,
ap2_payment_processor      |     "transaction_type": "human_not_present",



ap2_shopping_agent         |       "raw_items": [
ap2_merchant_agent         |         "details": {

ap2_merchant_agent         |           "id": "cart_e83c4b42",

ap2_payment_processor      |     "id": "payment_12f0c181",


ap2_shopping_agent         |         {


ap2_merchant_agent         |           "display_items": [


ap2_shopping_agent         |           "product_id": "d3215ff6-8087-4622-8ec3-8a8a37101927",


ap2_merchant_agent         |             {


ap2_payment_processor      |     "cart_mandate_id": "cart_e83c4b42",
ap2_shopping_agent         |           "name": "むぎぼー時計",
ap2_shopping_agent         |           "description": "むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。",
ap2_payment_processor      |     "intent_mandate_id": "intent_462960b4",
ap2_shopping_agent         |           "quantity": 1,
ap2_shopping_agent         |           "unit_price": {


ap2_merchant_agent         |               "label": "むぎぼー時計",
ap2_merchant_agent         |               "amount": {
ap2_shopping_agent         |             "value": 3500.0,

ap2_shopping_agent         |             "currency": "JPY"
ap2_shopping_agent         |           },
ap2_payment_processor      |     "payer_id": "usr_577b4cbdb15e4f5d",
ap2_shopping_agent         |           "total_price": {
ap2_shopping_agent         |             "value": 3500.0,
ap2_shopping_agent         |             "currency": "JPY"

ap2_payment_processor      |     "payee_id": "did:ap2:merchant:mugibo_merchant",
ap2_payment_processor      |     "amount": {
ap2_shopping_agent         |           },
ap2_payment_processor      |       "value": 4350.0,
ap2_shopping_agent         |           "image_url": null
ap2_shopping_agent         |         }
ap2_merchant_agent         |                 "value": 3500.0,
ap2_merchant_agent         |                 "currency": "JPY"

ap2_shopping_agent         |       ]
ap2_credential_provider    | [2025-10-29 09:42:25,128] INFO in services.credential_provider.utils.receipt_helpers: [CredentialProvider] Receipt received and stored to DB: transaction_id=txn_79b9548ad1c9, payer_id=usr_577b4cbdb15e4f5d, receipt_url=http://localhost:8004/receipts/txn_79b9548ad1c9.pdf
ap2_shopping_agent         |     },
ap2_merchant_agent         |               },
ap2_payment_processor      |       "currency": "JPY"
ap2_credential_provider    | INFO:     172.18.0.9:37258 - "POST /receipts HTTP/1.1" 200 OK
ap2_shopping_agent         |     "merchant_signature": {
ap2_payment_processor      |     },
ap2_merchant_agent         |               "refund_period": 2592000


ap2_payment_processor      |     "payment_method": {
ap2_merchant_agent         |             },


ap2_shopping_agent         |       "value": "zmYyvWThTHowgk/I6vAQ3y7ZBo6ferrNKgUncTv4FOQIfcGtv2wFMruPvliV8NDWhhEzg6JKpvZO2BwF29yCCQ==",

ap2_payment_processor      |       "type": "basic-card",
ap2_payment_processor      |       "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",

ap2_payment_processor      |       "last4": "3333",
ap2_merchant_agent         |             {


ap2_shopping_agent         |       "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_merchant_agent         |               "label": "消費税（10%）",
ap2_payment_processor      |       "brand": "Visa",
ap2_shopping_agent         |       "signed_at": "2025-10-29T09:29:02.231452Z",


ap2_payment_processor      |       "expiry_month": "03",
ap2_shopping_agent         |       "key_id": "merchant"
ap2_merchant_agent         |               "amount": {

ap2_merchant_agent         |                 "value": 350.0,
ap2_merchant_agent         |                 "currency": "JPY"
ap2_merchant_agent         |               },


ap2_merchant_agent         |               "refund_period": 0
ap2_payment_processor      |       "expiry_year": "2029"


ap2_shopping_agent         |   }
ap2_merchant_agent         |             },
ap2_shopping_agent         | }
ap2_payment_processor      |     },



ap2_merchant_agent         |             {
ap2_payment_processor      |     "risk_score": 1,




ap2_shopping_agent         | ================================================================================
ap2_merchant_agent         |               "label": "送料",
ap2_shopping_agent         | [2025-10-29 09:42:24,932] INFO in services.shopping_agent.utils.merchant_integration:


ap2_merchant_agent         |               "amount": {
ap2_payment_processor      |       "card_not_present_transaction"
ap2_shopping_agent         | ================================================================================

ap2_payment_processor      |     ]


ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信（PaymentRequest）
v View in Docker Desktop   o View Config   w Enable Watch

ap2_merchant_agent         |                 "value": 500.0,
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: 41a3326c-b664-432c-abd1-c17a5899dace
ap2_merchant_agent         |                 "currency": "JPY"
ap2_merchant_agent         |               },ndates.PaymentMandate
ap2_payment_processor      |   },
ap2_payment_processor      |   "cart_mandate": {



ap2_payment_processor      |     "contents": {


ap2_merchant_agent         |               "refund_period": 0


ap2_shopping_agent         |   PaymentMandate ID: payment_12f0c181
ap2_payment_processor      |       "id": "cart_e83c4b42",
ap2_shopping_agent         | ================================================================================


ap2_shopping_agent         | [2025-10-29 09:42:25,144] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_payment_processor      |       "user_cart_confirmation_required": true,


ap2_merchant_agent         |             }
ap2_shopping_agent         |   Response Type: ap2.responses.PaymentResult



ap2_payment_processor      |       "payment_request": {
ap2_shopping_agent         | ================================================================================
ap2_merchant_agent         |           ],
ap2_merchant_agent         |           "total": {
ap2_payment_processor      |         "method_data": [],


ap2_merchant_agent         |             "label": "合計",

ap2_payment_processor      |         "details": {
ap2_shopping_agent         | [2025-10-29 09:42:25,144] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Payment processing completed: status=captured


ap2_shopping_agent         | [2025-10-29 09:42:25,144] INFO in services.shopping_agent.langgraph_shopping_flow: [execute_payment_node] Payment successful: status=captured, transaction_id=txn_79b9548ad1c9

ap2_payment_processor      |           "id": "cart_e83c4b42",




ap2_payment_processor      |           "display_items": [


ap2_payment_processor      |             {
ap2_merchant_agent         |               "currency": "JPY"
ap2_merchant_agent         |             }
ap2_payment_processor      |               "label": "むぎぼー時計",
ap2_payment_processor      |               "amount": {



ap2_merchant_agent         |           }
ap2_payment_processor      |                 "value": 3500.0,
ap2_merchant_agent         |         },



ap2_payment_processor      |                 "currency": "JPY"
ap2_merchant_agent         |         "shipping_address": null
ap2_merchant_agent         |       },
ap2_merchant_agent         |       "cart_expiry": "2025-10-29T10:29:02.139425Z",
ap2_merchant_agent         |       "merchant_name": "Demo Merchant"

ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:25.191620Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761729806775_59uphh, step=completed", "module": "agent", "function": "_update_session", "line": 1888}


ap2_payment_processor      |               "refund_period": 2592000
ap2_payment_processor      |             },

ap2_merchant_agent         |     },


ap2_payment_processor      |             {
ap2_merchant_agent         |     "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiI3NDcyN2JhNC1hNzA2LTQ4YzAtOTFjZC0yYzljYzVhYmFkZjgiLCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4In
ap2_payment_processor      |               "label": "消費税（10%）",



ap2_payment_processor      |               "amount": {
ap2_shopping_agent         | {"timestamp": "2025-10-29T09:42:25.197043Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_17617298
ap2_payment_processor      |                 "value": 350.0,: "_update_session", "line": 1888}
ap2_merchant_agent         |       "intent_mandate_id": null,
ap2_merchant_agent         |       "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |       "created_at": "2025-10-29T09:29:02.139437Z",


ap2_merchant_agent         |       "cart_name": "高品質プラン (3,500円)",

ap2_payment_processor      |               },ription": "高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。",

ap2_merchant_agent         |       "raw_items": [
ap2_merchant_agent         |         {



ap2_payment_processor      |               "refund_period": 0
ap2_merchant_agent         |           "product_id": "d3215ff6-8087-4622-8ec3-8a8a37101927",


ap2_payment_processor      |             },
ap2_merchant_agent         |           "name": "むぎぼー時計",
ap2_payment_processor      |             {





ap2_merchant_agent         |           "description": "むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。",


ap2_payment_processor      |               "label": "送料",

ap2_payment_processor      |               "amount": {


ap2_payment_processor      |                 "value": 500.0,
ap2_payment_processor      |                 "currency": "JPY"
ap2_payment_processor      |               },

ap2_payment_processor      |               "refund_period": 0


ap2_merchant_agent         |             "value": 3500.0,

ap2_merchant_agent         |           },
ap2_payment_processor      |             }


ap2_merchant_agent         |           "total_price": {

ap2_merchant_agent         |             "value": 3500.0,
ap2_payment_processor      |           ],
ap2_merchant_agent         |             "currency": "JPY"


ap2_merchant_agent         |           },
ap2_payment_processor      |           "total": {
ap2_payment_processor      |             "label": "合計",
ap2_merchant_agent         |           "image_url": null
ap2_payment_processor      |             "amount": {
ap2_payment_processor      |               "value": 4350.0,


ap2_merchant_agent         |         }
ap2_payment_processor      |               "currency": "JPY"
ap2_merchant_agent         |       ]
ap2_payment_processor      |             }


ap2_payment_processor      |           }
ap2_merchant_agent         |     },


ap2_payment_processor      |         },


ap2_merchant_agent         |     "merchant_signature": {


ap2_merchant_agent         |       "algorithm": "ED25519",
ap2_payment_processor      |         "shipping_address": null


ap2_merchant_agent         |       "value": "zmYyvWThTHowgk/I6vAQ3y7ZBo6ferrNKgUncTv4FOQIfcGtv2wFMruPvliV8NDWhhEzg6JKpvZO2BwF29yCCQ==",



ap2_merchant_agent         |       "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_payment_processor      |       },
ap2_merchant_agent         |       "signed_at": "2025-10-29T09:29:02.231452Z",",


ap2_payment_processor      |       "merchant_name": "Demo Merchant"
ap2_merchant_agent         |     }

ap2_payment_processor      |     },
ap2_merchant_agent         |   }
ap2_merchant_agent         | }
ap2_payment_processor      |     "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiI3NDcyN2JhNC1hNzA2LTQ4YzAtOTFjZC0yYzljYzVhYmFkZjgiLCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4In0.MEUCIG3NN8NR_Hx2pgHC89HX2uXzJBUAxyJVTv_Qd3MoC3AGAiEAkUiW-84BDq0dwbwOT7IXd9mOtuQjr7aG0T_CjquDcgs",
ap2_merchant_agent         | ================================================================================
ap2_payment_processor      |     "_metadata": {



ap2_payment_processor      |       "intent_mandate_id": null,

ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.959256Z", "level": "DEBUG", "logger": "common.nonce_manager", "message": "Cleaned up 1 expired nonces", "module": "nonce_manager", "function": "_cleanup_expired", "line": 99}
ap2_payment_processor      |       "merchant_id": "did:ap2:merchant:mugibo_merchant",

ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.963079Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_payment_processor      |       "created_at": "2025-10-29T09:29:02.139437Z",


ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.964649Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 5897, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_12f0c181\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。\",\"cart_name\":\"高品質プラン (3,500", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_payment_processor      |       "cart_name": "高品質プラン (3,500円)",

ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.964852Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}


ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.968171Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant_agent         | [2025-10-29 09:42:24,968] INFO in v2.common.a2a_handler: [A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved


ap2_merchant_agent         | [2025-10-29 09:42:24,968] INFO in v2.common.a2a_handler: [A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:shopping_agent
ap2_payment_processor      |       "raw_items": [


ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.968639Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Received PaymentRequest from Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.968709Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Forwarding PaymentMandate to Payment Processor: payment_mandate_id=payment_12f0c181", "module": "payment_handler", "function": "handle_payment_request", "line": 51}
ap2_payment_processor      |         {



ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.969955Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_payment_processor      |           "product_id": "d3215ff6-8087-4622-8ec3-8a8a37101927",

ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.970647Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 5900, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_12f0c181\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。\",\"cart_name\":\"高品質プラン (3,500", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.970726Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}

ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.972381Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant_agent         | [2025-10-29 09:42:24,973] INFO in v2.common.a2a_handler:
ap2_payment_processor      |           "description": "むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。",
ap2_merchant_agent         | ================================================================================
ap2_payment_processor      |           "quantity": 1,

ap2_payment_processor      |           "unit_price": {
ap2_merchant_agent         | [A2A送信] レスポンス作成0.0,


ap2_payment_processor      |             "currency": "JPY"

ap2_merchant_agent         |   送信先: did:ap2:agent:payment_processor
ap2_payment_processor      |           },
ap2_merchant_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_payment_processor      |           "total_price": {
ap2_merchant_agent         |   データID: payment_12f0c181
ap2_merchant_agent         |   署名: あり
ap2_merchant_agent         |   タイムスタンプ: 2025-10-29T09:42:24.969076Z
ap2_merchant_agent         |   ペイロード: {
ap2_payment_processor      |             "value": 3500.0,


ap2_merchant_agent         |   "payment_mandate": {
ap2_payment_processor      |             "currency": "JPY"
ap2_merchant_agent         |     "payment_mandate_contents": {




ap2_payment_processor      |           "image_url": null
ap2_merchant_agent         |       "payment_mandate_id": "payment_12f0c181",
ap2_merchant_agent         |       "payment_details_id": "order_610b9058",
ap2_merchant_agent         |       "payment_details_total": {
ap2_merchant_agent         |         "label": "Total",


ap2_merchant_agent         |         "amount": {
ap2_merchant_agent         |           "value": 4350.0,


ap2_payment_processor      |       ]
ap2_payment_processor      |     },
ap2_merchant_agent         |           "currency": "JPY"

ap2_payment_processor      |     "merchant_signature": {
ap2_payment_processor      |       "algorithm": "ED25519",
ap2_merchant_agent         |         }




ap2_merchant_agent         |       },
ap2_payment_processor      |       "value": "zmYyvWThTHowgk/I6vAQ3y7ZBo6ferrNKgUncTv4FOQIfcGtv2wFMruPvliV8NDWhhEzg6JKpvZO2BwF29yCCQ==",


ap2_merchant_agent         |       "payment_response": {
ap2_payment_processor      |       "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",

ap2_payment_processor      |       "key_id": "merchant"
ap2_merchant_agent         |         "methodName": "basic-card",
ap2_payment_processor      |     }




ap2_payment_processor      |   }
ap2_payment_processor      | }
ap2_merchant_agent         |         "details": {


ap2_payment_processor      | ================================================================================
ap2_merchant_agent         |           "cardholderName": "Demo User",0Z", "level": "DEBUG", "logger": "common.nonce_manager", "message": "Cleaned up 1 expired nonces", "module":
ap2_merchant_agent         |           "cardNumber": "****3333",
ap2_merchant_agent         |           "cardSecurityCode": "***",
ap2_merchant_agent         |           "cardBrand": "Visa",
ap2_merchant_agent         |           "expiryMonth": "03",


ap2_merchant_agent         |           "expiryYear": "2029",
ap2_merchant_agent         |           "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",
ap2_merchant_agent         |           "tokenized": true
ap2_merchant_agent         |         }

ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.023709Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.024380Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 5900, first 200
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.024458Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.026445Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:merchant_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_payment_processor      | [2025-10-29 09:42:25,026] INFO in v2.common.a2a_handler: [A2AHandler] proof署名検証成功: sender=did:ap2:agent:merchant_agent, alg=ed25519, kid=did:ap2:agent:merchant_agent#key-2, public_key_source=DID-resolved
ap2_payment_processor      | [2025-10-29 09:42:25,026] INFO in v2.common.a2a_handler: [A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:merchant_agent


ap2_merchant_agent         |       },
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.026913Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Received PaymentMandate", "module": "processor", "function": "handle_payment_mandate", "line": 362}
ap2_payment_processor      | [2025-10-29 09:42:25,027] INFO in services.payment_processor.utils.mandate_helpers: [PaymentProcessor] PaymentMandate validation passed: payment_12f0c181, user_authorization present: eyJpc3N1ZXJfand0Ijoi...
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.027364Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation: PaymentMandate(payment_12f0c181) → CartMandate(cart_e83c4b42)", "module": "processor", "function": "_validate_mandate_chain", "line": 618}
ap2_merchant_agent         |       "merchant_agent": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |       "timestamp": "2025-10-29T09:42:21.999430Z"



ap2_merchant_agent         |     },

ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.028037Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying SD-JWT-VC user_authorization: cart_hash=49b8ecaf131e8ee7..., payment_hash=41a2312e3ce57fd3...", "module": "processor", "function": "_validate_mandate_chain", "line": 635}
ap2_merchant_agent         |     "user_authorization": "eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakUzTXpBNU5EUXNJbVY0Y0NJNk1UYzJNVGN6TVRJME5Dd2libUptSWpveE56WXhOek13T1RRMExDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUo0WkhGdFowSlVXRjlvU25CZlVVTjBUa1I1Um1SVE0zZHpRVXR1ZFZCNGJGOTFNRTVsTkd4S05FTk5JaXdpYVdGMElqb3hOell4TnpNd09UUTBMQ0p6WkY5b1lYTm9Jam9pWXpFeFptRmxORGMwWkRkak56STFZVGN3T0RnelpUaGhPVEE1WmpNellUQTBaR1ExT0dWak5ETmtNbVF6WW1NM05qVTNaR1l3T1dWbU1EaGpaV0kxWVNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lORGxpT0dWallXWXhNekZsT0dWbE56TmhNamd4T0RFMk5EQmxOV0kyTlRFNU5XTTBaakZrTjJRME56TXhPRFkxWmpZek1UUTFZVEkyTm1Vd1l6RXpPQ0lzSWpReFlUSXpNVEpsTTJObE5UZG1aRE5sTTJVNE5UTTFOalEwTlRKaFlXWm1ZVEEyTkRNM05EUm1aVEl4T0dNNE1UUmlaRE16WW1NeVlqYzVNek0yWVdFaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IaE5iVmwzV1hwRk5FMVRTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVkzcE5SR3N3VFdwck5VNHpNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lHazRtaGdxRXctN3hCb21NNldfVVR3UXllUC1qdEY1MDN2czNqX1M3UDZKQWlBaTVWNHRqbFBTai1kVzlFRmhYb2UwMmRUQ1R1RGV5R3F3UGtMVVpoUHFadyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHhNbVl3WXpFNE1TSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UY3pNRGswTWprNU4zMCJ9LCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4IiwicGF5bWVudF9oYXNoIjoiNDFhMjMxMmUzY2U1N2ZkM2UzZTg1MzU2NDQ1MmFhZmZhMDY0Mzc0NGZlMjE4YzgxNGJkMzNiYzJiNzkzMzZhYSJ9",
ap2_payment_processor      | [2025-10-29 09:42:25,028] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Hash verification passed: cart_hash=49b8ecaf131e8ee7..., payment_hash=41a2312e3ce57fd3...
ap2_merchant_agent         |     "agent_involved": true,
ap2_merchant_agent         |     "transaction_type": "human_not_present",
ap2_payment_processor      | [2025-10-29 09:42:25,031] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ WebAuthn signature verified successfully


ap2_merchant_agent         |     "id": "payment_12f0c181",
ap2_payment_processor      | [2025-10-29 09:42:25,032] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Key-binding JWT payload verified
ap2_merchant_agent         |     "cart_mandate_id": "cart_e83c4b42",

ap2_merchant_agent         |     "intent_mandate_id": "intent_462960b4",


ap2_payment_processor      | [2025-10-29 09:42:25,032] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ VP verification passed
ap2_merchant_agent         |     "payer_id": "usr_577b4cbdb15e4f5d",


ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.032318Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ SD-JWT-VC user_authorization verified: cart_hash_match=True, payment_hash_match=True, webauthn_signature_verified=True", "module": "processor", "function": "_validate_mandate_chain", "line": 648}
ap2_merchant_agent         |     "payee_id": "did:ap2:merchant:mugibo_merchant",



ap2_payment_processor      | [2025-10-29 09:42:25,033] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json


ap2_merchant_agent         |     "amount": {
ap2_merchant_agent         |       "value": 4350.0,34] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent





ap2_merchant_agent         |       "currency": "JPY"
ap2_payment_processor      | [2025-10-29 09:42:25,035] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json


ap2_payment_processor      | [2025-10-29 09:42:25,035] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent         |     },
ap2_payment_processor      | [2025-10-29 09:42:25,036] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json


ap2_merchant_agent         |       "type": "basic-card",


ap2_payment_processor      | [2025-10-29 09:42:25,038] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent         |       "token": "tok_d17a83ca_WlkUFJ8TAaEGw2NtSe8jjFDS",
ap2_payment_processor      | [2025-10-29 09:42:25,038] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor      | [2025-10-29 09:42:25,038] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp

ap2_merchant_agent         |       "last4": "3333",


ap2_merchant_agent         |       "brand": "Visa",39] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2

ap2_merchant_agent         |       "expiry_month": "03",


ap2_payment_processor      | [2025-10-29 09:42:25,039] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent         |       "expiry_year": "2029"
ap2_merchant_agent         |     },
ap2_merchant_agent         |     "risk_score": 1,
ap2_payment_processor      | [2025-10-29 09:42:25,040] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor


ap2_merchant_agent         |       "card_not_present_transaction"
ap2_payment_processor      | [2025-10-29 09:42:25,040] INFO in services.payment_processor.utils.jwt_helpers: [_verify_jwt_signature] ✓ JWT signature verified successfully


ap2_merchant_agent         |     ]

ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.041021Z", "level": "INFO", "logger": "processor", "message": "[_verify_merchant_authorization_jwt] JWT validation passed: iss=did:ap2:merchant:mugibo_merchant, exp=1761733742, jti=74727ba4-a706-48..., cart_hash=49b8ecaf131e8ee7...", "module": "processor", "function": "_verify_merchant_authorization_jwt", "line": 560}
ap2_merchant_agent         |   },

ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.041077Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] merchant_authorization JWT verified: iss=did:ap2:merchant:mugibo_merchant", "module": "processor", "function": "_validate_mandate_chain", "line": 672}


ap2_merchant_agent         |   "cart_mandate": {

ap2_merchant_agent         |     "contents": {

ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.041095Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] CartMandate hash in merchant_authorization: 49b8ecaf131e8ee7...", "module": "processor", "function": "_validate_mandate_chain", "line": 680}




ap2_merchant_agent         |       "id": "cart_e83c4b42",
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.041254Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ CartMandate hash verified (merchant_authorization): 49b8ecaf131e8ee7...", "module": "processor", "function": "_validate_mandate_chain", "line": 697}
ap2_merchant_agent         |       "user_cart_confirmation_required": true,
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.041279Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation passed", "module": "processor", "function": "_validate_mandate_chain", "line": 729}
ap2_merchant_agent         |       "payment_request": {
ap2_merchant_agent         |         "method_data": [],
ap2_merchant_agent         |         "details": {10-29T09:42:25.041667Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Processing payment (mock): txn_79b9548ad1c9", "module": "processor", "function": "_process_payment_mock", "line": 748}


ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.041713Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying credential with Credential Provider: token=tok_d17a83ca_WlkUFJ8...", "module": "processor", "function": "_verify_credential_with_cp", "line": 863}
ap2_merchant_agent         |           "id": "cart_e83c4b42",


ap2_payment_processor      | [2025-10-29 09:42:25,065] INFO in httpx: HTTP Request: POST http://credential_provider:8003/credentials/verify "HTTP/1.1 200 OK"
ap2_merchant_agent         |           "display_items": [

ap2_merchant_agent         |             {
ap2_merchant_agent         |               "label": "むぎぼー時計",
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.065774Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verification succeeded: payment_method_id=pm_1486a851", "module": "processor", "function": "_verify_credential_with_cp", "line": 898}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.065822Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verified: pm_1486a851", "module": "processor", "function": "_process_payment_mock", "line": 771}


ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.065855Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Risk assessment: score=1, indicators=['card_not_present_transaction']", "module": "processor", "function": "_process_payment_mock", "line": 786}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.065910Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Payment succeeded: txn_79b9548ad1c9, amount={'value': 4350.0, 'currency': 'JPY'}, risk_score=1", "module": "processor", "function": "_process_payment_mock", "line": 820}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.099858Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Transaction saved: txn_79b9548ad1c9", "module": "processor", "function": "_save_transaction", "line": 847}


ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.104583Z", "level": "WARNING", "logger": "processor", "message": "[PaymentProcessor] User not found for payer_id: usr_577b4cbdb15e4f5d, using default name", "module": "processor", "function": "_generate_receipt", "line": 1055}


ap2_payment_processor      | [2025-10-29 09:42:25,104] INFO in v2.common.receipt_generator: [ReceiptGenerator] Generating PDF receipt for transaction: txn_79b9548ad1c9
ap2_merchant_agent         |               },



ap2_payment_processor      | [2025-10-29 09:42:25,107] INFO in v2.common.receipt_generator: [ReceiptGenerator] PDF receipt generated successfully
ap2_merchant_agent         |               "refund_period": 2592000

ap2_merchant_agent         |             },

ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.109148Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Generated receipt PDF: /app/v2/data/receipts/txn_79b9548ad1c9.pdf", "module": "processor", "function": "_generate_receipt", "line": 1076}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.116788Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt record saved to database: txn_79b9548ad1c9", "module": "processor", "function": "_generate_receipt", "line": 1095}


ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.117403Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Sending receipt notification to Credential Provider: transaction_id=txn_79b9548ad1c9, payer_id=usr_577b4cbdb15e4f5d", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 927}
ap2_merchant_agent         |             {
ap2_payment_processor      | [2025-10-29 09:42:25,130] INFO in httpx: HTTP Request: POST http://credential_provider:8003/receipts "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.131098Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt notification sent successfully: transaction_id=txn_79b9548ad1c9, status=200", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 958}


ap2_payment_processor      | [2025-10-29 09:42:25,131] INFO in v2.common.a2a_handler: [A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult
ap2_merchant_agent         |               "label": "消費税（10%）",
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.131799Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}


ap2_merchant_agent         |               "amount": {
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.131904Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 521, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"ce0bde4d-879b-4cbd-b139-1ad9239817ca\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_79b9548ad1c9.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.131937Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         |                 "value": 350.0,
ap2_merchant_agent         |                 "currency": "JPY"
ap2_merchant_agent         |               },
ap2_merchant_agent         |               "refund_period": 0
ap2_merchant_agent         |             },
ap2_merchant_agent         |             {
ap2_merchant_agent         |               "label": "送料",
ap2_merchant_agent         |               "amount": {
ap2_merchant_agent         |                 "value": 500.0,
ap2_merchant_agent         |                 "currency": "JPY"
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | [A2A送信] レスポンス作成
ap2_payment_processor      |   送信元: did:ap2:agent:payment_processor

ap2_merchant_agent         |               },


ap2_merchant_agent         |               "refund_period": 0
ap2_merchant_agent         |             }
ap2_payment_processor      |   送信先: did:ap2:agent:merchant_agent


ap2_merchant_agent         |           ],
ap2_merchant_agent         |           "total": {ses.PaymentResult


ap2_payment_processor      |   データID: ce0bde4d-879b-4cbd-b139-1ad9239817ca
ap2_merchant_agent         |             "label": "合計",
ap2_payment_processor      |   署名: あり
ap2_merchant_agent         |             "amount": {

ap2_payment_processor      |   タイムスタンプ: 2025-10-29T09:42:25.131298Z



ap2_merchant_agent         |               "value": 4350.0,
ap2_payment_processor      |   ペイロード: {


ap2_merchant_agent         |               "currency": "JPY"
ap2_payment_processor      |   "transaction_id": "txn_79b9548ad1c9",


ap2_payment_processor      |   "status": "captured",
ap2_merchant_agent         |             }
ap2_payment_processor      |   "receipt_url": "http://localhost:8004/receipts/txn_79b9548ad1c9.pdf"
ap2_merchant_agent         |           }
ap2_payment_processor      | }
ap2_merchant_agent         |         },
ap2_merchant_agent         |         "shipping_address": null



ap2_merchant_agent         |       },


ap2_merchant_agent         |       "cart_expiry": "2025-10-29T10:29:02.139425Z",
ap2_payment_processor      | ================================================================================


ap2_payment_processor      | [2025-10-29 09:42:25,133] INFO in v2.common.base_agent: [Payment Processor] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:merchant_agent
ap2_merchant_agent         |       "merchant_name": "Demo Merchant"
ap2_merchant_agent         |     },
ap2_payment_processor      | {"timestamp": "2025-10-29T09:42:25.133232Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: payment_processor) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_payment_processor      | INFO:     172.18.0.5:48132 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_merchant_agent         |     "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTczMDE0MiwiZXhwIjoxNzYxNzMzNzQyLCJqdGkiOiI3NDcyN2JhNC1hNzA2LTQ4YzAtOTFjZC0yYzljYzVhYmFkZjgiLCJjYXJ0X2hhc2giOiI0OWI4ZWNhZjEzMWU4ZWU3M2EyODE4MTY0MGU1YjY1MTk1YzRmMWQ3ZDQ3MzE4NjVmNjMxNDVhMjY2ZTBjMTM4In0.MEUCIG3NN8NR_Hx2pgHC89HX2uXzJBUAxyJVTv_Qd3MoC3AGAiEAkUiW-84BDq0dwbwOT7IXd9mOtuQjr7aG0T_CjquDcgs",
ap2_merchant_agent         |     "_metadata": {
ap2_merchant_agent         |       "intent_mandate_id": null,
ap2_merchant_agent         |       "merchant_id": "did:ap2:merchant:mugibo_merchant",
ap2_merchant_agent         |       "created_at": "2025-10-29T09:29:02.139437Z",
ap2_merchant_agent         |       "cart_name": "高品質プラン (3,500円)",
ap2_merchant_agent         |       "cart_description": "高価だがデザイン性の高い時計を1点。かわいさを追求するなら最適な選択です。",
ap2_merchant_agent         |       "raw_items": [
ap2_merchant_agent         |         {
ap2_merchant_agent         |           "product_id": "d3215ff6-8087-4622-8ec3-8a8a37101927",
ap2_merchant_agent         |           "name": "むぎぼー時計",
ap2_merchant_agent         |           "description": "むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。",
ap2_merchant_agent         |           "quantity": 1,
ap2_merchant_agent         |           "unit_price": {
ap2_merchant_agent         |             "value": 3500.0,
ap2_merchant_agent         |             "currency": "JPY"
ap2_merchant_agent         |           },
ap2_merchant_agent         |           "total_price": {
ap2_merchant_agent         |             "value": 3500.0,
ap2_merchant_agent         |             "currency": "JPY"
ap2_merchant_agent         |           },
ap2_merchant_agent         |           "image_url": null
ap2_merchant_agent         |         }
ap2_merchant_agent         |       ]
ap2_merchant_agent         |     },
ap2_merchant_agent         |     "merchant_signature": {
ap2_merchant_agent         |       "algorithm": "ED25519",
ap2_merchant_agent         |       "value": "zmYyvWThTHowgk/I6vAQ3y7ZBo6ferrNKgUncTv4FOQIfcGtv2wFMruPvliV8NDWhhEzg6JKpvZO2BwF29yCCQ==",
ap2_merchant_agent         |       "public_key": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_merchant_agent         |       "signed_at": "2025-10-29T09:29:02.231452Z",
ap2_merchant_agent         |       "key_id": "merchant"
ap2_merchant_agent         |     }
ap2_merchant_agent         |   }
ap2_merchant_agent         | }
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:24.973270Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent → PaymentProcessor] A2Aメッセージ転送\n  URL: http://payment_processor:8004/a2a/message\n  メッセージID: 071c8e7b-04eb-4299-a4ef-cae3021aa2c0\n  タイプ: ap2.mandates.PaymentMandate\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 69}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:25.140857Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent ← PaymentProcessor] A2Aレスポンス受信\n  Status: 200\n  Response Body: {\n  \"header\": {\n    \"message_id\": \"e0701112-02ee-4692-b15e-fe3de563c0a0\",\n    \"sender\": \"did:ap2:agent:payment_processor\",\n    \"recipient\": \"did:ap2:agent:merchant_agent\",\n    \"timestamp\": \"2025-10-29T09:42:25.131298Z\",\n    \"nonce\": \"2c8f7da7b6979797e21a564c9bdf135223e05073b0e8de4508308a78963bf2c9\",\n    \"schema_version\": \"0.2\",\n    \"proof\": {\n      \"algorithm\": \"ed25519\",\n      \"signatureValue\": \"HV1J+cbwx36bGRJfAc5X9XeyjBHoYtBibQkB8gj4vBgSIxrGcUdN3pPizKalkKB+qxWsr5Fi2fcys/S5FjSaDg==\",\n      \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVQzaDBpcWp3UEhkakFxSjVNSDZqbXFYTGZpQjN1R096Y0ZnVzZoN0lSMVE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\",\n      \"kid\": \"did:ap2:agent:payment_processor#key-2\",\n      \"created\": \"2025-10-29T09:42:25.131298Z\",\n      \"proofPurpose\": \"authentication\"\n    },\n    \"signature\": null\n  },\n  \"dataPart\": {\n    \"@type\": \"ap2.responses.PaymentResult\",\n    \"id\": \"ce0bde4d-879b-4cbd-b139-1ad9239817ca\",\n    \"payload\": {\n      \"transaction_id\": \"txn_79b9548ad1c9\",\n      \"status\": \"captured\",\n      \"receipt_url\": \"http://localhost:8004/receipts/txn_79b9548ad1c9.pdf\"\n    },\n    \"kind\": null,\n    \"artifact\": null\n  }\n}\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 86}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:25.140926Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Payment processing completed, forwarding result to Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 101}
ap2_merchant_agent         | [2025-10-29 09:42:25,140] INFO in v2.common.a2a_handler: [A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:25.141348Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:25.141425Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 518, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"ce0bde4d-879b-4cbd-b139-1ad9239817ca\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_79b9548ad1c9.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:25.141582Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-29T09:42:25.141761Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 271}
ap2_merchant_agent         | [2025-10-29 09:42:25,141] INFO in v2.common.a2a_handler:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [A2A送信] レスポンス作成
ap2_merchant_agent         |   送信元: did:ap2:agent:merchant_agent
ap2_merchant_agent         |   送信先: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.responses.PaymentResult
ap2_merchant_agent         |   データID: ce0bde4d-879b-4cbd-b139-1ad9239817ca
ap2_merchant_agent         |   署名: あり
ap2_merchant_agent         |   タイムスタンプ: 2025-10-29T09:42:25.141236Z
ap2_merchant_agent         |   ペイロード: {
ap2_merchant_agent         |   "transaction_id": "txn_79b9548ad1c9",
ap2_merchant_agent         |   "status": "captured",
ap2_merchant_agent         |   "receipt_url": "http://localhost:8004/receipts/txn_79b9548ad1c9.pdf"
ap2_merchant_agent         | }
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [2025-10-29 09:42:25,141] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | INFO:     172.18.0.11:37664 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_jaeger                 | {"level":"info","ts":1761730963.5324268,"caller":"grpc@v1.75.0/clientconn.go:364","msg":"[core] [Channel #1]Channel exiting idle mode"}
ap2_jaeger                 | {"level":"info","ts":1761730963.5908763,"caller":"grpc@v1.75.0/resolver_wrapper.go:210","msg":"[core] [Channel #1]Resolver state updated: {\n  \"Addresses\": [\n    {\n      \"Addr\": \"127.0.0.1:4317\",\n      \"ServerName\": \"\",\n      \"Attributes\": null,\n      \"BalancerAttributes\": null,\n      \"Metadata\": null\n    },\n    {\n      \"Addr\": \"[::1]:4317\",\n      \"ServerName\": \"\",\n      \"Attributes\": null,\n      \"BalancerAttributes\": null,\n      \"Metadata\": null\n    }\n  ],\n  \"Endpoints\": [\n    {\n      \"Addresses\": [\n        {\n          \"Addr\": \"127.0.0.1:4317\",\n          \"ServerName\": \"\",\n          \"Attributes\": null,\n          \"BalancerAttributes\": null,\n          \"Metadata\": null\n        }\n      ],\n      \"Attributes\": null\n    },\n    {\n      \"Addresses\": [\n        {\n          \"Addr\": \"[::1]:4317\",\n          \"ServerName\": \"\",\n          \"Attributes\": null,\n          \"BalancerAttributes\": null,\n          \"Metadata\": null\n        }\n      ],\n      \"Attributes\": null\n    }\n  ],\n  \"ServiceConfig\": null,\n  \"Attributes\": null\n} (resolver returned new addresses)"}
ap2_jaeger                 | {"level":"info","ts":1761730963.591675,"caller":"grpc@v1.75.0/balancer_wrapper.go:122","msg":"[core] [Channel #1]Channel switches to new LB policy \"pick_first\""}
ap2_jaeger                 | {"level":"info","ts":1761730963.5942924,"caller":"gracefulswitch/gracefulswitch.go:194","msg":"[pick-first-leaf-lb] [pick-first-leaf-lb 0x400029f8c0] Received new config {\n  \"shuffleAddressList\": false\n}, resolver state {\n  \"Addresses\": [\n    {\n      \"Addr\": \"127.0.0.1:4317\",\n      \"ServerName\": \"\",\n      \"Attributes\": null,\n      \"BalancerAttributes\": null,\n      \"Metadata\": null\n    },\n    {\n      \"Addr\": \"[::1]:4317\",\n      \"ServerName\": \"\",\n      \"Attributes\": null,\n      \"BalancerAttributes\": null,\n      \"Metadata\": null\n    }\n  ],\n  \"Endpoints\": [\n    {\n      \"Addresses\": [\n        {\n          \"Addr\": \"127.0.0.1:4317\",\n          \"ServerName\": \"\",\n          \"Attributes\": null,\n          \"BalancerAttributes\": null,\n          \"Metadata\": null\n        }\n      ],\n      \"Attributes\": null\n    },\n    {\n      \"Addresses\": [\n        {\n          \"Addr\": \"[::1]:4317\",\n          \"ServerName\": \"\",\n          \"Attributes\": null,\n          \"BalancerAttributes\": null,\n          \"Metadata\": null\n        }\n      ],\n      \"Attributes\": null\n    }\n  ],\n  \"ServiceConfig\": null,\n  \"Attributes\": null\n}"}
ap2_jaeger                 | {"level":"info","ts":1761730963.5962827,"caller":"grpc@v1.75.0/clientconn.go:563","msg":"[core] [Channel #1]Channel Connectivity change to CONNECTING"}
ap2_jaeger                 | {"level":"info","ts":1761730963.596993,"caller":"grpc@v1.75.0/balancer_wrapper.go:195","msg":"[core] [Channel #1 SubChannel #14]Subchannel created"}
ap2_jaeger                 | {"level":"info","ts":1761730963.5983908,"caller":"grpc@v1.75.0/clientconn.go:1226","msg":"[core] [Channel #1 SubChannel #14]Subchannel Connectivity change to CONNECTING"}
ap2_jaeger                 | {"level":"info","ts":1761730963.5988364,"caller":"grpc@v1.75.0/clientconn.go:1345","msg":"[core] [Channel #1 SubChannel #14]Subchannel picks a new address \"127.0.0.1:4317\" to connect"}
ap2_jaeger                 | {"level":"info","ts":1761730963.6030357,"caller":"grpc@v1.75.0/clientconn.go:1226","msg":"[core] [Channel #1 SubChannel #14]Subchannel Connectivity change to READY"}
ap2_jaeger                 | {"level":"info","ts":1761730963.603278,"caller":"pickfirstleaf/pickfirstleaf.go:176","msg":"[pick-first-leaf-lb] [pick-first-leaf-lb 0x400029f8c0] SubConn 0x40006ae7d0 reported connectivity state READY and the health listener is disabled. Transitioning SubConn to READY."}
ap2_jaeger                 | {"level":"info","ts":1761730963.6038082,"caller":"grpc@v1.75.0/clientconn.go:563","msg":"[core] [Channel #1]Channel Connectivity change to READY"}

