                                                                                                                                                                              0.2s Attaching to ap2_credential_provider, ap2_credential_provider_2, ap2_frontend, ap2_init_keys, ap2_init_seeds, ap2_jaeger, ap2_meilisearch, ap2_merchant, ap2_merchant_agent, ap2_merchant_agent_mcp, ap2_payment_network, ap2_payment_processor, ap2_redis, ap2_shopping_agent, ap2_shopping_agent_mcp
ap2_jaeger  | 2025/10/30 11:03:58 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
ap2_jaeger  |
ap2_jaeger  | *******************************************************************************
ap2_jaeger  |
ap2_jaeger  | 🛑  WARNING: End-of-life Notice for Jaeger v1
ap2_jaeger  |
ap2_jaeger  | You are currently running a v1 version of Jaeger, which is deprecated and will
ap2_jaeger  | reach end-of-life on December 31st, 2025. This means there will be no further
ap2_jaeger  | development, bug fixes, or security patches for v1 after this date.
ap2_jaeger  |
ap2_jaeger  | We strongly recommend migrating to Jaeger v2 for continued support and access
ap2_jaeger  | to new features.
ap2_jaeger  |
ap2_jaeger  | For detailed migration instructions, please refer to the official Jaeger
ap2_jaeger  | documentation:  https://www.jaegertracing.io/docs/latest/migration/
ap2_jaeger  |
ap2_jaeger  | Tracking issue: https://github.com/jaegertracing/jaeger/issues/6321
ap2_jaeger  |
ap2_jaeger  | 🛑  WARNING: End-of-life Notice for Jaeger v1
ap2_jaeger  |
ap2_jaeger  | *******************************************************************************
ap2_jaeger  | 2025/10/30 11:03:58 application version: git-commit=a204929483c734da6c54eaa75f3f7c322b3e886b, git-version=v1.74.0, build-date=2025-10-03T02:41:46Z
ap2_jaeger  | {"level":"info","ts":1761822238.6698408,"caller":"flags/service.go:124","msg":"Mounting metrics handler on admin server","route":"/metrics"}
ap2_jaeger  | {"level":"info","ts":1761822238.66998,"caller":"flags/service.go:130","msg":"Mounting expvar handler on admin server","route":"/debug/vars"}
ap2_jaeger  | {"level":"info","ts":1761822238.7320364,"caller":"flags/admin.go:106","msg":"Mounting health check on admin server","route":"/"}
ap2_jaeger  | {"level":"info","ts":1761822238.7322233,"caller":"flags/admin.go:123","msg":"Starting admin HTTP server"}
ap2_jaeger  | {"level":"info","ts":1761822238.7324886,"caller":"flags/admin.go:137","msg":"Admin server started","http.host-port":"[::]:14269","health-status":"unavailable"}
ap2_jaeger  | {"level":"info","ts":1761822238.733443,"caller":"grpc@v1.75.0/clientconn.go:176","msg":"[core] original dial target is: \"localhost:4317\""}
ap2_jaeger  | {"level":"info","ts":1761822238.7335765,"caller":"grpc@v1.75.0/clientconn.go:459","msg":"[core] [Channel #1]Channel created"}
ap2_jaeger  | {"level":"info","ts":1761822238.733633,"caller":"grpc@v1.75.0/clientconn.go:207","msg":"[core] [Channel #1]parsed dial target is: resolver.Target{URL:url.URL{Scheme:\"dns\", Opaque:\"\", User:(*url.Userinfo)(nil), Host:\"\", Path:\"/localhost:4317\", RawPath:\"\", OmitHost:false, ForceQuery:false, RawQuery:\"\", Fragment:\"\", RawFragment:\"\"}}"}
ap2_jaeger  | {"level":"info","ts":1761822238.7336621,"caller":"grpc@v1.75.0/clientconn.go:208","msg":"[core] [Channel #1]Channel authority set to \"localhost:4317\""}
ap2_jaeger  | {"level":"info","ts":1761822238.7340677,"caller":"memory/factory.go:75","msg":"Memory storage initialized","configuration":{"MaxTraces":0}}
ap2_jaeger  | {"level":"info","ts":1761822238.7658541,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #2]Server created"}
ap2_jaeger  | {"level":"info","ts":1761822238.7664173,"caller":"server/grpc.go:75","msg":"Starting jaeger-collector gRPC server","grpc.host-port":"[::]:14250"}
ap2_jaeger  | {"level":"info","ts":1761822238.7665827,"caller":"server/http.go:37","msg":"Starting jaeger-collector HTTP server","host-port":":14268"}
ap2_jaeger  | {"level":"info","ts":1761822238.766918,"caller":"app/collector.go:128","msg":"Not listening for Zipkin HTTP traffic, port not configured"}
ap2_jaeger  | {"level":"info","ts":1761822238.767102,"caller":"handler/otlp_receiver.go:75","msg":"OTLP receiver status change","status":"StatusStarting"}
ap2_jaeger  | {"level":"info","ts":1761822238.7671752,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #3]Server created"}
ap2_jaeger  | {"level":"info","ts":1761822238.7671978,"caller":"otlpreceiver@v0.132.0/otlp.go:117","msg":"Starting GRPC server","endpoint":":4317"}
ap2_jaeger  | {"level":"info","ts":1761822238.7673228,"caller":"otlpreceiver@v0.132.0/otlp.go:175","msg":"Starting HTTP server","endpoint":":4318"}
ap2_jaeger  | {"level":"info","ts":1761822238.7673438,"caller":"app/flags.go:168","msg":"Archive storage not initialized"}
ap2_jaeger  | {"level":"info","ts":1761822238.7674003,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #4]Server created"}
ap2_jaeger  | {"level":"info","ts":1761822238.7677395,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #2 ListenSocket #5]ListenSocket created"}
ap2_jaeger  | {"level":"info","ts":1761822238.7680519,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #3 ListenSocket #6]ListenSocket created"}
ap2_redis   | 1:C 30 Oct 2025 11:03:58.773 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
ap2_redis   | 1:C 30 Oct 2025 11:03:58.773 * Redis version=7.4.6, bits=64, commit=00000000, modified=0, pid=1, just started
ap2_redis   | 1:C 30 Oct 2025 11:03:58.773 * Configuration loaded
ap2_redis   | 1:M 30 Oct 2025 11:03:58.777 * monotonic clock: POSIX clock_gettime
ap2_redis   | 1:M 30 Oct 2025 11:03:58.781 * Running mode=standalone, port=6379.
ap2_jaeger  | {"level":"info","ts":1761822238.7813845,"caller":"app/static_handler.go:92","msg":"Using UI configuration","path":""}
ap2_jaeger  | {"level":"info","ts":1761822238.781991,"caller":"app/server.go:258","msg":"Query server started","http_addr":"[::]:16686","grpc_addr":"[::]:16685"}
ap2_jaeger  | {"level":"info","ts":1761822238.7820423,"caller":"healthcheck/handler.go:117","msg":"Health Check state change","status":"ready"}
ap2_jaeger  | {"level":"info","ts":1761822238.7821474,"caller":"app/server.go:300","msg":"Starting GRPC server","port":16685,"addr":":16685"}
ap2_redis   | 1:M 30 Oct 2025 11:03:58.783 * Server initialized
ap2_redis   | 1:M 30 Oct 2025 11:03:58.783 * Reading RDB base file on AOF loading...
ap2_redis   | 1:M 30 Oct 2025 11:03:58.783 * Loading RDB produced by version 7.4.6
ap2_redis   | 1:M 30 Oct 2025 11:03:58.783 * RDB age 123249 seconds
ap2_redis   | 1:M 30 Oct 2025 11:03:58.784 * RDB memory usage when created 0.94 Mb
ap2_redis   | 1:M 30 Oct 2025 11:03:58.784 * RDB is base AOF
ap2_redis   | 1:M 30 Oct 2025 11:03:58.784 * Done loading RDB, keys loaded: 0, keys expired: 0.
ap2_redis   | 1:M 30 Oct 2025 11:03:58.784 * DB loaded from base file appendonly.aof.1.base.rdb: 0.001 seconds
ap2_redis   | 1:M 30 Oct 2025 11:03:58.788 * DB loaded from incr file appendonly.aof.1.incr.aof: 0.004 seconds
ap2_redis   | 1:M 30 Oct 2025 11:03:58.788 * DB loaded from append only file: 0.005 seconds
ap2_redis   | 1:M 30 Oct 2025 11:03:58.788 * Opening AOF incr file appendonly.aof.1.incr.aof on server start
ap2_redis   | 1:M 30 Oct 2025 11:03:58.788 * Ready to accept connections tcp
ap2_jaeger  | {"level":"info","ts":1761822238.783868,"caller":"app/server.go:286","msg":"Starting HTTP server","port":16686,"addr":":16686"}
ap2_jaeger  | {"level":"info","ts":1761822238.7931895,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #4 ListenSocket #7]ListenSocket created"}
ap2_meilisearch  |
ap2_meilisearch  | 888b     d888          d8b 888 d8b                                            888
ap2_meilisearch  | 8888b   d8888          Y8P 888 Y8P                                            888
ap2_meilisearch  | 88888b.d88888              888                                                888
ap2_meilisearch  | 888Y88888P888  .d88b.  888 888 888 .d8888b   .d88b.   8888b.  888d888 .d8888b 88888b.
ap2_meilisearch  | 888 Y888P 888 d8P  Y8b 888 888 888 88K      d8P  Y8b     "88b 888P"  d88P"    888 "88b
ap2_meilisearch  | 888  Y8P  888 88888888 888 888 888 "Y8888b. 88888888 .d888888 888    888      888  888
ap2_meilisearch  | 888   "   888 Y8b.     888 888 888      X88 Y8b.     888  888 888    Y88b.    888  888
ap2_meilisearch  | 888       888  "Y8888  888 888 888  88888P'  "Y8888  "Y888888 888     "Y8888P 888  888
ap2_meilisearch  |
ap2_meilisearch  | Config file path:    "none"
ap2_meilisearch  | Database path:               "./data.ms"
ap2_meilisearch  | Server listening on: "http://0.0.0.0:7700"
ap2_meilisearch  | Environment:         "development"
ap2_meilisearch  | Commit SHA:          "cfaac6f7ca55e91ec3cf40f8682f528cd8743562"
ap2_meilisearch  | Commit date:         "2024-11-14T15:55:14Z"
ap2_meilisearch  | Package version:     "1.11.3"
ap2_meilisearch  | Anonymous telemetry: "Disabled"
ap2_meilisearch  |
ap2_meilisearch  | A master key has been set. Requests to Meilisearch won't be authorized unless you provide an authentication key.
ap2_meilisearch  |
ap2_meilisearch  |
ap2_meilisearch  |  Meilisearch started with a master key considered unsafe for use in a production environment.
ap2_meilisearch  |
ap2_meilisearch  |  A master key of at least 16 bytes will be required when switching to a production environment.
ap2_meilisearch  |
ap2_meilisearch  |
ap2_meilisearch  | We generated a new secure master key for you (you can safely use this token):
ap2_meilisearch  |
ap2_meilisearch  | >> --master-key EF11wzt0c8AWSEStlwu81Paw4rB1aNo3WI22QV0ZLHA <<
ap2_meilisearch  |
ap2_meilisearch  | Restart Meilisearch with the argument above to use this new and secure master key.
ap2_meilisearch  |
ap2_meilisearch  | Check out Meilisearch Cloud! https://www.meilisearch.com/cloud?utm_campaign=oss&utm_source=engine&utm_medium=cli
ap2_meilisearch  | Documentation:                       https://www.meilisearch.com/docs
ap2_meilisearch  | Source code:                 https://github.com/meilisearch/meilisearch
ap2_meilisearch  | Discord:                     https://discord.meilisearch.com
ap2_meilisearch  |
ap2_meilisearch  | 2025-10-30T11:03:58.819655Z  INFO actix_server::builder: starting 8 workers
ap2_meilisearch  | 2025-10-30T11:03:58.819798Z  INFO actix_server::server: Actix runtime found; starting in Actix runtime
ap2_init_keys    | ================================================================================
ap2_init_keys    | AP2 エージェント キーペア初期化
ap2_init_keys    | ================================================================================
ap2_init_keys    |
ap2_init_keys    | キー保存先: /app/v2/keys
ap2_init_keys    | DID Document保存先: /app/v2/data/did_documents
ap2_init_keys    |
ap2_init_keys    | [Shopping Agent]
ap2_init_keys    |   ℹ️  既存の鍵とDID Documentが見つかりました（スキップ）
ap2_init_keys    |      DID: did:ap2:agent:shopping_agent
ap2_init_keys    |
ap2_init_keys    | [Merchant Agent]
ap2_init_keys    |   ℹ️  既存の鍵とDID Documentが見つかりました（スキップ）
ap2_init_keys    |      DID: did:ap2:agent:merchant_agent
ap2_init_keys    |
ap2_init_keys    | [Merchant]
ap2_init_keys    |   ℹ️  既存の鍵とDID Documentが見つかりました（スキップ）
ap2_init_keys    |      DID: did:ap2:merchant:mugibo_merchant
ap2_init_keys    |
ap2_init_keys    | [Credential Provider]
ap2_init_keys    |   ℹ️  既存の鍵とDID Documentが見つかりました（スキップ）
ap2_init_keys    |      DID: did:ap2:cp:demo_cp
ap2_init_keys    |
ap2_init_keys    | [Credential Provider 2]
ap2_init_keys    |   ℹ️  既存の鍵とDID Documentが見つかりました（スキップ）
ap2_init_keys    |      DID: did:ap2:cp:demo_cp_2
ap2_init_keys    |
ap2_init_keys    | [Payment Processor]
ap2_init_keys    |   ℹ️  既存の鍵とDID Documentが見つかりました（スキップ）
ap2_init_keys    |      DID: did:ap2:agent:payment_processor
ap2_init_keys    |
ap2_init_keys    | ================================================================================
ap2_init_keys    | ✅ 全エージェントの初期化が完了しました
ap2_init_keys    | ================================================================================
ap2_init_keys    |
ap2_init_keys    | 次のステップ:
ap2_init_keys    |   1. docker-compose up -d でサービスを起動
ap2_init_keys    |   2. 各エージェントはキーを永続化ストレージから読み込みます
ap2_init_keys    |   3. DIDは再起動後も一貫して維持されます
ap2_init_keys    |
ap2_init_keys exited with code 0
ap2_init_seeds   | ================================================================================
ap2_init_seeds   | AP2 シードデータ投入 (AP2完全準拠)
ap2_init_seeds   | ================================================================================
ap2_init_seeds   |
ap2_init_seeds   | データ保存先: /app/v2/data
ap2_init_seeds   |
ap2_init_seeds   | AP2完全準拠のため、以下のデータのみ投入します：
ap2_init_seeds   |   ✅ 商品データ: Merchantが管理
ap2_init_seeds   |   ⚠️  ユーザーデータ: Passkey登録時に自動作成（フロントエンド）
ap2_init_seeds   |   ⚠️  支払い方法: Passkey登録後、ユーザーが登録（セキュリティ要件）
ap2_init_seeds   |
ap2_init_seeds   | [商品データ投入]
ap2_init_seeds   | データベース: sqlite+aiosqlite:////app/v2/data/merchant_agent.db
ap2_init_seeds   |   ℹ️  既存の商品データが見つかりました（28件、スキップ）
ap2_init_seeds   |
ap2_init_seeds   | ================================================================================
ap2_init_seeds   | ✅ 商品データの投入が完了しました (AP2完全準拠)
ap2_init_seeds   | ================================================================================
ap2_init_seeds   |
ap2_init_seeds   | 投入データサマリ:
ap2_init_seeds   |   - 商品: 28件 (merchant_agent.db)
ap2_init_seeds   |
ap2_init_seeds   | 次のステップ:
ap2_init_seeds   |   1. フロントエンド (http://localhost:3000) にアクセス
ap2_init_seeds   |   2. ユーザー登録 (/auth/register)
ap2_init_seeds   |   3. Passkey登録 (/auth/register-passkey)
ap2_init_seeds   |   4. 支払い方法登録（Passkey登録後に自動表示）
ap2_init_seeds   |
ap2_init_seeds exited with code 0
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.543134Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.544222Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: merchant_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.544297Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: search_products", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.544323Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: check_inventory", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.544353Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_cart_mandates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.737590Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.737993Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: merchant_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.738096Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: search_products", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.738133Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: check_inventory", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.738157Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_cart_mandates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | INFO:     Started server process [1]
ap2_merchant_agent_mcp  | INFO:     Waiting for application startup.
ap2_merchant_agent_mcp  | INFO:     Application startup complete.
ap2_merchant_agent_mcp  | INFO:     Uvicorn running on http://0.0.0.0:8011 (Press CTRL+C to quit)
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.881314Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: shopping_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.881737Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_intent_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.881791Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: request_cart_candidates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.881826Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: select_and_sign_cart", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.881916Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: assess_payment_risk", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.882148Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_payment_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:03.882203Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: execute_payment", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035619Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: shopping_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035708Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_intent_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035736Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: request_cart_candidates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035754Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: select_and_sign_cart", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035769Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: assess_payment_risk", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035783Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_payment_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.035795Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: execute_payment", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.039732Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Starting up...", "module": "main", "function": "lifespan", "line": 404}
ap2_shopping_agent_mcp  | INFO:     Started server process [1]
ap2_shopping_agent_mcp  | INFO:     Waiting for application startup.
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.056357Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Database initialized", "module": "main", "function": "lifespan", "line": 408}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.067113Z", "level": "INFO", "logger": "main", "message": "[Startup] KeyManager initialized with keys_directory=/app/v2/keys", "module": "main", "function": "lifespan", "line": 415}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.067160Z", "level": "INFO", "logger": "main", "message": "[Startup] Extracted key_id=shopping_agent from AGENT_ID=did:ap2:agent:shopping_agent", "module": "main", "function": "lifespan", "line": 419}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.067181Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.080446Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.080747Z", "level": "INFO", "logger": "main", "message": "[Startup] ED25519 private key loaded for shopping_agent", "module": "main", "function": "lifespan", "line": 425}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.080790Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.089375Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.089504Z", "level": "INFO", "logger": "main", "message": "[Startup] ECDSA private key loaded for shopping_agent", "module": "main", "function": "lifespan", "line": 433}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.089548Z", "level": "INFO", "logger": "main", "message": "[Startup] SignatureManager initialized", "module": "main", "function": "lifespan", "line": 443}
ap2_shopping_agent_mcp  | INFO:     Application startup complete.
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.093496Z", "level": "INFO", "logger": "main", "message": "[Startup] A2AMessageHandler initialized with key_id: shopping_agent", "module": "main", "function": "lifespan", "line": 451}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.093578Z", "level": "INFO", "logger": "main", "message": "[Startup] RiskAssessmentEngine initialized", "module": "main", "function": "lifespan", "line": 455}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T11:04:04.093621Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Startup complete", "module": "main", "function": "lifespan", "line": 457}
ap2_shopping_agent_mcp  | INFO:     Uvicorn running on http://0.0.0.0:8010 (Press CTRL+C to quit)
ap2_merchant            | [2025-10-30 11:04:05,008] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_merchant            | [2025-10-30 11:04:05,009] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_merchant            |   Service Name: merchant
ap2_merchant            |   OTLP Endpoint: http://jaeger:4317
ap2_merchant            |   Insecure: True
ap2_merchant            | [2025-10-30 11:04:05,039] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: merchant
ap2_merchant            | [2025-10-30 11:04:05,040] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 11:04:05,040] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | [2025-10-30 11:04:05,040] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 11:04:05,040] INFO in v2.common.base_agent: [Merchant] OpenTelemetry distributed tracing enabled (service: merchant, manual instrumentation only)
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.061473Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 11:04:05,071] INFO in v2.common.base_agent: [Merchant] ✓ ECDSA鍵を読み込みました: merchant
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.071732Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.071908Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.075189Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | [2025-10-30 11:04:05,075] INFO in v2.common.base_agent: [Merchant] ✓ Ed25519鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 11:04:05,075] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant            | [2025-10-30 11:04:05,078] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 11:04:05,078] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant            | [2025-10-30 11:04:05,079] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant            | [2025-10-30 11:04:05,079] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant            | [2025-10-30 11:04:05,080] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant            | [2025-10-30 11:04:05,081] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant            | [2025-10-30 11:04:05,083] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | [2025-10-30 11:04:05,083] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant            | [2025-10-30 11:04:05,085] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant            | [2025-10-30 11:04:05,085] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant            | [2025-10-30 11:04:05,087] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.087917Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | [2025-10-30 11:04:05,095] INFO in v2.common.base_agent: [Merchant] Initialized: did:ap2:merchant
ap2_payment_processor   | [2025-10-30 11:04:05,140] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_payment_processor   | [2025-10-30 11:04:05,140] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_payment_processor   |   Service Name: payment_processor
ap2_payment_processor   |   OTLP Endpoint: http://jaeger:4317
ap2_payment_processor   |   Insecure: True
ap2_shopping_agent      | [2025-10-30 11:04:05,167] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_shopping_agent      | [2025-10-30 11:04:05,167] INFO in v2.common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_shopping_agent      |   Service Name: shopping_agent
ap2_shopping_agent      |   OTLP Endpoint: http://jaeger:4317
ap2_shopping_agent      |   Insecure: True
ap2_payment_processor   | [2025-10-30 11:04:05,177] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: payment_processor
ap2_payment_processor   | [2025-10-30 11:04:05,177] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 11:04:05,177] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 11:04:05,180] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 11:04:05,180] INFO in v2.common.base_agent: [Payment Processor] OpenTelemetry distributed tracing enabled (service: payment_processor, manual instrumentation only)
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.189068Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.195822Z", "level": "INFO", "logger": "service", "message": "[Merchant] Initialized", "module": "service", "function": "__init__", "line": 118}
ap2_shopping_agent      | [2025-10-30 11:04:05,195] INFO in v2.common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: shopping_agent
ap2_shopping_agent      | [2025-10-30 11:04:05,195] INFO in v2.common.base_agent: [Shopping Agent] OpenTelemetry distributed tracing enabled (service: shopping_agent, manual instrumentation only)
ap2_merchant            | [2025-10-30 11:04:05,196] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_payment_processor   | [2025-10-30 11:04:05,204] INFO in v2.common.base_agent: [Payment Processor] ✓ ECDSA鍵を読み込みました: payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.204665Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.204800Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.209244Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 11:04:05,209] INFO in v2.common.base_agent: [Payment Processor] ✓ Ed25519鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 11:04:05,209] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.209655Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | [2025-10-30 11:04:05,212] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor   | [2025-10-30 11:04:05,212] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,215] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor   | [2025-10-30 11:04:05,215] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,217] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor   | [2025-10-30 11:04:05,217] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,218] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor   | [2025-10-30 11:04:05,218] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,220] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor   | [2025-10-30 11:04:05,220] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,220] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.220768Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.223898Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.224043Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | [2025-10-30 11:04:05,223] INFO in v2.common.base_agent: [Shopping Agent] ✓ ECDSA鍵を読み込みました: shopping_agent
ap2_payment_processor   | [2025-10-30 11:04:05,226] INFO in v2.common.base_agent: [Payment Processor] Initialized: did:ap2:agent:payment_processor
ap2_shopping_agent      | [2025-10-30 11:04:05,232] INFO in v2.common.base_agent: [Shopping Agent] ✓ Ed25519鍵を読み込みました: shopping_agent
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.232740Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | [2025-10-30 11:04:05,232] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent      | [2025-10-30 11:04:05,236] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_shopping_agent      | [2025-10-30 11:04:05,237] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_shopping_agent      | [2025-10-30 11:04:05,239] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_shopping_agent      | [2025-10-30 11:04:05,240] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_shopping_agent      | [2025-10-30 11:04:05,242] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_shopping_agent      | [2025-10-30 11:04:05,243] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_shopping_agent      | [2025-10-30 11:04:05,244] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_shopping_agent      | [2025-10-30 11:04:05,244] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_shopping_agent      | [2025-10-30 11:04:05,245] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_shopping_agent      | [2025-10-30 11:04:05,246] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_shopping_agent      | [2025-10-30 11:04:05,247] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.247467Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.247535Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.ProductList", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:05.247555Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.SignatureResponse", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | [2025-10-30 11:04:05,268] INFO in v2.common.base_agent: [Shopping Agent] Initialized: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 11:04:05,351] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 11:04:05,351] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | [2025-10-30 11:04:05,352] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 11:04:05,353] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 11:04:05,353] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.355108Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 11:04:05,354] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 11:04:05,355] INFO in v2.common.base_agent: [Merchant] OpenTelemetry distributed tracing enabled (service: merchant, manual instrumentation only)
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.363565Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.363677Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 11:04:05,363] INFO in v2.common.base_agent: [Merchant] ✓ ECDSA鍵を読み込みました: merchant
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.367278Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | [2025-10-30 11:04:05,367] INFO in v2.common.base_agent: [Merchant] ✓ Ed25519鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 11:04:05,367] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant            | [2025-10-30 11:04:05,367] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 11:04:05,367] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant            | [2025-10-30 11:04:05,376] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant            | [2025-10-30 11:04:05,376] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant            | [2025-10-30 11:04:05,383] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant            | [2025-10-30 11:04:05,383] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant            | [2025-10-30 11:04:05,387] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | [2025-10-30 11:04:05,387] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant            | [2025-10-30 11:04:05,388] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant            | [2025-10-30 11:04:05,388] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.392263Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | [2025-10-30 11:04:05,392] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant            | [2025-10-30 11:04:05,402] INFO in v2.common.base_agent: [Merchant] Initialized: did:ap2:merchant
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.402961Z", "level": "INFO", "logger": "service", "message": "[Merchant] Initialized", "module": "service", "function": "__init__", "line": 118}
ap2_merchant            | [2025-10-30 11:04:05,403] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_merchant            | INFO:     Started server process [1]
ap2_merchant            | INFO:     Waiting for application startup.
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.403483Z", "level": "INFO", "logger": "service", "message": "[Merchant] Running startup tasks...", "module": "service", "function": "startup_event", "line": 102}
ap2_shopping_agent      | [2025-10-30 11:04:05,409] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Initialized (database_mode=enabled)
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.414388Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Initialized", "module": "processor", "function": "__init__", "line": 102}
ap2_payment_processor   | [2025-10-30 11:04:05,414] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.427861Z", "level": "INFO", "logger": "service", "message": "[Merchant] Database initialized", "module": "service", "function": "startup_event", "line": 106}
ap2_merchant            |
ap2_merchant            | ============================================================
ap2_merchant            | 商品データ投入中...
ap2_merchant            | ============================================================
ap2_merchant            |   ⏭️  スキップ: むぎぼーアクリルキーホルダー (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼー時計 (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーカレンダー (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーマグカップ (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーステッカー (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーTシャツ (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼートートバッグ (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーポーチ (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーぬいぐるみ（S） (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーぬいぐるみ（L） (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーキャップ (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼークッション (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーノート (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーボールペン (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーウォーターボトル (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼー靴下 (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーマウスパッド (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼースマホケース (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼー折りたたみ傘 (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーエコバッグ (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーブランケット (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼープレート皿 (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーパーカー (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーフェイスタオル (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーアロマキャンドル (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼー抱き枕 (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーポスター (既存)
ap2_merchant            |   ⏭️  スキップ: むぎぼーニット帽 (既存)
ap2_merchant            |
ap2_merchant            | ✅ 商品データ投入完了 (28件)
ap2_merchant            |
ap2_merchant            | ============================================================
ap2_merchant            | ユーザーデータ投入中...
ap2_merchant            | ============================================================
ap2_merchant            | {"timestamp": "2025-10-30T11:04:05.535370Z", "level": "WARNING", "logger": "service", "message": "[Merchant] Sample data seeding warning: (sqlite3.IntegrityError) NOT NULL constraint failed: users.hashed_password\n[SQL: INSERT INTO users (id, display_name, email, hashed_password, is_active, created_at) VALUES (?, ?, ?, ?, ?, ?)]\n[parameters: ('user_demo_001', '山田太郎', 'yamada@example.com', None, 1, '2025-10-30 11:04:05.530910')]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "service", "function": "startup_event", "line": 116}
ap2_merchant            | INFO:     Application startup complete.
ap2_merchant            | INFO:     Uvicorn running on http://0.0.0.0:8002 (Press CTRL+C to quit)
ap2_payment_processor   | [2025-10-30 11:04:05,639] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 11:04:05,640] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 11:04:05,640] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 11:04:05,643] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 11:04:05,643] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 11:04:05,645] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 11:04:05,645] INFO in v2.common.base_agent: [Payment Processor] OpenTelemetry distributed tracing enabled (service: payment_processor, manual instrumentation only)
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.645813Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.672710Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 11:04:05,672] INFO in v2.common.base_agent: [Payment Processor] ✓ ECDSA鍵を読み込みました: payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.672989Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.734849Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 11:04:05,735] INFO in v2.common.base_agent: [Payment Processor] ✓ Ed25519鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 11:04:05,744] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,758] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor   | [2025-10-30 11:04:05,758] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,759] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor   | [2025-10-30 11:04:05,759] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,760] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor   | [2025-10-30 11:04:05,760] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,761] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor   | [2025-10-30 11:04:05,761] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,770] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor   | [2025-10-30 11:04:05,771] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor   | [2025-10-30 11:04:05,777] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.777229Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_payment_processor   | [2025-10-30 11:04:05,792] INFO in v2.common.base_agent: [Payment Processor] Initialized: did:ap2:agent:payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.802139Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Initialized", "module": "processor", "function": "__init__", "line": 102}
ap2_payment_processor   | [2025-10-30 11:04:05,802] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_payment_processor   | INFO:     Started server process [1]
ap2_payment_processor   | INFO:     Waiting for application startup.
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.807760Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Running startup tasks...", "module": "processor", "function": "startup_event", "line": 96}
ap2_payment_processor   | {"timestamp": "2025-10-30T11:04:05.842365Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Database initialized", "module": "processor", "function": "startup_event", "line": 100}
ap2_payment_processor   | INFO:     Application startup complete.
ap2_payment_processor   | INFO:     Uvicorn running on http://0.0.0.0:8004 (Press CTRL+C to quit)
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.735007Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Tracing enabled", "module": "langgraph_merchant", "function": "<module>", "line": 83}
ap2_merchant_agent      | [2025-10-30 11:04:06,743] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant_agent      | [2025-10-30 11:04:06,743] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant_agent'. Adding OTLP exporter to existing provider.
ap2_merchant_agent      | [2025-10-30 11:04:06,763] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant_agent      | [2025-10-30 11:04:06,763] INFO in v2.common.base_agent: [Merchant Agent] OpenTelemetry distributed tracing enabled (service: merchant_agent, manual instrumentation only)
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.818062Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent      | [2025-10-30 11:04:06,828] INFO in v2.common.base_agent: [Merchant Agent] ✓ ECDSA鍵を読み込みました: merchant_agent
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.828225Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.828348Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.830211Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent      | [2025-10-30 11:04:06,830] INFO in v2.common.base_agent: [Merchant Agent] ✓ Ed25519鍵を読み込みました: merchant_agent
ap2_merchant_agent      | [2025-10-30 11:04:06,830] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,832] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant_agent      | [2025-10-30 11:04:06,832] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,834] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent      | [2025-10-30 11:04:06,834] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,836] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent      | [2025-10-30 11:04:06,836] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,836] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant_agent      | [2025-10-30 11:04:06,836] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,839] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant_agent      | [2025-10-30 11:04:06,839] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,840] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.840784Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.IntentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.840846Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.ProductSearch", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.840890Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.840932Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartSelection", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.840951Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | [2025-10-30 11:04:06,848] INFO in v2.common.base_agent: [Merchant Agent] Initialized: did:ap2:agent:merchant_agent
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.876899Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Initialized (AI Mode: True)", "module": "agent", "function": "__init__", "line": 163}
ap2_merchant_agent      | [2025-10-30 11:04:06,938] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant_agent      | [2025-10-30 11:04:06,938] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant_agent'. Adding OTLP exporter to existing provider.
ap2_merchant_agent      | [2025-10-30 11:04:06,939] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant_agent      | [2025-10-30 11:04:06,939] INFO in v2.common.base_agent: [Merchant Agent] OpenTelemetry distributed tracing enabled (service: merchant_agent, manual instrumentation only)
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.939220Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.939802Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.939848Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent      | [2025-10-30 11:04:06,939] INFO in v2.common.base_agent: [Merchant Agent] ✓ ECDSA鍵を読み込みました: merchant_agent
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.940318Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent      | [2025-10-30 11:04:06,940] INFO in v2.common.base_agent: [Merchant Agent] ✓ Ed25519鍵を読み込みました: merchant_agent
ap2_merchant_agent      | [2025-10-30 11:04:06,940] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,940] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant_agent      | [2025-10-30 11:04:06,940] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,940] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent      | [2025-10-30 11:04:06,940] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,941] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent      | [2025-10-30 11:04:06,941] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,941] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant_agent      | [2025-10-30 11:04:06,941] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,941] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant_agent      | [2025-10-30 11:04:06,941] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent      | [2025-10-30 11:04:06,942] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.942082Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.IntentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.942100Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.ProductSearch", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.942110Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.942122Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartSelection", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.942130Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent      | [2025-10-30 11:04:06,944] INFO in v2.common.base_agent: [Merchant Agent] Initialized: did:ap2:agent:merchant_agent
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.965449Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Initialized (AI Mode: True)", "module": "agent", "function": "__init__", "line": 163}
ap2_merchant_agent      | INFO:     Started server process [1]
ap2_merchant_agent      | INFO:     Waiting for application startup.
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.965807Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Running startup tasks...", "module": "agent", "function": "startup_event", "line": 111}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:06.975951Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Database initialized", "module": "agent", "function": "startup_event", "line": 115}
ap2_merchant_agent      |
ap2_merchant_agent      | ============================================================
ap2_merchant_agent      | 商品データ投入中...
ap2_merchant_agent      | ============================================================
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーアクリルキーホルダー (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼー時計 (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーカレンダー (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーマグカップ (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーステッカー (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーTシャツ (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼートートバッグ (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーポーチ (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーぬいぐるみ（S） (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーぬいぐるみ（L） (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーキャップ (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼークッション (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーノート (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーボールペン (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーウォーターボトル (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼー靴下 (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーマウスパッド (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼースマホケース (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼー折りたたみ傘 (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーエコバッグ (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーブランケット (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼープレート皿 (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーパーカー (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーフェイスタオル (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーアロマキャンドル (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼー抱き枕 (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーポスター (既存)
ap2_merchant_agent      |   ⏭️  スキップ: むぎぼーニット帽 (既存)
ap2_merchant_agent      |
ap2_merchant_agent      | ✅ 商品データ投入完了 (28件)
ap2_merchant_agent      |
ap2_merchant_agent      | ============================================================
ap2_merchant_agent      | ユーザーデータ投入中...
ap2_merchant_agent      | ============================================================
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.038599Z", "level": "WARNING", "logger": "agent", "message": "[Merchant Agent] Sample data seeding warning: (sqlite3.IntegrityError) NOT NULL constraint failed: users.hashed_password\n[SQL: INSERT INTO users (id, display_name, email, hashed_password, is_active, created_at) VALUES (?, ?, ?, ?, ?, ?)]\n[parameters: ('user_demo_001', '山田太郎', 'yamada@example.com', None, 1, '2025-10-30 11:04:07.036406')]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "agent", "function": "startup_event", "line": 123}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.038866Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_shopping_agent      | [2025-10-30 11:04:07,056] INFO in services.shopping_agent.langgraph_shopping_flow: [Langfuse] Shopping Agent tracing enabled
ap2_meilisearch         | 2025-10-30T11:04:07.098656Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=8.00ms time.idle=5.49ms
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.100511Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Index already exists: products", "module": "search_engine", "function": "create_index", "line": 65}
ap2_meilisearch         | 2025-10-30T11:04:07.101149Z ERROR index_scheduler: Batch failed Index `products` already exists.
ap2_meilisearch         | 2025-10-30T11:04:07.142757Z  INFO HTTP request{method=PATCH host="meilisearch:7700" route=/indexes/products/settings query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=613µs time.idle=1.52ms
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.143548Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Index configured: products", "module": "search_engine", "function": "configure_index", "line": 115}
ap2_meilisearch         | 2025-10-30T11:04:07.147497Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_meilisearch         | 2025-10-30T11:04:07.154315Z  INFO HTTP request{method=DELETE host="meilisearch:7700" route=/indexes/products/documents query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=313µs time.idle=2.04ms
ap2_meilisearch         | 2025-10-30T11:04:07.156147Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.155018Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Cleared index: products", "module": "search_engine", "function": "clear_index", "line": 239}
ap2_meilisearch         | 2025-10-30T11:04:07.169219Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/documents query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=1.39ms time.idle=1.35ms
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.169813Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Added 28 documents, taskUid=103", "module": "search_engine", "function": "add_documents", "line": 144}
ap2_merchant_agent      | [2025-10-30 11:04:07,170] INFO in utils.product_helpers: [_sync_products_to_meilisearch] Synced 28 products to Meilisearch
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.171558Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Meilisearch synchronized", "module": "agent", "function": "startup_event", "line": 129}
ap2_shopping_agent      | [2025-10-30 11:04:07,392] INFO in services.shopping_agent.langgraph_shopping_flow: [LangGraph Shopping Flow] LLM initialized: ai/qwen3 at http://host.docker.internal:12434/engines/llama.cpp/v1
ap2_shopping_agent      | [2025-10-30 11:04:07,397] INFO in services.shopping_agent.langgraph_shopping_flow: [create_shopping_flow_graph] LangGraph shopping flow compiled successfully (14 nodes, AP2 compliant, with checkpointer for trace continuity)
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.397590Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] LangGraph shopping flow graph initialized successfully (12 nodes)", "module": "agent", "function": "__init__", "line": 240}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.397678Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Initialized with database-backed risk assessment", "module": "agent", "function": "__init__", "line": 267}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.453660Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[MerchantLangGraphAgent] LLM initialized with DMR: http://host.docker.internal:12434/engines/llama.cpp/v1, model: ai/qwen3", "module": "langgraph_merchant", "function": "__init__", "line": 178}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.455083Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Initialized: http://merchant_agent_mcp:8011", "module": "mcp_client", "function": "__init__", "line": 65}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.457312Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[MerchantLangGraphAgent] Initialized with LLM: ai/qwen3, MCP: http://merchant_agent_mcp:8011", "module": "langgraph_merchant", "function": "__init__", "line": 196}
ap2_merchant_agent      | {"timestamp": "2025-10-30T11:04:07.457360Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] LangGraph AI engine initialized", "module": "agent", "function": "startup_event", "line": 143}
ap2_merchant_agent      | INFO:     Application startup complete.
ap2_merchant_agent      | INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
ap2_shopping_agent      | [2025-10-30 11:04:07,459] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_shopping_agent      | [2025-10-30 11:04:07,459] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='shopping_agent'. Adding OTLP exporter to existing provider.
ap2_shopping_agent      | [2025-10-30 11:04:07,459] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_shopping_agent      | [2025-10-30 11:04:07,459] INFO in v2.common.base_agent: [Shopping Agent] OpenTelemetry distributed tracing enabled (service: shopping_agent, manual instrumentation only)
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.460030Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | [2025-10-30 11:04:07,461] INFO in v2.common.base_agent: [Shopping Agent] ✓ ECDSA鍵を読み込みました: shopping_agent
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.461032Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.461085Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.461688Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | [2025-10-30 11:04:07,461] INFO in v2.common.base_agent: [Shopping Agent] ✓ Ed25519鍵を読み込みました: shopping_agent
ap2_shopping_agent      | [2025-10-30 11:04:07,461] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent      | [2025-10-30 11:04:07,463] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_shopping_agent      | [2025-10-30 11:04:07,463] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_shopping_agent      | [2025-10-30 11:04:07,465] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_shopping_agent      | [2025-10-30 11:04:07,465] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_shopping_agent      | [2025-10-30 11:04:07,469] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_shopping_agent      | [2025-10-30 11:04:07,469] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_shopping_agent      | [2025-10-30 11:04:07,471] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_shopping_agent      | [2025-10-30 11:04:07,471] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_shopping_agent      | [2025-10-30 11:04:07,471] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_shopping_agent      | [2025-10-30 11:04:07,471] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_shopping_agent      | [2025-10-30 11:04:07,474] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.474489Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.474531Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.ProductList", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.474543Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.SignatureResponse", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | [2025-10-30 11:04:07,482] INFO in v2.common.base_agent: [Shopping Agent] Initialized: did:ap2:agent:shopping_agent
ap2_shopping_agent      | [2025-10-30 11:04:07,488] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Initialized (database_mode=enabled)
ap2_shopping_agent      | [2025-10-30 11:04:07,488] INFO in services.shopping_agent.langgraph_shopping_flow: [LangGraph Shopping Flow] LLM initialized: ai/qwen3 at http://host.docker.internal:12434/engines/llama.cpp/v1
ap2_shopping_agent      | [2025-10-30 11:04:07,491] INFO in services.shopping_agent.langgraph_shopping_flow: [create_shopping_flow_graph] LangGraph shopping flow compiled successfully (14 nodes, AP2 compliant, with checkpointer for trace continuity)
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.491975Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] LangGraph shopping flow graph initialized successfully (12 nodes)", "module": "agent", "function": "__init__", "line": 240}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.492045Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Initialized with database-backed risk assessment", "module": "agent", "function": "__init__", "line": 267}
ap2_shopping_agent      | INFO:     Started server process [1]
ap2_shopping_agent      | INFO:     Waiting for application startup.
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.492391Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Running startup tasks...", "module": "agent", "function": "startup_event", "line": 261}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:07.506352Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Database initialized", "module": "agent", "function": "startup_event", "line": 265}
ap2_shopping_agent      | INFO:     Application startup complete.
ap2_shopping_agent      | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
ap2_meilisearch         | 2025-10-30T11:04:08.277363Z  INFO index_scheduler::batch: document indexing done indexing_result=DocumentAdditionResult { indexed_documents: 28, number_of_documents: 28 } processed_in=1.108382375s
ap2_meilisearch         | 2025-10-30T11:04:08.280224Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_payment_network     | [2025-10-30 11:04:12,326] INFO in network: [DemoPaymentNetwork] Payment Network Service initialized
ap2_payment_network     |   Redis URL: redis://redis:6379/2
ap2_payment_network     |   Token Store: RedisベースのKVストア（TTL管理対応）
ap2_payment_network     | [2025-10-30 11:04:12,561] INFO in network: [DemoPaymentNetwork] Payment Network Service initialized
ap2_payment_network     |   Redis URL: redis://redis:6379/2
ap2_payment_network     |   Token Store: RedisベースのKVストア（TTL管理対応）
ap2_payment_network     | INFO:     Started server process [1]
ap2_payment_network     | INFO:     Waiting for application startup.
ap2_payment_network     | INFO:     Application startup complete.
ap2_payment_network     | INFO:     Uvicorn running on http://0.0.0.0:8005 (Press CTRL+C to quit)
ap2_frontend            |    ▲ Next.js 15.5.5
ap2_frontend            |    - Local:        http://localhost:3000
ap2_frontend            |    - Network:      http://0.0.0.0:3000
ap2_frontend            |
ap2_frontend            |  ✓ Starting...
ap2_frontend            |  ✓ Ready in 404ms
ap2_shopping_agent      | INFO:     172.67.69.85:16616 - "OPTIONS /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:15.969522Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:15.979268Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: あ\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent      | INFO:     172.67.69.85:16616 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:16.078665Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Created new session in DB: session_1761822253905_ms7its", "module": "agent", "function": "_get_or_create_session", "line": 1949}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:16.080160Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent      | {"timestamp": "2025-10-30T11:04:16.082415Z", "level": "INFO", "logger": "agent", "message": "[Langfuse] Created new handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1642}
ap2_shopping_agent      | [2025-10-30 11:04:16,097] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent      |   current_step: initial
ap2_shopping_agent      |   user_input: あ
ap2_shopping_agent      |   is_step_up_completion: False
ap2_credential_provider  | [2025-10-30 11:04:16,233] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_credential_provider  | [2025-10-30 11:04:16,233] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_credential_provider  |   Service Name: credential_provider
ap2_credential_provider  |   OTLP Endpoint: http://jaeger:4317
ap2_credential_provider  |   Insecure: True
ap2_credential_provider_2  | [2025-10-30 11:04:16,262] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_credential_provider_2  | [2025-10-30 11:04:16,263] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_credential_provider_2  |   Service Name: credential_provider_2
ap2_credential_provider_2  |   OTLP Endpoint: http://jaeger:4317
ap2_credential_provider_2  |   Insecure: True
ap2_credential_provider_2  | [2025-10-30 11:04:16,301] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: credential_provider_2
ap2_credential_provider    | [2025-10-30 11:04:16,301] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: credential_provider
ap2_credential_provider    | [2025-10-30 11:04:16,303] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 11:04:16,304] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider    | [2025-10-30 11:04:16,305] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 11:04:16,305] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider, manual instrumentation only)

ap2_credential_provider_2  | [2025-10-30 11:04:16,304] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 11:04:16,304] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 11:04:16,305] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 11:04:16,306] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider_2, manual instrumentation only)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.391271Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.395278Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | [2025-10-30 11:04:16,407] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.407214Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.407376Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.407345Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.407532Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | [2025-10-30 11:04:16,407] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.414847Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 11:04:16,414] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider_2  | [2025-10-30 11:04:16,415] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,417] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider_2  | [2025-10-30 11:04:16,417] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,418] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent

ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.414702Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 11:04:16,414] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 11:04:16,414] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,417] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider    | [2025-10-30 11:04:16,417] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,418] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider_2  | [2025-10-30 11:04:16,419] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,420] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider    | [2025-10-30 11:04:16,418] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,420] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider_2  | [2025-10-30 11:04:16,422] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider_2  | [2025-10-30 11:04:16,422] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,425] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider_2  | [2025-10-30 11:04:16,425] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,428] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.428712Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.428800Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 11:04:16,442] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider    | [2025-10-30 11:04:16,420] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,421] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider    | [2025-10-30 11:04:16,421] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,423] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 11:04:16,423] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,425] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.426015Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.426060Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | [2025-10-30 11:04:16,441] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.636313Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider_2  | [2025-10-30 11:04:16,636] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.636904Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider    | [2025-10-30 11:04:16,637] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider    | [2025-10-30 11:04:16,761] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 11:04:16,761] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider    | [2025-10-30 11:04:16,763] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 11:04:16,763] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 11:04:16,764] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 11:04:16,763] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 11:04:16,763] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 11:04:16,765] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 11:04:16,765] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 11:04:16,765] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 11:04:16,767] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 11:04:16,767] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider_2, manual instrumentation only)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.767582Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.768694Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.768772Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | [2025-10-30 11:04:16,768] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.773402Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}


ap2_credential_provider    | [2025-10-30 11:04:16,766] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 11:04:16,766] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider, manual instrumentation only)
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.766467Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.769141Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 11:04:16,773] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider

ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.769483Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}




ap2_credential_provider    | [2025-10-30 11:04:16,769] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | [2025-10-30 11:04:16,774] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,776] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider    | [2025-10-30 11:04:16,773] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 11:04:16,774] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.773222Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 11:04:16,776] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,776] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider    | [2025-10-30 11:04:16,776] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,777] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider    | [2025-10-30 11:04:16,777] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,778] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider    | [2025-10-30 11:04:16,778] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,781] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider_2  | [2025-10-30 11:04:16,777] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider    | [2025-10-30 11:04:16,781] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,782] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 11:04:16,782] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider    | [2025-10-30 11:04:16,783] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider_2  | [2025-10-30 11:04:16,778] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider_2  | [2025-10-30 11:04:16,778] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json


ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.784085Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.784191Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 11:04:16,781] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider    | [2025-10-30 11:04:16,795] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider_2  | [2025-10-30 11:04:16,781] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,782] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider_2  | [2025-10-30 11:04:16,782] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | [2025-10-30 11:04:16,783] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.783817Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.783856Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 11:04:16,794] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.804563Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider_2  | [2025-10-30 11:04:16,804] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider_2  | INFO:     Started server process [1]
ap2_credential_pr
ap2_credential_provider    | [2025-10-30 11:04:16,807] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.808381Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Running startup tasks...", "module": "provider", "function": "startup_event", "line": 145}
ap2_credential_provider    | INFO:     Started server process [1]

ap2_credential_provider    | INFO:     Waiting for application startup.
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.806800Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.807832Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Running startup tasks...", "module": "provider", "function": "startup_event", "line": 145}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T11:04:16.832482Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Database initialized", "module": "provider", "function": "startup_event", "line": 149}
ap2_credential_provider_2  | INFO:     Application startup complete.
ap2_credential_provider    | {"timestamp": "2025-10-30T11:04:16.833063Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Database initialized", "module": "provider", "function": "startup_event", "line": 149}
ap2_credential_provider    | INFO:     Application startup complete.
ap2_credential_provider    | INFO:     Uvicorn running on http://0.0.0.0:8003 (Press CTRL+C to quit)
ap2_credential_provider_2  | INFO:     Uvicorn running on http://0.0.0.0:8003 (Press CTRL+C to quit)
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:18.602796Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:18.610726Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:22.963818Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:22.965117Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: かわいいグッズがほしい。5000円以内\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:43636 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:22.972122Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=ask_intent", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:22.972651Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:22.972977Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:04:22,990] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: ask_intent
ap2_shopping_agent         |   user_input: かわいいグッズがほしい。5000円以内
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 11:04:58,408] INFO in services.shopping_agent.langgraph_shopping_flow: [collect_intent_node] LLM result: {'intent': 'かわいいグッズ', 'max_amount': 5000, 'keywords': ['かわいい', 'グッズ']}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:58.410124Z", "level": "INFO", "logger": "agent", "message": "[_create_intent_mandate] Reconstructed intent: かわいいグッズ。5000円以内", "module": "agent", "function": "_create_intent_mandate", "line": 1731}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:58.410332Z", "level": "INFO", "logger": "agent", "message": "[_build_intent_mandate_from_session] Constructed natural_language_description: かわいいグッズ。5000円以内", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1789}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:58.410505Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] IntentMandate created (fallback mode): id=intent_beef923e, intent='かわいいグッズ...'", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1808}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:04:58.412269Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] User public key not available yet (will be provided by frontend): 公開鍵ファイルが見つかり ません: /app/v2/keys/usr_577b4cbdb15e4f5d_public.pem", "module": "agent", "function": "_create_intent_mandate", "line": 1742}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:00.187358Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:00.191074Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:07.476395Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:07.478255Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: {\"recipient\":\"あ\",\"postal_code\":\"あ\",\"city\":\"あ\",\"region\":\"あ\",\"address_line1\":\"あ\",\"country\":\"あ\"}\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:24563 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:07.482527Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=intent_complete_ask_shipping", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:07.482995Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:07.483109Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:05:07,490] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: intent_complete_ask_shipping
ap2_shopping_agent         |   user_input: {"recipient":"あ","postal_code":"あ","city":"あ","region":"あ","address_line1":"あ","country":"あ"}
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 11:05:07,805] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='{"recipient":"あ","postal_code":"あ","city":"あ","region":"あ","address_line1":" あ","country":"あ"}', session['step']='select_cp', is_digit=False
ap2_shopping_agent         | [2025-10-30 11:05:07,805] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-30 11:05:07,805] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-30 11:05:07,806] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: Presenting 2 Credential Providers to user
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:09.060867Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=select_cp", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:09.069424Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=select_cp", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.642792Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.643121Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: 1\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:24563 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.647606Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=select_cp", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.647992Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.648045Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:05:10,655] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: select_cp
ap2_shopping_agent         |   user_input: 1
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 11:05:10,657] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='1', session['step']='select_cp', is_digit=True
ap2_shopping_agent         | [2025-10-30 11:05:10,657] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-30 11:05:10,657] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-30 11:05:10,657] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: User selected Credential Provider
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP Name: AP2 Demo Credential Provider
ap2_shopping_agent         | [2025-10-30 11:05:10,870] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 6-7: Requesting payment methods from CP
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.870878Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment methods from Credential Provider (http://credential_provider:8003) for user: usr_577b4cbdb15e4f5d", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2276}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.871117Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: GET http://credential_provider:8003/payment-methods", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.871296Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"GET\", \"url\": \"http://credential_provider:8003/payment-methods\", \"headers\": {}, \"body\": null}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:05:10.952393Z", "level": "INFO", "logger": "provider", "message": "[get_payment_methods] Retrieved 2 payment methods for user: usr_577b4cbdb15e4f5d", "module": "provider", "function": "get_payment_methods", "line": 619}
ap2_credential_provider    | INFO:     172.18.0.8:41656 - "GET /payment-methods?user_id=usr_577b4cbdb15e4f5d HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.955584Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (84.43ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.955670Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:05:10 GMT\", \"server\": \"uvicorn\", \"content-length\": \"774\", \"content-type\": \"application/json\"}, \"body\": {\"user_id\": \"usr_577b4cbdb15e4f5d\", \"payment_methods\": [{\"type\": \"basic-card\", \"display_name\": \"Visaカード (****3333)\", \"brand\": \"Visa\", \"last4\": \"3333\", \"card_number\": \"1234567890123333\", \"cardholder_name\": \"YU OTSUBO\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\", \"cvv\": \"121\", \"billing_address\": {\"country\": \"JP\", \"postal_code\": \"111-1111\"}, \"requires_step_up\": false, \"id\": \"pm_1486a851\"}, {\"type\": \"basic-card\", \"display_name\": \"Amexカード (****1111)\", \"brand\": \"Amex\", \"last4\": \"1111\", \"card_number\": \"1111111111111111\", \"cardholder_name\": \"111\", \"expiry_month\": \"04\", \"expiry_year\": \"2027\", \"cvv\": \"124\", \"billing_address\": {\"country\": \"JP\", \"postal_code\": \"111-1111\"}, \"requires_step_up\": true, \"stepup_method\": \"3d_secure\", \"step_up_reason\": \"American Express requires additional authentication\", \"id\": \"pm_54832f24\"}]}, \"duration_ms\": 84.42568778991699}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:10.955738Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Retrieved 2 payment methods from Credential Provider", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2294}
ap2_shopping_agent         | [2025-10-30 11:05:10,955] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 7: Received 2 payment methods from CP
ap2_shopping_agent         |   Payment Methods: ['pm_1486a851', 'pm_54832f24']
ap2_shopping_agent         | [2025-10-30 11:05:11,159] INFO in services.shopping_agent.langgraph_shopping_flow: [fetch_carts_node] AP2 Step 8-12: Fetching cart candidates from Merchant Agent
ap2_shopping_agent         | [2025-10-30 11:05:11,160] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting cart candidates from Merchant Agent for IntentMandate: intent_beef923e
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.160789Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.164086Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 859, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_beef923e\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-30T11:04:58.409790Z\",\"id\":\"intent_beef923e\",\"intent_expiry\":\"2025-10-30T12:0", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.164141Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.171624Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.172023Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.mandates.IntentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.172072Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.IntentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"8f82153f-3b5e-4d4f-a7fd-16da58593b5c\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:05:11.160128Z\", \"nonce\": \"643224d31a8a28730f161347cf4a93b44008e3fc5c62d30ccb6f7ef7b2616e02\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"intent_mandate\": {\"id\": \"intent_beef923e\", \"type\": \"IntentMandate\", \"version\": \"0.2\", \"user_id\": \"usr_577b4cbdb15e4f5d\", \"natural_language_description\": \"かわいいグッズ。5000円以内\", \"user_cart_confirmation_required\": true, \"merchants\": null, \"skus\": null, \"requires_refundability\": false, \"intent_expiry\": \"2025-10-30T12:04:58.409790Z\", \"created_at\": \"2025-10-30T11:04:58.409790Z\", \"user_public_key\": null}, \"shipping_address\": {\"recipient\": \"あ\", \"postal_code\": \"あ\", \"city\": \"あ\", \"region\": \"あ\", \"address_line1\": \"あ\", \"country\": \"あ\"}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_shopping_agent         | [2025-10-30 11:05:11,172] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Intent A2A message created: message_id=8f82153f-3b5e-4d4f-a7fd-16da58593b5c, intent_mandate_id=intent_beef923e
ap2_shopping_agent         | [2025-10-30 11:05:11,172] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: 8f82153f-3b5e-4d4f-a7fd-16da58593b5c
ap2_shopping_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_shopping_agent         |   ペイロード: {
ap2_shopping_agent         |   "id": "intent_beef923e",
ap2_shopping_agent         |   "type": "IntentMandate",
ap2_shopping_agent         |   "version": "0.2",
ap2_shopping_agent         |   "user_id": "usr_577b4cbdb15e4f5d",
ap2_shopping_agent         |   "natural_language_description": "かわいいグッズ。5000円以内",
ap2_shopping_agent         |   "user_cart_confirmation_required": true,
ap2_shopping_agent         |   "merchants": null,

ap2_merchant_agent         | [2025-10-30 11:05:11,196] INFO in v2.common.base_agent:
ap2_shopping_agent         |   "skus": null,
ap2_merchant_agent         | ================================================================================
ap2_shopping_agent         |   "requires_refundability": false,
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message

ap2_shopping_agent         |   "created_at": "2025-10-30T11:04:58.409790Z",Z",
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent

ap2_shopping_agent         |   "user_public_key": null




ap2_merchant_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_shopping_agent         | }
ap2_shopping_agent         | ================================================================================

ap2_merchant_agent         | ================================================================================
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.173018Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent:8001/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.197271Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:shopping_agent: ap2.mandates.IntentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:05:11.173066Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent:8001/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"8f82153f-3b5e-4d4f-a7fd-16da58593b5c\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:05:11.160128Z\", \"nonce\": \"643224d31a8a28730f161347cf4a93b44008e3fc5c62d30ccb6f7ef7b2616e02\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"ODANKAUfnUOL5DqaSFIp1H7zZuJFa3rjPQUJqjxHAeTQA2TxB5u/GDJzAOe8Eiscj/D+HVak+N1+kyLMpdL5BQ==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQXRSRlkxZnFlRXdoSTNTVGlmc21OUzlHZHBUZzNnTGJ4L1FXcm5tQmRLSTQ9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:shopping_agent#key-2\", \"created\": \"2025-10-30T11:05:11.160128Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.IntentMandate\", \"id\": \"intent_beef923e\", \"payload\": {\"intent_mandate\": {\"id\": \"intent_beef923e\", \"type\": \"IntentMandate\", \"version\": \"0.2\", \"user_id\": \"usr_577b4cbdb15e4f5d\", \"natural_language_description\": \"かわいいグッズ。5000円以内\", \"user_cart_confirmation_required\": true, \"merchants\": null, \"skus\": null, \"requires_refundability\": false, \"intent_expiry\": \"2025-10-30T12:04:58.409790Z\", \"created_at\": \"2025-10-30T11:04:58.409790Z\", \"user_public_key\": null}, \"shipping_address\": {\"recipient\": \"あ\", \"postal_code\": \"あ\", \"city\": \"あ\", \"region\": \"あ\", \"address_line1\": \"あ\", \"country\": \"あ\"}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.197551Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.IntentMandate\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"8f82153f-3b5e-4d4f-a7fd-16da58593b5c\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:05:11.160128Z\", \"nonce\": \"643224d31a8a28730f161347cf4a93b44008e3fc5c62d30ccb6f7ef7b2616e02\", \"schema_version\": \"0.2\"}, \"payload\": {\"intent_mandate\": {\"id\": \"intent_beef923e\", \"type\": \"IntentMandate\", \"version\": \"0.2\", \"user_id\": \"usr_577b4cbdb15e4f5d\", \"natural_language_description\": \"かわいいグッズ。5000円以内\", \"user_cart_confirmation_required\": true, \"merchants\": null, \"skus\": null, \"requires_refundability\": false, \"intent_expiry\": \"2025-10-30T12:04:58.409790Z\", \"created_at\": \"2025-10-30T11:04:58.409790Z\", \"user_public_key\": null}, \"shipping_address\": {\"recipient\": \"あ\", \"postal_code\": \"あ\", \"city\": \"あ\", \"region\": \"あ\", \"address_line1\": \"あ\", \"country\": \"あ\"}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.197981Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=643224d31a8a2873...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.198413Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:shopping_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.200171Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.203350Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 859, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_beef923e\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-30T11:04:58.409790Z\",\"id\":\"intent_beef923e\",\"intent_expiry\":\"2025-10-30T12:0", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.203505Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210276Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210373Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210422Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.IntentMandate, from=did:ap2:agent:shopping_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210598Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate", "module": "intent_handler", "function": "handle_intent_mandate", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210650Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate with shipping_address (AP2 v0.1 compliant)", "module": "intent_handler", "function": "handle_intent_mandate", "line": 40}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210664Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Searching products with intent: 'かわいいグッズ。5000円以内'", "module": "intent_handler", "function": "handle_intent_mandate", "line": 49}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210701Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using provided shipping address: あ", "module": "intent_handler", "function": "handle_intent_mandate", "line": 66}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.210730Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using LangGraph AI engine for cart generation", "module": "intent_handler", "function": "handle_intent_mandate", "line": 71}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.211944Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Created new handler for session: 74c066fc-7033-4bd2-aa67-21e4b6003335", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 289}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.235708Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: initialize", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.235779Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"initialize\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\"}, \"arguments\": {\"protocolVersion\": \"2025-03-26\", \"clientInfo\": {\"name\": \"ap2_langgraph_client\", \"version\": \"1.0.0\"}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.236221Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.236282Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"initialize\", \"params\": {\"protocolVersion\": \"2025-03-26\", \"clientInfo\": {\"name\": \"ap2_langgraph_client\", \"version\": \"1.0.0\"}}, \"id\": 70249}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.9:36156 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.445034Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (208.82ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.445182Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:05:10 GMT\", \"server\": \"uvicorn\", \"mcp-session-id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\", \"content-length\": \"1144\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 70249, \"result\": {\"protocolVersion\": \"2025-03-26\", \"serverInfo\": {\"name\": \"merchant_agent_mcp\", \"version\": \"1.0.0\"}, \"capabilities\": {\"tools\": {\"search_products\": {\"description\": \"データベースから商品を検索\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"keywords\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}, \"description\": \"検索キーワードリスト\"}, \"limit\": {\"type\": \"integer\", \"description\": \"最 大検索結果数\", \"default\": 20}}, \"required\": [\"keywords\"]}}, \"check_inventory\": {\"description\": \"在庫状況を確認\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"product_ids\": {\"type\": \"array\", \"items\": {\"type\": \"integer\"}, \"description\": \"商品IDリスト\"}}, \"required\": [\"product_ids\"]}}, \"build_cart_mandates\": {\"description\": \"AP2準拠のCartMandateを構築（未署名）\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"cart_plan\": {\"type\": \"object\", \"description\": \"カートプラン（optimize_cartの結果）\"}, \"products\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}, \"description\": \"商品情報リスト\"}, \"shipping_address\": {\"type\": \"object\", \"description\": \"AP2準拠のContactAddress\"}}, \"required\": [\"cart_plan\", \"products\"]}}}}}}, \"duration_ms\": 208.81962776184082}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.445867Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: initialize - SUCCESS (209.98ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.445914Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"initialize\", \"result\": {\"protocolVersion\": \"2025-03-26\", \"serverInfo\": {\"name\": \"merchant_agent_mcp\", \"version\": \"1.0.0\"}, \"capabilities\": {\"tools\": {\"search_products\": {\"description\": \"データベースから商品を検索\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"keywords\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}, \"description\": \"検索キーワードリスト\"}, \"limit\": {\"type\": \"integer\", \"description\": \"最大検索結果数\", \"default\": 20}}, \"required\": [\"keywords\"]}}, \"check_inventory\": {\"description\": \"在庫状況を確認\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"product_ids\": {\"type\": \"array\", \"items\": {\"type\": \"integer\"}, \"description\": \"商品IDリスト\"}}, \"required\": [\"product_ids\"]}}, \"build_cart_mandates\": {\"description\": \"AP2準拠のCartMandateを構築（未署名）\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"cart_plan\": {\"type\": \"object\", \"description\": \"カートプラン（optimize_cartの結果）\"}, \"products\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}, \"description\": \"商品情報リスト\"}, \"shipping_address\": {\"type\": \"object\", \"description\": \"AP2準拠のContactAddress\"}}, \"required\": [\"cart_plan\", \"products\"]}}}}}, \"error\": null, \"duration_ms\": 209.9783420562744}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.445936Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Initialized session: 3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f", "module": "mcp_client", "function": "initialize", "line": 88}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.447790Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Server capabilities: {'tools': {'search_products': {'description': 'データベースから商品を検索', 'inputSchema': {'type': 'object', 'properties': {'keywords': {'type': 'array', 'items': {'type': 'string'}, 'description': '検索キーワードリスト'}, 'limit': {'type': 'integer', 'description': '最大検索結果数', 'default': 20}}, 'required': ['keywords']}}, 'check_inventory': {'description': '在庫状況を確認', 'inputSchema': {'type': 'object', 'properties': {'product_ids': {'type': 'array', 'items': {'type': 'integer'}, 'description': '商品IDリスト'}}, 'required': ['product_ids']}}, 'build_cart_mandates': {'description': 'AP2準拠のCartMandateを構築（未署名）', 'inputSchema': {'type': 'object', 'properties': {'cart_plan': {'type': 'object', 'description': 'カートプラン（optimize_cartの結果）'}, 'products': {'type': 'array', 'items': {'type': 'object'}, 'description': '商品情報リスト'}, 'shipping_address': {'type': 'object', 'description': 'AP2準拠のContactAddress'}}, 'required': ['cart_plan', 'products']}}}}", "module": "mcp_client", "function": "initialize", "line": 89}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:11.447961Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] MCP client initialized", "module": "intent_node", "function": "analyze_intent", "line": 35}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:40.966617Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] LLM result: {'primary_need': 'かわいいグッズを5000 円以内で購入したい', 'budget_strategy': 'low', 'key_factors': ['かわいい', '価格'], 'search_keywords': ['かわいい', 'グッズ', 'Tシャツ']}", "module": "intent_node", "function": "analyze_intent", "line": 124}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:40.974264Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:40.974767Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"arguments\": {\"name\": \"search_products\", \"arguments\": {\"keywords\": [\" かわいい\", \"グッズ\", \"Tシャツ\"], \"limit\": 20}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:40.975394Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:40.975446Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"search_products\", \"arguments\": {\"keywords\": [\"かわいい\", \"グッズ\", \"Tシャツ\"], \"limit\": 20}}, \"id\": 657941}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T11:05:41.000198Z", "level": "INFO", "logger": "main", "message": "[search_products] Searching with query: 'かわいい グッズ Tシャツ'", "module": "main", "function": "search_products", "line": 123}
ap2_meilisearch            | 2025-10-30T11:05:41.195641Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/search query_parameters= user_agent=python-httpx/0.28.1 status_code=200}: meilisearch: close time.busy=3.51ms time.idle=21.1ms
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T11:05:41.199256Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Search 'かわいい グッズ Tシャツ' returned 6 products", "module": "search_engine", "function": "search", "line": 187}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T11:05:41.226353Z", "level": "INFO", "logger": "main", "message": "[search_products] Returned 6 products for keywords: ['かわいい', 'グッズ', 'Tシャツ']", "module": "main", "function": "search_products", "line": 148}
ap2_merchant_agent_mcp     | INFO:     172.18.0.9:55162 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.231337Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (255.83ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.231431Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:05:40 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3086\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 657941, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"products\\\": [\\n    {\\n      \\\"id\\\": \\\"b8444ff4-1fec-4589-bf16-ef3639b59e61\\\",\\n      \\\"sku\\\": \\\"MUGI-KEYCHAIN-001\\\",\\n      \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n      \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n      \\\"price_cents\\\": 80000,\\n      \\\"price_jpy\\\": 800.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\",\\n      \\\"sku\\\": \\\"MUGI-CLOCK-001\\\",\\n      \\\"name\\\": \\\"むぎぼー時計\\\",\\n      \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n      \\\"price_cents\\\": 350000,\\n      \\\"price_jpy\\\": 3500.0,\\n      \\\"inventory_count\\\": 30,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"f22bbef3-ac71-42dd-9487-bd626c3a24d3\\\",\\n      \\\"sku\\\": \\\"MUGI-POUCH-001\\\",\\n      \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n      \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n      \\\"price_cents\\\": 95000,\\n      \\\"price_jpy\\\": 950.0,\\n      \\\"inventory_count\\\": 120,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\\\",\\n      \\\"sku\\\": \\\"MUGI-MUG-001\\\",\\n      \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n      \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n      \\\"price_cents\\\": 120000,\\n      \\\"price_jpy\\\": 1200.0,\\n      \\\"inventory_count\\\": 80,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\\\",\\n      \\\"sku\\\": \\\"MUGI-SOCKS-001\\\",\\n      \\\"name\\\": \\\"むぎぼー靴下\\\",\\n      \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n      \\\"price_cents\\\": 85000,\\n      \\\"price_jpy\\\": 850.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\\\",\\n      \\\"sku\\\": \\\"MUGI-PLATE-001\\\",\\n      \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n      \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n      \\\"price_cents\\\": 190000,\\n      \\\"price_jpy\\\": 1900.0,\\n      \\\"inventory_count\\\": 70,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    }\\n  ]\\n}\"}], \"isError\": false}}, \"duration_ms\": 255.8300495147705}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.231769Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (256.90ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.231809Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"products\\\": [\\n    {\\n      \\\"id\\\": \\\"b8444ff4-1fec-4589-bf16-ef3639b59e61\\\",\\n      \\\"sku\\\": \\\"MUGI-KEYCHAIN-001\\\",\\n      \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n      \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n      \\\"price_cents\\\": 80000,\\n      \\\"price_jpy\\\": 800.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\",\\n      \\\"sku\\\": \\\"MUGI-CLOCK-001\\\",\\n      \\\"name\\\": \\\"むぎぼー時計\\\",\\n      \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n      \\\"price_cents\\\": 350000,\\n      \\\"price_jpy\\\": 3500.0,\\n      \\\"inventory_count\\\": 30,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"f22bbef3-ac71-42dd-9487-bd626c3a24d3\\\",\\n      \\\"sku\\\": \\\"MUGI-POUCH-001\\\",\\n      \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n      \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペ ンケースとして使えます。\\\",\\n      \\\"price_cents\\\": 95000,\\n      \\\"price_jpy\\\": 950.0,\\n      \\\"inventory_count\\\": 120,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\\\",\\n      \\\"sku\\\": \\\"MUGI-MUG-001\\\",\\n      \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n      \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n      \\\"price_cents\\\": 120000,\\n      \\\"price_jpy\\\": 1200.0,\\n      \\\"inventory_count\\\": 80,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\\\",\\n      \\\"sku\\\": \\\"MUGI-SOCKS-001\\\",\\n      \\\"name\\\": \\\"むぎぼー靴下\\\",\\n      \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n      \\\"price_cents\\\": 85000,\\n      \\\"price_jpy\\\": 850.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\\\",\\n      \\\"sku\\\": \\\"MUGI-PLATE-001\\\",\\n      \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n      \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n      \\\"price_cents\\\": 190000,\\n      \\\"price_jpy\\\": 1900.0,\\n      \\\"inventory_count\\\": 70,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    }\\n  ]\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 256.90484046936035}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.231869Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool search_products executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.232461Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.search_node", "message": "[search_products] MCP returned 6 products", "module": "search_node", "function": "search_products", "line": 69}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.234523Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.234572Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"arguments\": {\"name\": \"check_inventory\", \"arguments\": {\"product_ids\": [\"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\"]}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.234689Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.234717Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"check_inventory\", \"arguments\": {\"product_ids\": [\"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\"]}}, \"id\": 265148}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T11:05:41.242802Z", "level": "INFO", "logger": "main", "message": "[check_inventory] Inventory: {'b8444ff4-1fec-4589-bf16-ef3639b59e61': 100, 'd3215ff6-8087-4622-8ec3-8a8a37101927': 30, 'f22bbef3-ac71-42dd-9487-bd626c3a24d3': 120, '8a4be9a4-b828-46d0-8921-ac6d1b1caf9a': 80, '16c5a5f5-bf3a-446c-834e-dfc8453bec8c': 100, '9540f8c0-b605-4599-9ae1-a3d4c82eaf8c': 70}", "module": "main", "function": "check_inventory", "line": 202}
ap2_merchant_agent_mcp     | INFO:     172.18.0.9:55162 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.245163Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (10.40ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.245222Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:05:40 GMT\", \"server\": \"uvicorn\", \"content-length\": \"431\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 265148, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"inventory\\\": {\\n    \\\"b8444ff4-1fec-4589-bf16-ef3639b59e61\\\": 100,\\n    \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\": 30,\\n    \\\"f22bbef3-ac71-42dd-9487-bd626c3a24d3\\\": 120,\\n    \\\"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\\\": 80,\\n    \\\"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\\\": 100,\\n    \\\"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\\\": 70\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 10.401725769042969}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.245475Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (10.84ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.245587Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"inventory\\\": {\\n    \\\"b8444ff4-1fec-4589-bf16-ef3639b59e61\\\": 100,\\n    \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\": 30,\\n    \\\"f22bbef3-ac71-42dd-9487-bd626c3a24d3\\\": 120,\\n    \\\"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\\\": 80,\\n    \\\"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\\\": 100,\\n    \\\"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\\\": 70\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 10.843515396118164}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.245696Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool check_inventory executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:05:41.245774Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.inventory_node", "message": "[check_inventory] MCP checked 6 products", "module": "inventory_node", "function": "check_inventory", "line": 62}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.535734Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.optimization_node", "message": "[optimize_cart] LLM generated 3 cart plans", "module": "optimization_node", "function": "optimize_cart", "line": 164}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.541224Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Creating 3 unsigned CartMandates...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 66}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.541753Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.541847Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"コスパ最優先プラン (3,800円)\", \"description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"quantity\": 1}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"quantity\": 1}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"quantity\": 1}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"quantity\": 1}]}, \"products\": [{\"id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.542076Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.542157Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"コスパ最優先プラン (3,800円)\", \"description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"quantity\": 1}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"quantity\": 1}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"quantity\": 1}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"quantity\": 1}]}, \"products\": [{\"id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 556458}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.9:50286 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.616091Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (73.94ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.616204Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:43 GMT\", \"server\": \"uvicorn\", \"content-length\": \"4949\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 556458, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_b7751f85\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_b7751f85\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 800.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー 靴下\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 850.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーポーチ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 950.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーマグカップ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1200.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 380.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4680.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-30T12:07:44.603210Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T11:07:44.603291Z\\\",\\n      \\\"cart_name\\\": \\\"コスパ最優先プラン (3,800円)\\\",\\n      \\\"cart_description\\\": \\\"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"b8444ff4-1fec-4589-bf16-ef3639b59e61\\\",\\n          \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n          \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\\\",\\n          \\\"name\\\": \\\"むぎぼー靴下\\\",\\n          \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"f22bbef3-ac71-42dd-9487-bd626c3a24d3\\\",\\n          \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n          \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\\\",\\n          \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n          \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 73.93813133239746}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.616914Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (75.00ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.617008Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_b7751f85\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_b7751f85\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼーアクリルキーホ ルダー\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 800.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー靴下\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 850.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーポーチ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 950.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーマグカップ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1200.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 380.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4680.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-30T12:07:44.603210Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T11:07:44.603291Z\\\",\\n      \\\"cart_name\\\": \\\"コスパ最優先プラン (3,800円)\\\",\\n      \\\"cart_description\\\": \\\"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"b8444ff4-1fec-4589-bf16-ef3639b59e61\\\",\\n          \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n          \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\\\",\\n          \\\"name\\\": \\\"むぎぼー靴下\\\",\\n          \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"f22bbef3-ac71-42dd-9487-bd626c3a24d3\\\",\\n          \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n          \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\\\",\\n          \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n          \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 74.9969482421875}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.617137Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.617184Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_b7751f85, plan=コスパ最優先プラン (3,800円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.617840Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.617972Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"高品質プラン (5,400円)\", \"description\": \"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少し超えても価値あり。\", \"items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"quantity\": 1}, {\"product_id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"quantity\": 1}]}, \"products\": [{\"id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリル キーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩り ます。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.618060Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.618111Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"高品質プラン (5,400円)\", \"description\": \"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少し超えても価値あり。\", \"items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"quantity\": 1}, {\"product_id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"quantity\": 1}]}, \"products\": [{\"id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 22398}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.620676Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (2.56ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.620752Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:44 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3074\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 22398, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_8353512c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_8353512c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼープレート皿\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1900.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 540.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5940.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-30T12:07:44.619627Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T11:07:44.619658Z\\\",\\n      \\\"cart_name\\\": \\\"高品質プラン (5,400円)\\\",\\n      \\\"cart_description\\\": \\\"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少し超えても価値あり。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\\\",\\n          \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n          \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 2.560853958129883}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.620938Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (2.93ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.620973Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_8353512c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_8353512c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼープレート皿\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1900.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 540.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5940.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-30T12:07:44.619627Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T11:07:44.619658Z\\\",\\n      \\\"cart_name\\\": \\\"高品質プラン (5,400円)\\\",\\n      \\\"cart_description\\\": \\\"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少 し超えても価値あり。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\\\",\\n          \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n          \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 2.9296875}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.621015Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent_mcp     | INFO:     172.18.0.9:50286 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent_mcp     | INFO:     172.18.0.9:50286 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.621030Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_8353512c, plan=高品質プラン (5,400円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.621186Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.621263Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"シンプルプラン (3,500円)\", \"description\": \"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\", \"items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"quantity\": 1}]}, \"products\": [{\"id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち 歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.621756Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.621832Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"3acb147c-9fb1-409d-9f1a-6c0ca4d84c2f\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"シンプルプラン (3,500円)\", \"description\": \"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\", \"items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"quantity\": 1}]}, \"products\": [{\"id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキー ホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 508973}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625013Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (3.38ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625076Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:44 GMT\", \"server\": \"uvicorn\", \"content-length\": \"2464\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 508973, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_009e787c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_009e787c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 350.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4350.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-30T12:07:44.623767Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T11:07:44.623783Z\\\",\\n      \\\"cart_name\\\": \\\"シンプルプラン (3,500円)\\\",\\n      \\\"cart_description\\\": \\\"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 3.3779144287109375}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625316Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (4.02ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625350Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_009e787c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_009e787c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 350.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4350.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-30T12:07:44.623767Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T11:07:44.623783Z\\\",\\n      \\\"cart_name\\\": \\\"シンプルプラン (3,500円)\\\",\\n      \\\"cart_description\\\": \\\"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"d3215ff6-8087-4622-8ec3-8a8a37101927\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋 を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 4.01616096496582}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625395Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625426Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_009e787c, plan=シンプルプラン (3,500円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625454Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created 3 unsigned CartMandates, sending to Merchant for signature...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 116}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.625495Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Processing 3 CartMandates in parallel...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 330}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.626401Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.626867Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.628193Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.628318Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_8353512c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_8353512c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.619627Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.619658Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少し超えても価値あり。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.628853Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.628948Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_009e787c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_009e787c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.623767Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.623783Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant               | [2025-10-30 11:07:44,814] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_8353512c
ap2_merchant               | [2025-10-30 11:07:44,821] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_b7751f85
ap2_merchant               | [2025-10-30 11:07:44,821] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_009e787c
ap2_merchant               | [2025-10-30 11:07:44,821] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_8353512c
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.824447Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.856889Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.866669Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=cf58d80850b47358..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-30 11:07:44,888] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_b7751f85
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.888997Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.889472Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.889839Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=5693232b637df46f..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-30 11:07:44,892] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_009e787c
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.892794Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.893188Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.893856Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=1e0ead31afef8620..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.909499Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_8353512c", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.909767Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_8353512c (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.9:38742 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.919372Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (291.13ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.920353Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:44 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3598\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_8353512c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_8353512c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.619627Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiIyYThjYjM5Yy05NGZhLTQxZmMtOTczZC1mMzViNGViOTMzMTMiLCJjYXJ0X2hhc2giOiJjZjU4ZDgwODUwYjQ3MzU4NjVlNGVhM2YwZGJjY2I2MjZkNmYyY2YzNzkxMTBlZDU0ZTMzODg3Y2Y5Y2FmNTE3In0.MEYCIQCpfrSxF9JT2cD76WkMLkCXeahA7S6CUt-oSHmYaPWZ6wIhAJll9ranxz0LMyaIWRFXCDh1N3PVCNqBJQLPiyJ6asqN\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.619658Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少し超えても価値あり。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"name\": \"むぎぼープレート皿\", \"description\": \"む ぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"1K3lFEmQxMdDuPIX1XyKaSam6PWkPs+C+r4dUsytsGdsp0iVnCw9A2SrsXsItaAPnSaZW7UHRRksr3YiWm13BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.853900Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"1K3lFEmQxMdDuPIX1XyKaSam6PWkPs+C+r4dUsytsGdsp0iVnCw9A2SrsXsItaAPnSaZW7UHRRksr3YiWm13BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.853900Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiIyYThjYjM5Yy05NGZhLTQxZmMtOTczZC1mMzViNGViOTMzMTMiLCJjYXJ0X2hhc2giOiJjZjU4ZDgwODUwYjQ3MzU4NjVlNGVhM2YwZGJjY2I2MjZkNmYyY2YzNzkxMTBlZDU0ZTMzODg3Y2Y5Y2FmNTE3In0.MEYCIQCpfrSxF9JT2cD76WkMLkCXeahA7S6CUt-oSHmYaPWZ6wIhAJll9ranxz0LMyaIWRFXCDh1N3PVCNqBJQLPiyJ6asqN\"}, \"duration_ms\": 291.12744331359863}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.920782Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_8353512c, plan=高品質プラン (5,400円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.920952Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: 高品 質プラン (5,400円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.925394Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_009e787c", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.926033Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_009e787c (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.9:38766 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.928117Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (299.21ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.928480Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:44 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3214\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_009e787c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_009e787c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.623767Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiI1NTRkYThjMS0zOTc4LTRhZmQtOGNkOS00ZGZmZDFiNTYzMmQiLCJjYXJ0X2hhc2giOiIxZTBlYWQzMWFmZWY4NjIwMzNmYzkwMmQ0YTI0ODE4M2JhMmJkOGE1NjlmMDNlMzU3YWI3Yzk2MmE0MTFjMTMyIn0.MEYCIQCsqdnNZ3C8ZeH0zVqXK-lWnQEhbyzYPwxep9v2tmQjlwIhAP1hHk43uTD0qIaV8GhTuRXcar6YcFx4FT-VNWuc6d3i\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.623783Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xFTXwQLpF9lRx7II6BOTsqbADB0hYQ98T7dvMoLQHo35r45atGv2SUkQXff5M+zf0RQeh4Y5qSaIdjxWbvuBBA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.893137Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xFTXwQLpF9lRx7II6BOTsqbADB0hYQ98T7dvMoLQHo35r45atGv2SUkQXff5M+zf0RQeh4Y5qSaIdjxWbvuBBA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.893137Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiI1NTRkYThjMS0zOTc4LTRhZmQtOGNkOS00ZGZmZDFiNTYzMmQiLCJjYXJ0X2hhc2giOiIxZTBlYWQzMWFmZWY4NjIwMzNmYzkwMmQ0YTI0ODE4M2JhMmJkOGE1NjlmMDNlMzU3YWI3Yzk2MmE0MTFjMTMyIn0.MEYCIQCsqdnNZ3C8ZeH0zVqXK-lWnQEhbyzYPwxep9v2tmQjlwIhAP1hHk43uTD0qIaV8GhTuRXcar6YcFx4FT-VNWuc6d3i\"}, \"duration_ms\": 299.2055416107178}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.928805Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_009e787c, plan=シンプルプラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.928868Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: シン プルプラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.932227Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_b7751f85", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-30T11:07:44.932604Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_b7751f85 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.9:38756 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.933796Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (307.33ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.933941Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:44 GMT\", \"server\": \"uvicorn\", \"content-length\": \"4573\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわ いいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄の かわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\"}, \"duration_ms\": 307.33275413513184}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.934368Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_b7751f85, plan=コスパ最優先プラン (3,800円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.934408Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: コス パ最優先プラン (3,800円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.935034Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Parallel processing complete: 3 signed, 0 pending, 0 timeout, 0 rejected", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 353}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.935070Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built 3 signed CartMandates (pending: 0, timeout: 0)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 373}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.939387Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.ranking_node", "message": "[rank_and_select] Selected top 3 carts", "module": "ranking_node", "function": "rank_and_select", "line": 31}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.947348Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[create_cart_candidates] 3 carts ready (pre-signed via MCP)", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 313}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.947437Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Generated 3 cart candidates", "module": "intent_handler", "function": "handle_intent_mandate", "line": 97}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.947808Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.IntentMandate, result_type=ap2.responses.CartCandidates", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.950598Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.952660Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 8199, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.CartCandidates\",\"id\":\"ab0b1776-c97e-47ae-afed-1b6760e0aae8\",\"payload\":{\"cart_candidates\":[{\"artifactId\":\"artifact_a63488d8\",\"name\":\"コスパ最優先プラン (3,800円)\",\"parts\":[{\"d", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.952727Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.958903Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.959335Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:shopping_agent: ap2.responses.CartCandidates", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | [2025-10-30 11:07:44,959] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.CartCandidates, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:44.959572Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.CartCandidates\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"4301c9e7-8e50-4dc8-b635-73d549e5d78a\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T11:07:44.948438Z\", \"nonce\": \"084a4be838c0bce0b2721711f5bd2a1bd0cec5c342c713bdc85dedfd6c9f28e9\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"intent_mandate_id\": \"intent_beef923e\", \"cart_candidates\": [{\"artifactId\": \"artifact_a63488d8\", \"name\": \"コスパ最優先プラン (3,800円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \" コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーア クリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎ ぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_7b5fa83d\", \"name\": \"高品質プラン (5,400円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_8353512c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_8353512c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.619627Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiIyYThjYjM5Yy05NGZhLTQxZmMtOTczZC1mMzViNGViOTMzMTMiLCJjYXJ0X2hhc2giOiJjZjU4ZDgwODUwYjQ3MzU4NjVlNGVhM2YwZGJjY2I2MjZkNmYyY2YzNzkxMTBlZDU0ZTMzODg3Y2Y5Y2FmNTE3In0.MEYCIQCpfrSxF9JT2cD76WkMLkCXeahA7S6CUt-oSHmYaPWZ6wIhAJll9ranxz0LMyaIWRFXCDh1N3PVCNqBJQLPiyJ6asqN\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.619658Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセットで購入。予算を少し超えても価値あり。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"む ぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"1K3lFEmQxMdDuPIX1XyKaSam6PWkPs+C+r4dUsytsGdsp0iVnCw9A2SrsXsItaAPnSaZW7UHRRksr3YiWm13BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.853900Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_c3b910f1\", \"name\": \"シンプルプラン (3,500円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_009e787c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_009e787c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.623767Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiI1NTRkYThjMS0zOTc4LTRhZmQtOGNkOS00ZGZmZDFiNTYzMmQiLCJjYXJ0X2hhc2giOiIxZTBlYWQzMWFmZWY4NjIwMzNmYzkwMmQ0YTI0ODE4M2JhMmJkOGE1NjlmMDNlMzU3YWI3Yzk2MmE0MTFjMTMyIn0.MEYCIQCsqdnNZ3C8ZeH0zVqXK-lWnQEhbyzYPwxep9v2tmQjlwIhAP1hHk43uTD0qIaV8GhTuRXcar6YcFx4FT-VNWuc6d3i\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.623783Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xFTXwQLpF9lRx7II6BOTsqbADB0hYQ98T7dvMoLQHo35r45atGv2SUkQXff5M+zf0RQeh4Y5qSaIdjxWbvuBBA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.893137Z\", \"key_id\": \"merchant\"}}}}]}], \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"merchant_name\": \"むぎぼーショップ\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | INFO:     172.18.0.8:34380 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:44.989737Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (153810.94ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:44.991204Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:05:10 GMT\", \"server\": \"uvicorn\", \"content-length\": \"9828\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"4301c9e7-8e50-4dc8-b635-73d549e5d78a\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T11:07:44.948438Z\", \"nonce\": \"084a4be838c0bce0b2721711f5bd2a1bd0cec5c342c713bdc85dedfd6c9f28e9\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"3amdT9BvKUSKiaZy10ktwUYtH0N2myKNtQmXDZ0EhVIw+TfkaTcTSy5Dyu3NeoIvjZiFoupXi6O0qSAEBeL/BQ==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVlOOU9NNE5heDdRajdUdEFWU25QL1k4V0RzYlg2VFRqdVVpSGtZUWNCK2c9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T11:07:44.948438Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.CartCandidates\", \"id\": \"ab0b1776-c97e-47ae-afed-1b6760e0aae8\", \"payload\": {\"intent_mandate_id\": \"intent_beef923e\", \"cart_candidates\": [{\"artifactId\": \"artifact_a63488d8\", \"name\": \"コスパ最優先プラン (3,800円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。 小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_7b5fa83d\", \"name\": \"高品質プラン (5,400円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_8353512c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_8353512c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.619627Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiIyYThjYjM5Yy05NGZhLTQxZmMtOTczZC1mMzViNGViOTMzMTMiLCJjYXJ0X2hhc2giOiJjZjU4ZDgwODUwYjQ3MzU4NjVlNGVhM2YwZGJjY2I2MjZkNmYyY2YzNzkxMTBlZDU0ZTMzODg3Y2Y5Y2FmNTE3In0.MEYCIQCpfrSxF9JT2cD76WkMLkCXeahA7S6CUt-oSHmYaPWZ6wIhAJll9ranxz0LMyaIWRFXCDh1N3PVCNqBJQLPiyJ6asqN\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.619658Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレート皿を組み合わせて、かわいいアイテムの高品質なセ ットで購入。予算を少し超えても価値あり。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"9540f8c0-b605-4599-9ae1-a3d4c82eaf8c\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"1K3lFEmQxMdDuPIX1XyKaSam6PWkPs+C+r4dUsytsGdsp0iVnCw9A2SrsXsItaAPnSaZW7UHRRksr3YiWm13BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.853900Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_c3b910f1\", \"name\": \"シンプルプラン (3,500円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_009e787c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_009e787c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.623767Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiI1NTRkYThjMS0zOTc4LTRhZmQtOGNkOS00ZGZmZDFiNTYzMmQiLCJjYXJ0X2hhc2giOiIxZTBlYWQzMWFmZWY4NjIwMzNmYzkwMmQ0YTI0ODE4M2JhMmJkOGE1NjlmMDNlMzU3YWI3Yzk2MmE0MTFjMTMyIn0.MEYCIQCsqdnNZ3C8ZeH0zVqXK-lWnQEhbyzYPwxep9v2tmQjlwIhAP1hHk43uTD0qIaV8GhTuRXcar6YcFx4FT-VNWuc6d3i\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.623783Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"時計を単品で購入。かわいいアイテムの代表として、高品質かつシンプルな選択。\", \"raw_items\": [{\"product_id\": \"d3215ff6-8087-4622-8ec3-8a8a37101927\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xFTXwQLpF9lRx7II6BOTsqbADB0hYQ98T7dvMoLQHo35r45atGv2SUkQXff5M+zf0RQeh4Y5qSaIdjxWbvuBBA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.893137Z\", \"key_id\": \"merchant\"}}}}]}], \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"merchant_name\": \"むぎぼーショップ\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 153810.94241142273}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 11:07:44,996] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_shopping_agent         |   Response Body: {
ap2_shopping_agent         |   "header": {
ap2_shopping_agent         |     "message_id": "4301c9e7-8e50-4dc8-b635-73d549e5d78a",
ap2_shopping_agent         |     "sender": "did:ap2:agent:merchant_agent",
ap2_shopping_agent         |     "recipient": "did:ap2:agent:shopping_agent",
ap2_shopping_agent         |     "timestamp": "2025-10-30T11:07:44.948438Z",
ap2_shopping_agent         |     "nonce": "084a4be838c0bce0b2721711f5bd2a1bd0cec5c342c713bdc85dedfd6c9f28e9",
ap2_shopping_agent         |     "schema_version": "0.2",
ap2_shopping_agent         |     "proof": {
ap2_shopping_agent         |       "algorithm": "ed25519",
ap2_shopping_agent         |       "signatureValue": "3amdT9BvKUSKiaZy10ktwUYtH0N2myKNtQmXDZ0EhVIw+TfkaTcTSy5Dyu3NeoIvjZiFoupXi6O0qSAEBeL/BQ==",
ap2_shopping_agent         |       "publicKey": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVlOOU9NNE5heDdRajdUdEFWU25QL1k4V0RzYlg2VFRqdVVpSGtZUWNCK2c9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_shopping_agent         |       "kid": "did:ap2:agent:merchant_agent#key-2",
ap2_shopping_agent         |       "created": "2025-10-30T11:07:44.948438Z",
ap2_shopping_agent         |       "proofPurpose": "authentication"
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "signature": null
ap2_shopping_agent         |   },
ap2_shopping_agent         |   "dataPart": {
ap2_shopping_agent         |     "@type": "ap2.responses.CartCandidates",
ap2_shopping_agent         |     "id": "ab0b1776-c97e-47ae-afed-1b6760e0aae8",
ap2_shopping_agent         |     "payload": {
ap2_shopping_agent         |       "intent_mandate_id": "intent_be...
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-30 11:07:44,997] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Received 3 cart candidates from Merchant Agent
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:45.774591Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:45.784767Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.796053Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.797484Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: cart_b7751f85\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:63922 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.807442Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=cart_selection", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.808923Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.809084Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:07:49,859] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: cart_selection
ap2_shopping_agent         |   user_input: cart_b7751f85
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.873117Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.879192Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.953453Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:49.979051Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | INFO:     172.67.69.85:63922 - "OPTIONS /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.763116Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.770807Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.772272Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] Received CartMandate signature: cart_id=None, session_id=session_1761822253905_ms7its", "module": "agent", "function": "submit_cart_signature", "line": 1274}
ap2_shopping_agent         | [2025-10-30 11:07:52,774] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying CartMandate WebAuthn signature: user_id=usr_577b4cbdb15e4f5d
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.776981Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/verify/attestation", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.777447Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/verify/attestation\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}, \"attestation\": {\"id\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"rawId\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2lZMkZ5ZEY5aU56YzFNV1k0TlNJc0luUnBiV1Z6ZEdGdGNDSTZNVGMyTVRneU1qUTNNRGMxT1gwIiwib3JpZ2luIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwIiwiY3Jvc3NPcmlnaW4iOmZhbHNlfQ\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEYCIQCJBjSECziI7k8U1fyySN0h4AtKFdvm_BvwE2jfzrA4gwIhANs2jWMUKfX3cSsn90fkd3QaPmQD0ye_kcXCFDmaChhF\", \"userHandle\": \"usr_577b4cbdb15e4f5d\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoiY2FydF9iNzc1MWY4NSIsInRpbWVzdGFtcCI6MTc2MTgyMjQ3MDc1OX0\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.843540Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: et9d3nUkGZvEXePq...", "module": "provider", "function": "verify_attestation", "line": 519}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.843648Z", "level": "INFO", "logger": "provider", "message": "  User: usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_attestation", "line": 520}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.843687Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 521}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.844640Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.844996Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.845019Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.845030Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.845039Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.847092Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.847152Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.847609Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.861263Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.873543Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 539}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:52.873918Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] No payment_method.token in mandate (likely IntentMandate signature), skipping Payment Network call", "module": "provider", "function": "verify_attestation", "line": 567}
ap2_credential_provider    | [2025-10-30 11:07:52,873] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: None
ap2_credential_provider    | [2025-10-30 11:07:52,882] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=unknown, verified=True, agent_token=None...
ap2_credential_provider    | INFO:     172.18.0.8:49536 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.903319Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (126.62ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.904521Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:52 GMT\", \"server\": \"uvicorn\", \"content-length\": \"191\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"token\": \"cred_token_0fd6f05c_M2OSNyYKWvoMRVXn3mzM9abg\", \"details\": {\"attestation_type\": \"passkey\", \"timestamp\": \"2025-10-30T11:07:52.882623+00:00\", \"counter\": 0, \"agent_token\": null}}, \"duration_ms\": 126.61600112915039}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 11:07:52,904] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Sent WebAuthn verification request to Credential Provider: user_id=usr_577b4cbdb15e4f5d
ap2_shopping_agent         | [2025-10-30 11:07:52,905] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ WebAuthn signature verified successfully: counter=0, attestation_type=passkey
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.920345Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.920686Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] CartMandate signed by user: cart_id=None, webauthn_assertion saved", "module": "agent", "function": "submit_cart_signature", "line": 1314}
ap2_shopping_agent         | INFO:     172.67.69.85:63922 - "POST /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.930334Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.930720Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: _cart_signature_completed\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:63922 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.936290Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.936767Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:52.936847Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:07:52,956] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: cart_signature_pending
ap2_shopping_agent         |   user_input: _cart_signature_completed
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 11:07:53,173] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 13-14: Presenting payment methods to user
ap2_shopping_agent         |   Available Methods: 2
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:53.775192Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:53.783701Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.736641Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.737132Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: 1\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:46540 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.741273Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=payment_method_selection", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.741822Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.741900Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:07:54,753] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: payment_method_selection
ap2_shopping_agent         |   user_input: 1
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 11:07:54,760] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 15-18: Tokenizing payment method
ap2_shopping_agent         |   User ID: usr_577b4cbdb15e4f5d
ap2_shopping_agent         |   Payment Method ID: pm_1486a851
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.760938Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment method tokenization for: pm_1486a851", "module": "agent", "function": "_tokenize_payment_method", "line": 2312}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.761571Z", "level": "INFO", "logger": "agent", "message": "\n================================================================================\n[ShoppingAgent → CredentialProvider] トークン化リクエスト送信\n  URL: http://credential_provider:8003/payment-methods/tokenize\n  User ID: usr_577b4cbdb15e4f5d\n  Payment Method ID: pm_1486a851\n================================================================================", "module": "agent", "function": "_tokenize_payment_method", "line": 2316}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.761963Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/payment-methods/tokenize", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.762313Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/payment-methods/tokenize\", \"headers\": {}, \"body\": {\"user_id\": \"usr_577b4cbdb15e4f5d\", \"payment_method_id\": \"pm_1486a851\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | [2025-10-30 11:07:54,775] INFO in v2.common.redis_client: [RedisClient] Connected to Redis: redis://redis:6379/0
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:54.793211Z", "level": "INFO", "logger": "provider", "message": "[tokenize_payment_method] Generated secure token for payment method: pm_1486a851", "module": "provider", "function": "tokenize_payment_method", "line": 760}
ap2_credential_provider    | INFO:     172.18.0.8:49536 - "POST /payment-methods/tokenize HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.795381Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (33.38ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.795447Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:54 GMT\", \"server\": \"uvicorn\", \"content-length\": \"217\", \"content-type\": \"application/json\"}, \"body\": {\"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"payment_method_id\": \"pm_1486a851\", \"brand\": \"Visa\", \"last4\": \"3333\", \"type\": \"basic-card\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\", \"expires_at\": \"2025-10-30T11:22:54.769533Z\"}, \"duration_ms\": 33.38027000427246}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.795500Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent ← CredentialProvider] トークン化レスポンス受信: status=200", "module": "agent", "function": "_tokenize_payment_method", "line": 2336}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.795535Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Payment method tokenized: pm_1486a851 → tok_0fd14ab4_9cIm6pE...", "module": "agent", "function": "_tokenize_payment_method", "line": 2346}
ap2_shopping_agent         | [2025-10-30 11:07:54,795] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 17-18: Received tokenized payment method
ap2_shopping_agent         |   Token: tok_0fd14ab4_9cIm6pE...
ap2_shopping_agent         | [2025-10-30 11:07:54,795] INFO in services.shopping_agent.utils.payment_helpers: [_extract_payment_amount_from_cart] CartMandate structure: has_contents=True, has_payment_request=True, has_details=True, has_total=True, total_amount={'value': 4680.0, 'currency': 'JPY'}
ap2_shopping_agent         | [2025-10-30 11:07:54,796] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-30 11:07:54,798] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: 5693232b637df46f...
ap2_shopping_agent         | [2025-10-30 11:07:54,798] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: 45c8db5f2c090188...
ap2_shopping_agent         | [2025-10-30 11:07:54,798] ERROR in v2.common.user_authorization: Failed to extract public key from WebAuthn assertion: attestationObject not found in assertion
ap2_shopping_agent         | Traceback (most recent call last):
ap2_shopping_agent         |   File "/app/v2/common/user_authorization.py", line 156, in extract_public_key_from_webauthn_assertion
ap2_shopping_agent         |     raise ValueError("attestationObject not found in assertion")
ap2_shopping_agent         | ValueError: attestationObject not found in assertion
ap2_shopping_agent         | [2025-10-30 11:07:54,806] WARNING in v2.common.user_authorization: [create_user_authorization_vp] No attestationObject, and no public_key_cose provided
ap2_shopping_agent         | [2025-10-30 11:07:54,806] WARNING in v2.common.user_authorization: [create_user_authorization_vp] No public key available, cnf claim not added
ap2_shopping_agent         | [2025-10-30 11:07:54,806] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2148, cart_hash=5693232b637df46f..., payment_hash=45c8db5f2c090188...
ap2_shopping_agent         | [2025-10-30 11:07:54,806] INFO in services.shopping_agent.utils.payment_helpers: [_generate_user_authorization_for_payment] Generated user_authorization VP: length=2148
ap2_shopping_agent         | [2025-10-30 11:07:54,806] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] transaction_type=human_not_present (no strong authentication detected)
ap2_shopping_agent         | [2025-10-30 11:07:54,806] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Performing risk assessment...
ap2_shopping_agent         | [2025-10-30 11:07:54,807] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Invalid amount value: 4680.0
ap2_shopping_agent         | [2025-10-30 11:07:54,807] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Failed to parse amounts for constraint check
ap2_shopping_agent         | [2025-10-30 11:07:54,809] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Assessment completed: risk_score=3, recommendation=approve, fraud_indicators=['card_not_present_transaction']
ap2_shopping_agent         | [2025-10-30 11:07:54,809] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Risk assessment completed: score=3, recommendation=approve, indicators=['card_not_present_transaction']
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.810050Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created with user_authorization: has_user_auth=True", "module": "agent", "function": "_create_payment_mandate", "line": 2081}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.810099Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created: amount=4680.0 JPY, payment_method=Visa ****3333, token=tok_0fd14ab4_9cIm6pE..., risk_score=3", "module": "agent", "function": "_create_payment_mandate", "line": 2086}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.846559Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:54.850140Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | INFO:     172.67.69.85:46540 - "OPTIONS /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.484748Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.486211Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Verifying attestation for PaymentMandate: payment_22f80a63", "module": "agent", "function": "submit_payment_attestation", "line": 1426}
ap2_shopping_agent         | [2025-10-30 11:07:57,486] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying PaymentMandate attestation: payment_id=payment_22f80a63
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.486408Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/verify/attestation", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.486500Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/verify/attestation\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56UXNJbVY0Y0NJNk1UYzJNVGd5TWpjM05Dd2libUptSWpveE56WXhPREl5TkRjMGZRIiwia2Jfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNkltdGlLMnAzZENKOS5leUpoZFdRaU9pSmthV1E2WVhBeU9tRm5aVzUwT25CaGVXMWxiblJmY0hKdlkyVnpjMjl5SWl3aWJtOXVZMlVpT2lKU1VXUlZkbE55VG5obVV6aG9PR0l3ZHpJdE56SmxUMkZRUm0xS2VHaDBSalkyWWxoSWRuWkhXVVZKSWl3aWFXRjBJam94TnpZeE9ESXlORGMwTENKelpGOW9ZWE5vSWpvaU1UbGxNR1JoWVRRNE9HUTVNR1JrTVRRNFpUVm1ZakkxTXpVMU0yTXlaRFF6WldFNVpEQXpabU0wTXpZek9ERmhOR1ppTVRVMU1XWmlNemcwTW1VM09DSXNJblJ5WVc1ellXTjBhVzl1WDJSaGRHRWlPbHNpTlRZNU16SXpNbUkyTXpka1pqUTJabVV5WlRGalptTXdNekV3T0RJM05XSm1PVFptTWpJeU1HUmlPR0k1WXpjeVl6TTVZV05tTTJNM09UWXdaV1ZtTkNJc0lqUTFZemhrWWpWbU1tTXdPVEF4T0RnMk5ERTROak16Tm1ZMU5ETTVaRFl3WkdJNE0ySmxPVEZsTm1SbFl6WmhNemt5TkRCa1lUWXpZekF3TmpRNFpXTWlYWDAiLCJ3ZWJhdXRobl9hc3NlcnRpb24iOnsiaWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJhd0lkIjoiZXQ5ZDNuVWtHWnZFWGVQcTFDQUdyMlEiLCJyZXNwb25zZSI6eyJjbGllbnREYXRhSlNPTiI6ImV5SjBlWEJsSWpvaWQyVmlZWFYwYUc0dVoyVjBJaXdpWTJoaGJHeGxibWRsSWpvaVpYbEtkRmxYTld0WldGSnNXREpzYTBscWIybFpNa1o1WkVZNWFVNTZZekZOVjFrMFRsTkpjMGx1VW5CaVYxWjZaRWRHZEdORFNUWk5WR015VFZSbmVVMXFVVE5OUkdNeFQxZ3dJaXdpYjNKcFoybHVJam9pYUhSMGNEb3ZMMnh2WTJGc2FHOXpkRG96TURBd0lpd2lZM0p2YzNOUGNtbG5hVzRpT21aaGJITmxmUSIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVlDSVFDSkJqU0VDemlJN2s4VTFmeXlTTjBoNEF0S0Zkdm1fQnZ3RTJqZnpyQTRnd0loQU5zMmpXTVVLZlgzY1NzbjkwZmtkM1FhUG1RRDB5ZV9rY1hDRkRtYUNoaEYiLCJ1c2VySGFuZGxlIjoidXNyXzU3N2I0Y2JkYjE1ZTRmNWQifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pWTJGeWRGOWlOemMxTVdZNE5TSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTURjMU9YMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiNDVjOGRiNWYyYzA5MDE4ODY0MTg2MzM2ZjU0MzlkNjBkYjgzYmU5MWU2ZGVjNmEzOTI0MGRhNjNjMDA2NDhlYyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"attestation\": {\"id\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"rawId\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCIsIm9yaWdpbiI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImNyb3NzT3JpZ2luIjpmYWxzZX0\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEQCIAt4S-9Fyhd6gWxMSnnKZAhiTRCr8_n1CXeR485ZhvCEAiAo2xErgXbvAHXzrcYsYRJ7jOOpyjK2mr3ziCx9bzp1yg\", \"userHandle\": \"usr_577b4cbdb15e4f5d\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoicGF5bWVudF8yMmY4MGE2MyIsInRpbWVzdGFtcCI6MTc2MTgyMjQ3NTc2MH0\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498556Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: et9d3nUkGZvEXePq...", "module": "provider", "function": "verify_attestation", "line": 519}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498667Z", "level": "INFO", "logger": "provider", "message": "  User: usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_attestation", "line": 520}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498694Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 521}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498775Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498860Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498896Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498925Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.498944Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.499005Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.499038Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.499152Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.500214Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.503244Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 539}
ap2_credential_provider    | [2025-10-30 11:07:57,503] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: usr_577b4cbdb15e4f5d
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.503490Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] PaymentMandate contains payment_method.token, calling Payment Network (Step 23)", "module": "provider", "function": "verify_attestation", "line": 558}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.503608Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Requesting Agent Token from Payment Network: payment_mandate_id=payment_22f80a63", "module": "provider", "function": "_request_agent_token_from_network", "line": 1795}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.503688Z", "level": "INFO", "logger": "provider", "message": "HTTP Request: POST http://payment_network:8005/network/tokenize", "module": "logger", "function": "log_http_request", "line": 182}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.503806Z", "level": "DEBUG", "logger": "provider", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://payment_network:8005/network/tokenize\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56UXNJbVY0Y0NJNk1UYzJNVGd5TWpjM05Dd2libUptSWpveE56WXhPREl5TkRjMGZRIiwia2Jfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNkltdGlLMnAzZENKOS5leUpoZFdRaU9pSmthV1E2WVhBeU9tRm5aVzUwT25CaGVXMWxiblJmY0hKdlkyVnpjMjl5SWl3aWJtOXVZMlVpT2lKU1VXUlZkbE55VG5obVV6aG9PR0l3ZHpJdE56SmxUMkZRUm0xS2VHaDBSalkyWWxoSWRuWkhXVVZKSWl3aWFXRjBJam94TnpZeE9ESXlORGMwTENKelpGOW9ZWE5vSWpvaU1UbGxNR1JoWVRRNE9HUTVNR1JrTVRRNFpUVm1ZakkxTXpVMU0yTXlaRFF6WldFNVpEQXpabU0wTXpZek9ERmhOR1ppTVRVMU1XWmlNemcwTW1VM09DSXNJblJ5WVc1ellXTjBhVzl1WDJSaGRHRWlPbHNpTlRZNU16SXpNbUkyTXpka1pqUTJabVV5WlRGalptTXdNekV3T0RJM05XSm1PVFptTWpJeU1HUmlPR0k1WXpjeVl6TTVZV05tTTJNM09UWXdaV1ZtTkNJc0lqUTFZemhrWWpWbU1tTXdPVEF4T0RnMk5ERTROak16Tm1ZMU5ETTVaRFl3WkdJNE0ySmxPVEZsTm1SbFl6WmhNemt5TkRCa1lUWXpZekF3TmpRNFpXTWlYWDAiLCJ3ZWJhdXRobl9hc3NlcnRpb24iOnsiaWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJhd0lkIjoiZXQ5ZDNuVWtHWnZFWGVQcTFDQUdyMlEiLCJyZXNwb25zZSI6eyJjbGllbnREYXRhSlNPTiI6ImV5SjBlWEJsSWpvaWQyVmlZWFYwYUc0dVoyVjBJaXdpWTJoaGJHeGxibWRsSWpvaVpYbEtkRmxYTld0WldGSnNXREpzYTBscWIybFpNa1o1WkVZNWFVNTZZekZOVjFrMFRsTkpjMGx1VW5CaVYxWjZaRWRHZEdORFNUWk5WR015VFZSbmVVMXFVVE5OUkdNeFQxZ3dJaXdpYjNKcFoybHVJam9pYUhSMGNEb3ZMMnh2WTJGc2FHOXpkRG96TURBd0lpd2lZM0p2YzNOUGNtbG5hVzRpT21aaGJITmxmUSIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVlDSVFDSkJqU0VDemlJN2s4VTFmeXlTTjBoNEF0S0Zkdm1fQnZ3RTJqZnpyQTRnd0loQU5zMmpXTVVLZlgzY1NzbjkwZmtkM1FhUG1RRDB5ZV9rY1hDRkRtYUNoaEYiLCJ1c2VySGFuZGxlIjoidXNyXzU3N2I0Y2JkYjE1ZTRmNWQifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pWTJGeWRGOWlOemMxTVdZNE5TSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTURjMU9YMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiNDVjOGRiNWYyYzA5MDE4ODY0MTg2MzM2ZjU0MzlkNjBkYjgzYmU5MWU2ZGVjNmEzOTI0MGRhNjNjMDA2NDhlYyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"attestation\": {\"id\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"rawId\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCIsIm9yaWdpbiI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImNyb3NzT3JpZ2luIjpmYWxzZX0\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEQCIAt4S-9Fyhd6gWxMSnnKZAhiTRCr8_n1CXeR485ZhvCEAiAo2xErgXbvAHXzrcYsYRJ7jOOpyjK2mr3ziCx9bzp1yg\", \"userHandle\": \"usr_577b4cbdb15e4f5d\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoicGF5bWVudF8yMmY4MGE2MyIsInRpbWVzdGFtcCI6MTc2MTgyMjQ3NTc2MH0\"}, \"payment_method_token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"transaction_context\": {\"credential_provider_id\": \"did:ap2:agent:credential_provider\", \"timestamp\": \"2025-10-30T11:07:57.503639+00:00\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_network        | [2025-10-30 11:07:57,644] INFO in network: [DemoPaymentNetwork] Received tokenization request: payment_mandate_id=payment_22f80a63, payment_method_token=tok_0fd14ab4_9cIm6pE...
ap2_payment_network        | [2025-10-30 11:07:57,652] INFO in common.redis_client: [RedisClient] Connected to Redis: redis://redis:6379/2
ap2_payment_network        | [2025-10-30 11:07:57,672] INFO in services.payment_network.utils.token_helpers: [DemoPaymentNetwork] Issued Agent Token (Redis): agent_tok_demopaymentnetwork_176..., expires_at=2025-10-30T12:07:57.645375+00:00, ttl=3600s
ap2_payment_network        | INFO:     172.18.0.12:36976 - "POST /network/tokenize HTTP/1.1" 200 OK
ap2_credential_provider    | [2025-10-30 11:07:57,682] INFO in httpx: HTTP Request: POST http://payment_network:8005/network/tokenize "HTTP/1.1 200 OK"
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.683268Z", "level": "INFO", "logger": "provider", "message": "HTTP Response: 200 (179.54ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.683345Z", "level": "DEBUG", "logger": "provider", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"186\", \"content-type\": \"application/json\"}, \"body\": {\"agent_token\": \"agent_tok_demopaymentnetwork_17610d1f_4zPJ_Jb83rrcXegoR75_7Cwy\", \"expires_at\": \"2025-10-30T12:07:57.645375Z\", \"network_name\": \"DemoPaymentNetwork\", \"token_type\": \"agent_token\"}, \"duration_ms\": 179.5368194580078}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.683388Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Received Agent Token from Payment Network: agent_tok_demopaymentnetwork_176..., network_name=DemoPaymentNetwork", "module": "provider", "function": "_request_agent_token_from_network", "line": 1819}
ap2_credential_provider    | [2025-10-30 11:07:57,687] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=usr_577b4cbdb15e4f5d, verified=True, agent_token=agent_tok_demopaymentnetwork_176...
ap2_credential_provider    | INFO:     172.18.0.8:49536 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.700665Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (214.20ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.705399Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"251\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"token\": \"cred_token_ce97391b_x28rk9wrN_XjTe_XrWnO2BaH\", \"details\": {\"attestation_type\": \"passkey\", \"timestamp\": \"2025-10-30T11:07:57.687271+00:00\", \"counter\": 0, \"agent_token\": \"agent_tok_demopaymentnetwork_17610d1f_4zPJ_Jb83rrcXegoR75_7Cwy\"}}, \"duration_ms\": 214.2040729522705}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.705503Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Attestation verified, processing payment...", "module": "agent", "function": "submit_payment_attestation", "line": 1446}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.705556Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/passkey/get-public-key", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.705572Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/passkey/get-public-key\", \"headers\": {}, \"body\": {\"credential_id\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"user_id\": \"usr_577b4cbdb15e4f5d\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_shopping_agent         | [2025-10-30 11:07:57,705] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ PaymentMandate attestation verified: payment_id=payment_22f80a63
ap2_shopping_agent         | [2025-10-30 11:07:57,705] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Retrieving public key from Credential Provider: credential_id=et9d3nUkGZvEXePq..., user_id=usr_577b4cbdb15e4f5d
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.711014Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (5.40ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.711082Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"201\", \"content-type\": \"application/json\"}, \"body\": {\"credential_id\": \"et9d3nUkGZvEXePq1CAGr2Q\", \"public_key_cose\": \"pQECAyYgASFYIFgE1Cc56nv+TZJw7Vd70LDDgnxT+RntXlc2ZLmnQGFFIlgg2vVV+InjyB9l+M55OHx/8WyRUWZXcKcv9VsXD+zDf08=\", \"user_id\": \"usr_577b4cbdb15e4f5d\"}, \"duration_ms\": 5.398273468017578}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 11:07:57,711] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ Public key retrieved: credential_id=et9d3nUkGZvEXePq...
ap2_shopping_agent         | [2025-10-30 11:07:57,711] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-30 11:07:57,711] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: 5693232b637df46f...
ap2_shopping_agent         | [2025-10-30 11:07:57,711] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: 92e9ccdfcd881af7...
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:57.709279Z", "level": "INFO", "logger": "provider", "message": "[get_passkey_public_key] Public key retrieved: credential_id=et9d3nUkGZvEXePq..., user_id=usr_577b4cbdb15e4f5d", "module": "provider", "function": "get_passkey_public_key", "line": 1484}
ap2_credential_provider    | INFO:     172.18.0.8:49536 - "POST /passkey/get-public-key HTTP/1.1" 200 OK
ap2_shopping_agent         | [2025-10-30 11:07:57,716] INFO in v2.common.user_authorization: [create_user_authorization_vp] Restored public key from COSE format
ap2_shopping_agent         | [2025-10-30 11:07:57,717] INFO in v2.common.user_authorization: [create_user_authorization_vp] cnf claim with JWK added to Issuer JWT
ap2_shopping_agent         | [2025-10-30 11:07:57,717] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2408, cart_hash=5693232b637df46f..., payment_hash=92e9ccdfcd881af7...
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.717523Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] SD-JWT-VC user_authorization generated: user_id=usr_577b4cbdb15e4f5d, vp_length=2408", "module": "agent", "function": "submit_payment_attestation", "line": 1490}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.724480Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.724719Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] PaymentMandate signed by user: payment_id=payment_22f80a63, next_step=payment_execution", "module": "agent", "function": "submit_payment_attestation", "line": 1511}
ap2_shopping_agent         | INFO:     172.67.69.85:46540 - "POST /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.731059Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.731222Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761822253905_ms7its\n  user_id: usr_577b4cbdb15e4f5d\n  user_input: _payment_signature_completed\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1057}
ap2_shopping_agent         | INFO:     172.67.69.85:46540 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.732503Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761822253905_ms7its, step=webauthn_signature_requested", "module": "agent", "function": "_get_or_create_session", "line": 1927}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.732804Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761822253905_ms7its)", "module": "agent", "function": "event_generator", "line": 1072}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.732849Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761822253905_ms7its", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1645}
ap2_shopping_agent         | [2025-10-30 11:07:57,741] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: webauthn_signature_requested
ap2_shopping_agent         |   user_input: _payment_signature_completed
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 11:07:57,756] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting payment processing via Merchant Agent for PaymentMandate: payment_22f80a63
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.757475Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.757734Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 6900, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_22f80a63\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\",\"cart_name\":\"コスパ最優先プラン (3,8", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.757783Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.759382Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.759650Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | [2025-10-30 11:07:57,759] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信（PaymentRequest）
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: 2a8949af-66ed-406d-bc95-589a41c07c5a
ap2_shopping_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_shopping_agent         |   PaymentMandate ID: payment_22f80a63
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.759770Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"2a8949af-66ed-406d-bc95-589a41c07c5a\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:07:57.756422Z\", \"nonce\": \"0f5f881ca22c7a6e4e8a2b0ffeb1e52f327a2ebbd0be1aed66b4b218b0801ba4\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56Y3NJbVY0Y0NJNk1UYzJNVGd5TWpjM055d2libUptSWpveE56WXhPREl5TkRjM0xDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpFZW1KNExXY3lWVmxTT1dOeVNUZDVhekJ1U1hKVlpIRmlMVE5TU21SWVJ6RjFlSFZLYzJaVVRYQmpJaXdpYVdGMElqb3hOell4T0RJeU5EYzNMQ0p6WkY5b1lYTm9Jam9pWmpjeU5Ea3hOMkUzWWpnNU1HTTNaVFU0TVRBMlpXWmxOR0UwWWpKalltWXpabUZpWm1SbFlUWmtZbUZoWmpobFpqbGhNRFpqTmpsaU5qZzNPR1k0T0NJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lOVFk1TXpJek1tSTJNemRrWmpRMlptVXlaVEZqWm1Nd016RXdPREkzTldKbU9UWm1Nakl5TUdSaU9HSTVZemN5WXpNNVlXTm1NMk0zT1RZd1pXVm1OQ0lzSWpreVpUbGpZMlJtWTJRNE9ERmhaamRrWm1JNVkyVXlaalJtTlRka05EQmxNRGxpWXpWaE5UUTJaR016T1RVd01tVTJZemhsTWpaaE1tWXhZemRqWm1FaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IbE5iVmswVFVkRk1rMTVTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVozbE5hbEV6VGxSak1rMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lBdDRTLTlGeWhkNmdXeE1Tbm5LWkFoaVRSQ3I4X24xQ1hlUjQ4NVpodkNFQWlBbzJ4RXJnWGJ2QUhYenJjWXNZUko3ak9PcHlqSzJtcjN6aUN4OWJ6cDF5ZyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiOTJlOWNjZGZjZDg4MWFmN2RmYjljZTJmNGY1N2Q0MGUwOWJjNWE1NDZkYzM5NTAyZTZjOGUyNmEyZjFjN2NmYSJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーが プリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.760436Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent:8001/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:57.760547Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent:8001/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"2a8949af-66ed-406d-bc95-589a41c07c5a\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:07:57.756422Z\", \"nonce\": \"0f5f881ca22c7a6e4e8a2b0ffeb1e52f327a2ebbd0be1aed66b4b218b0801ba4\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"HX1ypPCiwD66sBtUnerLgQ3p+m2Tzc9KXoPi7J9peTgncbBxKGSWnSD/MuRBCxn/y+qmZWI6y+7JsIUVtHDPAw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQXRSRlkxZnFlRXdoSTNTVGlmc21OUzlHZHBUZzNnTGJ4L1FXcm5tQmRLSTQ9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:shopping_agent#key-2\", \"created\": \"2025-10-30T11:07:57.756422Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.PaymentMandate\", \"id\": \"payment_22f80a63\", \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56Y3NJbVY0Y0NJNk1UYzJNVGd5TWpjM055d2libUptSWpveE56WXhPREl5TkRjM0xDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpFZW1KNExXY3lWVmxTT1dOeVNUZDVhekJ1U1hKVlpIRmlMVE5TU21SWVJ6RjFlSFZLYzJaVVRYQmpJaXdpYVdGMElqb3hOell4T0RJeU5EYzNMQ0p6WkY5b1lYTm9Jam9pWmpjeU5Ea3hOMkUzWWpnNU1HTTNaVFU0TVRBMlpXWmxOR0UwWWpKalltWXpabUZpWm1SbFlUWmtZbUZoWmpobFpqbGhNRFpqTmpsaU5qZzNPR1k0T0NJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lOVFk1TXpJek1tSTJNemRrWmpRMlptVXlaVEZqWm1Nd016RXdPREkzTldKbU9UWm1Nakl5TUdSaU9HSTVZemN5WXpNNVlXTm1NMk0zT1RZd1pXVm1OQ0lzSWpreVpUbGpZMlJtWTJRNE9ERmhaamRrWm1JNVkyVXlaalJtTlRka05EQmxNRGxpWXpWaE5UUTJaR016T1RVd01tVTJZemhsTWpaaE1tWXhZemRqWm1FaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IbE5iVmswVFVkRk1rMTVTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVozbE5hbEV6VGxSak1rMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lBdDRTLTlGeWhkNmdXeE1Tbm5LWkFoaVRSQ3I4X24xQ1hlUjQ4NVpodkNFQWlBbzJ4RXJnWGJ2QUhYenJjWXNZUko3ak9PcHlqSzJtcjN6aUN4OWJ6cDF5ZyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiOTJlOWNjZGZjZDg4MWFmN2RmYjljZTJmNGY1N2Q0MGUwOWJjNWE1NDZkYzM5NTAyZTZjOGUyNmEyZjFjN2NmYSJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴 下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー マグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして 使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | [2025-10-30 11:07:57,778] INFO in v2.common.base_agent:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message
ap2_merchant_agent         |   受信メッセージ: ID=2a8949af-66ed-406d-bc95-589a41c07c5a
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.779526Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:shopping_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.779921Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"2a8949af-66ed-406d-bc95-589a41c07c5a\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:07:57.756422Z\", \"nonce\": \"0f5f881ca22c7a6e4e8a2b0ffeb1e52f327a2ebbd0be1aed66b4b218b0801ba4\", \"schema_version\": \"0.2\"}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56Y3NJbVY0Y0NJNk1UYzJNVGd5TWpjM055d2libUptSWpveE56WXhPREl5TkRjM0xDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpFZW1KNExXY3lWVmxTT1dOeVNUZDVhekJ1U1hKVlpIRmlMVE5TU21SWVJ6RjFlSFZLYzJaVVRYQmpJaXdpYVdGMElqb3hOell4T0RJeU5EYzNMQ0p6WkY5b1lYTm9Jam9pWmpjeU5Ea3hOMkUzWWpnNU1HTTNaVFU0TVRBMlpXWmxOR0UwWWpKalltWXpabUZpWm1SbFlUWmtZbUZoWmpobFpqbGhNRFpqTmpsaU5qZzNPR1k0T0NJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lOVFk1TXpJek1tSTJNemRrWmpRMlptVXlaVEZqWm1Nd016RXdPREkzTldKbU9UWm1Nakl5TUdSaU9HSTVZemN5WXpNNVlXTm1NMk0zT1RZd1pXVm1OQ0lzSWpreVpUbGpZMlJtWTJRNE9ERmhaamRrWm1JNVkyVXlaalJtTlRka05EQmxNRGxpWXpWaE5UUTJaR016T1RVd01tVTJZemhsTWpaaE1tWXhZemRqWm1FaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IbE5iVmswVFVkRk1rMTVTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVozbE5hbEV6VGxSak1rMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lBdDRTLTlGeWhkNmdXeE1Tbm5LWkFoaVRSQ3I4X24xQ1hlUjQ4NVpodkNFQWlBbzJ4RXJnWGJ2QUhYenJjWXNZUko3ak9PcHlqSzJtcjN6aUN4OWJ6cDF5ZyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiOTJlOWNjZGZjZDg4MWFmN2RmYjljZTJmNGY1N2Q0MGUwOWJjNWE1NDZkYzM5NTAyZTZjOGUyNmEyZjFjN2NmYSJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされた かわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.780282Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=0f5f881ca22c7a6e...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.780489Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:shopping_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.780909Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.781448Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 6900, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_22f80a63\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\",\"cart_name\":\"コスパ最優先プラン (3,8", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.781495Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.785016Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.785105Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.785168Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:shopping_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.785345Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Received PaymentRequest from Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.785409Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Forwarding PaymentMandate to Payment Processor: payment_mandate_id=payment_22f80a63", "module": "payment_handler", "function": "handle_payment_request", "line": 51}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.785823Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.786195Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 6903, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_22f80a63\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\",\"cart_name\":\"コスパ最優先プラン (3,8", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.786229Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.786931Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.787005Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:payment_processor: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.787092Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:payment_processor\", \"headers\": {\"message_id\": \"acca1c45-a046-48ac-91b4-7b40ccddd176\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T11:07:57.785455Z\", \"nonce\": \"86eb495fc8da902b4ccc6b4ab5797c9b68c73bd168ec3a3de0742128b678f83d\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56Y3NJbVY0Y0NJNk1UYzJNVGd5TWpjM055d2libUptSWpveE56WXhPREl5TkRjM0xDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpFZW1KNExXY3lWVmxTT1dOeVNUZDVhekJ1U1hKVlpIRmlMVE5TU21SWVJ6RjFlSFZLYzJaVVRYQmpJaXdpYVdGMElqb3hOell4T0RJeU5EYzNMQ0p6WkY5b1lYTm9Jam9pWmpjeU5Ea3hOMkUzWWpnNU1HTTNaVFU0TVRBMlpXWmxOR0UwWWpKalltWXpabUZpWm1SbFlUWmtZbUZoWmpobFpqbGhNRFpqTmpsaU5qZzNPR1k0T0NJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lOVFk1TXpJek1tSTJNemRrWmpRMlptVXlaVEZqWm1Nd016RXdPREkzTldKbU9UWm1Nakl5TUdSaU9HSTVZemN5WXpNNVlXTm1NMk0zT1RZd1pXVm1OQ0lzSWpreVpUbGpZMlJtWTJRNE9ERmhaamRrWm1JNVkyVXlaalJtTlRka05EQmxNRGxpWXpWaE5UUTJaR016T1RVd01tVTJZemhsTWpaaE1tWXhZemRqWm1FaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IbE5iVmswVFVkRk1rMTVTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVozbE5hbEV6VGxSak1rMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lBdDRTLTlGeWhkNmdXeE1Tbm5LWkFoaVRSQ3I4X24xQ1hlUjQ4NVpodkNFQWlBbzJ4RXJnWGJ2QUhYenJjWXNZUko3ak9PcHlqSzJtcjN6aUN4OWJ6cDF5ZyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiOTJlOWNjZGZjZDg4MWFmN2RmYjljZTJmNGY1N2Q0MGUwOWJjNWE1NDZkYzM5NTAyZTZjOGUyNmEyZjFjN2NmYSJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎ ぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.787200Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent → PaymentProcessor] A2Aメッセージ転送\n  URL: http://payment_processor:8004/a2a/message\n  メッセージID: acca1c45-a046-48ac-91b4-7b40ccddd176\n  タイプ: ap2.mandates.PaymentMandate\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 69}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.787565Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://payment_processor:8004/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:57.787669Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://payment_processor:8004/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"acca1c45-a046-48ac-91b4-7b40ccddd176\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T11:07:57.785455Z\", \"nonce\": \"86eb495fc8da902b4ccc6b4ab5797c9b68c73bd168ec3a3de0742128b678f83d\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"0HCTT9zbqMOTrZmQCMBMg1eBJ3D54wlYqSRzMm28AFn0/TsF5u9yDjeFi+UxMj1iYxC+GSiFemVYD3xSMTwRDg==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVlOOU9NNE5heDdRajdUdEFWU25QL1k4V0RzYlg2VFRqdVVpSGtZUWNCK2c9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T11:07:57.785455Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.PaymentMandate\", \"id\": \"payment_22f80a63\", \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56Y3NJbVY0Y0NJNk1UYzJNVGd5TWpjM055d2libUptSWpveE56WXhPREl5TkRjM0xDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpFZW1KNExXY3lWVmxTT1dOeVNUZDVhekJ1U1hKVlpIRmlMVE5TU21SWVJ6RjFlSFZLYzJaVVRYQmpJaXdpYVdGMElqb3hOell4T0RJeU5EYzNMQ0p6WkY5b1lYTm9Jam9pWmpjeU5Ea3hOMkUzWWpnNU1HTTNaVFU0TVRBMlpXWmxOR0UwWWpKalltWXpabUZpWm1SbFlUWmtZbUZoWmpobFpqbGhNRFpqTmpsaU5qZzNPR1k0T0NJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lOVFk1TXpJek1tSTJNemRrWmpRMlptVXlaVEZqWm1Nd016RXdPREkzTldKbU9UWm1Nakl5TUdSaU9HSTVZemN5WXpNNVlXTm1NMk0zT1RZd1pXVm1OQ0lzSWpreVpUbGpZMlJtWTJRNE9ERmhaamRrWm1JNVkyVXlaalJtTlRka05EQmxNRGxpWXpWaE5UUTJaR016T1RVd01tVTJZemhsTWpaaE1tWXhZemRqWm1FaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IbE5iVmswVFVkRk1rMTVTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVozbE5hbEV6VGxSak1rMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lBdDRTLTlGeWhkNmdXeE1Tbm5LWkFoaVRSQ3I4X24xQ1hlUjQ4NVpodkNFQWlBbzJ4RXJnWGJ2QUhYenJjWXNZUko3ak9PcHlqSzJtcjN6aUN4OWJ6cDF5ZyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiOTJlOWNjZGZjZDg4MWFmN2RmYjljZTJmNGY1N2Q0MGUwOWJjNWE1NDZkYzM5NTAyZTZjOGUyNmEyZjFjN2NmYSJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎ ぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"む ぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \" 送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいア イテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケー スとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_processor      | [2025-10-30 11:07:57,972] INFO in v2.common.base_agent:
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | [Payment Processor] A2Aエンドポイント: POST /a2a/message
ap2_payment_processor      |   受信メッセージ: ID=acca1c45-a046-48ac-91b4-7b40ccddd176
ap2_payment_processor      |   送信元: did:ap2:agent:merchant_agent
ap2_payment_processor      |   タイプ: ap2.mandates.PaymentMandate
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.974470Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:merchant_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.975376Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"acca1c45-a046-48ac-91b4-7b40ccddd176\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T11:07:57.785455Z\", \"nonce\": \"86eb495fc8da902b4ccc6b4ab5797c9b68c73bd168ec3a3de0742128b678f83d\", \"schema_version\": \"0.2\"}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_22f80a63\", \"payment_details_id\": \"order_009edf10\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****3333\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T11:07:54.795723Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpVM04ySTBZMkprWWpFMVpUUm1OV1FpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelUzTjJJMFkySmtZakUxWlRSbU5XUWlMQ0pwWVhRaU9qRTNOakU0TWpJME56Y3NJbVY0Y0NJNk1UYzJNVGd5TWpjM055d2libUptSWpveE56WXhPREl5TkRjM0xDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVYwRlVWVXA2Ym5GbFh6Vk9hMjVFZEZZemRsRnpUVTlEWmtaUU5VZGxNV1ZXZWxwcmRXRmtRVmxWVlNJc0lua2lPaUl5ZGxaV0xVbHVhbmxDT1d3dFRUVTFUMGg0WHpoWGVWSlZWMXBZWTB0amRqbFdjMWhFTFhwRVpqQTRJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpFZW1KNExXY3lWVmxTT1dOeVNUZDVhekJ1U1hKVlpIRmlMVE5TU21SWVJ6RjFlSFZLYzJaVVRYQmpJaXdpYVdGMElqb3hOell4T0RJeU5EYzNMQ0p6WkY5b1lYTm9Jam9pWmpjeU5Ea3hOMkUzWWpnNU1HTTNaVFU0TVRBMlpXWmxOR0UwWWpKalltWXpabUZpWm1SbFlUWmtZbUZoWmpobFpqbGhNRFpqTmpsaU5qZzNPR1k0T0NJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lOVFk1TXpJek1tSTJNemRrWmpRMlptVXlaVEZqWm1Nd016RXdPREkzTldKbU9UWm1Nakl5TUdSaU9HSTVZemN5WXpNNVlXTm1NMk0zT1RZd1pXVm1OQ0lzSWpreVpUbGpZMlJtWTJRNE9ERmhaamRrWm1JNVkyVXlaalJtTlRka05EQmxNRGxpWXpWaE5UUTJaR016T1RVd01tVTJZemhsTWpaaE1tWXhZemRqWm1FaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6ImV0OWQzblVrR1p2RVhlUHExQ0FHcjJRIiwicmF3SWQiOiJldDlkM25Va0dadkVYZVBxMUNBR3IyUSIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IbE5iVmswVFVkRk1rMTVTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVozbE5hbEV6VGxSak1rMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lBdDRTLTlGeWhkNmdXeE1Tbm5LWkFoaVRSQ3I4X24xQ1hlUjQ4NVpodkNFQWlBbzJ4RXJnWGJ2QUhYenJjWXNZUko3ak9PcHlqSzJtcjN6aUN4OWJ6cDF5ZyIsInVzZXJIYW5kbGUiOiJ1c3JfNTc3YjRjYmRiMTVlNGY1ZCJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHlNbVk0TUdFMk15SXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZ3lNalEzTlRjMk1IMCJ9LCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0IiwicGF5bWVudF9oYXNoIjoiOTJlOWNjZGZjZDg4MWFmN2RmYjljZTJmNGY1N2Q0MGUwOWJjNWE1NDZkYzM5NTAyZTZjOGUyNmEyZjFjN2NmYSJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_22f80a63\", \"cart_mandate_id\": \"cart_b7751f85\", \"intent_mandate_id\": \"intent_beef923e\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"last4\": \"3333\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_b7751f85\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_b7751f85\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-30T12:07:44.603210Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTgyMjQ2NCwiZXhwIjoxNzYxODI2MDY0LCJqdGkiOiJiZjg3OGJlYS04YzAyLTRjMmYtOGZjMy0zMjhmYzRlZDIyZjEiLCJjYXJ0X2hhc2giOiI1NjkzMjMyYjYzN2RmNDZmZTJlMWNmYzAzMTA4Mjc1YmY5NmYyMjIwZGI4YjljNzJjMzlhY2YzYzc5NjBlZWY0In0.MEQCIEljeBYBDxGWh8vfdfcqiSvSlso6S1y7fXUsrkkRnaMfAiA6yDJMchlawS5uDh4k5qRrtPKQpcUU_NZZxK8PJxXXaA\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T11:07:44.603291Z\", \"cart_name\": \"コスパ最優先プラン (3,800円)\", \"cart_description\": \"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\", \"raw_items\": [{\"product_id\": \"b8444ff4-1fec-4589-bf16-ef3639b59e61\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"16c5a5f5-bf3a-446c-834e-dfc8453bec8c\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼ ーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f22bbef3-ac71-42dd-9487-bd626c3a24d3\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8a4be9a4-b828-46d0-8921-ac6d1b1caf9a\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントさ れたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"Y9HhXQ5TeNfqPHc1apd/vOpKehV/EihHmWw5li37M287Iv0EQbjjttZ5z5TXUvxDecM3Qdcqnp0ZvAU8RzGeDw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWpDNmQ4T2VNVmR0SXdkRjlTaE5mTzRuZ3NCUXlNb25hUzB1SUhrN3FUdUE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T11:07:44.889377Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.977658Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=86eb495fc8da902b...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.978649Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:merchant_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.983346Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.987465Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 6903, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_22f80a63\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"価格重視で、かわいいアイテムを4点セットで購入。予算内で最大の数を確保。\",\"cart_name\":\"コスパ最優先プラン (3,8", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:57.988217Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.005360Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:merchant_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.005639Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:merchant_agent, alg=ed25519, kid=did:ap2:agent:merchant_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.005688Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:merchant_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.005769Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Received PaymentMandate", "module": "processor", "function": "handle_payment_mandate", "line": 366}
ap2_payment_processor      | [2025-10-30 11:07:58,006] INFO in services.payment_processor.utils.mandate_helpers: [PaymentProcessor] PaymentMandate validation passed: payment_22f80a63, user_authorization present: eyJpc3N1ZXJfand0Ijoi...
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.006357Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation: PaymentMandate(payment_22f80a63) → CartMandate(cart_b7751f85)", "module": "processor", "function": "_validate_mandate_chain", "line": 622}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.010430Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying SD-JWT-VC user_authorization: cart_hash=5693232b637df46f..., payment_hash=92e9ccdfcd881af7...", "module": "processor", "function": "_validate_mandate_chain", "line": 639}
ap2_payment_processor      | [2025-10-30 11:07:58,011] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Decoded VP successfully
ap2_payment_processor      | [2025-10-30 11:07:58,012] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Hash verification passed: cart_hash=5693232b637df46f..., payment_hash=92e9ccdfcd881af7...
ap2_payment_processor      | [2025-10-30 11:07:58,017] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ WebAuthn signature verified successfully
ap2_payment_processor      | [2025-10-30 11:07:58,018] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Key-binding JWT payload verified
ap2_payment_processor      | [2025-10-30 11:07:58,018] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ VP verification passed
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.018146Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ SD-JWT-VC user_authorization verified: cart_hash_match=True, payment_hash_match=True, webauthn_signature_verified=True", "module": "processor", "function": "_validate_mandate_chain", "line": 652}
ap2_payment_processor      | [2025-10-30 11:07:58,021] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor      | [2025-10-30 11:07:58,023] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor      | [2025-10-30 11:07:58,023] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor      | [2025-10-30 11:07:58,028] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor      | [2025-10-30 11:07:58,029] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor      | [2025-10-30 11:07:58,032] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor      | [2025-10-30 11:07:58,033] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor      | [2025-10-30 11:07:58,037] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor      | [2025-10-30 11:07:58,038] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor      | [2025-10-30 11:07:58,040] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor      | [2025-10-30 11:07:58,040] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor      | [2025-10-30 11:07:58,042] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor      | [2025-10-30 11:07:58,043] INFO in services.payment_processor.utils.jwt_helpers: [_verify_jwt_signature] ✓ JWT signature verified successfully
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.043279Z", "level": "INFO", "logger": "processor", "message": "[_verify_merchant_authorization_jwt] JWT validation passed: iss=did:ap2:merchant:mugibo_merchant, exp=1761826064, jti=bf878bea-8c02-4c..., cart_hash=5693232b637df46f...", "module": "processor", "function": "_verify_merchant_authorization_jwt", "line": 564}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.043330Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] merchant_authorization JWT verified: iss=did:ap2:merchant:mugibo_merchant", "module": "processor", "function": "_validate_mandate_chain", "line": 676}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.043342Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] CartMandate hash in merchant_authorization: 5693232b637df46f...", "module": "processor", "function": "_validate_mandate_chain", "line": 684}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.044266Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ CartMandate hash verified (merchant_authorization): 5693232b637df46f...", "module": "processor", "function": "_validate_mandate_chain", "line": 701}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.044299Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation passed", "module": "processor", "function": "_validate_mandate_chain", "line": 733}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.048252Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Processing payment (mock): txn_20fc22288e85", "module": "processor", "function": "_process_payment_mock", "line": 752}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.048492Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying credential with Credential Provider: token=tok_0fd14ab4_9cIm6pE...", "module": "processor", "function": "_verify_credential_with_cp", "line": 867}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.052807Z", "level": "INFO", "logger": "processor", "message": "HTTP Request: POST http://credential_provider:8003/credentials/verify", "module": "logger", "function": "log_http_request", "line": 182}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.052895Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/credentials/verify\", \"headers\": {}, \"body\": {\"token\": \"tok_0fd14ab4_9cIm6pE4viT0PDX_-49kjKR6\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:58.072231Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Verifying token for payer: usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_credentials", "line": 1559}
ap2_credential_provider    | {"timestamp": "2025-10-30T11:07:58.078292Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Token verified: payment_method_id=pm_1486a851, user_id=usr_577b4cbdb15e4f5d", "module": "provider", "function": "verify_credentials", "line": 1596}
ap2_credential_provider    | INFO:     172.18.0.10:36162 - "POST /credentials/verify HTTP/1.1" 200 OK
ap2_payment_processor      | [2025-10-30 11:07:58,081] INFO in httpx: HTTP Request: POST http://credential_provider:8003/credentials/verify "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.082127Z", "level": "INFO", "logger": "processor", "message": "HTTP Response: 200 (29.33ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.082175Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"186\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"credential_info\": {\"payment_method_id\": \"pm_1486a851\", \"type\": \"basic-card\", \"brand\": \"Visa\", \"last4\": \"3333\", \"holder_name\": \"Unknown\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}}, \"duration_ms\": 29.33359146118164}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.082271Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verification succeeded: payment_method_id=pm_1486a851", "module": "processor", "function": "_verify_credential_with_cp", "line": 902}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.082290Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verified: pm_1486a851", "module": "processor", "function": "_process_payment_mock", "line": 775}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.082453Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Risk assessment: score=3, indicators=['card_not_present_transaction']", "module": "processor", "function": "_process_payment_mock", "line": 790}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.082600Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Payment succeeded: txn_20fc22288e85, amount={'value': 4680.0, 'currency': 'JPY'}, risk_score=3", "module": "processor", "function": "_process_payment_mock", "line": 824}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.124575Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Transaction saved: txn_20fc22288e85", "module": "processor", "function": "_save_transaction", "line": 851}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.342474Z", "level": "WARNING", "logger": "processor", "message": "[PaymentProcessor] User not found for payer_id: usr_577b4cbdb15e4f5d, using default name", "module": "processor", "function": "_generate_receipt", "line": 1059}
ap2_payment_processor      | [2025-10-30 11:07:58,342] INFO in v2.common.receipt_generator: [ReceiptGenerator] Generating PDF receipt for transaction: txn_20fc22288e85
ap2_payment_processor      | [2025-10-30 11:07:58,347] INFO in v2.common.receipt_generator: [ReceiptGenerator] PDF receipt generated successfully
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.348591Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Generated receipt PDF: /app/v2/data/receipts/txn_20fc22288e85.pdf", "module": "processor", "function": "_generate_receipt", "line": 1080}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.352708Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt record saved to database: txn_20fc22288e85", "module": "processor", "function": "_generate_receipt", "line": 1099}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.352942Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Sending receipt notification to Credential Provider: transaction_id=txn_20fc22288e85, payer_id=usr_577b4cbdb15e4f5d", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 931}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.353101Z", "level": "INFO", "logger": "processor", "message": "HTTP Request: POST http://credential_provider:8003/receipts", "module": "logger", "function": "log_http_request", "line": 182}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.353132Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/receipts\", \"headers\": {}, \"body\": {\"transaction_id\": \"txn_20fc22288e85\", \"receipt_url\": \"http://localhost:8004/receipts/txn_20fc22288e85.pdf\", \"payer_id\": \"usr_577b4cbdb15e4f5d\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}, \"timestamp\": \"2025-10-30T11:07:58.353077Z\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_processor      | [2025-10-30 11:07:58,366] INFO in httpx: HTTP Request: POST http://credential_provider:8003/receipts "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.367281Z", "level": "INFO", "logger": "processor", "message": "HTTP Response: 200 (14.15ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.367321Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:58 GMT\", \"server\": \"uvicorn\", \"content-length\": \"97\", \"content-type\": \"application/json\"}, \"body\": {\"status\": \"received\", \"message\": \"Receipt stored successfully\", \"transaction_id\": \"txn_20fc22288e85\"}, \"duration_ms\": 14.151573181152344}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.367422Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt notification sent successfully: transaction_id=txn_20fc22288e85, status=200", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 962}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.367467Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.368372Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.368438Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 521, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"d3b3c803-3d4c-4838-8ee2-c70cf360625b\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_20fc22288e85.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.368470Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.370561Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: payment_processor) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.371062Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.responses.PaymentResult", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_credential_provider    | [2025-10-30 11:07:58,366] INFO in services.credential_provider.utils.receipt_helpers: [CredentialProvider] Receipt received and stored to DB: transaction_id=txn_20fc22288e85, payer_id=usr_577b4cbdb15e4f5d, receipt_url=http://localhost:8004/receipts/txn_20fc22288e85.pdf
ap2_payment_processor      | {"timestamp": "2025-10-30T11:07:58.371093Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.PaymentResult\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"1aa3e5c2-cf61-434a-82a1-471f47605e5a\", \"sender\": \"did:ap2:agent:payment_processor\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:07:58.367503Z\", \"nonce\": \"f78b68fefbc47d5d030ff7c1d0f54bf6ccb41f1a2be8254d0d7ca2d0fda23a31\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"transaction_id\": \"txn_20fc22288e85\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_20fc22288e85.pdf\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}


ap2_credential_provider    | INFO:     172.18.0.10:36162 - "POST /receipts HTTP/1.1" 200 OK
ap2_payment_processor      | [2025-10-30 11:07:58,371] INFO in v2.common.base_agent: [Payment Processor] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:merchant_agent
ap2_payment_processor      | INFO:     172.18.0.9:37462 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.376436Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (588.78ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.376595Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"991\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"1aa3e5c2-cf61-434a-82a1-471f47605e5a\", \"sender\": \"did:ap2:agent:payment_processor\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T11:07:58.367503Z\", \"nonce\": \"f78b68fefbc47d5d030ff7c1d0f54bf6ccb41f1a2be8254d0d7ca2d0fda23a31\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"lUavMstyTVqMpKoZtyL+r3ISNLKx1pmZTDDeWitw4k6tDaXUH9GytBDJ0y7DFUFD5fR7Lbm7z+VJrefD/urTAw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVQzaDBpcWp3UEhkakFxSjVNSDZqbXFYTGZpQjN1R096Y0ZnVzZoN0lSMVE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:payment_processor#key-2\", \"created\": \"2025-10-30T11:07:58.367503Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.PaymentResult\", \"id\": \"d3b3c803-3d4c-4838-8ee2-c70cf360625b\", \"payload\": {\"transaction_id\": \"txn_20fc22288e85\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_20fc22288e85.pdf\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 588.7808799743652}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.378324Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent ← PaymentProcessor] A2Aレスポンス受信\n  Status: 200\n  Response Body: {\n  \"header\": {\n    \"message_id\": \"1aa3e5c2-cf61-434a-82a1-471f47605e5a\",\n    \"sender\": \"did:ap2:agent:payment_processor\",\n    \"recipient\": \"did:ap2:agent:merchant_agent\",\n    \"timestamp\": \"2025-10-30T11:07:58.367503Z\",\n    \"nonce\": \"f78b68fefbc47d5d030ff7c1d0f54bf6ccb41f1a2be8254d0d7ca2d0fda23a31\",\n    \"schema_version\": \"0.2\",\n    \"proof\": {\n      \"algorithm\": \"ed25519\",\n      \"signatureValue\": \"lUavMstyTVqMpKoZtyL+r3ISNLKx1pmZTDDeWitw4k6tDaXUH9GytBDJ0y7DFUFD5fR7Lbm7z+VJrefD/urTAw==\",\n      \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVQzaDBpcWp3UEhkakFxSjVNSDZqbXFYTGZpQjN1R096Y0ZnVzZoN0lSMVE9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\",\n      \"kid\": \"did:ap2:agent:payment_processor#key-2\",\n      \"created\": \"2025-10-30T11:07:58.367503Z\",\n      \"proofPurpose\": \"authentication\"\n    },\n    \"signature\": null\n  },\n  \"dataPart\": {\n    \"@type\": \"ap2.responses.PaymentResult\",\n    \"id\": \"d3b3c803-3d4c-4838-8ee2-c70cf360625b\",\n    \"payload\": {\n      \"transaction_id\": \"txn_20fc22288e85\",\n      \"status\": \"captured\",\n      \"receipt_url\": \"http://localhost:8004/receipts/txn_20fc22288e85.pdf\"\n    },\n    \"kind\": null,\n    \"artifact\": null\n  }\n}\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 86}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.378437Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Payment processing completed, forwarding result to Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 101}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.378497Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.378829Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.378938Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 518, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"d3b3c803-3d4c-4838-8ee2-c70cf360625b\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_20fc22288e85.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.379035Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.379398Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.379486Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:shopping_agent: ap2.responses.PaymentResult", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T11:07:58.379530Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.PaymentResult\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"9434d098-585e-4a35-8ab1-83dd4ef85ada\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T11:07:58.378540Z\", \"nonce\": \"aa1cef5883dce4daebe7896adf98b6e86df6b1185f40db62303dffac4abfd3c9\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"transaction_id\": \"txn_20fc22288e85\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_20fc22288e85.pdf\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | [2025-10-30 11:07:58,379] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | INFO:     172.18.0.8:35670 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:58.385187Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (624.53ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:58.385400Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 11:07:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"985\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"9434d098-585e-4a35-8ab1-83dd4ef85ada\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T11:07:58.378540Z\", \"nonce\": \"aa1cef5883dce4daebe7896adf98b6e86df6b1185f40db62303dffac4abfd3c9\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"cx7Jjba7DhZGDMNjzjJuDlZmwtBxO3fwOj/9q43mx8J5VtdGuPs1E2jd6fh66HzfOR5F2VfIlDGLXiAjNloPBA==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVlOOU9NNE5heDdRajdUdEFWU25QL1k4V0RzYlg2VFRqdVVpSGtZUWNCK2c9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T11:07:58.378540Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.PaymentResult\", \"id\": \"d3b3c803-3d4c-4838-8ee2-c70cf360625b\", \"payload\": {\"transaction_id\": \"txn_20fc22288e85\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_20fc22288e85.pdf\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 624.530553817749}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 11:07:58,385] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_shopping_agent         |   Response Type: ap2.responses.PaymentResult
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-30 11:07:58,385] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Payment processing completed: status=captured
ap2_shopping_agent         | [2025-10-30 11:07:58,386] INFO in services.shopping_agent.langgraph_shopping_flow: [execute_payment_node] Payment successful: status=captured, transaction_id=txn_20fc22288e85
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:58.433433Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=completed", "module": "agent", "function": "_update_session", "line": 1962}
ap2_shopping_agent         | {"timestamp": "2025-10-30T11:07:58.438673Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761822253905_ms7its, step=completed", "module": "agent", "function": "_update_session", "line": 1962}

