Attaching to ap2_credential_provider, ap2_credential_provider_2, ap2_frontend, ap2_init_keys, ap2_init_seeds, ap2_jaeger, ap2_meilisearch, ap2_merchant, ap2_merchant_agent, ap2_merchant_agent_mcp, ap2_payment_network, ap2_payment_processor, ap2_redis, ap2_shopping_agent, ap2_shopping_agent_mcp
ap2_jaeger  | 2025/10/30 23:37:50 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
ap2_jaeger  |
ap2_jaeger  | *******************************************************************************
ap2_jaeger  |
ap2_jaeger  | 🛑  WARNING: End-of-life Notice for Jaeger v1
ap2_jaeger  |
ap2_jaeger  | You are currently running a v1 version of Jaeger, which is deprecated and will
ap2_jaeger  | reach end-of-life on December 31st, 2025. This means there will be no further
ap2_jaeger  | development, bug fixes, or security patches for v1 after this date.
ap2_jaeger  |
ap2_jaeger  | We strongly recommend migrating to Jaeger v2 for continued support and access
ap2_jaeger  | to new features.
ap2_jaeger  |
ap2_jaeger  | For detailed migration instructions, please refer to the official Jaeger
ap2_jaeger  | documentation:  https://www.jaegertracing.io/docs/latest/migration/
ap2_jaeger  |
ap2_jaeger  | Tracking issue: https://github.com/jaegertracing/jaeger/issues/6321
ap2_jaeger  |
ap2_jaeger  | 🛑  WARNING: End-of-life Notice for Jaeger v1
ap2_jaeger  |
ap2_jaeger  | *******************************************************************************
ap2_jaeger  | 2025/10/30 23:37:50 application version: git-commit=a204929483c734da6c54eaa75f3f7c322b3e886b, git-version=v1.74.0, build-date=2025-10-03T02:41:46Z
ap2_jaeger  | {"level":"info","ts":1761867470.6574187,"caller":"flags/service.go:124","msg":"Mounting metrics handler on admin server","route":"/metrics"}
ap2_jaeger  | {"level":"info","ts":1761867470.6797545,"caller":"flags/service.go:130","msg":"Mounting expvar handler on admin server","route":"/debug/vars"}
ap2_jaeger  | {"level":"info","ts":1761867470.714026,"caller":"flags/admin.go:106","msg":"Mounting health check on admin server","route":"/"}
ap2_jaeger  | {"level":"info","ts":1761867470.7159686,"caller":"flags/admin.go:123","msg":"Starting admin HTTP server"}
ap2_jaeger  | {"level":"info","ts":1761867470.7170625,"caller":"flags/admin.go:137","msg":"Admin server started","http.host-port":"[::]:14269","health-status":"unavailable"}
ap2_jaeger  | {"level":"info","ts":1761867470.72253,"caller":"grpc@v1.75.0/clientconn.go:176","msg":"[core] original dial target is: \"localhost:4317\""}
ap2_jaeger  | {"level":"info","ts":1761867470.7236347,"caller":"grpc@v1.75.0/clientconn.go:459","msg":"[core] [Channel #1]Channel created"}
ap2_jaeger  | {"level":"info","ts":1761867470.7238927,"caller":"grpc@v1.75.0/clientconn.go:207","msg":"[core] [Channel #1]parsed dial target is: resolver.Target{URL:url.URL{Scheme:\"dns\", Opaque:\"\", User:(*url.Userinfo)(nil), Host:\"\", Path:\"/localhost:4317\", RawPath:\"\", OmitHost:false, ForceQuery:false, RawQuery:\"\", Fragment:\"\", RawFragment:\"\"}}"}
ap2_meilisearch  |
ap2_meilisearch  | 888b     d888          d8b 888 d8b                                            888
ap2_meilisearch  | 8888b   d8888          Y8P 888 Y8P                                            888
ap2_meilisearch  | 88888b.d88888              888                                                888
ap2_meilisearch  | 888Y88888P888  .d88b.  888 888 888 .d8888b   .d88b.   8888b.  888d888 .d8888b 88888b.
ap2_meilisearch  | 888 Y888P 888 d8P  Y8b 888 888 888 88K      d8P  Y8b     "88b 888P"  d88P"    888 "88b
ap2_meilisearch  | 888  Y8P  888 88888888 888 888 888 "Y8888b. 88888888 .d888888 888    888      888  888
ap2_meilisearch  | 888   "   888 Y8b.     888 888 888      X88 Y8b.     888  888 888    Y88b.    888  888


ap2_jaeger       | {"level":"info","ts":1761867470.730092,"caller":"grpc@v1.75.0/clientconn.go:208","msg":"[core] [Channel #1]Channel authority set to \"localhost:4317\""}
ap2_jaeger       | {"level":"info","ts":1761867470.7351356,"caller":"memory/factory.go:75","msg":"Memory storage initialized","configuration":{"MaxTraces":0}}
ap2_meilisearch  | 888       888  "Y8888  888 888 888  88888P'  "Y8888  "Y888888 888     "Y8888P 888  888
ap2_meilisearch  |
ap2_meilisearch  | Config file path:    "none"
ap2_meilisearch  | Database path:               "./data.ms"
ap2_meilisearch  | Server listening on: "http://0.0.0.0:7700"
ap2_meilisearch  | Environment:         "development"
ap2_meilisearch  | Commit SHA:          "cfaac6f7ca55e91ec3cf40f8682f528cd8743562"
ap2_meilisearch  | Commit date:         "2024-11-14T15:55:14Z"
ap2_meilisearch  | Package version:     "1.11.3"
ap2_meilisearch  | Anonymous telemetry: "Disabled"
ap2_meilisearch  |

ap2_redis        | 1:C 30 Oct 2025 23:37:50.760 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
ap2_meilisearch  | A master key has been set. Requests to Meilisearch won't be authorized unless you provide an authentication key.
ap2_meilisearch  |
ap2_meilisearch  |
ap2_meilisearch  |  Meilisearch started with a master key considered unsafe for use in a production environment.
ap2_meilisearch  |


ap2_redis        | 1:C 30 Oct 2025 23:37:50.760 * Redis version=7.4.6, bits=64, commit=00000000, modified=0, pid=1, just started
ap2_redis        | 1:C 30 Oct 2025 23:37:50.760 * Configuration loaded
ap2_redis        | 1:M 30 Oct 2025 23:37:50.763 * monotonic clock: POSIX clock_gettime
ap2_jaeger       | {"level":"info","ts":1761867470.783127,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #2]Server created"}
ap2_meilisearch  |  A master key of at least 16 bytes will be required when switching to a production environment.
ap2_meilisearch  |
ap2_meilisearch  |
ap2_meilisearch  | We generated a new secure master key for you (you can safely use this token):
ap2_meilisearch  |
ap2_meilisearch  | >> --master-key fXYJ40WzVsBkMUJF2u5KbCUdlmc3Owes5NrM8BU5FB8 <<
ap2_meilisearch  |
ap2_meilisearch  | Restart Meilisearch with the argument above to use this new and secure master key.
ap2_meilisearch  |

ap2_meilisearch  | Check out Meilisearch Cloud! https://www.meilisearch.com/cloud?utm_campaign=oss&utm_source=engine&utm_medium=cli
ap2_redis        | 1:M 30 Oct 2025 23:37:50.818 * Running mode=standalone, port=6379.
ap2_jaeger       | {"level":"info","ts":1761867470.8022566,"caller":"server/grpc.go:75","msg":"Starting jaeger-collector gRPC server","grpc.host-port":"[::]:14250"}
ap2_jaeger       | {"level":"info","ts":1761867470.8033342,"caller":"server/http.go:37","msg":"Starting jaeger-collector HTTP server","host-port":":14268"}
ap2_jaeger       | {"level":"info","ts":1761867470.8044348,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #2 ListenSocket #3]ListenSocket created"}
ap2_jaeger       | {"level":"info","ts":1761867470.8086667,"caller":"app/collector.go:128","msg":"Not listening for Zipkin HTTP traffic, port not configured"}
ap2_jaeger       | {"level":"info","ts":1761867470.8134897,"caller":"handler/otlp_receiver.go:75","msg":"OTLP receiver status change","status":"StatusStarting"}
ap2_jaeger       | {"level":"info","ts":1761867470.8142245,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #4]Server created"}
ap2_redis        | 1:M 30 Oct 2025 23:37:50.840 * Server initialized
ap2_jaeger       | {"level":"info","ts":1761867470.8142543,"caller":"otlpreceiver@v0.132.0/otlp.go:117","msg":"Starting GRPC server","endpoint":":4317"}
ap2_jaeger       | {"level":"info","ts":1761867470.8360193,"caller":"otlpreceiver@v0.132.0/otlp.go:175","msg":"Starting HTTP server","endpoint":":4318"}
ap2_jaeger       | {"level":"info","ts":1761867470.8361905,"caller":"app/flags.go:168","msg":"Archive storage not initialized"}
ap2_meilisearch  | Documentation:                       https://www.meilisearch.com/docs
ap2_meilisearch  | Source code:                 https://github.com/meilisearch/meilisearch
ap2_meilisearch  | Discord:                     https://discord.meilisearch.com

ap2_meilisearch  |
ap2_meilisearch  | 2025-10-30T23:37:50.738424Z  INFO actix_server::builder: starting 8 workers
ap2_meilisearch  | 2025-10-30T23:37:50.740371Z  INFO actix_server::server: Actix runtime found; starting in Actix runtime
ap2_redis        | 1:M 30 Oct 2025 23:37:50.852 * Reading RDB base file on AOF loading...go:715","msg":"[core] [Server #6]Server created"}
ap2_redis        | 1:M 30 Oct 2025 23:37:50.853 * Loading RDB produced by version 7.4.6
ap2_redis        | 1:M 30 Oct 2025 23:37:50.854 * RDB age 1431 seconds
ap2_redis        | 1:M 30 Oct 2025 23:37:50.854 * RDB memory usage when created 0.94 Mb
ap2_redis        | 1:M 30 Oct 2025 23:37:50.854 * RDB is base AOF
ap2_redis        | 1:M 30 Oct 2025 23:37:50.854 * Done loading RDB, keys loaded: 0, keys expired: 0.
ap2_redis        | 1:M 30 Oct 2025 23:37:50.855 * DB loaded from base file appendonly.aof.1.base.rdb: 0.008 seconds
ap2_jaeger       | {"level":"info","ts":1761867470.8489127,"caller":"app/static_handler.go:92","msg":"Using UI configuration","path":""}
ap2_jaeger       | {"level":"info","ts":1761867470.8497047,"caller":"app/server.go:258","msg":"Query server started","http_addr":"[::]:16686","grpc_addr":"[::]:16685"}

ap2_redis        | 1:M 30 Oct 2025 23:37:50.856 * DB loaded from incr file appendonly.aof.1.incr.aof: 0.001 seconds
ap2_redis        | 1:M 30 Oct 2025 23:37:50.856 * DB loaded from append only file: 0.009 seconds
ap2_jaeger       | {"level":"info","ts":1761867470.8498135,"caller":"healthcheck/handler.go:117","msg":"Health Check state change","status":"ready"}
ap2_jaeger       | {"level":"info","ts":1761867470.8498907,"caller":"app/server.go:300","msg":"Starting GRPC server","port":16685,"addr":":16685"}
ap2_jaeger       | {"level":"info","ts":1761867470.84996,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #6 ListenSocket #7]ListenSocket created"}
ap2_jaeger       | {"level":"info","ts":1761867470.850014,"caller":"app/server.go:286","msg":"Starting HTTP server","port":16686,"addr":":16686"}
ap2_jaeger       | {"level":"info","ts":1761867470.8377242,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #4 ListenSocket #5]ListenSocket created"}
ap2_redis        | 1:M 30 Oct 2025 23:37:50.856 * Opening AOF incr file appendonly.aof.1.incr.aof on server start
ap2_redis        | 1:M 30 Oct 2025 23:37:50.856 * Ready to accept connections tcp
ap2_init_keys    | ================================================================================
ap2_init_keys    | AP2 エージェント キーペア初期化
ap2_init_keys    | ================================================================================
ap2_init_keys    |
ap2_init_keys    | キー保存先: /app/v2/keys
ap2_init_keys    | DID Document保存先: /app/v2/data/did_documents
ap2_init_keys    |
ap2_init_keys    | [Shopping Agent]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/shopping_agent_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/shopping_agent_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/shopping_agent_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/shopping_agent_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/shopping_agent_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:agent:shopping_agent
ap2_init_keys    |
ap2_init_keys    | [Merchant Agent]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/merchant_agent_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_agent_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/merchant_agent_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_agent_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/merchant_agent_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:agent:merchant_agent
ap2_init_keys    |
ap2_init_keys    | [Merchant]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/merchant_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/merchant_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/merchant_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:merchant:mugibo_merchant
ap2_init_keys    |
ap2_init_keys    | [Credential Provider]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/credential_provider_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/credential_provider_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/credential_provider_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:cp:demo_cp
ap2_init_keys    |
ap2_init_keys    | [Credential Provider 2]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/credential_provider_2_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_2_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/credential_provider_2_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_2_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:cp:demo_cp_2
ap2_init_keys    |
ap2_init_keys    | [Payment Processor]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/payment_processor_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/payment_processor_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/payment_processor_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/payment_processor_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/payment_processor_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:agent:payment_processor
ap2_init_keys    |
ap2_init_keys    | ================================================================================
ap2_init_keys    | ✅ 全エージェントの初期化が完了しました
ap2_init_keys    | ================================================================================
ap2_init_keys    |
ap2_init_keys    | 次のステップ:
ap2_init_keys    |   1. docker-compose up -d でサービスを起動
ap2_init_keys    |   2. 各エージェントはキーを永続化ストレージから読み込みます
ap2_init_keys    |   3. DIDは再起動後も一貫して維持されます
ap2_init_keys    |
ap2_init_keys exited with code 0
ap2_init_seeds   | ================================================================================
ap2_init_seeds   | AP2 シードデータ投入 (AP2完全準拠)
ap2_init_seeds   | ================================================================================
ap2_init_seeds   |
ap2_init_seeds   | データ保存先: /app/v2/data
ap2_init_seeds   |
ap2_init_seeds   | AP2完全準拠のため、以下のデータのみ投入します：
ap2_init_seeds   |   ✅ 商品データ: Merchantが管理
ap2_init_seeds   |   ⚠️  ユーザーデータ: Passkey登録時に自動作成（フロントエンド）
ap2_init_seeds   |   ⚠️  支払い方法: Passkey登録後、ユーザーが登録（セキュリティ要件）
ap2_init_seeds   |
ap2_init_seeds   | [商品データ投入]
ap2_init_seeds   | データベース: sqlite+aiosqlite:////app/v2/data/merchant_agent.db
ap2_init_seeds   |   ✅ 作成: むぎぼーアクリルキーホルダー (¥800)
ap2_init_seeds   |   ✅ 作成: むぎぼー時計 (¥3500)
ap2_init_seeds   |   ✅ 作成: むぎぼーカレンダー (¥1500)
ap2_init_seeds   |   ✅ 作成: むぎぼーマグカップ (¥1200)
ap2_init_seeds   |   ✅ 作成: むぎぼーステッカー (¥500)
ap2_init_seeds   |   ✅ 作成: むぎぼーTシャツ (¥2800)
ap2_init_seeds   |   ✅ 作成: むぎぼートートバッグ (¥1800)
ap2_init_seeds   |   ✅ 作成: むぎぼーポーチ (¥950)
ap2_init_seeds   |   ✅ 作成: むぎぼーぬいぐるみ（S） (¥2200)
ap2_init_seeds   |   ✅ 作成: むぎぼーぬいぐるみ（L） (¥4800)
ap2_init_seeds   |   ✅ 作成: むぎぼーキャップ (¥2000)
ap2_init_seeds   |   ✅ 作成: むぎぼークッション (¥2500)
ap2_init_seeds   |   ✅ 作成: むぎぼーノート (¥700)
ap2_init_seeds   |   ✅ 作成: むぎぼーボールペン (¥600)
ap2_init_seeds   |   ✅ 作成: むぎぼーウォーターボトル (¥2400)
ap2_init_seeds   |   ✅ 作成: むぎぼー靴下 (¥850)
ap2_init_seeds   |   ✅ 作成: むぎぼーマウスパッド (¥900)
ap2_init_seeds   |   ✅ 作成: むぎぼースマホケース (¥1800)
ap2_init_seeds   |   ✅ 作成: むぎぼー折りたたみ傘 (¥2600)
ap2_init_seeds   |   ✅ 作成: むぎぼーエコバッグ (¥1200)
ap2_init_seeds   |   ✅ 作成: むぎぼーブランケット (¥3200)
ap2_init_seeds   |   ✅ 作成: むぎぼープレート皿 (¥1900)
ap2_init_seeds   |   ✅ 作成: むぎぼーパーカー (¥4500)
ap2_init_seeds   |   ✅ 作成: むぎぼーフェイスタオル (¥1300)
ap2_init_seeds   |   ✅ 作成: むぎぼーアロマキャンドル (¥2100)
ap2_init_seeds   |   ✅ 作成: むぎぼー抱き枕 (¥5500)
ap2_init_seeds   |   ✅ 作成: むぎぼーポスター (¥900)
ap2_init_seeds   |   ✅ 作成: むぎぼーニット帽 (¥1800)
ap2_init_seeds   |   ✅ 商品データ投入完了 (28件)
ap2_init_seeds   |
ap2_init_seeds   | ================================================================================
ap2_init_seeds   | ✅ 商品データの投入が完了しました (AP2完全準拠)
ap2_init_seeds   | ================================================================================
ap2_init_seeds   |
ap2_init_seeds   | 投入データサマリ:
ap2_init_seeds   |   - 商品: 28件 (merchant_agent.db)
ap2_init_seeds   |
ap2_init_seeds   | 次のステップ:
ap2_init_seeds   |   1. フロントエンド (http://localhost:3000) にアクセス
ap2_init_seeds   |   2. ユーザー登録 (/auth/register)
ap2_init_seeds   |   3. Passkey登録 (/auth/register-passkey)
ap2_init_seeds   |   4. 支払い方法登録（Passkey登録後に自動表示）
ap2_init_seeds   |
ap2_init_seeds exited with code 0
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:58.275711Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:58.280489Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: merchant_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:58.280688Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: search_products", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:58.280740Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: check_inventory", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:58.280774Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_cart_mandates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.486204Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: shopping_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.510069Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_intent_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.515454Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: request_cart_candidates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.515570Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: select_and_sign_cart", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.515649Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: assess_payment_risk", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.515720Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_payment_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.515798Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: execute_payment", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.919052Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}


ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.109050Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: shopping_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.928652Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: merchant_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.127055Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_intent_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.127138Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: request_cart_candidates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.127157Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: select_and_sign_cart", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.127173Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: assess_payment_risk", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.929461Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: search_products", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.929647Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: check_inventory", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.127202Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_payment_mandate", "module": "mcp_server", "function": "decorator", "line": 412}


ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:37:59.929735Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_cart_mandates", "module": "mcp_server", "function": "decorator", "line": 412}


ap2_merchant_agent_mcp  | INFO:     Started server process [1]
ap2_merchant_agent_mcp  | INFO:     Waiting for application startup.
ap2_merchant_agent_mcp  | INFO:     Application startup complete.
ap2_merchant_agent_mcp  | INFO:     Uvicorn running on http://0.0.0.0:8011 (Press CTRL+C to quit)
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.127219Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: execute_payment", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:02.193421Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Starting up...", "module": "main", "function": "lifespan", "line": 404}
ap2_shopping_agent_mcp  | INFO:     Started server process [1]
ap2_shopping_agent_mcp  | INFO:     Waiting for application startup.
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.163999Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Database initialized", "module": "main", "function": "lifespan", "line": 408}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.240177Z", "level": "INFO", "logger": "main", "message": "[Startup] KeyManager initialized with keys_directory=/app/v2/keys", "module": "main", "function": "lifespan", "line": 415}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.240513Z", "level": "INFO", "logger": "main", "message": "[Startup] Extracted key_id=shopping_agent from AGENT_ID=did:ap2:agent:shopping_agent", "module": "main", "function": "lifespan", "line": 419}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.240734Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.316451Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.316851Z", "level": "INFO", "logger": "main", "message": "[Startup] ED25519 private key loaded for shopping_agent", "module": "main", "function": "lifespan", "line": 425}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.317018Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.357462Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.357669Z", "level": "INFO", "logger": "main", "message": "[Startup] ECDSA private key loaded for shopping_agent", "module": "main", "function": "lifespan", "line": 433}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.358096Z", "level": "INFO", "logger": "main", "message": "[Startup] SignatureManager initialized", "module": "main", "function": "lifespan", "line": 443}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.416664Z", "level": "INFO", "logger": "main", "message": "[Startup] A2AMessageHandler initialized with key_id: shopping_agent", "module": "main", "function": "lifespan", "line": 451}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.416988Z", "level": "INFO", "logger": "main", "message": "[Startup] RiskAssessmentEngine initialized", "module": "main", "function": "lifespan", "line": 455}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:38:04.417018Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Startup complete", "module": "main", "function": "lifespan", "line": 457}
ap2_shopping_agent_mcp  | INFO:     Application startup complete.
ap2_shopping_agent_mcp  | INFO:     Uvicorn running on http://0.0.0.0:8010 (Press CTRL+C to quit)
ap2_frontend            |    ▲ Next.js 15.5.5
ap2_frontend            |    - Local:        http://localhost:3000
ap2_frontend            |    - Network:      http://0.0.0.0:3000
ap2_frontend            |
ap2_frontend            |  ✓ Starting...
ap2_frontend            |  ✓ Ready in 456ms
ap2_payment_network     | [2025-10-30 23:38:11,291] INFO in network: [DemoPaymentNetwork] Payment Network Service initialized
ap2_payment_network     |   Redis URL: redis://redis:6379/2
ap2_payment_network     |   Token Store: RedisベースのKVストア（TTL管理対応）
ap2_payment_network     | [2025-10-30 23:38:11,522] INFO in network: [DemoPaymentNetwork] Payment Network Service initialized
ap2_payment_network     |   Redis URL: redis://redis:6379/2
ap2_payment_network     |   Token Store: RedisベースのKVストア（TTL管理対応）
ap2_payment_network     | INFO:     Started server process [1]
ap2_payment_network     | INFO:     Waiting for application startup.
ap2_payment_network     | INFO:     Application startup complete.
ap2_payment_network     | INFO:     Uvicorn running on http://0.0.0.0:8005 (Press CTRL+C to quit)
ap2_merchant            | [2025-10-30 23:38:12,784] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_merchant            | [2025-10-30 23:38:12,785] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_merchant            |   Service Name: merchant
ap2_merchant            |   OTLP Endpoint: http://jaeger:4317
ap2_merchant            |   Insecure: True
ap2_merchant            | [2025-10-30 23:38:12,937] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: merchant
ap2_merchant            | [2025-10-30 23:38:12,938] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 23:38:12,939] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | [2025-10-30 23:38:12,941] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 23:38:12,941] INFO in v2.common.base_agent: [Merchant] OpenTelemetry distributed tracing enabled (service: merchant, manual instrumentation only)
ap2_merchant            | {"timestamp": "2025-10-30T23:38:12.973679Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 23:38:13,027] INFO in v2.common.base_agent: [Merchant] ✓ ECDSA鍵を読み込みました: merchant
ap2_merchant            | {"timestamp": "2025-10-30T23:38:13.027048Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | {"timestamp": "2025-10-30T23:38:13.027377Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | {"timestamp": "2025-10-30T23:38:13.033713Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | [2025-10-30 23:38:13,033] INFO in v2.common.base_agent: [Merchant] ✓ Ed25519鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 23:38:13,036] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant            | [2025-10-30 23:38:13,044] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | {"timestamp": "2025-10-30T23:38:13.060145Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | [2025-10-30 23:38:13,044] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant            | [2025-10-30 23:38:13,045] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant            | [2025-10-30 23:38:13,045] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant            | [2025-10-30 23:38:13,046] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant            | [2025-10-30 23:38:13,046] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant            | [2025-10-30 23:38:13,050] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | [2025-10-30 23:38:13,051] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant            | [2025-10-30 23:38:13,055] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant            | [2025-10-30 23:38:13,056] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant            | [2025-10-30 23:38:13,059] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant            | [2025-10-30 23:38:13,089] INFO in v2.common.base_agent: [Merchant] Initialized: did:ap2:merchant
ap2_shopping_agent      | [2025-10-30 23:38:13,093] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_shopping_agent      | [2025-10-30 23:38:13,093] INFO in v2.common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_shopping_agent      |   Service Name: shopping_agent
ap2_shopping_agent      |   OTLP Endpoint: http://jaeger:4317
ap2_shopping_agent      |   Insecure: True
ap2_shopping_agent      | [2025-10-30 23:38:13,509] INFO in v2.common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: shopping_agent
ap2_shopping_agent      | [2025-10-30 23:38:13,509] INFO in v2.common.base_agent: [Shopping Agent] OpenTelemetry distributed tracing enabled (service: shopping_agent, manual instrumentation only)
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.567883Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.610133Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.610288Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | [2025-10-30 23:38:13,610] INFO in v2.common.base_agent: [Shopping Agent] ✓ ECDSA鍵を読み込みました: shopping_agent
ap2_shopping_agent      | [2025-10-30 23:38:13,619] INFO in v2.common.base_agent: [Shopping Agent] ✓ Ed25519鍵を読み込みました: shopping_agent
ap2_shopping_agent      | [2025-10-30 23:38:13,619] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.618819Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | [2025-10-30 23:38:13,628] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_shopping_agent      | [2025-10-30 23:38:13,628] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_shopping_agent      | [2025-10-30 23:38:13,634] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_shopping_agent      | [2025-10-30 23:38:13,634] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_shopping_agent      | [2025-10-30 23:38:13,635] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_shopping_agent      | [2025-10-30 23:38:13,635] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_shopping_agent      | [2025-10-30 23:38:13,639] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | {"timestamp": "2025-10-30T23:38:13.643986Z", "level": "INFO", "logger": "service", "message": "[Merchant] Initialized", "module": "service", "function": "__init__", "line": 118}

ap2_merchant            | [2025-10-30 23:38:13,647] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_shopping_agent      | [2025-10-30 23:38:13,644] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_shopping_agent      | [2025-10-30 23:38:13,645] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_shopping_agent      | [2025-10-30 23:38:13,654] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.655118Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.655215Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.ProductList", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:38:13.655250Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.SignatureResponse", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | [2025-10-30 23:38:13,725] INFO in v2.common.base_agent: [Shopping Agent] Initialized: did:ap2:agent:shopping_agent
ap2_payment_processor   | [2025-10-30 23:38:13,830] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_payment_processor   | [2025-10-30 23:38:13,830] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_payment_processor   |   Service Name: payment_processor
ap2_payment_processor   |   OTLP Endpoint: http://jaeger:4317
ap2_payment_processor   |   Insecure: True
ap2_payment_processor   | [2025-10-30 23:38:13,984] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: payment_processor
ap2_payment_processor   | [2025-10-30 23:38:13,987] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 23:38:13,987] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 23:38:13,993] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:38:13,993] INFO in v2.common.base_agent: [Payment Processor] OpenTelemetry distributed tracing enabled (service: payment_processor, manual instrumentation only)
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:14.298427Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:14.577178Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:14.588427Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}


ap2_shopping_agent      | [2025-10-30 23:38:14,605] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Initialized (database_mode=enabled)
ap2_payment_processor   | [2025-10-30 23:38:14,577] INFO in v2.common.base_agent: [Payment Processor] ✓ ECDSA鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 23:38:14,609] INFO in v2.common.base_agent: [Payment Processor] ✓ Ed25519鍵を読み込みました: payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:14.609461Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 23:38:14,609] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor   | [2025-10-30 23:38:14,634] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 23:38:14,653] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 23:38:14,654] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merch

ant            | [2025-10-30 23:38:14,725] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
-30 23:38:14,727] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider

ap2_merchant            | [2025-10-30 23:38:14,727] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 23:38:14,640] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor   | [2025-10-30 23:38:14,641] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:14.667390Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_payment_processor   | [2025-10-30 23:38:14,658] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor   | [2025-10-30 23:38:14,659] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor   | [2025-10-30 23:38:14,661] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor   | [2025-10-30 23:38:14,661] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json

ap2_merchant            | [2025-10-30 23:38:14,749] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:38:14,664] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor   | [2025-10-30 23:38:14,664] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
 in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor   | [2025-10-30 23:38:14,721] INFO in v2.common.base_agent: [Payment Processor] Initialized: did:ap2:agent:payment_processor
ap2_merchant            | [2025-10-30 23:38:14,749] INFO in v2.common.base_agent: [Merchant] OpenTelemetry distributed tracing enabled (service: merchant, manual instrumentation only)
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.750496Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.773547Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.773947Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 23:38:14,773] INFO in v2.common.base_agent: [Merchant] ✓ ECDSA鍵を読み込みました: merchant
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.781867Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | [2025-10-30 23:38:14,781] INFO in v2.common.base_agent: [Merchant] ✓ Ed25519鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 23:38:14,782] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant            | [2025-10-30 23:38:14,788] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 23:38:14,789] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant            | [2025-10-30 23:38:14,796] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant            | [2025-10-30 23:38:14,797] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant            | [2025-10-30 23:38:14,807] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant            | [2025-10-30 23:38:14,807] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant            | [2025-10-30 23:38:14,812] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | [2025-10-30 23:38:14,813] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant            | [2025-10-30 23:38:14,822] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant            | [2025-10-30 23:38:14,823] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant            | [2025-10-30 23:38:14,848] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.852159Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | [2025-10-30 23:38:14,881] INFO in v2.common.base_agent: [Merchant] Initialized: did:ap2:merchant
ap2_merchant            | [2025-10-30 23:38:14,894] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.893344Z", "level": "INFO", "logger": "service", "message": "[Merchant] Initialized", "module": "service", "function": "__init__", "line": 118}
ap2_merchant            | INFO:     Started server process [1]
ap2_merchant            | INFO:     Waiting for application startup.
ap2_merchant            | {"timestamp": "2025-10-30T23:38:14.902430Z", "level": "INFO", "logger": "service", "message": "[Merchant] Running startup tasks...", "module": "service", "function": "startup_event", "line": 102}
ap2_payment_processor   | [2025-10-30 23:38:15,765] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:15.764051Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Initialized", "module": "processor", "function": "__init__", "line": 102}
ap2_merchant            | {"timestamp": "2025-10-30T23:38:16.603072Z", "level": "INFO", "logger": "service", "message": "[Merchant] Database initialized", "module": "service", "function": "startup_event", "line": 106}
ap2_payment_processor   | [2025-10-30 23:38:16,865] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 23:38:16,868] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_merchant            |
ap2_merchant            | ============================================================
ap2_merchant            | 商品データ投入中...
ap2_merchant            | ============================================================
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:16.893095Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | [2025-10-30 23:38:16,884] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:38:16,888] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 23:38:16,888] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 23:38:16,890] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:38:16,891] INFO in v2.common.base_agent: [Payment Processor] OpenTelemetry distributed tracing enabled (service: payment_processor, manual instrumentation only)
ap2_payment_processor   | [2025-10-30 23:38:16,923] INFO in v2.common.base_agent: [Payment Processor] ✓ ECDSA鍵を読み込みました: payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:16.923251Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:16.923488Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:16.960263Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 23:38:16,960] INFO in v2.common.base_agent: [Payment Processor] ✓ Ed25519鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 23:38:16,960] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor   | [2025-10-30 23:38:16,979] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor   | [2025-10-30 23:38:16,979] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor   | [2025-10-30 23:38:16,999] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor   | [2025-10-30 23:38:17,027] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor   | [2025-10-30 23:38:17,037] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor   | [2025-10-30 23:38:17,039] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor   | [2025-10-30 23:38:17,045] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor   | [2025-10-30 23:38:17,047] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor   | [2025-10-30 23:38:17,049] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor   | [2025-10-30 23:38:17,049] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor   | [2025-10-30 23:38:17,061] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:17.064141Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_payment_processor   | [2025-10-30 23:38:17,435] INFO in v2.common.base_agent: [Payment Processor] Initialized: did:ap2:agent:payment_processor
ap2_merchant            |   ✅ 作成: むぎぼーアクリルキーホルダー (¥800)
ap2_payment_processor   | [2025-10-30 23:38:17,557] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_payment_processor   | INFO:     Started server process [1]
ap2_payment_processor   | INFO:     Waiting for application startup.
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:17.554444Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Initialized", "module": "processor", "function": "__init__", "line": 102}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:17.583523Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Running startup tasks...", "module": "processor", "function": "startup_event", "line": 96}
ap2_merchant            |   ✅ 作成: むぎぼー時計 (¥3,500)
ap2_merchant            |   ✅ 作成: むぎぼーカレンダー (¥1,500)
ap2_merchant            |   ✅ 作成: むぎぼーマグカップ (¥1,200)
ap2_merchant            |   ✅ 作成: むぎぼーステッカー (¥500)
ap2_merchant            |   ✅ 作成: むぎぼーTシャツ (¥2,800)
ap2_merchant            |   ✅ 作成: むぎぼートートバッグ (¥1,800)
ap2_merchant            |   ✅ 作成: むぎぼーポーチ (¥950)
ap2_merchant            |   ✅ 作成: むぎぼーぬいぐるみ（S） (¥2,200)
ap2_merchant            |   ✅ 作成: むぎぼーぬいぐるみ（L） (¥4,800)
ap2_merchant            |   ✅ 作成: むぎぼーキャップ (¥2,000)
ap2_merchant            |   ✅ 作成: むぎぼークッション (¥2,500)
ap2_merchant            |   ✅ 作成: むぎぼーノート (¥700)
ap2_merchant            |   ✅ 作成: むぎぼーボールペン (¥600)
ap2_payment_processor   | {"timestamp": "2025-10-30T23:38:19.026362Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Database initialized", "module": "processor", "function": "startup_event", "line": 100}
ap2_payment_processor   | INFO:     Application startup complete.
ap2_payment_processor   | INFO:     Uvicorn running on http://0.0.0.0:8004 (Press CTRL+C to quit)
ap2_merchant            |   ✅ 作成: むぎぼーウォーターボトル (¥2,400)
ap2_merchant            |   ✅ 作成: むぎぼー靴下 (¥850)
ap2_merchant            |   ✅ 作成: むぎぼーマウスパッド (¥900)
ap2_merchant            |   ✅ 作成: むぎぼースマホケース (¥1,800)
ap2_merchant            |   ✅ 作成: むぎぼー折りたたみ傘 (¥2,600)
ap2_merchant            |   ✅ 作成: むぎぼーエコバッグ (¥1,200)
ap2_merchant            |   ✅ 作成: むぎぼーブランケット (¥3,200)
ap2_merchant            |   ✅ 作成: むぎぼープレート皿 (¥1,900)
ap2_merchant            |   ✅ 作成: むぎぼーパーカー (¥4,500)
ap2_merchant            |   ✅ 作成: むぎぼーフェイスタオル (¥1,300)
ap2_merchant            |   ✅ 作成: むぎぼーアロマキャンドル (¥2,100)
ap2_merchant            |   ✅ 作成: むぎぼー抱き枕 (¥5,500)
ap2_merchant            |   ✅ 作成: むぎぼーポスター (¥900)
ap2_merchant            |   ✅ 作成: むぎぼーニット帽 (¥1,800)
ap2_merchant            |
ap2_merchant            | ✅ 商品データ投入完了 (28件)
ap2_merchant            |
ap2_merchant            | ============================================================
ap2_merchant            | ユーザーデータ投入中...
ap2_merchant            | ============================================================
ap2_merchant            |   ✅ 作成: 山田太郎 (yamada@example.com)
ap2_merchant            |   ✅ 作成: 佐藤花子 (sato@example.com)
ap2_merchant            |
ap2_merchant            | ✅ ユーザーデータ投入完了 (2件)
ap2_merchant            | {"timestamp": "2025-10-30T23:38:19.808352Z", "level": "INFO", "logger": "service", "message": "[Merchant] Sample data seeded successfully", "module": "service", "function": "startup_event", "line": 114}
ap2_merchant            | INFO:     Application startup complete.
ap2_merchant            | INFO:     Uvicorn running on http://0.0.0.0:8002 (Press CTRL+C to quit)
ap2_credential_provider  | [2025-10-30 23:38:20,135] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_credential_provider  | [2025-10-30 23:38:20,135] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_credential_provider  |   Service Name: credential_provider
ap2_credential_provider  |   OTLP Endpoint: http://jaeger:4317
ap2_credential_provider  |   Insecure: True
ap2_credential_provider  | [2025-10-30 23:38:20,193] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: credential_provider
ap2_credential_provider  | [2025-10-30 23:38:20,194] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider  | [2025-10-30 23:38:20,194] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:38:20,193] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_credential_provider_2  | [2025-10-30 23:38:20,194] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_credential_provider_2  |   Service Name: credential_provider_2
ap2_credential_provider_2  |   OTLP Endpoint: http://jaeger:4317
ap2_credential_provider_2  |   Insecure: True
ap2_credential_provider    | [2025-10-30 23:38:20,195] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 23:38:20,195] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider, manual instrumentation only)
ap2_credential_provider_2  | [2025-10-30 23:38:20,245] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: credential_provider_2
ap2_credential_provider_2  | [2025-10-30 23:38:20,246] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 23:38:20,246] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:38:20,247] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 23:38:20,247] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider_2, manual instrumentation only)


ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.295192Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.296056Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.344358Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:38:20,344] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.344648Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.344456Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 23:38:20,344] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.345030Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.354932Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:38:20,355] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 23:38:20,355] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:20,357] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.357509Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 23:38:20,358] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,365] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider    | [2025-10-30 23:38:20,367] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,368] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider    | [2025-10-30 23:38:20,369] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,370] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider    | [2025-10-30 23:38:20,370] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,373] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider    | [2025-10-30 23:38:20,373] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,374] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 23:38:20,374] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:20,365] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent


ap2_credential_provider_2  | [2025-10-30 23:38:20,384] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,374] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor

ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.374784Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:38:20,392] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent

ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.374974Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:38:20,392] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json


ap2_credential_provider_2  | [2025-10-30 23:38:20,393] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider_2  | [2025-10-30 23:38:20,393] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:20,395] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider_2  | [2025-10-30 23:38:20,395] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:20,399] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider_2  | [2025-10-30 23:38:20,399] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:20,407] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.407584Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.407641Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | [2025-10-30 23:38:20,414] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider_2  | [2025-10-30 23:38:20,431] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.755204Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider    | [2025-10-30 23:38:20,758] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:20.882849Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider_2  | [2025-10-30 23:38:20,884] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider    | [2025-10-30 23:38:20,959] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 23:38:20,960] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider    | [2025-10-30 23:38:20,967] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 23:38:20,967] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 23:38:20,967] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider    | [2025-10-30 23:38:20,973] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 23:38:20,973] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider, manual instrumentation only)
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.973524Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.978425Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.978599Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | [2025-10-30 23:38:20,978] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 23:38:20,985] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 23:38:20,986] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:20.985905Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:38:20,987] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider    | [2025-10-30 23:38:20,987] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,987] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider    | [2025-10-30 23:38:20,987] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,988] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider    | [2025-10-30 23:38:20,988] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,992] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider    | [2025-10-30 23:38:20,992] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | [2025-10-30 23:38:20,997] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 23:38:20,999] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider    | [2025-10-30 23:38:21,002] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:21.002965Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:21.003000Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | [2025-10-30 23:38:21,028] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:21.038799Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider    | [2025-10-30 23:38:21,039] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider    | INFO:     Started server process [1]
ap2_credential_provider    | INFO:     Waiting for application startup.
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:21.042397Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Running startup tasks...", "module": "provider", "function": "startup_event", "line": 145}
ap2_credential_provider_2  | [2025-10-30 23:38:21,078] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 23:38:21,078] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:38:21,081] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 23:38:21,081] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 23:38:21,081] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:38:21,084] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 23:38:21,084] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider_2, manual instrumentation only)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.084505Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.100916Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.101884Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | [2025-10-30 23:38:21,101] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | [2025-10-30 23:38:21,105] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.105835Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 23:38:21,106] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:21,110] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider_2  | [2025-10-30 23:38:21,110] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:21,113] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider_2  | [2025-10-30 23:38:21,114] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:21,116] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider_2  | [2025-10-30 23:38:21,116] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:21,121] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider_2  | [2025-10-30 23:38:21,121] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:21,122] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider_2  | [2025-10-30 23:38:21,122] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | [2025-10-30 23:38:21,125] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.126418Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.126616Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:38:21,143] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider_2  | [2025-10-30 23:38:21,158] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.158265Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider_2  | INFO:     Started server process [1]
ap2_credential_provider_2  | INFO:     Waiting for application startup.
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.165763Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Running startup tasks...", "module": "provider", "function": "startup_event", "line": 145}
ap2_credential_provider    | INFO:     Application startup complete.
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:21.352773Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Database initialized", "module": "provider", "function": "startup_event", "line": 149}
ap2_credential_provider    | INFO:     Uvicorn running on http://0.0.0.0:8003 (Press CTRL+C to quit)
ap2_credential_provider_2  | INFO:     Application startup complete.
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:38:21.466997Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Database initialized", "module": "provider", "function": "startup_event", "line": 149}
ap2_credential_provider_2  | INFO:     Uvicorn running on http://0.0.0.0:8003 (Press CTRL+C to quit)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.051783Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Tracing enabled", "module": "langgraph_merchant", "function": "<module>", "line": 83}
ap2_merchant_agent         | [2025-10-30 23:38:22,065] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant_agent         | [2025-10-30 23:38:22,065] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant_agent'. Adding OTLP exporter to existing provider.
ap2_merchant_agent         | [2025-10-30 23:38:22,107] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant_agent         | [2025-10-30 23:38:22,108] INFO in v2.common.base_agent: [Merchant Agent] OpenTelemetry distributed tracing enabled (service: merchant_agent, manual instrumentation only)
ap2_shopping_agent         | [2025-10-30 23:38:22,297] INFO in services.shopping_agent.langgraph_shopping_flow: [Langfuse] Shopping Agent tracing enabled
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.310640Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.324540Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | [2025-10-30 23:38:22,324] INFO in v2.common.base_agent: [Merchant Agent] ✓ ECDSA鍵を読み込みました: merchant_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.324684Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.328356Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | [2025-10-30 23:38:22,328] INFO in v2.common.base_agent: [Merchant Agent] ✓ Ed25519鍵を読み込みました: merchant_agent
ap2_merchant_agent         | [2025-10-30 23:38:22,328] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,330] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant_agent         | [2025-10-30 23:38:22,330] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,330] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent         | [2025-10-30 23:38:22,330] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,331] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent         | [2025-10-30 23:38:22,331] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,331] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant_agent         | [2025-10-30 23:38:22,331] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,332] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant_agent         | [2025-10-30 23:38:22,332] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,332] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.332482Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.IntentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.332526Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.ProductSearch", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.332545Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.332561Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartSelection", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.332577Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | [2025-10-30 23:38:22,338] INFO in v2.common.base_agent: [Merchant Agent] Initialized: did:ap2:agent:merchant_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.387634Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Initialized (AI Mode: True)", "module": "agent", "function": "__init__", "line": 163}
ap2_merchant_agent         | [2025-10-30 23:38:22,528] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant_agent         | [2025-10-30 23:38:22,528] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant_agent'. Adding OTLP exporter to existing provider.
ap2_merchant_agent         | [2025-10-30 23:38:22,528] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant_agent         | [2025-10-30 23:38:22,528] INFO in v2.common.base_agent: [Merchant Agent] OpenTelemetry distributed tracing enabled (service: merchant_agent, manual instrumentation only)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.529178Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.531056Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.531192Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | [2025-10-30 23:38:22,531] INFO in v2.common.base_agent: [Merchant Agent] ✓ ECDSA鍵を読み込みました: merchant_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.532926Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | [2025-10-30 23:38:22,532] INFO in v2.common.base_agent: [Merchant Agent] ✓ Ed25519鍵を読み込みました: merchant_agent
ap2_merchant_agent         | [2025-10-30 23:38:22,533] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,535] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant_agent         | [2025-10-30 23:38:22,535] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,537] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent         | [2025-10-30 23:38:22,537] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,539] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent         | [2025-10-30 23:38:22,539] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,540] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant_agent         | [2025-10-30 23:38:22,541] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,541] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant_agent         | [2025-10-30 23:38:22,541] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent         | [2025-10-30 23:38:22,544] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.544241Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.IntentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.544283Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.ProductSearch", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.544300Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.544461Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartSelection", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.544596Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | [2025-10-30 23:38:22,555] INFO in v2.common.base_agent: [Merchant Agent] Initialized: did:ap2:agent:merchant_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.564895Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Initialized (AI Mode: True)", "module": "agent", "function": "__init__", "line": 163}
ap2_merchant_agent         | INFO:     Started server process [1]
ap2_merchant_agent         | INFO:     Waiting for application startup.
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.566207Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Running startup tasks...", "module": "agent", "function": "startup_event", "line": 111}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.577804Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Database initialized", "module": "agent", "function": "startup_event", "line": 115}
ap2_merchant_agent         |
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         | 商品データ投入中...
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーアクリルキーホルダー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー時計 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーカレンダー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーマグカップ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーステッカー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーTシャツ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼートートバッグ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーポーチ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーぬいぐるみ（S） (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーぬいぐるみ（L） (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーキャップ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼークッション (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーノート (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーボールペン (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーウォーターボトル (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー靴下 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーマウスパッド (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼースマホケース (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー折りたたみ傘 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーエコバッグ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーブランケット (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼープレート皿 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーパーカー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーフェイスタオル (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーアロマキャンドル (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー抱き枕 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーポスター (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーニット帽 (既存)
ap2_merchant_agent         |
ap2_merchant_agent         | ✅ 商品データ投入完了 (28件)
ap2_merchant_agent         |
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         | ユーザーデータ投入中...
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         |   ✅ 作成: 山田太郎 (yamada@example.com)
ap2_merchant_agent         |   ✅ 作成: 佐藤花子 (sato@example.com)
ap2_merchant_agent         |
ap2_merchant_agent         | ✅ ユーザーデータ投入完了 (2件)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.672064Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Sample data seeded successfully", "module": "agent", "function": "startup_event", "line": 121}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.672264Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_meilisearch            | 2025-10-30T23:38:22.755870Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=5.60ms time.idle=8.36ms
ap2_meilisearch            | 2025-10-30T23:38:22.756159Z ERROR index_scheduler: Batch failed Index `products` already exists.
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.761559Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Index already exists: products", "module": "search_engine", "function": "create_index", "line": 65}
ap2_meilisearch            | 2025-10-30T23:38:22.779817Z  INFO HTTP request{method=PATCH host="meilisearch:7700" route=/indexes/products/settings query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=1.84ms time.idle=7.04ms
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.782162Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Index configured: products", "module": "search_engine", "function": "configure_index", "line": 115}
ap2_meilisearch            | 2025-10-30T23:38:22.787065Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_meilisearch            | 2025-10-30T23:38:22.804783Z  INFO HTTP request{method=DELETE host="meilisearch:7700" route=/indexes/products/documents query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=767µs time.idle=7.54ms
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.807947Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Cleared index: products", "module": "search_engine", "function": "clear_index", "line": 239}
ap2_meilisearch            | 2025-10-30T23:38:22.813705Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_meilisearch            | 2025-10-30T23:38:22.854908Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/documents query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=6.41ms time.idle=12.2ms
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.855814Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Added 28 documents, taskUid=11", "module": "search_engine", "function": "add_documents", "line": 144}
ap2_merchant_agent         | [2025-10-30 23:38:22,856] INFO in utils.product_helpers: [_sync_products_to_meilisearch] Synced 28 products to Meilisearch
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:22.856545Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Meilisearch synchronized", "module": "agent", "function": "startup_event", "line": 129}
ap2_shopping_agent         | [2025-10-30 23:38:22,905] INFO in services.shopping_agent.langgraph_shopping_flow: [LangGraph Shopping Flow] LLM initialized: ai/qwen3 at http://host.docker.internal:12434/engines/llama.cpp/v1
ap2_shopping_agent         | [2025-10-30 23:38:22,910] INFO in services.shopping_agent.langgraph_shopping_flow: [create_shopping_flow_graph] LangGraph shopping flow compiled successfully (14 nodes, AP2 compliant, with checkpointer for trace continuity)
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:22.911101Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] LangGraph shopping flow graph initialized successfully (12 nodes)", "module": "agent", "function": "__init__", "line": 241}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:22.911278Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Initialized with database-backed risk assessment", "module": "agent", "function": "__init__", "line": 268}
ap2_shopping_agent         | [2025-10-30 23:38:23,037] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_shopping_agent         | [2025-10-30 23:38:23,037] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='shopping_agent'. Adding OTLP exporter to existing provider.
ap2_shopping_agent         | [2025-10-30 23:38:23,042] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_shopping_agent         | [2025-10-30 23:38:23,042] INFO in v2.common.base_agent: [Shopping Agent] OpenTelemetry distributed tracing enabled (service: shopping_agent, manual instrumentation only)
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.043099Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.049469Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent         | [2025-10-30 23:38:23,049] INFO in v2.common.base_agent: [Shopping Agent] ✓ ECDSA鍵を読み込みました: shopping_agent
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.049760Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.055276Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent         | [2025-10-30 23:38:23,055] INFO in v2.common.base_agent: [Shopping Agent] ✓ Ed25519鍵を読み込みました: shopping_agent
ap2_shopping_agent         | [2025-10-30 23:38:23,055] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent         | [2025-10-30 23:38:23,058] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_shopping_agent         | [2025-10-30 23:38:23,058] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_shopping_agent         | [2025-10-30 23:38:23,060] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_shopping_agent         | [2025-10-30 23:38:23,060] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_shopping_agent         | [2025-10-30 23:38:23,061] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_shopping_agent         | [2025-10-30 23:38:23,061] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_shopping_agent         | [2025-10-30 23:38:23,063] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_shopping_agent         | [2025-10-30 23:38:23,063] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_shopping_agent         | [2025-10-30 23:38:23,063] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_shopping_agent         | [2025-10-30 23:38:23,064] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_shopping_agent         | [2025-10-30 23:38:23,066] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.066366Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.066408Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.ProductList", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.066427Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.SignatureResponse", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent         | [2025-10-30 23:38:23,082] INFO in v2.common.base_agent: [Shopping Agent] Initialized: did:ap2:agent:shopping_agent
ap2_shopping_agent         | [2025-10-30 23:38:23,089] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Initialized (database_mode=enabled)
ap2_shopping_agent         | [2025-10-30 23:38:23,090] INFO in services.shopping_agent.langgraph_shopping_flow: [LangGraph Shopping Flow] LLM initialized: ai/qwen3 at http://host.docker.internal:12434/engines/llama.cpp/v1
ap2_shopping_agent         | [2025-10-30 23:38:23,096] INFO in services.shopping_agent.langgraph_shopping_flow: [create_shopping_flow_graph] LangGraph shopping flow compiled successfully (14 nodes, AP2 compliant, with checkpointer for trace continuity)
ap2_shopping_agent         | INFO:     Started server process [1]
ap2_shopping_agent         | INFO:     Waiting for application startup.
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.096265Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] LangGraph shopping flow graph initialized successfully (12 nodes)", "module": "agent", "function": "__init__", "line": 241}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.096408Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Initialized with database-backed risk assessment", "module": "agent", "function": "__init__", "line": 268}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.098008Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Running startup tasks...", "module": "agent", "function": "startup_event", "line": 262}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:23.120707Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Database initialized", "module": "agent", "function": "startup_event", "line": 266}
ap2_shopping_agent         | INFO:     Application startup complete.
ap2_shopping_agent         | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:23.339763Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[MerchantLangGraphAgent] LLM initialized with DMR: http://host.docker.internal:12434/engines/llama.cpp/v1, model: ai/qwen3", "module": "langgraph_merchant", "function": "__init__", "line": 178}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:23.343265Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Initialized: http://merchant_agent_mcp:8011", "module": "mcp_client", "function": "__init__", "line": 65}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:23.349396Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[MerchantLangGraphAgent] Initialized with LLM: ai/qwen3, MCP: http://merchant_agent_mcp:8011", "module": "langgraph_merchant", "function": "__init__", "line": 196}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:38:23.349461Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] LangGraph AI engine initialized", "module": "agent", "function": "startup_event", "line": 143}
ap2_merchant_agent         | INFO:     Application startup complete.
ap2_merchant_agent         | INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
ap2_meilisearch            | 2025-10-30T23:38:24.714860Z  INFO index_scheduler::batch: document indexing done indexing_result=DocumentAdditionResult { indexed_documents: 28, number_of_documents: 28 } processed_in=1.865630668s
ap2_meilisearch            | 2025-10-30T23:38:24.719552Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:38.606890Z", "level": "INFO", "logger": "agent", "message": "[register_user] Validating password strength for email=tubone24@example.com", "module": "agent", "function": "register_user", "line": 321}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:38.607770Z", "level": "INFO", "logger": "agent", "message": "[register_user] Hashing password for email=tubone24@example.com", "module": "agent", "function": "register_user", "line": 325}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:38.689296Z", "level": "INFO", "logger": "agent", "message": "[register_user] Password hashed successfully (length=97)", "module": "agent", "function": "register_user", "line": 327}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:38.726108Z", "level": "INFO", "logger": "agent", "message": "[register_user] Creating user with data: id=usr_ee3014bbc51f4156, email=tubone24@example.com, hashed_password_len=97", "module": "agent", "function": "register_user", "line": 347}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:38.742895Z", "level": "INFO", "logger": "agent", "message": "[Auth] User registered: user_id=usr_ee3014bbc51f4156, email=tubone24@example.com", "module": "agent", "function": "register_user", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:38:38.747071Z", "level": "INFO", "logger": "v2.common.auth", "message": "[Auth] Created JWT token: user_id=usr_ee3014bbc51f4156, expires=2025-10-31T23:38:38.742946+00:00", "module": "auth", "function": "create_access_token", "line": 173}
ap2_shopping_agent         | INFO:     172.67.69.85:50454 - "POST /auth/register HTTP/1.1" 200 OK
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:48.431407Z", "level": "INFO", "logger": "provider", "message": "[register_passkey_challenge] Generated challenge for user_id=usr_ee3014bbc51f4156", "module": "provider", "function": "register_passkey_challenge", "line": 220}
ap2_credential_provider    | [2025-10-30 23:38:48,435] INFO in v2.common.redis_client: [RedisClient] Connected to Redis: redis://redis:6379/0
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:48.449738Z", "level": "INFO", "logger": "provider", "message": "[register_passkey_challenge] Saved challenge to Redis KV (TTL: 60s)", "module": "provider", "function": "register_passkey_challenge", "line": 236}
ap2_credential_provider    | INFO:     172.67.69.85:24207 - "POST /register/passkey/challenge HTTP/1.1" 200 OK
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.252525Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Registering passkey for user: usr_ee3014bbc51f4156", "module": "provider", "function": "register_passkey", "line": 302}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.258476Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Challenge verified and deleted: mvhk6zlHIyOt_Y88...", "module": "provider", "function": "register_passkey", "line": 343}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.261463Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] COSE key length: 77 bytes", "module": "provider", "function": "register_passkey", "line": 390}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.261587Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] COSE key dict: {1: 2, 3: -7, -1: 1, -2: b'\\xcfq\\xbe4r\\xdc=\\x11r\\x0f\\xb6\\xe8\\xcf\\xd9\\x0f2\\xf9@@\\x0b\\x1b\\xef\\xb3k\\xee~\"\\xd1\\xc0\\x1c\\xc7\\x94', -3: b'\\x0f&cSh\\xf9\\x8a\\x0c\\x890T^\\xbb\\xb6\\xbeE\\xbe\\xb8jFV(C8\\x95\\xf3\\xbe\\xd7Z\\x04\\x0fW'}", "module": "provider", "function": "register_passkey", "line": 391}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.261626Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Extracted public key from attestationObject", "module": "provider", "function": "register_passkey", "line": 393}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.344369Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] User created: usr_ee3014bbc51f4156", "module": "provider", "function": "register_passkey", "line": 426}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:38:52.345018Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Passkey registered: nMJrfBrkstu2zYV5...", "module": "provider", "function": "register_passkey", "line": 430}
ap2_credential_provider    | INFO:     172.67.69.85:58077 - "POST /register/passkey HTTP/1.1" 200 OK
ap2_credential_provider    | INFO:     172.67.69.85:60696 - "OPTIONS /payment-methods HTTP/1.1" 200 OK
ap2_credential_provider    | {"timestamp": "2025-10-30T23:39:10.221003Z", "level": "INFO", "logger": "provider", "message": "[add_payment_method] Saved payment method to DB: pm_e6367cd7 for user: usr_ee3014bbc51f4156", "module": "provider", "function": "add_payment_method", "line": 666}
ap2_credential_provider    | INFO:     172.67.69.85:19043 - "POST /payment-methods HTTP/1.1" 200 OK
ap2_shopping_agent         | INFO:     172.67.69.85:53036 - "OPTIONS /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:14.429390Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:14.431555Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: a\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:53036 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:14.504316Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Created new session in DB: session_1761867551787_p210teo", "module": "agent", "function": "_get_or_create_session", "line": 1965}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:14.504874Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:14.505663Z", "level": "INFO", "logger": "agent", "message": "[Langfuse] Created new handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1643}
ap2_shopping_agent         | [2025-10-30 23:39:14,529] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: initial
ap2_shopping_agent         |   user_input: a
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:17.099274Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:17.103839Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:19.591087Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:19.591270Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: かわいいグッズがほしい。5000円以内\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:53036 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:19.593541Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=ask_intent", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:19.594144Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:19.594213Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:39:19,596] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: ask_intent
ap2_shopping_agent         |   user_input: かわいいグッズがほしい。5000円以内
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:39:45,903] INFO in services.shopping_agent.langgraph_shopping_flow: [collect_intent_node] LLM result: {'intent': 'かわいいグッズを購入したい', 'max_amount': 5000, 'keywords': ['かわいい', 'グッズ', 'かわいいグッズ']}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:45.905512Z", "level": "INFO", "logger": "agent", "message": "[_create_intent_mandate] Reconstructed intent: かわいいグッズを購入したい。5000円以内", "module": "agent", "function": "_create_intent_mandate", "line": 1733}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:45.906043Z", "level": "INFO", "logger": "agent", "message": "[_build_intent_mandate_from_session] Constructed natural_language_description: かわいいグッズを購入したい。5000円以内", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1812}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:45.906251Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] IntentMandate created (AP2-compliant): intent='かわいいグッズを購入したい...', expiry=2025-10-31T00:39:45.904755Z", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1824}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:47.935100Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:47.950704Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:53.535066Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:53.538519Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: {\"recipient\":\"あ\",\"postal_code\":\"あ\",\"city\":\"あ\",\"region\":\"あ\",\"address_line1\":\"あ\",\"country\":\"あ\"}\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:32611 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:53.547577Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=intent_complete_ask_shipping", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:53.548790Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:53.549020Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:39:53,606] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: intent_complete_ask_shipping
ap2_shopping_agent         |   user_input: {"recipient":"あ","postal_code":"あ","city":"あ","region":"あ","address_line1":"あ","country":"あ"}
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:39:53,924] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='{"recipient":"あ","postal_code":"あ","city":"あ","region":"あ","address_line1":" あ","country":"あ"}', session['step']='select_cp', is_digit=False
ap2_shopping_agent         | [2025-10-30 23:39:53,926] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-30 23:39:53,926] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-30 23:39:53,926] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: Presenting 2 Credential Providers to user
ap2_shopping_agent         |   User ID: usr_ee3014bbc51f4156
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:55.190915Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=select_cp", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:55.197738Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=select_cp", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.014073Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.014522Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: 1\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:32611 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.020942Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=select_cp", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.021786Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.021877Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:39:57,025] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: select_cp
ap2_shopping_agent         |   user_input: 1
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:39:57,028] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='1', session['step']='select_cp', is_digit=True
ap2_shopping_agent         | [2025-10-30 23:39:57,028] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-30 23:39:57,028] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-30 23:39:57,028] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: User selected Credential Provider
ap2_shopping_agent         |   User ID: usr_ee3014bbc51f4156
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP Name: AP2 Demo Credential Provider
ap2_shopping_agent         | [2025-10-30 23:39:57,242] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 6-7: Requesting payment methods from CP
ap2_shopping_agent         |   User ID: usr_ee3014bbc51f4156
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.242385Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment methods from Credential Provider (http://credential_provider:8003) for user: usr_ee3014bbc51f4156", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2316}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.243947Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: GET http://credential_provider:8003/payment-methods", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.245819Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"GET\", \"url\": \"http://credential_provider:8003/payment-methods\", \"headers\": {}, \"body\": null}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:39:57.399658Z", "level": "INFO", "logger": "provider", "message": "[get_payment_methods] Retrieved 1 payment methods for user: usr_ee3014bbc51f4156", "module": "provider", "function": "get_payment_methods", "line": 631}


ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.410329Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (166.46ms)", "module": "logger", "function": "log_http_response", "line": 215}


ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.410673Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:39:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"368\", \"content-type\": \"application/json\"}, \"body\": {\"user_id\": \"usr_ee3014bbc51f4156\", \"payment_methods\": [{\"type\": \"basic-card\", \"display_name\": \"Visaカード (****1111)\", \"brand\": \"Visa\", \"last4\": \"1111\", \"card_number\": \"1111111111111111\", \"cardholder_name\": \"YUUUUUUUU\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\", \"cvv\": \"123\", \"billing_address\": {\"country\": \"JP\", \"postal_code\": \"111-1111\"}, \"requires_step_up\": false, \"id\": \"pm_e6367cd7\"}]}, \"duration_ms\": 166.45503044128418}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_credential_provider    | INFO:     172.18.0.8:57766 - "GET /payment-methods?user_id=usr_ee3014bbc51f4156 HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.411335Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Retrieved 1 payment methods from Credential Provider", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2334}
ap2_shopping_agent         | [2025-10-30 23:39:57,411] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 7: Received 1 payment methods from CP
ap2_shopping_agent         |   Payment Methods: ['pm_e6367cd7']
ap2_shopping_agent         | [2025-10-30 23:39:57,623] INFO in services.shopping_agent.langgraph_shopping_flow: [fetch_carts_node] AP2 Step 8-12: Fetching cart candidates from Merchant Agent
ap2_shopping_agent         | [2025-10-30 23:39:57,624] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting cart candidates from Merchant Agent for IntentMandate: intent_dd1b41e3
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.629381Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.654263Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 797, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_dd1b41e3\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-30T23:39:45.904755Z\",\"id\":\"intent_dd1b41e3\",\"intent_expiry\":\"2025-10-31T00:3", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.654641Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.685590Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.687760Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.mandates.IntentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.687847Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.IntentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"f6e228a0-903f-4e82-88f1-4e77a2fdf388\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:39:57.624859Z\", \"nonce\": \"fbf612c3927c0f42c879d7200e04123948dd281b21cb61399aeeb157a12aad8d\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"intent_mandate\": {\"id\": \"intent_dd1b41e3\", \"type\": \"IntentMandate\", \"user_id\": \"usr_ee3014bbc51f4156\", \"user_cart_confirmation_required\": true, \"natural_language_description\": \"かわいいグッズを購入したい。5000円以内\", \"requires_refundability\": false, \"intent_expiry\": \"2025-10-31T00:39:45.904755Z\", \"created_at\": \"2025-10-30T23:39:45.904755Z\"}, \"shipping_address\": {\"recipient\": \"あ\", \"postal_code\": \"あ\", \"city\": \"あ\", \"region\": \"あ\", \"address_line1\": \"あ\", \"country\": \"あ\"}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_shopping_agent         | [2025-10-30 23:39:57,688] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Intent A2A message created: message_id=f6e228a0-903f-4e82-88f1-4e77a2fdf388, intent_mandate_id=intent_dd1b41e3
ap2_shopping_agent         | [2025-10-30 23:39:57,688] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: f6e228a0-903f-4e82-88f1-4e77a2fdf388
ap2_shopping_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_shopping_agent         |   ペイロード: {
ap2_shopping_agent         |   "id": "intent_dd1b41e3",
ap2_shopping_agent         |   "type": "IntentMandate",
ap2_shopping_agent         |   "user_id": "usr_ee3014bbc51f4156",
ap2_shopping_agent         |   "user_cart_confirmation_required": true,
ap2_shopping_agent         |   "natural_language_description": "かわいいグッズを購入したい。5000円以内",
ap2_shopping_agent         |   "requires_refundability": false,
ap2_shopping_agent         |   "intent_expiry": "2025-10-31T00:39:45.904755Z",
ap2_shopping_agent         |   "created_at": "2025-10-30T23:39:45.904755Z"
ap2_shopping_agent         | }
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.691246Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent:8001/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:39:57.691712Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent:8001/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"f6e228a0-903f-4e82-88f1-4e77a2fdf388\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:39:57.624859Z\", \"nonce\": \"fbf612c3927c0f42c879d7200e04123948dd281b21cb61399aeeb157a12aad8d\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"6HtDIU6iCqxJbdQOh2XwfDWKW/Um7Y+4LSmAKeHaBhI0SDl40TUs0jgfRydpdL+TnNg+Zy30okpwAJL4BeKmAA==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQSt4cHkrMkRqZ0FJcVBEUERmV0JLeExVd0NNL2pGdFZ6WlN3b3gyaGZtL0k9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:shopping_agent#key-2\", \"created\": \"2025-10-30T23:39:57.624859Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.IntentMandate\", \"id\": \"intent_dd1b41e3\", \"payload\": {\"intent_mandate\": {\"id\": \"intent_dd1b41e3\", \"type\": \"IntentMandate\", \"user_id\": \"usr_ee3014bbc51f4156\", \"user_cart_confirmation_required\": true, \"natural_language_description\": \"かわいいグッズを購入したい。5000円以内\", \"requires_refundability\": false, \"intent_expiry\": \"2025-10-31T00:39:45.904755Z\", \"created_at\": \"2025-10-30T23:39:45.904755Z\"}, \"shipping_address\": {\"recipient\": \"あ\", \"postal_code\": \"あ\", \"city\": \"あ\", \"region\": \"あ\", \"address_line1\": \"あ\", \"country\": \"あ\"}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | [2025-10-30 23:39:57,810] INFO in v2.common.base_agent:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message
ap2_merchant_agent         |   受信メッセージ: ID=f6e228a0-903f-4e82-88f1-4e77a2fdf388
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.822627Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:shopping_agent: ap2.mandates.IntentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.825440Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.IntentMandate\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"f6e228a0-903f-4e82-88f1-4e77a2fdf388\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:39:57.624859Z\", \"nonce\": \"fbf612c3927c0f42c879d7200e04123948dd281b21cb61399aeeb157a12aad8d\", \"schema_version\": \"0.2\"}, \"payload\": {\"intent_mandate\": {\"id\": \"intent_dd1b41e3\", \"type\": \"IntentMandate\", \"user_id\": \"usr_ee3014bbc51f4156\", \"user_cart_confirmation_required\": true, \"natural_language_description\": \"かわいいグッズを購入したい。5000円以内\", \"requires_refundability\": false, \"intent_expiry\": \"2025-10-31T00:39:45.904755Z\", \"created_at\": \"2025-10-30T23:39:45.904755Z\"}, \"shipping_address\": {\"recipient\": \"あ\", \"postal_code\": \"あ\", \"city\": \"あ\", \"region\": \"あ\", \"address_line1\": \"あ\", \"country\": \"あ\"}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.829828Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=fbf612c3927c0f42...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.834016Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:shopping_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.848886Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.870624Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 797, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_dd1b41e3\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-30T23:39:45.904755Z\",\"id\":\"intent_dd1b41e3\",\"intent_expiry\":\"2025-10-31T00:3", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.870698Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.908146Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.908791Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.909207Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.IntentMandate, from=did:ap2:agent:shopping_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.909865Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate", "module": "intent_handler", "function": "handle_intent_mandate", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.909912Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate with shipping_address (AP2 v0.1 compliant)", "module": "intent_handler", "function": "handle_intent_mandate", "line": 50}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.909942Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Searching products with intent: 'かわいいグッズを購入したい。5000円以内'", "module": "intent_handler", "function": "handle_intent_mandate", "line": 54}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.909978Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using provided shipping address: あ", "module": "intent_handler", "function": "handle_intent_mandate", "line": 71}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.910196Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using LangGraph AI engine for cart generation", "module": "intent_handler", "function": "handle_intent_mandate", "line": 76}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:57.923154Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Created new handler for session: bf401d51-db42-49be-99ce-fedd8b3fad79", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 289}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.031614Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: initialize", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.031724Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"initialize\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\"}, \"arguments\": {\"protocolVersion\": \"2025-03-26\", \"clientInfo\": {\"name\": \"ap2_langgraph_client\", \"version\": \"1.0.0\"}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.035883Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.036249Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"initialize\", \"params\": {\"protocolVersion\": \"2025-03-26\", \"clientInfo\": {\"name\": \"ap2_langgraph_client\", \"version\": \"1.0.0\"}}, \"id\": 814265}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.10:38016 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.489174Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (453.37ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.489278Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:39:57 GMT\", \"server\": \"uvicorn\", \"mcp-session-id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\", \"content-length\": \"1145\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 814265, \"result\": {\"protocolVersion\": \"2025-03-26\", \"serverInfo\": {\"name\": \"merchant_agent_mcp\", \"version\": \"1.0.0\"}, \"capabilities\": {\"tools\": {\"search_products\": {\"description\": \"データベースから商品を検索\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"keywords\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}, \"description\": \"検索キーワードリスト\"}, \"limit\": {\"type\": \"integer\", \"description\": \"最大検索結果数\", \"default\": 20}}, \"required\": [\"keywords\"]}}, \"check_inventory\": {\"description\": \"在庫状況を確認\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"product_ids\": {\"type\": \"array\", \"items\": {\"type\": \"integer\"}, \"description\": \"商品IDリスト\"}}, \"required\": [\"product_ids\"]}}, \"build_cart_mandates\": {\"description\": \"AP2準拠のCartMandateを構築（未署名）\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"cart_plan\": {\"type\": \"object\", \"description\": \"カートプラン（optimize_cartの結果）\"}, \"products\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}, \"description\": \"商品情報リスト\"}, \"shipping_address\": {\"type\": \"object\", \"description\": \"AP2準拠のContactAddress\"}}, \"required\": [\"cart_plan\", \"products\"]}}}}}}, \"duration_ms\": 453.3727169036865}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.491420Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: initialize - SUCCESS (459.65ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.491483Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"initialize\", \"result\": {\"protocolVersion\": \"2025-03-26\", \"serverInfo\": {\"name\": \"merchant_agent_mcp\", \"version\": \"1.0.0\"}, \"capabilities\": {\"tools\": {\"search_products\": {\"description\": \"データベースから商品を検索\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"keywords\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}, \"description\": \"検索キーワードリスト\"}, \"limit\": {\"type\": \"integer\", \"description\": \"最大検索結果数\", \"default\": 20}}, \"required\": [\"keywords\"]}}, \"check_inventory\": {\"description\": \"在庫状況を確認\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"product_ids\": {\"type\": \"array\", \"items\": {\"type\": \"integer\"}, \"description\": \"商品IDリスト\"}}, \"required\": [\"product_ids\"]}}, \"build_cart_mandates\": {\"description\": \"AP2準拠のCartMandateを構築（未署名）\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"cart_plan\": {\"type\": \"object\", \"description\": \"カートプラン（optimize_cartの結果）\"}, \"products\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}, \"description\": \"商品情報リスト\"}, \"shipping_address\": {\"type\": \"object\", \"description\": \"AP2準拠のContactAddress\"}}, \"required\": [\"cart_plan\", \"products\"]}}}}}, \"error\": null, \"duration_ms\": 459.65075492858887}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.491515Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Initialized session: 46e81faf-e759-4282-b06b-e3b4520ed717", "module": "mcp_client", "function": "initialize", "line": 88}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.491926Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Server capabilities: {'tools': {'search_products': {'description': 'データベースから商品を検索', 'inputSchema': {'type': 'object', 'properties': {'keywords': {'type': 'array', 'items': {'type': 'string'}, 'description': '検索キーワードリスト'}, 'limit': {'type': 'integer', 'description': '最大検索結果数', 'default': 20}}, 'required': ['keywords']}}, 'check_inventory': {'description': '在庫状況を確認', 'inputSchema': {'type': 'object', 'properties': {'product_ids': {'type': 'array', 'items': {'type': 'integer'}, 'description': '商品IDリスト'}}, 'required': ['product_ids']}}, 'build_cart_mandates': {'description': 'AP2準拠のCartMandateを構築（未署名）', 'inputSchema': {'type': 'object', 'properties': {'cart_plan': {'type': 'object', 'description': 'カートプラン（optimize_cartの結果）'}, 'products': {'type': 'array', 'items': {'type': 'object'}, 'description': '商品情報リスト'}, 'shipping_address': {'type': 'object', 'description': 'AP2準拠のContactAddress'}}, 'required': ['cart_plan', 'products']}}}}", "module": "mcp_client", "function": "initialize", "line": 89}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:39:58.492323Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] MCP client initialized", "module": "intent_node", "function": "analyze_intent", "line": 35}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:16.460894Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] LLM result: {'primary_need': 'かわいいグッズを5000 円以内で購入したい', 'budget_strategy': 'low', 'key_factors': ['かわいい', '価格'], 'search_keywords': ['かわいいグッズ', 'Tシャツ', 'オリジナル']}", "module": "intent_node", "function": "analyze_intent", "line": 124}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:16.473933Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:16.474170Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"arguments\": {\"name\": \"search_products\", \"arguments\": {\"keywords\": [\" かわいいグッズ\", \"Tシャツ\", \"オリジナル\"], \"limit\": 20}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:16.474831Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:16.475041Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"search_products\", \"arguments\": {\"keywords\": [\"かわいいグッズ\", \"Tシャツ\", \"オリジナル\"], \"limit\": 20}}, \"id\": 186538}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:40:16.517210Z", "level": "INFO", "logger": "main", "message": "[search_products] Searching with query: 'かわいいグッズ Tシャツ オリジナル'", "module": "main", "function": "search_products", "line": 123}
ap2_meilisearch            | 2025-10-30T23:40:17.339727Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/search query_parameters= user_agent=python-httpx/0.28.1 status_code=200}: meilisearch: close time.busy=46.3ms time.idle=176ms
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:40:17.358734Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Search 'かわいいグッズ Tシャツ オリジナル' returned 6 products", "module": "search_engine", "function": "search", "line": 187}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:40:17.529378Z", "level": "INFO", "logger": "main", "message": "[search_products] Returned 6 products for keywords: ['かわいいグッズ', 'Tシャツ', 'オリジナル']", "module": "main", "function": "search_products", "line": 148}
ap2_merchant_agent_mcp     | INFO:     172.18.0.10:60454 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.535848Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (1060.77ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.535930Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:40:16 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3086\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 186538, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"products\\\": [\\n    {\\n      \\\"id\\\": \\\"3446cca8-fe68-4354-a518-63eb3e47d27f\\\",\\n      \\\"sku\\\": \\\"MUGI-KEYCHAIN-001\\\",\\n      \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n      \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n      \\\"price_cents\\\": 80000,\\n      \\\"price_jpy\\\": 800.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\",\\n      \\\"sku\\\": \\\"MUGI-CLOCK-001\\\",\\n      \\\"name\\\": \\\"むぎぼー時計\\\",\\n      \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n      \\\"price_cents\\\": 350000,\\n      \\\"price_jpy\\\": 3500.0,\\n      \\\"inventory_count\\\": 30,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"cf08568b-8115-461c-aa7e-5a2e07bf4476\\\",\\n      \\\"sku\\\": \\\"MUGI-POUCH-001\\\",\\n      \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n      \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n      \\\"price_cents\\\": 95000,\\n      \\\"price_jpy\\\": 950.0,\\n      \\\"inventory_count\\\": 120,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"e534386f-c89b-4548-9734-78bd34958f88\\\",\\n      \\\"sku\\\": \\\"MUGI-MUG-001\\\",\\n      \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n      \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n      \\\"price_cents\\\": 120000,\\n      \\\"price_jpy\\\": 1200.0,\\n      \\\"inventory_count\\\": 80,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"eb0e5de8-679d-4445-8e64-a1d4d40097fd\\\",\\n      \\\"sku\\\": \\\"MUGI-SOCKS-001\\\",\\n      \\\"name\\\": \\\"むぎぼー靴下\\\",\\n      \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n      \\\"price_cents\\\": 85000,\\n      \\\"price_jpy\\\": 850.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\",\\n      \\\"sku\\\": \\\"MUGI-PLATE-001\\\",\\n      \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n      \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n      \\\"price_cents\\\": 190000,\\n      \\\"price_jpy\\\": 1900.0,\\n      \\\"inventory_count\\\": 70,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    }\\n  ]\\n}\"}], \"isError\": false}}, \"duration_ms\": 1060.774564743042}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.536208Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (1061.98ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.536261Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"products\\\": [\\n    {\\n      \\\"id\\\": \\\"3446cca8-fe68-4354-a518-63eb3e47d27f\\\",\\n      \\\"sku\\\": \\\"MUGI-KEYCHAIN-001\\\",\\n      \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n      \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n      \\\"price_cents\\\": 80000,\\n      \\\"price_jpy\\\": 800.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\",\\n      \\\"sku\\\": \\\"MUGI-CLOCK-001\\\",\\n      \\\"name\\\": \\\"むぎぼー時計\\\",\\n      \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n      \\\"price_cents\\\": 350000,\\n      \\\"price_jpy\\\": 3500.0,\\n      \\\"inventory_count\\\": 30,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"cf08568b-8115-461c-aa7e-5a2e07bf4476\\\",\\n      \\\"sku\\\": \\\"MUGI-POUCH-001\\\",\\n      \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n      \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペ ンケースとして使えます。\\\",\\n      \\\"price_cents\\\": 95000,\\n      \\\"price_jpy\\\": 950.0,\\n      \\\"inventory_count\\\": 120,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"e534386f-c89b-4548-9734-78bd34958f88\\\",\\n      \\\"sku\\\": \\\"MUGI-MUG-001\\\",\\n      \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n      \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n      \\\"price_cents\\\": 120000,\\n      \\\"price_jpy\\\": 1200.0,\\n      \\\"inventory_count\\\": 80,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"eb0e5de8-679d-4445-8e64-a1d4d40097fd\\\",\\n      \\\"sku\\\": \\\"MUGI-SOCKS-001\\\",\\n      \\\"name\\\": \\\"むぎぼー靴下\\\",\\n      \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n      \\\"price_cents\\\": 85000,\\n      \\\"price_jpy\\\": 850.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\",\\n      \\\"sku\\\": \\\"MUGI-PLATE-001\\\",\\n      \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n      \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n      \\\"price_cents\\\": 190000,\\n      \\\"price_jpy\\\": 1900.0,\\n      \\\"inventory_count\\\": 70,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    }\\n  ]\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 1061.9750022888184}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.536323Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool search_products executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.536763Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.search_node", "message": "[search_products] MCP returned 6 products", "module": "search_node", "function": "search_products", "line": 69}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.539287Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.539319Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"arguments\": {\"name\": \"check_inventory\", \"arguments\": {\"product_ids\": [\"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"e534386f-c89b-4548-9734-78bd34958f88\", \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"f0f41c9f-a31d-4a88-a180-96149a9057fc\"]}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.539837Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.540050Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"check_inventory\", \"arguments\": {\"product_ids\": [\"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"e534386f-c89b-4548-9734-78bd34958f88\", \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"f0f41c9f-a31d-4a88-a180-96149a9057fc\"]}}, \"id\": 316395}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:40:17.546316Z", "level": "INFO", "logger": "main", "message": "[check_inventory] Inventory: {'3446cca8-fe68-4354-a518-63eb3e47d27f': 100, '1530a7db-6b7a-458e-b7b9-f510f6fdaa89': 30, 'cf08568b-8115-461c-aa7e-5a2e07bf4476': 120, 'e534386f-c89b-4548-9734-78bd34958f88': 80, 'eb0e5de8-679d-4445-8e64-a1d4d40097fd': 100, 'f0f41c9f-a31d-4a88-a180-96149a9057fc': 70}", "module": "main", "function": "check_inventory", "line": 202}
ap2_merchant_agent_mcp     | INFO:     172.18.0.10:60454 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.547725Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (7.86ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.547771Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:40:16 GMT\", \"server\": \"uvicorn\", \"content-length\": \"431\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 316395, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"inventory\\\": {\\n    \\\"3446cca8-fe68-4354-a518-63eb3e47d27f\\\": 100,\\n    \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\": 30,\\n    \\\"cf08568b-8115-461c-aa7e-5a2e07bf4476\\\": 120,\\n    \\\"e534386f-c89b-4548-9734-78bd34958f88\\\": 80,\\n    \\\"eb0e5de8-679d-4445-8e64-a1d4d40097fd\\\": 100,\\n    \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\": 70\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 7.8563690185546875}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.547984Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (8.41ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.548010Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"inventory\\\": {\\n    \\\"3446cca8-fe68-4354-a518-63eb3e47d27f\\\": 100,\\n    \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\": 30,\\n    \\\"cf08568b-8115-461c-aa7e-5a2e07bf4476\\\": 120,\\n    \\\"e534386f-c89b-4548-9734-78bd34958f88\\\": 80,\\n    \\\"eb0e5de8-679d-4445-8e64-a1d4d40097fd\\\": 100,\\n    \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\": 70\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 8.409976959228516}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.548029Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool check_inventory executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:40:17.548068Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.inventory_node", "message": "[check_inventory] MCP checked 6 products", "module": "inventory_node", "function": "check_inventory", "line": 62}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.732561Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.optimization_node", "message": "[optimize_cart] LLM generated 3 cart plans", "module": "optimization_node", "function": "optimize_cart", "line": 164}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.742716Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Creating 3 unsigned CartMandates...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 66}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.743292Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.743393Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"コスパ最適プラン (4,900円)\", \"description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"quantity\": 1}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"quantity\": 1}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"quantity\": 1}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"quantity\": 1}]}, \"products\": [{\"id\": \"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.744219Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.744296Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"コスパ最適プラン (4,900円)\", \"description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"quantity\": 1}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"quantity\": 1}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"quantity\": 1}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"quantity\": 1}]}, \"products\": [{\"id\": \"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 368072}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.10:56690 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.800699Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (56.38ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.800820Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:35 GMT\", \"server\": \"uvicorn\", \"content-length\": \"4967\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 368072, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_ab329e26\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_ab329e26\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼープレート皿\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1900.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーマグカップ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1200.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーポーチ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 950.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー靴下\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 850.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 490.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5890.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:43:35.790876Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:43:35.791618Z\\\",\\n      \\\"cart_name\\\": \\\"コスパ最適プラン (4,900円)\\\",\\n      \\\"cart_description\\\": \\\"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\",\\n          \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n          \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"e534386f-c89b-4548-9734-78bd34958f88\\\",\\n          \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n          \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"cf08568b-8115-461c-aa7e-5a2e07bf4476\\\",\\n          \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n          \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"eb0e5de8-679d-4445-8e64-a1d4d40097fd\\\",\\n          \\\"name\\\": \\\"むぎぼー靴下\\\",\\n          \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 56.37502670288086}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.801586Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (57.98ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.801632Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_ab329e26\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_ab329e26\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼープレート皿\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1900.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーマグカップ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1200.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーポーチ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 950.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー靴下\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 850.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 490.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5890.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:43:35.790876Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:43:35.791618Z\\\",\\n      \\\"cart_name\\\": \\\"コスパ最適プラン (4,900円)\\\",\\n      \\\"cart_description\\\": \\\"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\",\\n          \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n          \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"e534386f-c89b-4548-9734-78bd34958f88\\\",\\n          \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n          \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"cf08568b-8115-461c-aa7e-5a2e07bf4476\\\",\\n          \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n          \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"eb0e5de8-679d-4445-8e64-a1d4d40097fd\\\",\\n          \\\"name\\\": \\\"むぎぼー靴下\\\",\\n          \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 57.984113693237305}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.801705Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.801737Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_ab329e26, plan=コスパ最適プラン (4,900円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.802111Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.802281Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"高品質プラン (5,400円)\", \"description\": \"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\", \"items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"quantity\": 1}, {\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"quantity\": 1}]}, \"products\": [{\"id\": \"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーア クリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明る く彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.802731Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.802789Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"高品質プラン (5,400円)\", \"description\": \"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\", \"items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"quantity\": 1}, {\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"quantity\": 1}]}, \"products\": [{\"id\": \"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 432835}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.10:56690 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent_mcp     | INFO:     172.18.0.10:56690 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.806546Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (3.76ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.806632Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:35 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3084\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 432835, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_a6ea098c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_a6ea098c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼープレート皿\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1900.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 540.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5940.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:43:35.804586Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:43:35.804742Z\\\",\\n      \\\"cart_name\\\": \\\"高品質プラン (5,400円)\\\",\\n      \\\"cart_description\\\": \\\"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お 部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\",\\n          \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n          \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 3.756999969482422}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.806863Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (4.52ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.806917Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_a6ea098c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_a6ea098c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼープレート皿\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1900.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 540.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5940.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:43:35.804586Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:43:35.804742Z\\\",\\n      \\\"cart_name\\\": \\\"高品質プラン (5,400円)\\\",\\n      \\\"cart_description\\\": \\\"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させた おすすめの組み合わせです。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"f0f41c9f-a31d-4a88-a180-96149a9057fc\\\",\\n          \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n          \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1900.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 4.522562026977539}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.806957Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.806980Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_a6ea098c, plan=高品質プラン (5,400円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.807958Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.808845Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"シンプルプラン (3,500円)\", \"description\": \"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\", \"items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"quantity\": 1}]}, \"products\": [{\"id\": \"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.809570Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.809636Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"46e81faf-e759-4282-b06b-e3b4520ed717\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"シンプルプラン (3,500円)\", \"description\": \"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\", \"items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"quantity\": 1}]}, \"products\": [{\"id\": \"3446cca8-fe68-4354-a518-63eb3e47d27f\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 43681}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.813868Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (4.24ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.813939Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:35 GMT\", \"server\": \"uvicorn\", \"content-length\": \"2467\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 43681, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_1a5ccade\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_1a5ccade\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 350.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4350.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:43:35.811655Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:43:35.811670Z\\\",\\n      \\\"cart_name\\\": \\\"シンプルプラン (3,500円)\\\",\\n      \\\"cart_description\\\": \\\"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 4.235267639160156}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.814233Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (5.25ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.814356Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_1a5ccade\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_1a5ccade\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 350.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4350.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:43:35.811655Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:43:35.811670Z\\\",\\n      \\\"cart_name\\\": \\\"シンプルプラン (3,500円)\\\",\\n      \\\"cart_description\\\": \\\"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 5.247592926025391}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.814458Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.814500Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_1a5ccade, plan=シンプルプラン (3,500円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.814539Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created 3 unsigned CartMandates, sending to Merchant for signature...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 116}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.814907Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Processing 3 CartMandates in parallel...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 330}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.815892Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.815993Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.816980Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.817035Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_a6ea098c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_a6ea098c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.804586Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.804742Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.817255Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:35.817313Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_1a5ccade\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1a5ccade\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.811655Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.811670Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant               | [2025-10-30 23:43:36,266] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_ab329e26
ap2_merchant               | [2025-10-30 23:43:36,280] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_a6ea098c
ap2_merchant               | [2025-10-30 23:43:36,281] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_1a5ccade
ap2_merchant               | [2025-10-30 23:43:36,283] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_ab329e26
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.291254Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.400849Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.445808Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=053016b1f380dcc6..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-30 23:43:36,500] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_a6ea098c
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.502949Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.503783Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.504561Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=6a85a21574eb366c..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-30 23:43:36,512] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_1a5ccade
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.512322Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.512696Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.513223Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=e34e237bb0c8ae0f..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.583133Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_a6ea098c", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.585233Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_a6ea098c (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.10:45320 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.606644Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (789.74ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.606848Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:35 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3605\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_a6ea098c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_a6ea098c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.804586Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIzYzgwNTIwNS1lZThhLTQxZGYtYWIxMi00YWI1NzU1ZDE4ZWIiLCJjYXJ0X2hhc2giOiI2YTg1YTIxNTc0ZWIzNjZjZGMyZTI1YzBhYWRjYTljZTk2MGUyODQwNGU4NmMxODZhYzZiOGRlNmYxY2I3NDdiIn0.MEUCIQCF3fcVU0KSGYqjZD3l3APTHDpWh4H3GPVRxETi48KtygIgSCu7Fa2syWxRZX-zYaYFB5VG7M-Sqxl8073FQxM3--E\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.804742Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"NIW3zubbzO07wWnyxIibMnFPnmaFTK/7QvbHftPRcV5rHQKcy2gD+D/555ez9ylqNjXwIk4xmCWdbHHfh0DMAA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.503631Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"NIW3zubbzO07wWnyxIibMnFPnmaFTK/7QvbHftPRcV5rHQKcy2gD+D/555ez9ylqNjXwIk4xmCWdbHHfh0DMAA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.503631Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIzYzgwNTIwNS1lZThhLTQxZGYtYWIxMi00YWI1NzU1ZDE4ZWIiLCJjYXJ0X2hhc2giOiI2YTg1YTIxNTc0ZWIzNjZjZGMyZTI1YzBhYWRjYTljZTk2MGUyODQwNGU4NmMxODZhYzZiOGRlNmYxY2I3NDdiIn0.MEUCIQCF3fcVU0KSGYqjZD3l3APTHDpWh4H3GPVRxETi48KtygIgSCu7Fa2syWxRZX-zYaYFB5VG7M-Sqxl8073FQxM3--E\"}, \"duration_ms\": 789.7441387176514}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.607530Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_a6ea098c, plan=高品質プラン (5,400円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.607603Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: 高品 質プラン (5,400円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.618544Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_1a5ccade", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.619096Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_1a5ccade (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.10:45330 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.625216Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (807.53ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.625531Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:35 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3216\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_1a5ccade\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1a5ccade\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.811655Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiJjZTA3M2E1Zi0xNzJiLTQyNzctOThlOC1hMjU3NjIyMDFlM2YiLCJjYXJ0X2hhc2giOiJlMzRlMjM3YmIwYzhhZTBmYzVjYWI0NGY0NjNiMjg4NmVkYjJjZmQwODI4MDdhNjliODhhN2IzY2RlMjkwNjMwIn0.MEUCIDQ9sNcyoelZQpE0FFHJpgHoiw06ysmPjX5Wg3kuPdwhAiEA2nb1RVkCgSrbB7ZdWdrFj4VMmAzSLDX9Yqw3DzyeG8k\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.811670Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"zSW+cJNoGO6y8vCoVdFGNJ9dd6Z8Yydr3NiUHeLy+0tNvXbHryEXjFoZKd9fWzT+wsP1gQQuG23BAV4rN9D6CQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.512650Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"zSW+cJNoGO6y8vCoVdFGNJ9dd6Z8Yydr3NiUHeLy+0tNvXbHryEXjFoZKd9fWzT+wsP1gQQuG23BAV4rN9D6CQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.512650Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiJjZTA3M2E1Zi0xNzJiLTQyNzctOThlOC1hMjU3NjIyMDFlM2YiLCJjYXJ0X2hhc2giOiJlMzRlMjM3YmIwYzhhZTBmYzVjYWI0NGY0NjNiMjg4NmVkYjJjZmQwODI4MDdhNjliODhhN2IzY2RlMjkwNjMwIn0.MEUCIDQ9sNcyoelZQpE0FFHJpgHoiw06ysmPjX5Wg3kuPdwhAiEA2nb1RVkCgSrbB7ZdWdrFj4VMmAzSLDX9Yqw3DzyeG8k\"}, \"duration_ms\": 807.5275421142578}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.626328Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_1a5ccade, plan=シンプルプラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.626412Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: シン プルプラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.636559Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_ab329e26", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.638440Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:35 GMT\", \"server\": \"uvicorn\", \"content-length\": \"4591\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート 皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポー チ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\"}, \"duration_ms\": 822.2167491912842}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant               | {"timestamp": "2025-10-30T23:43:36.636778Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_ab329e26 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.10:45306 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.639516Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_ab329e26, plan=コスパ最適プラン (4,900円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.640788Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: コス パ最適プラン (4,900円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.642764Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Parallel processing complete: 3 signed, 0 pending, 0 timeout, 0 rejected", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 353}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.642865Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built 3 signed CartMandates (pending: 0, timeout: 0)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 373}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.649948Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.ranking_node", "message": "[rank_and_select] Selected top 3 carts", "module": "ranking_node", "function": "rank_and_select", "line": 31}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.657523Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[create_cart_candidates] 3 carts ready (pre-signed via MCP)", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 313}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.658040Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Generated 3 cart candidates", "module": "intent_handler", "function": "handle_intent_mandate", "line": 102}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.659467Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.IntentMandate, result_type=ap2.responses.CartCandidates", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.667001Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.674502Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 8209, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.CartCandidates\",\"id\":\"a92302d1-d342-4171-80d1-7cb18e9b326e\",\"payload\":{\"cart_candidates\":[{\"artifactId\":\"artifact_1e3c61df\",\"name\":\"コスパ最適プラン (4,900円)\",\"parts\":[{\"da", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.675753Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.714307Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.716730Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:shopping_agent: ap2.responses.CartCandidates", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:36.717022Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.CartCandidates\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"fa1fb0ff-f1fc-4318-8600-f112d93ac5e8\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:43:36.660938Z\", \"nonce\": \"effc09fb280c52dd5bf768d9fdaf05ad328e0cf53ce0f9494a5f3a09c861dc03\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"intent_mandate_id\": \"intent_dd1b41e3\", \"cart_candidates\": [{\"artifactId\": \"artifact_1e3c61df\", \"name\": \"コスパ最適プラン (4,900円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心 地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_8a3085e4\", \"name\": \"高品質プラン (5,400円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_a6ea098c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_a6ea098c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.804586Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIzYzgwNTIwNS1lZThhLTQxZGYtYWIxMi00YWI1NzU1ZDE4ZWIiLCJjYXJ0X2hhc2giOiI2YTg1YTIxNTc0ZWIzNjZjZGMyZTI1YzBhYWRjYTljZTk2MGUyODQwNGU4NmMxODZhYzZiOGRlNmYxY2I3NDdiIn0.MEUCIQCF3fcVU0KSGYqjZD3l3APTHDpWh4H3GPVRxETi48KtygIgSCu7Fa2syWxRZX-zYaYFB5VG7M-Sqxl8073FQxM3--E\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.804742Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"NIW3zubbzO07wWnyxIibMnFPnmaFTK/7QvbHftPRcV5rHQKcy2gD+D/555ez9ylqNjXwIk4xmCWdbHHfh0DMAA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.503631Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_d3bd97c8\", \"name\": \"シンプルプラン (3,500円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_1a5ccade\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1a5ccade\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.811655Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiJjZTA3M2E1Zi0xNzJiLTQyNzctOThlOC1hMjU3NjIyMDFlM2YiLCJjYXJ0X2hhc2giOiJlMzRlMjM3YmIwYzhhZTBmYzVjYWI0NGY0NjNiMjg4NmVkYjJjZmQwODI4MDdhNjliODhhN2IzY2RlMjkwNjMwIn0.MEUCIDQ9sNcyoelZQpE0FFHJpgHoiw06ysmPjX5Wg3kuPdwhAiEA2nb1RVkCgSrbB7ZdWdrFj4VMmAzSLDX9Yqw3DzyeG8k\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.811670Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点 集中の選択です。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"zSW+cJNoGO6y8vCoVdFGNJ9dd6Z8Yydr3NiUHeLy+0tNvXbHryEXjFoZKd9fWzT+wsP1gQQuG23BAV4rN9D6CQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.512650Z\", \"key_id\": \"merchant\"}}}}]}], \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"merchant_name\": \"むぎぼーショップ\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | [2025-10-30 23:43:36,717] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.CartCandidates, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | INFO:     172.18.0.8:60332 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:36.802478Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (219104.04ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:36.805240Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:39:56 GMT\", \"server\": \"uvicorn\", \"content-length\": \"9854\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"fa1fb0ff-f1fc-4318-8600-f112d93ac5e8\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:43:36.660938Z\", \"nonce\": \"effc09fb280c52dd5bf768d9fdaf05ad328e0cf53ce0f9494a5f3a09c861dc03\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"2AmkP8I0nN9bK13GidkXTYE+RD+300N6FR+Veeiqlj22QLyw1oZWsJUyzA10SbD9A50fyIek436/sEm2MGNxCw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTZHQmRVRllXaHBZcUNtdjVUMGFsTGg3ckt4TzlHTkZLdnRabU5keWUyQk09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T23:43:36.660938Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.CartCandidates\", \"id\": \"a92302d1-d342-4171-80d1-7cb18e9b326e\", \"payload\": {\"intent_mandate_id\": \"intent_dd1b41e3\", \"cart_candidates\": [{\"artifactId\": \"artifact_1e3c61df\", \"name\": \"コスパ最適プラン (4,900円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_8a3085e4\", \"name\": \"高品質プラン (5,400円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_a6ea098c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_a6ea098c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 540.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5940.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.804586Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIzYzgwNTIwNS1lZThhLTQxZGYtYWIxMi00YWI1NzU1ZDE4ZWIiLCJjYXJ0X2hhc2giOiI2YTg1YTIxNTc0ZWIzNjZjZGMyZTI1YzBhYWRjYTljZTk2MGUyODQwNGU4NmMxODZhYzZiOGRlNmYxY2I3NDdiIn0.MEUCIQCF3fcVU0KSGYqjZD3l3APTHDpWh4H3GPVRxETi48KtygIgSCu7Fa2syWxRZX-zYaYFB5VG7M-Sqxl8073FQxM3--E\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.804742Z\", \"cart_name\": \"高品質プラン (5,400円)\", \"cart_description\": \"時計とプレートを組み合わせた高品質なプラン。かわいいデザインと実用性を両立させたおすすめの組み合わせです。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明 るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"NIW3zubbzO07wWnyxIibMnFPnmaFTK/7QvbHftPRcV5rHQKcy2gD+D/555ez9ylqNjXwIk4xmCWdbHHfh0DMAA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.503631Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_d3bd97c8\", \"name\": \"シンプルプラン (3,500円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_1a5ccade\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1a5ccade\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.811655Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiJjZTA3M2E1Zi0xNzJiLTQyNzctOThlOC1hMjU3NjIyMDFlM2YiLCJjYXJ0X2hhc2giOiJlMzRlMjM3YmIwYzhhZTBmYzVjYWI0NGY0NjNiMjg4NmVkYjJjZmQwODI4MDdhNjliODhhN2IzY2RlMjkwNjMwIn0.MEUCIDQ9sNcyoelZQpE0FFHJpgHoiw06ysmPjX5Wg3kuPdwhAiEA2nb1RVkCgSrbB7ZdWdrFj4VMmAzSLDX9Yqw3DzyeG8k\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.811670Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計を単品で選ぶシンプルなプラン。予算内で高品質な1点集中の選択です。\", \"raw_items\": [{\"product_id\": \"1530a7db-6b7a-458e-b7b9-f510f6fdaa89\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"zSW+cJNoGO6y8vCoVdFGNJ9dd6Z8Yydr3NiUHeLy+0tNvXbHryEXjFoZKd9fWzT+wsP1gQQuG23BAV4rN9D6CQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.512650Z\", \"key_id\": \"merchant\"}}}}]}], \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"merchant_name\": \"むぎぼーショップ\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 219104.04205322266}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:43:36,822] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_shopping_agent         |   Response Body: {
ap2_shopping_agent         |   "header": {
ap2_shopping_agent         |     "message_id": "fa1fb0ff-f1fc-4318-8600-f112d93ac5e8",
ap2_shopping_agent         |     "sender": "did:ap2:agent:merchant_agent",
ap2_shopping_agent         |     "recipient": "did:ap2:agent:shopping_agent",
ap2_shopping_agent         |     "timestamp": "2025-10-30T23:43:36.660938Z",
ap2_shopping_agent         |     "nonce": "effc09fb280c52dd5bf768d9fdaf05ad328e0cf53ce0f9494a5f3a09c861dc03",
ap2_shopping_agent         |     "schema_version": "0.2",
ap2_shopping_agent         |     "proof": {
ap2_shopping_agent         |       "algorithm": "ed25519",
ap2_shopping_agent         |       "signatureValue": "2AmkP8I0nN9bK13GidkXTYE+RD+300N6FR+Veeiqlj22QLyw1oZWsJUyzA10SbD9A50fyIek436/sEm2MGNxCw==",
ap2_shopping_agent         |       "publicKey": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTZHQmRVRllXaHBZcUNtdjVUMGFsTGg3ckt4TzlHTkZLdnRabU5keWUyQk09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_shopping_agent         |       "kid": "did:ap2:agent:merchant_agent#key-2",
ap2_shopping_agent         |       "created": "2025-10-30T23:43:36.660938Z",
ap2_shopping_agent         |       "proofPurpose": "authentication"
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "signature": null
ap2_shopping_agent         |   },
ap2_shopping_agent         |   "dataPart": {
ap2_shopping_agent         |     "@type": "ap2.responses.CartCandidates",
ap2_shopping_agent         |     "id": "a92302d1-d342-4171-80d1-7cb18e9b326e",
ap2_shopping_agent         |     "payload": {
ap2_shopping_agent         |       "intent_mandate_id": "intent_dd...
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-30 23:43:36,823] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Received 3 cart candidates from Merchant Agent
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:38.012105Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:38.024908Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.908740Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.917110Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: cart_ab329e26\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:59630 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.925686Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=cart_selection", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.926110Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.926483Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:43:46,954] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: cart_selection
ap2_shopping_agent         |   user_input: cart_ab329e26
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.966939Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:46.977397Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:47.021180Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:47.030288Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | INFO:     172.67.69.85:57749 - "OPTIONS /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.123653Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.126842Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.127306Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] Received CartMandate signature: cart_id=None, session_id=session_1761867551787_p210teo", "module": "agent", "function": "submit_cart_signature", "line": 1275}
ap2_shopping_agent         | [2025-10-30 23:43:50,128] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying CartMandate WebAuthn signature: user_id=usr_ee3014bbc51f4156
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.130531Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/verify/attestation", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.134019Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/verify/attestation\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼー マグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}, \"attestation\": {\"id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"rawId\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2lZMkZ5ZEY5aFlqTXlPV1V5TmlJc0luUnBiV1Z6ZEdGdGNDSTZNVGMyTVRnMk56Z3lOemszTTMwIiwib3JpZ2luIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwIiwiY3Jvc3NPcmlnaW4iOmZhbHNlfQ\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEQCIBOY4hpA3R6gxQ3hCRNKBUV5-tVWwlMd4DMpifq5svNMAiAETa1WFxzp58NKYzkH5p15dLVKyrK4Aec_slU70rvYiA\", \"userHandle\": \"usr_ee3014bbc51f4156\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoiY2FydF9hYjMyOWUyNiIsInRpbWVzdGFtcCI6MTc2MTg2NzgyNzk3M30\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.322322Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: nMJrfBrkstu2zYV5...", "module": "provider", "function": "verify_attestation", "line": 531}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.322913Z", "level": "INFO", "logger": "provider", "message": "  User: usr_ee3014bbc51f4156", "module": "provider", "function": "verify_attestation", "line": 532}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.322965Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 533}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.325072Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.326383Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.326421Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.326435Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.326450Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.330478Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.332775Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.346233Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.445912Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.463030Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 551}
ap2_credential_provider    | [2025-10-30 23:43:50,466] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: None
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:50.467801Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] No payment_method.token in mandate (likely IntentMandate signature), skipping Payment Network call", "module": "provider", "function": "verify_attestation", "line": 579}
ap2_credential_provider    | [2025-10-30 23:43:50,511] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=unknown, verified=True, agent_token=None...
ap2_credential_provider    | INFO:     172.18.0.8:50156 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.526586Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (396.63ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.526693Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:50 GMT\", \"server\": \"uvicorn\", \"content-length\": \"191\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"token\": \"cred_token_cf809ebb_Mh9-GFGWRwLHS0UVAm8bM9Sx\", \"details\": {\"attestation_type\": \"passkey\", \"timestamp\": \"2025-10-30T23:43:50.511594+00:00\", \"counter\": 0, \"agent_token\": null}}, \"duration_ms\": 396.6336250305176}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:43:50,526] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Sent WebAuthn verification request to Credential Provider: user_id=usr_ee3014bbc51f4156
ap2_shopping_agent         | [2025-10-30 23:43:50,526] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ WebAuthn signature verified successfully: counter=0, attestation_type=passkey
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.536958Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.537214Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] CartMandate signed by user: cart_id=None, webauthn_assertion saved", "module": "agent", "function": "submit_cart_signature", "line": 1315}
ap2_shopping_agent         | INFO:     172.67.69.85:57749 - "POST /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.549108Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.549385Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: _cart_signature_completed\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:57749 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.550661Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.550891Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:50.550991Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:43:50,575] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: cart_signature_pending
ap2_shopping_agent         |   user_input: _cart_signature_completed
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:43:50,791] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 13-14: Presenting payment methods to user
ap2_shopping_agent         |   Available Methods: 1
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:51.392540Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:51.406442Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.390965Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.391337Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: 1\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:57749 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.399568Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=payment_method_selection", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.400263Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.401657Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:43:52,410] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: payment_method_selection
ap2_shopping_agent         |   user_input: 1
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.416057Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment method tokenization for: pm_e6367cd7", "module": "agent", "function": "_tokenize_payment_method", "line": 2352}
ap2_shopping_agent         | [2025-10-30 23:43:52,415] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 15-18: Tokenizing payment method
ap2_shopping_agent         |   User ID: usr_ee3014bbc51f4156
ap2_shopping_agent         |   Payment Method ID: pm_e6367cd7
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.416118Z", "level": "INFO", "logger": "agent", "message": "\n================================================================================\n[ShoppingAgent → CredentialProvider] トークン化リクエスト送信\n  URL: http://credential_provider:8003/payment-methods/tokenize\n  User ID: usr_ee3014bbc51f4156\n  Payment Method ID: pm_e6367cd7\n================================================================================", "module": "agent", "function": "_tokenize_payment_method", "line": 2356}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.416155Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/payment-methods/tokenize", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.416181Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/payment-methods/tokenize\", \"headers\": {}, \"body\": {\"user_id\": \"usr_ee3014bbc51f4156\", \"payment_method_id\": \"pm_e6367cd7\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:52.454428Z", "level": "INFO", "logger": "provider", "message": "[tokenize_payment_method] Generated secure token for payment method: pm_e6367cd7", "module": "provider", "function": "tokenize_payment_method", "line": 772}
ap2_credential_provider    | INFO:     172.18.0.8:50156 - "POST /payment-methods/tokenize HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.456320Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (40.11ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.456368Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:52 GMT\", \"server\": \"uvicorn\", \"content-length\": \"217\", \"content-type\": \"application/json\"}, \"body\": {\"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"payment_method_id\": \"pm_e6367cd7\", \"brand\": \"Visa\", \"last4\": \"1111\", \"type\": \"basic-card\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\", \"expires_at\": \"2025-10-30T23:58:52.424086Z\"}, \"duration_ms\": 40.107011795043945}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.456414Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent ← CredentialProvider] トークン化レスポンス受信: status=200", "module": "agent", "function": "_tokenize_payment_method", "line": 2376}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.456435Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Payment method tokenized: pm_e6367cd7 → tok_53572c11_KVHnOcr...", "module": "agent", "function": "_tokenize_payment_method", "line": 2386}
ap2_shopping_agent         | [2025-10-30 23:43:52,456] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 17-18: Received tokenized payment method
ap2_shopping_agent         |   Token: tok_53572c11_KVHnOcr...
ap2_shopping_agent         | [2025-10-30 23:43:52,457] INFO in services.shopping_agent.utils.payment_helpers: [_extract_payment_amount_from_cart] CartMandate structure: has_contents=True, has_payment_request=True, has_details=True, has_total=True, total_amount={'value': 5890.0, 'currency': 'JPY'}
ap2_shopping_agent         | [2025-10-30 23:43:52,457] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Retrieving public key from Credential Provider: credential_id=nMJrfBrkstu2zYV5..., user_id=usr_ee3014bbc51f4156
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.457820Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/passkey/get-public-key", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.457881Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/passkey/get-public-key\", \"headers\": {}, \"body\": {\"credential_id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"user_id\": \"usr_ee3014bbc51f4156\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:52.469084Z", "level": "INFO", "logger": "provider", "message": "[get_passkey_public_key] Public key retrieved: credential_id=nMJrfBrkstu2zYV5..., user_id=usr_ee3014bbc51f4156", "module": "provider", "function": "get_passkey_public_key", "line": 1496}
ap2_credential_provider    | INFO:     172.18.0.8:50156 - "POST /passkey/get-public-key HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.471241Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (13.37ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.471340Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:52 GMT\", \"server\": \"uvicorn\", \"content-length\": \"205\", \"content-type\": \"application/json\"}, \"body\": {\"credential_id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"public_key_cose\": \"pQECAyYgASFYIM9xvjRy3D0Rcg+26M/ZDzL5QEALG++za+5+ItHAHMeUIlggDyZjU2j5igyJMFReu7a+Rb64akZWKEM4lfO+11oED1c=\", \"user_id\": \"usr_ee3014bbc51f4156\"}, \"duration_ms\": 13.367176055908203}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:43:52,471] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ Public key retrieved: credential_id=nMJrfBrkstu2zYV5...
ap2_shopping_agent         | [2025-10-30 23:43:52,471] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-30 23:43:52,473] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: 053016b1f380dcc6...
ap2_shopping_agent         | [2025-10-30 23:43:52,473] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: b32da416ae2c63dc...
ap2_shopping_agent         | [2025-10-30 23:43:52,488] INFO in v2.common.user_authorization: [create_user_authorization_vp] Restored public key from COSE format (DB)
ap2_shopping_agent         | [2025-10-30 23:43:52,492] INFO in v2.common.user_authorization: [create_user_authorization_vp] cnf claim with JWK added to Issuer JWT
ap2_shopping_agent         | [2025-10-30 23:43:52,493] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2407, cart_hash=053016b1f380dcc6..., payment_hash=b32da416ae2c63dc...
ap2_shopping_agent         | [2025-10-30 23:43:52,493] INFO in services.shopping_agent.utils.payment_helpers: [_generate_user_authorization_for_payment] Generated user_authorization VP: length=2407
ap2_shopping_agent         | [2025-10-30 23:43:52,493] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] transaction_type=human_not_present (no strong authentication detected)
ap2_shopping_agent         | [2025-10-30 23:43:52,494] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Performing risk assessment...
ap2_shopping_agent         | [2025-10-30 23:43:52,494] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Invalid amount value: 5890.0
ap2_shopping_agent         | [2025-10-30 23:43:52,494] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Failed to parse amounts for constraint check
ap2_shopping_agent         | [2025-10-30 23:43:52,497] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Assessment completed: risk_score=3, recommendation=approve, fraud_indicators=['card_not_present_transaction']
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.498341Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created with user_authorization: has_user_auth=True", "module": "agent", "function": "_create_payment_mandate", "line": 2121}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.498385Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created: amount=5890.0 JPY, payment_method=Visa ****1111, token=tok_53572c11_KVHnOcr..., risk_score=3", "module": "agent", "function": "_create_payment_mandate", "line": 2126}
ap2_shopping_agent         | [2025-10-30 23:43:52,498] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Risk assessment completed: score=3, recommendation=approve, indicators=['card_not_present_transaction']
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.538525Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:52.547430Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | INFO:     172.67.69.85:24884 - "OPTIONS /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:55.653599Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:55.683234Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Verifying attestation for PaymentMandate: payment_c2ba4b9a", "module": "agent", "function": "submit_payment_attestation", "line": 1427}
ap2_shopping_agent         | [2025-10-30 23:43:55,685] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying PaymentMandate attestation: payment_id=payment_c2ba4b9a
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:55.688008Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/verify/attestation", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:55.688824Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/verify/attestation\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16SXNJbVY0Y0NJNk1UYzJNVGcyT0RFek1pd2libUptSWpveE56WXhPRFkzT0RNeUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpXVURsTVVtRldXVUpwVlRoRmJWOHpXVUY2TUVFemIxRnJla2haTm1WUlpVczRPV290WTJ0SVEzZDNJaXdpYVdGMElqb3hOell4T0RZM09ETXlMQ0p6WkY5b1lYTm9Jam9pTXpKak9EWmxOalJqT0RZMk1UYzJObU0zTkRVeU1XSTRaalUzWXpJMU5UbGpOR1ppTnpNNU0yVTBPR0ZrTUdGbU1tWmhZamxqT0RBMk5qQXhPRE14TUNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1Jek1tUmhOREUyWVdVeVl6WXpaR00zWldVM1pHSTROMkk1TVRVMk1tVXhOMlU0TWpJek1qRmhabVE1WldNd05tTXlNalJpTURjNFlUWmlNMlpqWkdZaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxaTWtaNVpFWTVhRmxxVFhsUFYxVjVUbWxKYzBsdVVuQmlWMVo2WkVkR2RHTkRTVFpOVkdNeVRWUm5NazU2WjNsT2Vtc3pUVE13SWl3aWIzSnBaMmx1SWpvaWFIUjBjRG92TDJ4dlkyRnNhRzl6ZERvek1EQXdJaXdpWTNKdmMzTlBjbWxuYVc0aU9tWmhiSE5sZlEiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lCT1k0aHBBM1I2Z3hRM2hDUk5LQlVWNS10Vld3bE1kNERNcGlmcTVzdk5NQWlBRVRhMVdGeHpwNThOS1l6a0g1cDE1ZExWS3lySzRBZWNfc2xVNzBydllpQSIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2lZMkZ5ZEY5aFlqTXlPV1V5TmlJc0luUnBiV1Z6ZEdGdGNDSTZNVGMyTVRnMk56Z3lOemszTTMwIn0sImNhcnRfaGFzaCI6IjA1MzAxNmIxZjM4MGRjYzZlOGVjOWIyNWE5OGVjYjkwNWM0ZTkwNTRiNTk3NjNhOGRiZGY0Mzc4NWVkMzgwMTgiLCJwYXltZW50X2hhc2giOiJiMzJkYTQxNmFlMmM2M2RjN2VlN2RiODdiOTE1NjJlMTdlODIyMzIxYWZkOWVjMDZjMjI0YjA3OGE2YjNmY2RmIn0\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"attestation\": {\"id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"rawId\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCIsIm9yaWdpbiI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImNyb3NzT3JpZ2luIjpmYWxzZX0\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEUCIQCMDRTBF0m7bQa8uy3M4R4NJVJDkLWdkRsFARt9yZ76rAIgfhEO2QSmAkJJ4LPzEpJByNp3sG8Ng-IAXugCUcqddek\", \"userHandle\": \"usr_ee3014bbc51f4156\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoicGF5bWVudF9jMmJhNGI5YSIsInRpbWVzdGFtcCI6MTc2MTg2NzgzMzc2MH0\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753098Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: nMJrfBrkstu2zYV5...", "module": "provider", "function": "verify_attestation", "line": 531}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753366Z", "level": "INFO", "logger": "provider", "message": "  User: usr_ee3014bbc51f4156", "module": "provider", "function": "verify_attestation", "line": 532}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753413Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 533}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753619Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753801Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753828Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753844Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.753867Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.754014Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.754050Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.754254Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.756660Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.767768Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 551}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.768271Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] PaymentMandate contains payment_method.token, calling Payment Network (Step 23)", "module": "provider", "function": "verify_attestation", "line": 570}
ap2_credential_provider    | [2025-10-30 23:43:55,768] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: usr_ee3014bbc51f4156
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.768634Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Requesting Agent Token from Payment Network: payment_mandate_id=payment_c2ba4b9a", "module": "provider", "function": "_request_agent_token_from_network", "line": 1807}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.768721Z", "level": "INFO", "logger": "provider", "message": "HTTP Request: POST http://payment_network:8005/network/tokenize", "module": "logger", "function": "log_http_request", "line": 182}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:55.768833Z", "level": "DEBUG", "logger": "provider", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://payment_network:8005/network/tokenize\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16SXNJbVY0Y0NJNk1UYzJNVGcyT0RFek1pd2libUptSWpveE56WXhPRFkzT0RNeUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpXVURsTVVtRldXVUpwVlRoRmJWOHpXVUY2TUVFemIxRnJla2haTm1WUlpVczRPV290WTJ0SVEzZDNJaXdpYVdGMElqb3hOell4T0RZM09ETXlMQ0p6WkY5b1lYTm9Jam9pTXpKak9EWmxOalJqT0RZMk1UYzJObU0zTkRVeU1XSTRaalUzWXpJMU5UbGpOR1ppTnpNNU0yVTBPR0ZrTUdGbU1tWmhZamxqT0RBMk5qQXhPRE14TUNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1Jek1tUmhOREUyWVdVeVl6WXpaR00zWldVM1pHSTROMkk1TVRVMk1tVXhOMlU0TWpJek1qRmhabVE1WldNd05tTXlNalJpTURjNFlUWmlNMlpqWkdZaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxaTWtaNVpFWTVhRmxxVFhsUFYxVjVUbWxKYzBsdVVuQmlWMVo2WkVkR2RHTkRTVFpOVkdNeVRWUm5NazU2WjNsT2Vtc3pUVE13SWl3aWIzSnBaMmx1SWpvaWFIUjBjRG92TDJ4dlkyRnNhRzl6ZERvek1EQXdJaXdpWTNKdmMzTlBjbWxuYVc0aU9tWmhiSE5sZlEiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVRQ0lCT1k0aHBBM1I2Z3hRM2hDUk5LQlVWNS10Vld3bE1kNERNcGlmcTVzdk5NQWlBRVRhMVdGeHpwNThOS1l6a0g1cDE1ZExWS3lySzRBZWNfc2xVNzBydllpQSIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2lZMkZ5ZEY5aFlqTXlPV1V5TmlJc0luUnBiV1Z6ZEdGdGNDSTZNVGMyTVRnMk56Z3lOemszTTMwIn0sImNhcnRfaGFzaCI6IjA1MzAxNmIxZjM4MGRjYzZlOGVjOWIyNWE5OGVjYjkwNWM0ZTkwNTRiNTk3NjNhOGRiZGY0Mzc4NWVkMzgwMTgiLCJwYXltZW50X2hhc2giOiJiMzJkYTQxNmFlMmM2M2RjN2VlN2RiODdiOTE1NjJlMTdlODIyMzIxYWZkOWVjMDZjMjI0YjA3OGE2YjNmY2RmIn0\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"attestation\": {\"id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"rawId\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCIsIm9yaWdpbiI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImNyb3NzT3JpZ2luIjpmYWxzZX0\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEUCIQCMDRTBF0m7bQa8uy3M4R4NJVJDkLWdkRsFARt9yZ76rAIgfhEO2QSmAkJJ4LPzEpJByNp3sG8Ng-IAXugCUcqddek\", \"userHandle\": \"usr_ee3014bbc51f4156\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoicGF5bWVudF9jMmJhNGI5YSIsInRpbWVzdGFtcCI6MTc2MTg2NzgzMzc2MH0\"}, \"payment_method_token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"transaction_context\": {\"credential_provider_id\": \"did:ap2:agent:credential_provider\", \"timestamp\": \"2025-10-30T23:43:55.768669+00:00\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_network        | [2025-10-30 23:43:55,953] INFO in network: [DemoPaymentNetwork] Received tokenization request: payment_mandate_id=payment_c2ba4b9a, payment_method_token=tok_53572c11_KVHnOcr...
ap2_payment_network        | [2025-10-30 23:43:56,008] INFO in common.redis_client: [RedisClient] Connected to Redis: redis://redis:6379/2
ap2_payment_network        | [2025-10-30 23:43:56,086] INFO in services.payment_network.utils.token_helpers: [DemoPaymentNetwork] Issued Agent Token (Redis): agent_tok_demopaymentnetwork_c0e..., expires_at=2025-10-31T00:43:55.959567+00:00, ttl=3600s
ap2_payment_network        | INFO:     172.18.0.13:52944 - "POST /network/tokenize HTTP/1.1" 200 OK
ap2_credential_provider    | [2025-10-30 23:43:56,128] INFO in httpx: HTTP Request: POST http://payment_network:8005/network/tokenize "HTTP/1.1 200 OK"
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:56.134104Z", "level": "INFO", "logger": "provider", "message": "HTTP Response: 200 (365.33ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:56.134192Z", "level": "DEBUG", "logger": "provider", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"186\", \"content-type\": \"application/json\"}, \"body\": {\"agent_token\": \"agent_tok_demopaymentnetwork_c0ebc3ea_u-adERprOB9e-dHAq_R5PJ7r\", \"expires_at\": \"2025-10-31T00:43:55.959567Z\", \"network_name\": \"DemoPaymentNetwork\", \"token_type\": \"agent_token\"}, \"duration_ms\": 365.33427238464355}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:56.134228Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Received Agent Token from Payment Network: agent_tok_demopaymentnetwork_c0e..., network_name=DemoPaymentNetwork", "module": "provider", "function": "_request_agent_token_from_network", "line": 1831}
ap2_credential_provider    | [2025-10-30 23:43:56,138] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=usr_ee3014bbc51f4156, verified=True, agent_token=agent_tok_demopaymentnetwork_c0e...
ap2_credential_provider    | INFO:     172.18.0.8:50156 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | [2025-10-30 23:43:56,149] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ PaymentMandate attestation verified: payment_id=payment_c2ba4b9a
ap2_shopping_agent         | [2025-10-30 23:43:56,149] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Retrieving public key from Credential Provider: credential_id=nMJrfBrkstu2zYV5..., user_id=usr_ee3014bbc51f4156
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.149394Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (461.63ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.149493Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"251\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"token\": \"cred_token_c74ff482_gKJu9yo24TKjjfsFHxR8h8Nr\", \"details\": {\"attestation_type\": \"passkey\", \"timestamp\": \"2025-10-30T23:43:56.138429+00:00\", \"counter\": 0, \"agent_token\": \"agent_tok_demopaymentnetwork_c0ebc3ea_u-adERprOB9e-dHAq_R5PJ7r\"}}, \"duration_ms\": 461.63320541381836}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.149580Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Attestation verified, processing payment...", "module": "agent", "function": "submit_payment_attestation", "line": 1447}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.149656Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/passkey/get-public-key", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.149673Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/passkey/get-public-key\", \"headers\": {}, \"body\": {\"credential_id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"user_id\": \"usr_ee3014bbc51f4156\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:56.154884Z", "level": "INFO", "logger": "provider", "message": "[get_passkey_public_key] Public key retrieved: credential_id=nMJrfBrkstu2zYV5..., user_id=usr_ee3014bbc51f4156", "module": "provider", "function": "get_passkey_public_key", "line": 1496}
ap2_credential_provider    | INFO:     172.18.0.8:50156 - "POST /passkey/get-public-key HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.156787Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (7.09ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.156833Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"205\", \"content-type\": \"application/json\"}, \"body\": {\"credential_id\": \"nMJrfBrkstu2zYV5-kgiIz2rink\", \"public_key_cose\": \"pQECAyYgASFYIM9xvjRy3D0Rcg+26M/ZDzL5QEALG++za+5+ItHAHMeUIlggDyZjU2j5igyJMFReu7a+Rb64akZWKEM4lfO+11oED1c=\", \"user_id\": \"usr_ee3014bbc51f4156\"}, \"duration_ms\": 7.087945938110352}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:43:56,156] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ Public key retrieved: credential_id=nMJrfBrkstu2zYV5...
ap2_shopping_agent         | [2025-10-30 23:43:56,157] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-30 23:43:56,158] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: 053016b1f380dcc6...
ap2_shopping_agent         | [2025-10-30 23:43:56,158] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: f6d2da3d56c637f4...
ap2_shopping_agent         | [2025-10-30 23:43:56,159] INFO in v2.common.user_authorization: [create_user_authorization_vp] Restored public key from COSE format (DB)
ap2_shopping_agent         | [2025-10-30 23:43:56,159] INFO in v2.common.user_authorization: [create_user_authorization_vp] cnf claim with JWK added to Issuer JWT
ap2_shopping_agent         | [2025-10-30 23:43:56,160] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2420, cart_hash=053016b1f380dcc6..., payment_hash=f6d2da3d56c637f4...
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.160718Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] SD-JWT-VC user_authorization generated: user_id=usr_ee3014bbc51f4156, vp_length=2420", "module": "agent", "function": "submit_payment_attestation", "line": 1491}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.170555Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.170972Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] PaymentMandate signed by user: payment_id=payment_c2ba4b9a, next_step=payment_execution", "module": "agent", "function": "submit_payment_attestation", "line": 1512}
ap2_shopping_agent         | INFO:     172.67.69.85:24884 - "POST /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.182213Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.182475Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761867551787_p210teo\n  user_id: usr_ee3014bbc51f4156\n  user_input: _payment_signature_completed\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:24884 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.185718Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761867551787_p210teo, step=webauthn_signature_requested", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.186992Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761867551787_p210teo)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.188978Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761867551787_p210teo", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:43:56,213] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: webauthn_signature_requested
ap2_shopping_agent         |   user_input: _payment_signature_completed
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:43:56,231] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting payment processing via Merchant Agent for PaymentMandate: payment_c2ba4b9a
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.233438Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.233751Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 6920, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_c2ba4b9a\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました 。\",\"c", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.233804Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.236449Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.237343Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | [2025-10-30 23:43:56,237] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信（PaymentRequest）
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: b8da704e-61f6-4e5f-9073-fbd1c9aa1d79
ap2_shopping_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_shopping_agent         |   PaymentMandate ID: payment_c2ba4b9a
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.237445Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"b8da704e-61f6-4e5f-9073-fbd1c9aa1d79\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:43:56.231587Z\", \"nonce\": \"b307bc9982018010d58d13f31841f345ea37f98d2a6671a90002ada6c0a54adf\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16WXNJbVY0Y0NJNk1UYzJNVGcyT0RFek5pd2libUptSWpveE56WXhPRFkzT0RNMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUl0Y2xKblRUWjBUa05FZVdWVU0wZFFhWEZGYkVOeGVVWkJRM2RFWm5WTGRUWnRkRmt5TkdveVdUSnJJaXdpYVdGMElqb3hOell4T0RZM09ETTJMQ0p6WkY5b1lYTm9Jam9pWldVeE9HVXdOakkwT1dVek5tTmtNakpoTUdRek5UQXpPV1kxT0RNNU16RmpZakF5TXprNU1UTTROV0kyTTJJMk5UVTJOVEl5WlRRMU9ETXdNV1l5WmlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1ZMlpESmtZVE5rTlRaak5qTTNaalF4WVRnME1tVTNaVEUzT0RabVl6azJabUV6TXpKaE5qVTBPREV3WkRSallXTTBPVFppWmpkbU5XUXdaREZtTnpNaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxqUjBZMVlsZFdkV1JHT1dwTmJVcG9Ua2RKTlZsVFNYTkpibEp3WWxkV2VtUkhSblJqUTBrMlRWUmpNazFVWnpKT2VtZDZUWHBqTWsxSU1DSXNJbTl5YVdkcGJpSTZJbWgwZEhBNkx5OXNiMk5oYkdodmMzUTZNekF3TUNJc0ltTnliM056VDNKcFoybHVJanBtWVd4elpYMCIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVVDSVFDTURSVEJGMG03YlFhOHV5M000UjROSlZKRGtMV2RrUnNGQVJ0OXlaNzZyQUlnZmhFTzJRU21Ba0pKNExQekVwSkJ5TnAzc0c4TmctSUFYdWdDVWNxZGRlayIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCJ9LCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4IiwicGF5bWVudF9oYXNoIjoiZjZkMmRhM2Q1NmM2MzdmNDFhODQyZTdlMTc4NmZjOTZmYTMzMmE2NTQ4MTBkNGNhYzQ5NmJmN2Y1ZDBkMWY3MyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザイ ンのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎ ぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \" むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.238658Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent:8001/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:56.239044Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent:8001/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"b8da704e-61f6-4e5f-9073-fbd1c9aa1d79\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:43:56.231587Z\", \"nonce\": \"b307bc9982018010d58d13f31841f345ea37f98d2a6671a90002ada6c0a54adf\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"r291CXVyxDlOR8whw/RomFDnIfuTR13jhHzhMv91UZ9+1JlrHqPhcuadpnmjYAwvEhJKNzlHJOsntc2dgUgRBQ==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQSt4cHkrMkRqZ0FJcVBEUERmV0JLeExVd0NNL2pGdFZ6WlN3b3gyaGZtL0k9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:shopping_agent#key-2\", \"created\": \"2025-10-30T23:43:56.231587Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.PaymentMandate\", \"id\": \"payment_c2ba4b9a\", \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16WXNJbVY0Y0NJNk1UYzJNVGcyT0RFek5pd2libUptSWpveE56WXhPRFkzT0RNMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUl0Y2xKblRUWjBUa05FZVdWVU0wZFFhWEZGYkVOeGVVWkJRM2RFWm5WTGRUWnRkRmt5TkdveVdUSnJJaXdpYVdGMElqb3hOell4T0RZM09ETTJMQ0p6WkY5b1lYTm9Jam9pWldVeE9HVXdOakkwT1dVek5tTmtNakpoTUdRek5UQXpPV1kxT0RNNU16RmpZakF5TXprNU1UTTROV0kyTTJJMk5UVTJOVEl5WlRRMU9ETXdNV1l5WmlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1ZMlpESmtZVE5rTlRaak5qTTNaalF4WVRnME1tVTNaVEUzT0RabVl6azJabUV6TXpKaE5qVTBPREV3WkRSallXTTBPVFppWmpkbU5XUXdaREZtTnpNaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxqUjBZMVlsZFdkV1JHT1dwTmJVcG9Ua2RKTlZsVFNYTkpibEp3WWxkV2VtUkhSblJqUTBrMlRWUmpNazFVWnpKT2VtZDZUWHBqTWsxSU1DSXNJbTl5YVdkcGJpSTZJbWgwZEhBNkx5OXNiMk5oYkdodmMzUTZNekF3TUNJc0ltTnliM056VDNKcFoybHVJanBtWVd4elpYMCIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVVDSVFDTURSVEJGMG03YlFhOHV5M000UjROSlZKRGtMV2RrUnNGQVJ0OXlaNzZyQUlnZmhFTzJRU21Ba0pKNExQekVwSkJ5TnAzc0c4TmctSUFYdWdDVWNxZGRlayIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCJ9LCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4IiwicGF5bWVudF9oYXNoIjoiZjZkMmRhM2Q1NmM2MzdmNDFhODQyZTdlMTc4NmZjOTZmYTMzMmE2NTQ4MTBkNGNhYzQ5NmJmN2Y1ZDBkMWY3MyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼ ーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼ ー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | [2025-10-30 23:43:56,262] INFO in v2.common.base_agent:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message
ap2_merchant_agent         |   受信メッセージ: ID=b8da704e-61f6-4e5f-9073-fbd1c9aa1d79
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.263268Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:shopping_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.263836Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"b8da704e-61f6-4e5f-9073-fbd1c9aa1d79\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:43:56.231587Z\", \"nonce\": \"b307bc9982018010d58d13f31841f345ea37f98d2a6671a90002ada6c0a54adf\", \"schema_version\": \"0.2\"}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16WXNJbVY0Y0NJNk1UYzJNVGcyT0RFek5pd2libUptSWpveE56WXhPRFkzT0RNMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUl0Y2xKblRUWjBUa05FZVdWVU0wZFFhWEZGYkVOeGVVWkJRM2RFWm5WTGRUWnRkRmt5TkdveVdUSnJJaXdpYVdGMElqb3hOell4T0RZM09ETTJMQ0p6WkY5b1lYTm9Jam9pWldVeE9HVXdOakkwT1dVek5tTmtNakpoTUdRek5UQXpPV1kxT0RNNU16RmpZakF5TXprNU1UTTROV0kyTTJJMk5UVTJOVEl5WlRRMU9ETXdNV1l5WmlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1ZMlpESmtZVE5rTlRaak5qTTNaalF4WVRnME1tVTNaVEUzT0RabVl6azJabUV6TXpKaE5qVTBPREV3WkRSallXTTBPVFppWmpkbU5XUXdaREZtTnpNaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxqUjBZMVlsZFdkV1JHT1dwTmJVcG9Ua2RKTlZsVFNYTkpibEp3WWxkV2VtUkhSblJqUTBrMlRWUmpNazFVWnpKT2VtZDZUWHBqTWsxSU1DSXNJbTl5YVdkcGJpSTZJbWgwZEhBNkx5OXNiMk5oYkdodmMzUTZNekF3TUNJc0ltTnliM056VDNKcFoybHVJanBtWVd4elpYMCIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVVDSVFDTURSVEJGMG03YlFhOHV5M000UjROSlZKRGtMV2RrUnNGQVJ0OXlaNzZyQUlnZmhFTzJRU21Ba0pKNExQekVwSkJ5TnAzc0c4TmctSUFYdWdDVWNxZGRlayIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCJ9LCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4IiwicGF5bWVudF9oYXNoIjoiZjZkMmRhM2Q1NmM2MzdmNDFhODQyZTdlMTc4NmZjOTZmYTMzMmE2NTQ4MTBkNGNhYzQ5NmJmN2Y1ZDBkMWY3MyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを 追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.265158Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=b307bc9982018010...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.267230Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:shopping_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.270495Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.272279Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 6920, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_c2ba4b9a\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しまし た。\",\"c", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.272623Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.283453Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.288364Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.291976Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:shopping_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.292573Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Received PaymentRequest from Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.292836Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Forwarding PaymentMandate to Payment Processor: payment_mandate_id=payment_c2ba4b9a", "module": "payment_handler", "function": "handle_payment_request", "line": 51}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.297263Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.297587Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 6923, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_c2ba4b9a\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました 。\",\"c", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.297648Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.300252Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.300468Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:payment_processor: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.300568Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:payment_processor\", \"headers\": {\"message_id\": \"3c542041-6bbe-4579-a520-a86998b20458\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T23:43:56.293028Z\", \"nonce\": \"5b0839481e29b5f484d2a89d438d2f8a1cf67226f86284956f3f6739f89fe898\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16WXNJbVY0Y0NJNk1UYzJNVGcyT0RFek5pd2libUptSWpveE56WXhPRFkzT0RNMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUl0Y2xKblRUWjBUa05FZVdWVU0wZFFhWEZGYkVOeGVVWkJRM2RFWm5WTGRUWnRkRmt5TkdveVdUSnJJaXdpYVdGMElqb3hOell4T0RZM09ETTJMQ0p6WkY5b1lYTm9Jam9pWldVeE9HVXdOakkwT1dVek5tTmtNakpoTUdRek5UQXpPV1kxT0RNNU16RmpZakF5TXprNU1UTTROV0kyTTJJMk5UVTJOVEl5WlRRMU9ETXdNV1l5WmlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1ZMlpESmtZVE5rTlRaak5qTTNaalF4WVRnME1tVTNaVEUzT0RabVl6azJabUV6TXpKaE5qVTBPREV3WkRSallXTTBPVFppWmpkbU5XUXdaREZtTnpNaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxqUjBZMVlsZFdkV1JHT1dwTmJVcG9Ua2RKTlZsVFNYTkpibEp3WWxkV2VtUkhSblJqUTBrMlRWUmpNazFVWnpKT2VtZDZUWHBqTWsxSU1DSXNJbTl5YVdkcGJpSTZJbWgwZEhBNkx5OXNiMk5oYkdodmMzUTZNekF3TUNJc0ltTnliM056VDNKcFoybHVJanBtWVd4elpYMCIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVVDSVFDTURSVEJGMG03YlFhOHV5M000UjROSlZKRGtMV2RrUnNGQVJ0OXlaNzZyQUlnZmhFTzJRU21Ba0pKNExQekVwSkJ5TnAzc0c4TmctSUFYdWdDVWNxZGRlayIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCJ9LCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4IiwicGF5bWVudF9oYXNoIjoiZjZkMmRhM2Q1NmM2MzdmNDFhODQyZTdlMTc4NmZjOTZmYTMzMmE2NTQ4MTBkNGNhYzQ5NmJmN2Y1ZDBkMWY3MyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格と デザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.304044Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent → PaymentProcessor] A2Aメッセージ転送\n  URL: http://payment_processor:8004/a2a/message\n  メッセージID: 3c542041-6bbe-4579-a520-a86998b20458\n  タイプ: ap2.mandates.PaymentMandate\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 69}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.304583Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://payment_processor:8004/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:56.304729Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://payment_processor:8004/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"3c542041-6bbe-4579-a520-a86998b20458\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T23:43:56.293028Z\", \"nonce\": \"5b0839481e29b5f484d2a89d438d2f8a1cf67226f86284956f3f6739f89fe898\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"yV3+mnf6G+10Tf883aN1mthEAbLCj5IVEi4BnlSesiuTMrv4Xv2RAzrswTeMLEzsGScGbjT6pdrpvDtQeDUSAA==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTZHQmRVRllXaHBZcUNtdjVUMGFsTGg3ckt4TzlHTkZLdnRabU5keWUyQk09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T23:43:56.293028Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.PaymentMandate\", \"id\": \"payment_c2ba4b9a\", \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16WXNJbVY0Y0NJNk1UYzJNVGcyT0RFek5pd2libUptSWpveE56WXhPRFkzT0RNMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUl0Y2xKblRUWjBUa05FZVdWVU0wZFFhWEZGYkVOeGVVWkJRM2RFWm5WTGRUWnRkRmt5TkdveVdUSnJJaXdpYVdGMElqb3hOell4T0RZM09ETTJMQ0p6WkY5b1lYTm9Jam9pWldVeE9HVXdOakkwT1dVek5tTmtNakpoTUdRek5UQXpPV1kxT0RNNU16RmpZakF5TXprNU1UTTROV0kyTTJJMk5UVTJOVEl5WlRRMU9ETXdNV1l5WmlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1ZMlpESmtZVE5rTlRaak5qTTNaalF4WVRnME1tVTNaVEUzT0RabVl6azJabUV6TXpKaE5qVTBPREV3WkRSallXTTBPVFppWmpkbU5XUXdaREZtTnpNaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxqUjBZMVlsZFdkV1JHT1dwTmJVcG9Ua2RKTlZsVFNYTkpibEp3WWxkV2VtUkhSblJqUTBrMlRWUmpNazFVWnpKT2VtZDZUWHBqTWsxSU1DSXNJbTl5YVdkcGJpSTZJbWgwZEhBNkx5OXNiMk5oYkdodmMzUTZNekF3TUNJc0ltTnliM056VDNKcFoybHVJanBtWVd4elpYMCIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVVDSVFDTURSVEJGMG03YlFhOHV5M000UjROSlZKRGtMV2RrUnNGQVJ0OXlaNzZyQUlnZmhFTzJRU21Ba0pKNExQekVwSkJ5TnAzc0c4TmctSUFYdWdDVWNxZGRlayIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCJ9LCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4IiwicGF5bWVudF9oYXNoIjoiZjZkMmRhM2Q1NmM2MzdmNDFhODQyZTdlMTc4NmZjOTZmYTMzMmE2NTQ4MTBkNGNhYzQ5NmJmN2Y1ZDBkMWY3MyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \" むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \" むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_processor      | [2025-10-30 23:43:56,761] INFO in v2.common.base_agent:
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | [Payment Processor] A2Aエンドポイント: POST /a2a/message
ap2_payment_processor      |   受信メッセージ: ID=3c542041-6bbe-4579-a520-a86998b20458
ap2_payment_processor      |   送信元: did:ap2:agent:merchant_agent
ap2_payment_processor      |   タイプ: ap2.mandates.PaymentMandate
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.769060Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:merchant_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.770580Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"3c542041-6bbe-4579-a520-a86998b20458\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T23:43:56.293028Z\", \"nonce\": \"5b0839481e29b5f484d2a89d438d2f8a1cf67226f86284956f3f6739f89fe898\", \"schema_version\": \"0.2\"}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_c2ba4b9a\", \"payment_details_id\": \"order_43142bae\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:43:52.457337Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WDJWbE16QXhOR0ppWXpVeFpqUXhOVFlpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYMlZsTXpBeE5HSmlZelV4WmpReE5UWWlMQ0pwWVhRaU9qRTNOakU0TmpjNE16WXNJbVY0Y0NJNk1UYzJNVGcyT0RFek5pd2libUptSWpveE56WXhPRFkzT0RNMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaWVqTkhMVTVJVEdOUVVrWjVSRGRpYjNvNWExQk5kbXhCVVVGellqYzNUbkkzYmpScE1HTkJZM2cxVVNJc0lua2lPaUpFZVZwcVZUSnFOV2xuZVVwTlJsSmxkVGRoTFZKaU5qUmhhMXBYUzBWTk5HeG1UeTB4TVc5RlJERmpJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUl0Y2xKblRUWjBUa05FZVdWVU0wZFFhWEZGYkVOeGVVWkJRM2RFWm5WTGRUWnRkRmt5TkdveVdUSnJJaXdpYVdGMElqb3hOell4T0RZM09ETTJMQ0p6WkY5b1lYTm9Jam9pWldVeE9HVXdOakkwT1dVek5tTmtNakpoTUdRek5UQXpPV1kxT0RNNU16RmpZakF5TXprNU1UTTROV0kyTTJJMk5UVTJOVEl5WlRRMU9ETXdNV1l5WmlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lNRFV6TURFMllqRm1Nemd3WkdOak5tVTRaV001WWpJMVlUazRaV05pT1RBMVl6UmxPVEExTkdJMU9UYzJNMkU0WkdKa1pqUXpOemcxWldRek9EQXhPQ0lzSW1ZMlpESmtZVE5rTlRaak5qTTNaalF4WVRnME1tVTNaVEUzT0RabVl6azJabUV6TXpKaE5qVTBPREV3WkRSallXTTBPVFppWmpkbU5XUXdaREZtTnpNaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6Im5NSnJmQnJrc3R1MnpZVjUta2dpSXoycmluayIsInJhd0lkIjoibk1KcmZCcmtzdHUyellWNS1rZ2lJejJyaW5rIiwicmVzcG9uc2UiOnsiY2xpZW50RGF0YUpTT04iOiJleUowZVhCbElqb2lkMlZpWVhWMGFHNHVaMlYwSWl3aVkyaGhiR3hsYm1kbElqb2laWGxLZEZsWE5XdFpXRkpzV0RKc2EwbHFiMmxqUjBZMVlsZFdkV1JHT1dwTmJVcG9Ua2RKTlZsVFNYTkpibEp3WWxkV2VtUkhSblJqUTBrMlRWUmpNazFVWnpKT2VtZDZUWHBqTWsxSU1DSXNJbTl5YVdkcGJpSTZJbWgwZEhBNkx5OXNiMk5oYkdodmMzUTZNekF3TUNJc0ltTnliM056VDNKcFoybHVJanBtWVd4elpYMCIsImF1dGhlbnRpY2F0b3JEYXRhIjoiU1pZTjVZZ09qR2gwTkJjUFpIWmdXNF9rcnJtaWhqTEhtVnp6dW9NZGwyTWRBQUFBQUEiLCJzaWduYXR1cmUiOiJNRVVDSVFDTURSVEJGMG03YlFhOHV5M000UjROSlZKRGtMV2RrUnNGQVJ0OXlaNzZyQUlnZmhFTzJRU21Ba0pKNExQekVwSkJ5TnAzc0c4TmctSUFYdWdDVWNxZGRlayIsInVzZXJIYW5kbGUiOiJ1c3JfZWUzMDE0YmJjNTFmNDE1NiJ9LCJ0eXBlIjoicHVibGljLWtleSIsImF0dGVzdGF0aW9uX3R5cGUiOiJwYXNza2V5IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOWpNbUpoTkdJNVlTSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOemd6TXpjMk1IMCJ9LCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4IiwicGF5bWVudF9oYXNoIjoiZjZkMmRhM2Q1NmM2MzdmNDFhODQyZTdlMTc4NmZjOTZmYTMzMmE2NTQ4MTBkNGNhYzQ5NmJmN2Y1ZDBkMWY3MyJ9\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_c2ba4b9a\", \"cart_mandate_id\": \"cart_ab329e26\", \"intent_mandate_id\": \"intent_dd1b41e3\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_ab329e26\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ab329e26\", \"display_items\": [{\"label\": \"むぎぼープレート皿\", \"amount\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 490.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:43:35.790876Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NzgxNiwiZXhwIjoxNzYxODcxNDE2LCJqdGkiOiIxYWEzNDhhMi03YmQyLTQyMjktYjU2OC00N2NlOTEyM2Y1ZDciLCJjYXJ0X2hhc2giOiIwNTMwMTZiMWYzODBkY2M2ZThlYzliMjVhOThlY2I5MDVjNGU5MDU0YjU5NzYzYThkYmRmNDM3ODVlZDM4MDE4In0.MEQCIHSKqlwsOBlQuDW_24cdDcHCczeZmceac4hWaxc1l8CqAiBkiiXspyQvzyYNfXccCe0da1C1UIrGFWkNXBkAHlq15g\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:43:35.791618Z\", \"cart_name\": \"コスパ最適プラン (4,900円)\", \"cart_description\": \"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しました。\", \"raw_items\": [{\"product_id\": \"f0f41c9f-a31d-4a88-a180-96149a9057fc\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"quantity\": 1, \"unit_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1900.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"e534386f-c89b-4548-9734-78bd34958f88\", \"name\": \"むぎぼーマグカッ プ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"cf08568b-8115-461c-aa7e-5a2e07bf4476\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"eb0e5de8-679d-4445-8e64-a1d4d40097fd\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"p7SZFFfTaAfxh7GcrGTXIcmrQXg9aHyHFsC+epemKVuKJpdly8iGAMlcOlHIu+4gndGxp9UFI0CR3bx4Trf2BA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQW56Y1hRdS9yM08xcjAxWWhFSCtOOEtRQS83ZzZac0xCb0JxOCt5dkJUeHc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:43:36.395383Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.774273Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=5b0839481e29b5f4...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.777529Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:merchant_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.797413Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.804066Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 6923, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_c2ba4b9a\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"予算内で最大4点を組み合わせた高コスパのプラン。かわいいアイテムを複数選ぶことで、価格とデザインのバランスを追求しまし た。\",\"c", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.804102Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.825854Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:merchant_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.826094Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:merchant_agent, alg=ed25519, kid=did:ap2:agent:merchant_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.826160Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:merchant_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.827261Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Received PaymentMandate", "module": "processor", "function": "handle_payment_mandate", "line": 366}
ap2_payment_processor      | [2025-10-30 23:43:56,827] INFO in services.payment_processor.utils.mandate_helpers: [PaymentProcessor] PaymentMandate validation passed: payment_c2ba4b9a, user_authorization present: eyJpc3N1ZXJfand0Ijoi...
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.828079Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation: PaymentMandate(payment_c2ba4b9a) → CartMandate(cart_ab329e26)", "module": "processor", "function": "_validate_mandate_chain", "line": 631}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.832450Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying SD-JWT-VC user_authorization: cart_hash=053016b1f380dcc6..., payment_hash=f6d2da3d56c637f4...", "module": "processor", "function": "_validate_mandate_chain", "line": 648}
ap2_payment_processor      | [2025-10-30 23:43:56,835] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Decoded VP successfully
ap2_payment_processor      | [2025-10-30 23:43:56,835] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Hash verification passed: cart_hash=053016b1f380dcc6..., payment_hash=f6d2da3d56c637f4...
ap2_payment_processor      | [2025-10-30 23:43:56,845] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ WebAuthn signature verified successfully
ap2_payment_processor      | [2025-10-30 23:43:56,845] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Key-binding JWT payload verified
ap2_payment_processor      | [2025-10-30 23:43:56,845] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ VP verification passed
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.845268Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ SD-JWT-VC user_authorization verified: cart_hash_match=True, payment_hash_match=True, webauthn_signature_verified=True", "module": "processor", "function": "_validate_mandate_chain", "line": 661}
ap2_payment_processor      | [2025-10-30 23:43:56,855] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor      | [2025-10-30 23:43:56,857] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor      | [2025-10-30 23:43:56,858] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor      | [2025-10-30 23:43:56,858] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor      | [2025-10-30 23:43:56,859] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor      | [2025-10-30 23:43:56,860] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor      | [2025-10-30 23:43:56,860] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor      | [2025-10-30 23:43:56,861] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor      | [2025-10-30 23:43:56,862] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor      | [2025-10-30 23:43:56,864] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor      | [2025-10-30 23:43:56,864] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor      | [2025-10-30 23:43:56,864] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor      | [2025-10-30 23:43:56,865] INFO in services.payment_processor.utils.jwt_helpers: [_verify_jwt_signature] ✓ JWT signature verified successfully
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.865936Z", "level": "INFO", "logger": "processor", "message": "[_verify_merchant_authorization_jwt] JWT validation passed: iss=did:ap2:merchant:mugibo_merchant, exp=1761871416, jti=1aa348a2-7bd2-42..., cart_hash=053016b1f380dcc6...", "module": "processor", "function": "_verify_merchant_authorization_jwt", "line": 573}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.866009Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] merchant_authorization JWT verified: iss=did:ap2:merchant:mugibo_merchant", "module": "processor", "function": "_validate_mandate_chain", "line": 685}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.866023Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] CartMandate hash in merchant_authorization: 053016b1f380dcc6...", "module": "processor", "function": "_validate_mandate_chain", "line": 693}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.866227Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ CartMandate hash verified (merchant_authorization): 053016b1f380dcc6...", "module": "processor", "function": "_validate_mandate_chain", "line": 710}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.866248Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation passed", "module": "processor", "function": "_validate_mandate_chain", "line": 742}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.867688Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Processing payment (mock): txn_fe72c7ce957d", "module": "processor", "function": "_process_payment_mock", "line": 761}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.867920Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying credential with Credential Provider: token=tok_53572c11_KVHnOcr...", "module": "processor", "function": "_verify_credential_with_cp", "line": 876}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.870270Z", "level": "INFO", "logger": "processor", "message": "HTTP Request: POST http://credential_provider:8003/credentials/verify", "module": "logger", "function": "log_http_request", "line": 182}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.870517Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/credentials/verify\", \"headers\": {}, \"body\": {\"token\": \"tok_53572c11_KVHnOcrRDSQeNslPUCjO2GQD\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:56.917965Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Verifying token for payer: usr_ee3014bbc51f4156", "module": "provider", "function": "verify_credentials", "line": 1571}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:43:56.920165Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Token verified: payment_method_id=pm_e6367cd7, user_id=usr_ee3014bbc51f4156", "module": "provider", "function": "verify_credentials", "line": 1608}
ap2_credential_provider    | INFO:     172.18.0.9:54942 - "POST /credentials/verify HTTP/1.1" 200 OK
ap2_payment_processor      | [2025-10-30 23:43:56,927] INFO in httpx: HTTP Request: POST http://credential_provider:8003/credentials/verify "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.931318Z", "level": "INFO", "logger": "processor", "message": "HTTP Response: 200 (60.76ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.931576Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:56 GMT\", \"server\": \"uvicorn\", \"content-length\": \"186\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"credential_info\": {\"payment_method_id\": \"pm_e6367cd7\", \"type\": \"basic-card\", \"brand\": \"Visa\", \"last4\": \"1111\", \"holder_name\": \"Unknown\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}}, \"duration_ms\": 60.75716018676758}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.932111Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verification succeeded: payment_method_id=pm_e6367cd7", "module": "processor", "function": "_verify_credential_with_cp", "line": 911}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.932139Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verified: pm_e6367cd7", "module": "processor", "function": "_process_payment_mock", "line": 784}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.932161Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Risk assessment: score=3, indicators=['card_not_present_transaction']", "module": "processor", "function": "_process_payment_mock", "line": 799}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:56.932205Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Payment succeeded: txn_fe72c7ce957d, amount={'value': 5890.0, 'currency': 'JPY'}, risk_score=3", "module": "processor", "function": "_process_payment_mock", "line": 833}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.030375Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Transaction saved: txn_fe72c7ce957d", "module": "processor", "function": "_save_transaction", "line": 860}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.481437Z", "level": "WARNING", "logger": "processor", "message": "[PaymentProcessor] User not found for payer_id: usr_ee3014bbc51f4156, using default name", "module": "processor", "function": "_generate_receipt", "line": 1067}
ap2_payment_processor      | [2025-10-30 23:43:57,481] INFO in v2.common.receipt_generator: [ReceiptGenerator] Generating PDF receipt for transaction: txn_fe72c7ce957d
ap2_payment_processor      | [2025-10-30 23:43:57,489] INFO in v2.common.receipt_generator: [ReceiptGenerator] PDF receipt generated successfully
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.491394Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Generated receipt PDF: /app/v2/data/receipts/txn_fe72c7ce957d.pdf", "module": "processor", "function": "_generate_receipt", "line": 1088}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.498037Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt record saved to database: txn_fe72c7ce957d", "module": "processor", "function": "_generate_receipt", "line": 1107}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.498428Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Sending receipt notification to Credential Provider: transaction_id=txn_fe72c7ce957d, payer_id=usr_ee3014bbc51f4156", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 940}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.498587Z", "level": "INFO", "logger": "processor", "message": "HTTP Request: POST http://credential_provider:8003/receipts", "module": "logger", "function": "log_http_request", "line": 182}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.498623Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/receipts\", \"headers\": {}, \"body\": {\"transaction_id\": \"txn_fe72c7ce957d\", \"receipt_url\": \"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\", \"payer_id\": \"usr_ee3014bbc51f4156\", \"amount\": {\"value\": 5890.0, \"currency\": \"JPY\"}, \"timestamp\": \"2025-10-30T23:43:57.498564Z\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | [2025-10-30 23:43:57,510] INFO in services.credential_provider.utils.receipt_helpers: [CredentialProvider] Receipt received and stored to DB: transaction_id=txn_fe72c7ce957d, payer_id=usr_ee3014bbc51f4156, receipt_url=http://localhost:8004/receipts/txn_fe72c7ce957d.pdf
ap2_credential_provider    | INFO:     172.18.0.9:54942 - "POST /receipts HTTP/1.1" 200 OK
ap2_payment_processor      | [2025-10-30 23:43:57,511] INFO in httpx: HTTP Request: POST http://credential_provider:8003/receipts "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.511572Z", "level": "INFO", "logger": "processor", "message": "HTTP Response: 200 (12.96ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.511617Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"97\", \"content-type\": \"application/json\"}, \"body\": {\"status\": \"received\", \"message\": \"Receipt stored successfully\", \"transaction_id\": \"txn_fe72c7ce957d\"}, \"duration_ms\": 12.955188751220703}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.511692Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt notification sent successfully: transaction_id=txn_fe72c7ce957d, status=200", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 971}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.511753Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.516682Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.516824Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 521, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"11193e18-cb8a-45d7-bb62-e704df362f4b\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.516851Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.524124Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: payment_processor) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.526293Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.responses.PaymentResult", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:43:57.526354Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.PaymentResult\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"53996af8-0fc9-47d3-b8b3-ef6e4570344d\", \"sender\": \"did:ap2:agent:payment_processor\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:43:57.511979Z\", \"nonce\": \"a2a09d352c04627d96d1ffa4f56a6c925770a22563958ea2879daa7fb01ad33d\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"transaction_id\": \"txn_fe72c7ce957d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_payment_processor      | [2025-10-30 23:43:57,526] INFO in v2.common.base_agent: [Payment Processor] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:merchant_agent
ap2_payment_processor      | INFO:     172.18.0.10:43548 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535095Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (1230.58ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535191Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"991\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"53996af8-0fc9-47d3-b8b3-ef6e4570344d\", \"sender\": \"did:ap2:agent:payment_processor\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:43:57.511979Z\", \"nonce\": \"a2a09d352c04627d96d1ffa4f56a6c925770a22563958ea2879daa7fb01ad33d\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"lTxo0zN1pF6ymZjmXR1jmepHGyt8G4f4bZ/5jvHXYzKobq9oLbDDoZ6iHV7jOvx5MoL537YbT5opnzN/aagLDw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWYrMEZBcWlPZ3hXYTVFL3BRYU5XUXdMRnQ3cmtZeHlMSS9FUmpZakUzY2s9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:payment_processor#key-2\", \"created\": \"2025-10-30T23:43:57.511979Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.PaymentResult\", \"id\": \"11193e18-cb8a-45d7-bb62-e704df362f4b\", \"payload\": {\"transaction_id\": \"txn_fe72c7ce957d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 1230.5753231048584}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535365Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent ← PaymentProcessor] A2Aレスポンス受信\n  Status: 200\n  Response Body: {\n  \"header\": {\n    \"message_id\": \"53996af8-0fc9-47d3-b8b3-ef6e4570344d\",\n    \"sender\": \"did:ap2:agent:payment_processor\",\n    \"recipient\": \"did:ap2:agent:merchant_agent\",\n    \"timestamp\": \"2025-10-30T23:43:57.511979Z\",\n    \"nonce\": \"a2a09d352c04627d96d1ffa4f56a6c925770a22563958ea2879daa7fb01ad33d\",\n    \"schema_version\": \"0.2\",\n    \"proof\": {\n      \"algorithm\": \"ed25519\",\n      \"signatureValue\": \"lTxo0zN1pF6ymZjmXR1jmepHGyt8G4f4bZ/5jvHXYzKobq9oLbDDoZ6iHV7jOvx5MoL537YbT5opnzN/aagLDw==\",\n      \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQWYrMEZBcWlPZ3hXYTVFL3BRYU5XUXdMRnQ3cmtZeHlMSS9FUmpZakUzY2s9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\",\n      \"kid\": \"did:ap2:agent:payment_processor#key-2\",\n      \"created\": \"2025-10-30T23:43:57.511979Z\",\n      \"proofPurpose\": \"authentication\"\n    },\n    \"signature\": null\n  },\n  \"dataPart\": {\n    \"@type\": \"ap2.responses.PaymentResult\",\n    \"id\": \"11193e18-cb8a-45d7-bb62-e704df362f4b\",\n    \"payload\": {\n      \"transaction_id\": \"txn_fe72c7ce957d\",\n      \"status\": \"captured\",\n      \"receipt_url\": \"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\"\n    },\n    \"kind\": null,\n    \"artifact\": null\n  }\n}\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 86}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535405Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Payment processing completed, forwarding result to Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 101}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535480Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535648Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.535937Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 518, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"11193e18-cb8a-45d7-bb62-e704df362f4b\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.536225Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.536549Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.536631Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:shopping_agent: ap2.responses.PaymentResult", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:43:57.536658Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.PaymentResult\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"1c8aaa70-7633-48a6-840c-9ef3088ab436\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:43:57.535538Z\", \"nonce\": \"1eef1a510bddd3aedd9ec0059b5c973bf8187ca3d3c13fa0e75ccc29030cd823\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"transaction_id\": \"txn_fe72c7ce957d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | [2025-10-30 23:43:57,536] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | INFO:     172.18.0.8:40044 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:57.543753Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (1304.83ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:57.544078Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:43:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"985\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"1c8aaa70-7633-48a6-840c-9ef3088ab436\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:43:57.535538Z\", \"nonce\": \"1eef1a510bddd3aedd9ec0059b5c973bf8187ca3d3c13fa0e75ccc29030cd823\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"W5U+ss+4XoNZTP0zzuIZH2P+Ci9JyuyY4B+sMZ3A0KOWZbGE780jI+UZS5f8VkHGHj2IiD6+aRg3LXb76zlcCQ==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTZHQmRVRllXaHBZcUNtdjVUMGFsTGg3ckt4TzlHTkZLdnRabU5keWUyQk09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T23:43:57.535538Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.PaymentResult\", \"id\": \"11193e18-cb8a-45d7-bb62-e704df362f4b\", \"payload\": {\"transaction_id\": \"txn_fe72c7ce957d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_fe72c7ce957d.pdf\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 1304.8300743103027}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:43:57,545] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_shopping_agent         |   Response Type: ap2.responses.PaymentResult
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-30 23:43:57,545] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Payment processing completed: status=captured
ap2_shopping_agent         | [2025-10-30 23:43:57,546] INFO in services.shopping_agent.langgraph_shopping_flow: [execute_payment_node] Payment successful: status=captured, transaction_id=txn_fe72c7ce957d
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:57.611145Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=completed", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:43:57.617303Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761867551787_p210teo, step=completed", "module": "agent", "function": "_update_session", "line": 1978}