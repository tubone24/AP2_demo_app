Attaching to ap2_credential_provider, ap2_credential_provider_2, ap2_frontend, ap2_init_keys, ap2_init_seeds, ap2_jaeger, ap2_meilisearch, ap2_merchant, ap2_merchant_agent, ap2_merchant_agent_mcp, ap2_payment_network, ap2_payment_processor, ap2_redis, ap2_shopping_agent, ap2_shopping_agent_mcp
ap2_jaeger  | 2025/10/30 23:13:59 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
ap2_redis   | 1:C 30 Oct 2025 23:13:59.819 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
ap2_redis   | 1:C 30 Oct 2025 23:13:59.819 * Redis version=7.4.6, bits=64, commit=00000000, modified=0, pid=1, just started
ap2_redis   | 1:C 30 Oct 2025 23:13:59.819 * Configuration loaded
ap2_redis   | 1:M 30 Oct 2025 23:13:59.819 * monotonic clock: POSIX clock_gettime
ap2_redis   | 1:M 30 Oct 2025 23:13:59.841 * Running mode=standalone, port=6379.
ap2_redis   | 1:M 30 Oct 2025 23:13:59.844 * Server initialized
ap2_redis   | 1:M 30 Oct 2025 23:13:59.890 * Creating AOF base file appendonly.aof.1.base.rdb on server start
ap2_meilisearch  |
ap2_meilisearch  | 888b     d888          d8b 888 d8b                                            888
ap2_meilisearch  | 8888b   d8888          Y8P 888 Y8P                                            888
ap2_meilisearch  | 88888b.d88888              888                                                888
ap2_meilisearch  | 888Y88888P888  .d88b.  888 888 888 .d8888b   .d88b.   8888b.  888d888 .d8888b 88888b.
ap2_meilisearch  | 888 Y888P 888 d8P  Y8b 888 888 888 88K      d8P  Y8b     "88b 888P"  d88P"    888 "88b
ap2_meilisearch  | 888  Y8P  888 88888888 888 888 888 "Y8888b. 88888888 .d888888 888    888      888  888
ap2_meilisearch  | 888   "   888 Y8b.     888 888 888      X88 Y8b.     888  888 888    Y88b.    888  888
ap2_meilisearch  | 888       888  "Y8888  888 888 888  88888P'  "Y8888  "Y888888 888     "Y8888P 888  888
ap2_meilisearch  |
ap2_meilisearch  | Config file path:    "none"
ap2_meilisearch  | Database path:               "./data.ms"
ap2_meilisearch  | Server listening on: "http://0.0.0.0:7700"
ap2_meilisearch  | Environment:         "development"
ap2_meilisearch  | Commit SHA:          "cfaac6f7ca55e91ec3cf40f8682f528cd8743562"
ap2_meilisearch  | Commit date:         "2024-11-14T15:55:14Z"
ap2_meilisearch  | Package version:     "1.11.3"
ap2_meilisearch  | Anonymous telemetry: "Disabled"
ap2_meilisearch  |
ap2_meilisearch  | A master key has been set. Requests to Meilisearch won't be authorized unless you provide an authentication key.
ap2_meilisearch  |
ap2_redis        | 1:M 30 Oct 2025 23:13:59.906 * Creating AOF incr file appendonly.aof.1.incr.aof on server start
ap2_redis        | 1:M 30 Oct 2025 23:13:59.906 * Ready to accept connections tcp
ap2_meilisearch  |
ap2_meilisearch  |  Meilisearch started with a master key considered unsafe for use in a production environment.
ap2_meilisearch  |
ap2_meilisearch  |  A master key of at least 16 bytes will be required when switching to a production environment.
ap2_meilisearch  |
ap2_meilisearch  |
ap2_meilisearch  | We generated a new secure master key for you (you can safely use this token):
ap2_meilisearch  |
ap2_meilisearch  | >> --master-key L1Sb_t9Wr60IP7r6I-EheTllNf_aKQTQjY2SLQ1pwfM <<
ap2_meilisearch  |
ap2_meilisearch  | Restart Meilisearch with the argument above to use this new and secure master key.
ap2_meilisearch  |
ap2_meilisearch  | Check out Meilisearch Cloud! https://www.meilisearch.com/cloud?utm_campaign=oss&utm_source=engine&utm_medium=cli
ap2_meilisearch  | Documentation:                       https://www.meilisearch.com/docs
ap2_meilisearch  | Source code:                 https://github.com/meilisearch/meilisearch
ap2_meilisearch  | Discord:                     https://discord.meilisearch.com
ap2_meilisearch  |
ap2_meilisearch  | 2025-10-30T23:13:59.914694Z  INFO actix_server::builder: starting 8 workers
ap2_meilisearch  | 2025-10-30T23:13:59.918607Z  INFO actix_server::server: Actix runtime found; starting in Actix runtime
ap2_jaeger       |
ap2_jaeger       | *******************************************************************************
ap2_jaeger       |
ap2_jaeger       | 🛑  WARNING: End-of-life Notice for Jaeger v1
ap2_jaeger       |
ap2_jaeger       | You are currently running a v1 version of Jaeger, which is deprecated and will
ap2_jaeger       | reach end-of-life on December 31st, 2025. This means there will be no further
ap2_jaeger       | development, bug fixes, or security patches for v1 after this date.
ap2_jaeger       |
ap2_jaeger       | We strongly recommend migrating to Jaeger v2 for continued support and access
ap2_jaeger       | to new features.
ap2_jaeger       |
ap2_jaeger       | For detailed migration instructions, please refer to the official Jaeger
ap2_jaeger       | documentation:  https://www.jaegertracing.io/docs/latest/migration/
ap2_jaeger       |
ap2_jaeger       | Tracking issue: https://github.com/jaegertracing/jaeger/issues/6321
ap2_jaeger       |
ap2_jaeger       | 🛑  WARNING: End-of-life Notice for Jaeger v1
ap2_jaeger       |
ap2_jaeger       | *******************************************************************************
ap2_jaeger       | 2025/10/30 23:14:00 application version: git-commit=a204929483c734da6c54eaa75f3f7c322b3e886b, git-version=v1.74.0, build-date=2025-10-03T02:41:46Z
ap2_jaeger       | {"level":"info","ts":1761866040.0501084,"caller":"flags/service.go:124","msg":"Mounting metrics handler on admin server","route":"/metrics"}
ap2_jaeger       | {"level":"info","ts":1761866040.0508912,"caller":"flags/service.go:130","msg":"Mounting expvar handler on admin server","route":"/debug/vars"}
ap2_jaeger       | {"level":"info","ts":1761866040.0782483,"caller":"flags/admin.go:106","msg":"Mounting health check on admin server","route":"/"}
ap2_jaeger       | {"level":"info","ts":1761866040.0786152,"caller":"flags/admin.go:123","msg":"Starting admin HTTP server"}
ap2_jaeger       | {"level":"info","ts":1761866040.079745,"caller":"flags/admin.go:137","msg":"Admin server started","http.host-port":"[::]:14269","health-status":"unavailable"}
ap2_jaeger       | {"level":"info","ts":1761866040.088077,"caller":"grpc@v1.75.0/clientconn.go:176","msg":"[core] original dial target is: \"localhost:4317\""}
ap2_jaeger       | {"level":"info","ts":1761866040.0886354,"caller":"grpc@v1.75.0/clientconn.go:459","msg":"[core] [Channel #1]Channel created"}
ap2_jaeger       | {"level":"info","ts":1761866040.089267,"caller":"grpc@v1.75.0/clientconn.go:207","msg":"[core] [Channel #1]parsed dial target is: resolver.Target{URL:url.URL{Scheme:\"dns\", Opaque:\"\", User:(*url.Userinfo)(nil), Host:\"\", Path:\"/localhost:4317\", RawPath:\"\", OmitHost:false, ForceQuery:false, RawQuery:\"\", Fragment:\"\", RawFragment:\"\"}}"}
ap2_jaeger       | {"level":"info","ts":1761866040.089289,"caller":"grpc@v1.75.0/clientconn.go:208","msg":"[core] [Channel #1]Channel authority set to \"localhost:4317\""}
ap2_jaeger       | {"level":"info","ts":1761866040.0939324,"caller":"memory/factory.go:75","msg":"Memory storage initialized","configuration":{"MaxTraces":0}}
ap2_jaeger       | {"level":"info","ts":1761866040.2088578,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #2]Server created"}
ap2_jaeger       | {"level":"info","ts":1761866040.2108889,"caller":"server/grpc.go:75","msg":"Starting jaeger-collector gRPC server","grpc.host-port":"[::]:14250"}
ap2_jaeger       | {"level":"info","ts":1761866040.2110739,"caller":"server/http.go:37","msg":"Starting jaeger-collector HTTP server","host-port":":14268"}
ap2_jaeger       | {"level":"info","ts":1761866040.2122877,"caller":"app/collector.go:128","msg":"Not listening for Zipkin HTTP traffic, port not configured"}
ap2_jaeger       | {"level":"info","ts":1761866040.2155695,"caller":"handler/otlp_receiver.go:75","msg":"OTLP receiver status change","status":"StatusStarting"}
ap2_jaeger       | {"level":"info","ts":1761866040.2157423,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #4]Server created"}
ap2_jaeger       | {"level":"info","ts":1761866040.2157784,"caller":"otlpreceiver@v0.132.0/otlp.go:117","msg":"Starting GRPC server","endpoint":":4317"}
ap2_jaeger       | {"level":"info","ts":1761866040.2164273,"caller":"otlpreceiver@v0.132.0/otlp.go:175","msg":"Starting HTTP server","endpoint":":4318"}
ap2_jaeger       | {"level":"info","ts":1761866040.2179356,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #2 ListenSocket #3]ListenSocket created"}
ap2_jaeger       | {"level":"info","ts":1761866040.218059,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #4 ListenSocket #5]ListenSocket created"}
ap2_jaeger       | {"level":"info","ts":1761866040.2164538,"caller":"app/flags.go:168","msg":"Archive storage not initialized"}
ap2_jaeger       | {"level":"info","ts":1761866040.2216508,"caller":"grpc@v1.75.0/server.go:715","msg":"[core] [Server #6]Server created"}
ap2_jaeger       | {"level":"info","ts":1761866040.2252488,"caller":"app/static_handler.go:92","msg":"Using UI configuration","path":""}
ap2_jaeger       | {"level":"info","ts":1761866040.2256737,"caller":"app/server.go:258","msg":"Query server started","http_addr":"[::]:16686","grpc_addr":"[::]:16685"}
ap2_jaeger       | {"level":"info","ts":1761866040.2256923,"caller":"healthcheck/handler.go:117","msg":"Health Check state change","status":"ready"}
ap2_jaeger       | {"level":"info","ts":1761866040.2268436,"caller":"app/server.go:300","msg":"Starting GRPC server","port":16685,"addr":":16685"}
ap2_jaeger       | {"level":"info","ts":1761866040.2269428,"caller":"grpc@v1.75.0/server.go:911","msg":"[core] [Server #6 ListenSocket #7]ListenSocket created"}
ap2_jaeger       | {"level":"info","ts":1761866040.2270308,"caller":"app/server.go:286","msg":"Starting HTTP server","port":16686,"addr":":16686"}
ap2_init_keys    | ================================================================================
ap2_init_keys    | AP2 エージェント キーペア初期化
ap2_init_keys    | ================================================================================
ap2_init_keys    |
ap2_init_keys    | キー保存先: /app/v2/keys
ap2_init_keys    | DID Document保存先: /app/v2/data/did_documents
ap2_init_keys    |
ap2_init_keys    | [Shopping Agent]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/shopping_agent_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/shopping_agent_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/shopping_agent_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/shopping_agent_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/shopping_agent_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:agent:shopping_agent
ap2_init_keys    |
ap2_init_keys    | [Merchant Agent]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/merchant_agent_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_agent_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/merchant_agent_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_agent_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/merchant_agent_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:agent:merchant_agent
ap2_init_keys    |
ap2_init_keys    | [Merchant]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/merchant_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/merchant_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/merchant_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/merchant_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:merchant:mugibo_merchant
ap2_init_keys    |
ap2_init_keys    | [Credential Provider]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/credential_provider_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/credential_provider_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/credential_provider_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:cp:demo_cp
ap2_init_keys    |
ap2_init_keys    | [Credential Provider 2]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/credential_provider_2_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_2_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/credential_provider_2_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/credential_provider_2_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:cp:demo_cp_2
ap2_init_keys    |
ap2_init_keys    | [Payment Processor]
ap2_init_keys    |   🔑 ECDSA SECP256R1キーペアを生成中（JWT用）...
ap2_init_keys    |   🔒 ECDSA秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ 秘密鍵を保存: /app/v2/keys/payment_processor_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/payment_processor_public.pem
ap2_init_keys    |   🔑 Ed25519キーペアを生成中（A2A通信用）...
ap2_init_keys    |   🔒 Ed25519秘密鍵をAES-256-CBCで暗号化中...
ap2_init_keys    |   ✓ Ed25519秘密鍵を保存: /app/v2/keys/payment_processor_ed25519_private.pem
ap2_init_keys    |   ✓ 公開鍵を保存: /app/v2/keys/payment_processor_ed25519_public.pem
ap2_init_keys    |   📄 W3C準拠のDID Documentを生成中（ECDSA + Ed25519）...
ap2_init_keys    |   ✓ DID Documentを保存: /app/v2/data/did_documents/payment_processor_did.json
ap2_init_keys    |   ✅ 初期化完了: DID = did:ap2:agent:payment_processor
ap2_init_keys    |
ap2_init_keys    | ================================================================================
ap2_init_keys    | ✅ 全エージェントの初期化が完了しました
ap2_init_keys    | ================================================================================
ap2_init_keys    |
ap2_init_keys    | 次のステップ:
ap2_init_keys    |   1. docker-compose up -d でサービスを起動
ap2_init_keys    |   2. 各エージェントはキーを永続化ストレージから読み込みます
ap2_init_keys    |   3. DIDは再起動後も一貫して維持されます
ap2_init_keys    |
ap2_init_keys exited with code 0
ap2_init_seeds   | ================================================================================
ap2_init_seeds   | AP2 シードデータ投入 (AP2完全準拠)
ap2_init_seeds   | ================================================================================
ap2_init_seeds   |
ap2_init_seeds   | データ保存先: /app/v2/data
ap2_init_seeds   |
ap2_init_seeds   | AP2完全準拠のため、以下のデータのみ投入します：
ap2_init_seeds   |   ✅ 商品データ: Merchantが管理
ap2_init_seeds   |   ⚠️  ユーザーデータ: Passkey登録時に自動作成（フロントエンド）
ap2_init_seeds   |   ⚠️  支払い方法: Passkey登録後、ユーザーが登録（セキュリティ要件）
ap2_init_seeds   |
ap2_init_seeds   | [商品データ投入]
ap2_init_seeds   | データベース: sqlite+aiosqlite:////app/v2/data/merchant_agent.db
ap2_init_seeds   |   ✅ 作成: むぎぼーアクリルキーホルダー (¥800)
ap2_init_seeds   |   ✅ 作成: むぎぼー時計 (¥3500)
ap2_init_seeds   |   ✅ 作成: むぎぼーカレンダー (¥1500)
ap2_init_seeds   |   ✅ 作成: むぎぼーマグカップ (¥1200)
ap2_init_seeds   |   ✅ 作成: むぎぼーステッカー (¥500)
ap2_init_seeds   |   ✅ 作成: むぎぼーTシャツ (¥2800)
ap2_init_seeds   |   ✅ 作成: むぎぼートートバッグ (¥1800)
ap2_init_seeds   |   ✅ 作成: むぎぼーポーチ (¥950)
ap2_init_seeds   |   ✅ 作成: むぎぼーぬいぐるみ（S） (¥2200)
ap2_init_seeds   |   ✅ 作成: むぎぼーぬいぐるみ（L） (¥4800)
ap2_init_seeds   |   ✅ 作成: むぎぼーキャップ (¥2000)
ap2_init_seeds   |   ✅ 作成: むぎぼークッション (¥2500)
ap2_init_seeds   |   ✅ 作成: むぎぼーノート (¥700)
ap2_init_seeds   |   ✅ 作成: むぎぼーボールペン (¥600)
ap2_init_seeds   |   ✅ 作成: むぎぼーウォーターボトル (¥2400)
ap2_init_seeds   |   ✅ 作成: むぎぼー靴下 (¥850)
ap2_init_seeds   |   ✅ 作成: むぎぼーマウスパッド (¥900)
ap2_init_seeds   |   ✅ 作成: むぎぼースマホケース (¥1800)
ap2_init_seeds   |   ✅ 作成: むぎぼー折りたたみ傘 (¥2600)
ap2_init_seeds   |   ✅ 作成: むぎぼーエコバッグ (¥1200)
ap2_init_seeds   |   ✅ 作成: むぎぼーブランケット (¥3200)
ap2_init_seeds   |   ✅ 作成: むぎぼープレート皿 (¥1900)
ap2_init_seeds   |   ✅ 作成: むぎぼーパーカー (¥4500)
ap2_init_seeds   |   ✅ 作成: むぎぼーフェイスタオル (¥1300)
ap2_init_seeds   |   ✅ 作成: むぎぼーアロマキャンドル (¥2100)
ap2_init_seeds   |   ✅ 作成: むぎぼー抱き枕 (¥5500)
ap2_init_seeds   |   ✅ 作成: むぎぼーポスター (¥900)
ap2_init_seeds   |   ✅ 作成: むぎぼーニット帽 (¥1800)
ap2_init_seeds   |   ✅ 商品データ投入完了 (28件)
ap2_init_seeds   |
ap2_init_seeds   | ================================================================================
ap2_init_seeds   | ✅ 商品データの投入が完了しました (AP2完全準拠)
ap2_init_seeds   | ================================================================================
ap2_init_seeds   |
ap2_init_seeds   | 投入データサマリ:
ap2_init_seeds   |   - 商品: 28件 (merchant_agent.db)
ap2_init_seeds   |
ap2_init_seeds   | 次のステップ:
ap2_init_seeds   |   1. フロントエンド (http://localhost:3000) にアクセス
ap2_init_seeds   |   2. ユーザー登録 (/auth/register)
ap2_init_seeds   |   3. Passkey登録 (/auth/register-passkey)
ap2_init_seeds   |   4. 支払い方法登録（Passkey登録後に自動表示）
ap2_init_seeds   |
ap2_init_seeds exited with code 0
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.157476Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.175437Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: merchant_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.176279Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: search_products", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.177088Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: check_inventory", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.177307Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_cart_mandates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.665096Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: shopping_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.665710Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_intent_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.665831Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: request_cart_candidates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.665897Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: select_and_sign_cart", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.665950Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: assess_payment_risk", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.666020Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_payment_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.666090Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: execute_payment", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.829140Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.829587Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: merchant_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.829659Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: search_products", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.829683Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: check_inventory", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.829698Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_cart_mandates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_merchant_agent_mcp  | INFO:     Started server process [1]
ap2_merchant_agent_mcp  | INFO:     Waiting for application startup.
ap2_merchant_agent_mcp  | INFO:     Application startup complete.
ap2_merchant_agent_mcp  | INFO:     Uvicorn running on http://0.0.0.0:8011 (Press CTRL+C to quit)
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955149Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Initialized: shopping_agent_mcp v1.0.0", "module": "mcp_server", "function": "__init__", "line": 90}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955327Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_intent_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955370Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: request_cart_candidates", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955415Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: select_and_sign_cart", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955456Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: assess_payment_risk", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955498Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: build_payment_mandate", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.955541Z", "level": "INFO", "logger": "common.mcp_server", "message": "[MCPServer] Registered tool: execute_payment", "module": "mcp_server", "function": "decorator", "line": 412}
ap2_shopping_agent_mcp  | INFO:     Started server process [1]
ap2_shopping_agent_mcp  | INFO:     Waiting for application startup.
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:07.960333Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Starting up...", "module": "main", "function": "lifespan", "line": 404}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.401079Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Database initialized", "module": "main", "function": "lifespan", "line": 408}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.422562Z", "level": "INFO", "logger": "main", "message": "[Startup] KeyManager initialized with keys_directory=/app/v2/keys", "module": "main", "function": "lifespan", "line": 415}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.422629Z", "level": "INFO", "logger": "main", "message": "[Startup] Extracted key_id=shopping_agent from AGENT_ID=did:ap2:agent:shopping_agent", "module": "main", "function": "lifespan", "line": 419}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.422706Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.437785Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.437892Z", "level": "INFO", "logger": "main", "message": "[Startup] ED25519 private key loaded for shopping_agent", "module": "main", "function": "lifespan", "line": 425}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.437928Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.449966Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.450036Z", "level": "INFO", "logger": "main", "message": "[Startup] ECDSA private key loaded for shopping_agent", "module": "main", "function": "lifespan", "line": 433}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.450084Z", "level": "INFO", "logger": "main", "message": "[Startup] SignatureManager initialized", "module": "main", "function": "lifespan", "line": 443}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.463441Z", "level": "INFO", "logger": "main", "message": "[Startup] A2AMessageHandler initialized with key_id: shopping_agent", "module": "main", "function": "lifespan", "line": 451}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.463581Z", "level": "INFO", "logger": "main", "message": "[Startup] RiskAssessmentEngine initialized", "module": "main", "function": "lifespan", "line": 455}
ap2_shopping_agent_mcp  | {"timestamp": "2025-10-30T23:14:08.463627Z", "level": "INFO", "logger": "main", "message": "[Shopping Agent MCP] Startup complete", "module": "main", "function": "lifespan", "line": 457}
ap2_shopping_agent_mcp  | INFO:     Application startup complete.
ap2_shopping_agent_mcp  | INFO:     Uvicorn running on http://0.0.0.0:8010 (Press CTRL+C to quit)
ap2_merchant            | [2025-10-30 23:14:14,268] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_merchant            | [2025-10-30 23:14:14,269] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_merchant            |   Service Name: merchant
ap2_merchant            |   OTLP Endpoint: http://jaeger:4317
ap2_merchant            |   Insecure: True
ap2_payment_processor   | [2025-10-30 23:14:14,369] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_payment_processor   | [2025-10-30 23:14:14,371] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_payment_processor   |   Service Name: payment_processor
ap2_payment_processor   |   OTLP Endpoint: http://jaeger:4317
ap2_payment_processor   |   Insecure: True
ap2_merchant            | [2025-10-30 23:14:14,366] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: merchant
ap2_merchant            | [2025-10-30 23:14:14,368] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 23:14:14,368] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | [2025-10-30 23:14:14,369] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 23:14:14,369] INFO in v2.common.base_agent: [Merchant] OpenTelemetry distributed tracing enabled (service: merchant, manual instrumentation only)
ap2_merchant            | {"timestamp": "2025-10-30T23:14:14.431935Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | {"timestamp": "2025-10-30T23:14:14.464613Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | {"timestamp": "2025-10-30T23:14:14.465024Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 23:14:14,464] INFO in v2.common.base_agent: [Merchant] ✓ ECDSA鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 23:14:14,489] INFO in v2.common.base_agent: [Merchant] ✓ Ed25519鍵を読み込みました: merchant
ap2_merchant            | {"timestamp": "2025-10-30T23:14:14.489277Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | [2025-10-30 23:14:14,491] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant            | [2025-10-30 23:14:14,504] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 23:14:14,505] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant            | [2025-10-30 23:14:14,524] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant            | [2025-10-30 23:14:14,524] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant            | [2025-10-30 23:14:14,534] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant            | [2025-10-30 23:14:14,537] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant            | [2025-10-30 23:14:14,595] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | [2025-10-30 23:14:14,596] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant            | [2025-10-30 23:14:14,597] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant            | [2025-10-30 23:14:14,597] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant            | {"timestamp": "2025-10-30T23:14:14.607743Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | [2025-10-30 23:14:14,607] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant            | [2025-10-30 23:14:14,630] INFO in v2.common.base_agent: [Merchant] Initialized: did:ap2:merchant
ap2_payment_processor   | [2025-10-30 23:14:14,658] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: payment_processor
ap2_payment_processor   | [2025-10-30 23:14:14,659] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 23:14:14,662] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_shopping_agent      | [2025-10-30 23:14:14,677] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_shopping_agent      | [2025-10-30 23:14:14,678] INFO in v2.common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_shopping_agent      |   Service Name: shopping_agent
ap2_shopping_agent      |   OTLP Endpoint: http://jaeger:4317
ap2_shopping_agent      |   Insecure: True
ap2_payment_processor   | [2025-10-30 23:14:14,682] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:14:14,683] INFO in v2.common.base_agent: [Payment Processor] OpenTelemetry distributed tracing enabled (service: payment_processor, manual instrumentation only)
ap2_payment_network     | [2025-10-30 23:14:14,700] INFO in network: [DemoPaymentNetwork] Payment Network Service initialized
ap2_payment_network     |   Redis URL: redis://redis:6379/2
ap2_payment_network     |   Token Store: RedisベースのKVストア（TTL管理対応）
ap2_frontend            |    ▲ Next.js 15.5.5
ap2_frontend            |    - Local:        http://localhost:3000
ap2_frontend            |    - Network:      http://0.0.0.0:3000
ap2_frontend            |
ap2_frontend            |  ✓ Starting...
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:14.712417Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:14.725762Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 23:14:14,725] INFO in v2.common.base_agent: [Payment Processor] ✓ ECDSA鍵を読み込みました: payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:14.726053Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:14.729094Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 23:14:14,729] INFO in v2.common.base_agent: [Payment Processor] ✓ Ed25519鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 23:14:14,729] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor   | [2025-10-30 23:14:14,730] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor   | [2025-10-30 23:14:14,730] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor   | [2025-10-30 23:14:14,730] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor   | [2025-10-30 23:14:14,731] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor   | [2025-10-30 23:14:14,732] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor   | [2025-10-30 23:14:14,733] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor   | [2025-10-30 23:14:14,735] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor   | [2025-10-30 23:14:14,735] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor   | [2025-10-30 23:14:14,737] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor   | [2025-10-30 23:14:14,737] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor   | [2025-10-30 23:14:14,739] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:14.740294Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_payment_processor   | [2025-10-30 23:14:14,759] INFO in v2.common.base_agent: [Payment Processor] Initialized: did:ap2:agent:payment_processor
ap2_shopping_agent      | [2025-10-30 23:14:14,759] INFO in v2.common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: shopping_agent
ap2_shopping_agent      | [2025-10-30 23:14:14,759] INFO in v2.common.base_agent: [Shopping Agent] OpenTelemetry distributed tracing enabled (service: shopping_agent, manual instrumentation only)
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.809574Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.831659Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.831936Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent      | [2025-10-30 23:14:14,831] INFO in v2.common.base_agent: [Shopping Agent] ✓ ECDSA鍵を読み込みました: shopping_agent
ap2_shopping_agent      | [2025-10-30 23:14:14,838] INFO in v2.common.base_agent: [Shopping Agent] ✓ Ed25519鍵を読み込みました: shopping_agent
ap2_shopping_agent      | [2025-10-30 23:14:14,838] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.838669Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent      | [2025-10-30 23:14:14,847] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_shopping_agent      | [2025-10-30 23:14:14,847] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_shopping_agent      | [2025-10-30 23:14:14,848] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_shopping_agent      | [2025-10-30 23:14:14,848] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_shopping_agent      | [2025-10-30 23:14:14,851] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_shopping_agent      | [2025-10-30 23:14:14,851] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_shopping_agent      | [2025-10-30 23:14:14,853] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_shopping_agent      | [2025-10-30 23:14:14,853] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_shopping_agent      | [2025-10-30 23:14:14,854] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_shopping_agent      | [2025-10-30 23:14:14,855] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_shopping_agent      | [2025-10-30 23:14:14,857] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.857911Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.857962Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.ProductList", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent      | {"timestamp": "2025-10-30T23:14:14.857974Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.SignatureResponse", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | {"timestamp": "2025-10-30T23:14:14.861763Z", "level": "INFO", "logger": "service", "message": "[Merchant] Initialized", "module": "service", "function": "__init__", "line": 118}
ap2_merchant            | [2025-10-30 23:14:14,863] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_shopping_agent      | [2025-10-30 23:14:14,884] INFO in v2.common.base_agent: [Shopping Agent] Initialized: did:ap2:agent:shopping_agent
ap2_frontend            |  ✓ Ready in 244ms
ap2_payment_network     | [2025-10-30 23:14:14,984] INFO in network: [DemoPaymentNetwork] Payment Network Service initialized
ap2_payment_network     |   Redis URL: redis://redis:6379/2
ap2_payment_network     |   Token Store: RedisベースのKVストア（TTL管理対応）
ap2_payment_network     | INFO:     Started server process [1]
ap2_payment_network     | INFO:     Waiting for application startup.
ap2_payment_network     | INFO:     Application startup complete.
ap2_payment_network     | INFO:     Uvicorn running on http://0.0.0.0:8005 (Press CTRL+C to quit)
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.087554Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Initialized", "module": "processor", "function": "__init__", "line": 102}
ap2_payment_processor   | [2025-10-30 23:14:15,088] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_shopping_agent      | [2025-10-30 23:14:15,093] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Initialized (database_mode=enabled)
ap2_merchant            | [2025-10-30 23:14:15,092] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 23:14:15,093] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | [2025-10-30 23:14:15,096] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 23:14:15,096] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant            | [2025-10-30 23:14:15,096] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant'. Adding OTLP exporter to existing provider.
ap2_merchant            | [2025-10-30 23:14:15,098] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant            | [2025-10-30 23:14:15,098] INFO in v2.common.base_agent: [Merchant] OpenTelemetry distributed tracing enabled (service: merchant, manual instrumentation only)
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.099579Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.106944Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.107171Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant            | [2025-10-30 23:14:15,107] INFO in v2.common.base_agent: [Merchant] ✓ ECDSA鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 23:14:15,111] INFO in v2.common.base_agent: [Merchant] ✓ Ed25519鍵を読み込みました: merchant
ap2_merchant            | [2025-10-30 23:14:15,111] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.111015Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant            | [2025-10-30 23:14:15,121] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant            | [2025-10-30 23:14:15,121] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant            | [2025-10-30 23:14:15,129] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant            | [2025-10-30 23:14:15,129] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant            | [2025-10-30 23:14:15,130] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant            | [2025-10-30 23:14:15,130] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant            | [2025-10-30 23:14:15,136] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant            | [2025-10-30 23:14:15,136] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant            | [2025-10-30 23:14:15,137] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant            | [2025-10-30 23:14:15,137] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.141018Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant            | [2025-10-30 23:14:15,137] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant            | [2025-10-30 23:14:15,171] INFO in v2.common.base_agent: [Merchant] Initialized: did:ap2:merchant
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.173005Z", "level": "INFO", "logger": "service", "message": "[Merchant] Initialized", "module": "service", "function": "__init__", "line": 118}
ap2_merchant            | [2025-10-30 23:14:15,173] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_merchant            | INFO:     Started server process [1]
ap2_merchant            | INFO:     Waiting for application startup.
ap2_merchant            | {"timestamp": "2025-10-30T23:14:15.174247Z", "level": "INFO", "logger": "service", "message": "[Merchant] Running startup tasks...", "module": "service", "function": "startup_event", "line": 102}
ap2_payment_processor   | [2025-10-30 23:14:15,451] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 23:14:15,451] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 23:14:15,452] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:14:15,452] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_payment_processor   | [2025-10-30 23:14:15,452] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='payment_processor'. Adding OTLP exporter to existing provider.
ap2_payment_processor   | [2025-10-30 23:14:15,453] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_payment_processor   | [2025-10-30 23:14:15,453] INFO in v2.common.base_agent: [Payment Processor] OpenTelemetry distributed tracing enabled (service: payment_processor, manual instrumentation only)
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.453317Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.459086Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.459230Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: payment_processor (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_payment_processor   | [2025-10-30 23:14:15,459] INFO in v2.common.base_agent: [Payment Processor] ✓ ECDSA鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 23:14:15,466] INFO in v2.common.base_agent: [Payment Processor] ✓ Ed25519鍵を読み込みました: payment_processor
ap2_payment_processor   | [2025-10-30 23:14:15,467] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.466740Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_payment_processor   | [2025-10-30 23:14:15,471] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor   | [2025-10-30 23:14:15,472] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor   | [2025-10-30 23:14:15,474] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor   | [2025-10-30 23:14:15,474] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor   | [2025-10-30 23:14:15,480] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor   | [2025-10-30 23:14:15,480] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor   | [2025-10-30 23:14:15,486] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor   | [2025-10-30 23:14:15,486] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor   | [2025-10-30 23:14:15,488] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor   | [2025-10-30 23:14:15,489] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.497866Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_payment_processor   | [2025-10-30 23:14:15,497] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor   | [2025-10-30 23:14:15,505] INFO in v2.common.base_agent: [Payment Processor] Initialized: did:ap2:agent:payment_processor
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.646362Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Initialized", "module": "processor", "function": "__init__", "line": 102}
ap2_payment_processor   | [2025-10-30 23:14:15,656] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_payment_processor   | INFO:     Started server process [1]
ap2_payment_processor   | INFO:     Waiting for application startup.
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:15.707960Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Running startup tasks...", "module": "processor", "function": "startup_event", "line": 96}
ap2_merchant            | {"timestamp": "2025-10-30T23:14:16.030557Z", "level": "INFO", "logger": "service", "message": "[Merchant] Database initialized", "module": "service", "function": "startup_event", "line": 106}
ap2_merchant            |
ap2_merchant            | ============================================================
ap2_merchant            | 商品データ投入中...
ap2_merchant            | ============================================================
ap2_merchant            |   ✅ 作成: むぎぼーアクリルキーホルダー (¥800)
ap2_merchant            |   ✅ 作成: むぎぼー時計 (¥3,500)
ap2_merchant            |   ✅ 作成: むぎぼーカレンダー (¥1,500)
ap2_merchant            |   ✅ 作成: むぎぼーマグカップ (¥1,200)
ap2_merchant            |   ✅ 作成: むぎぼーステッカー (¥500)
ap2_merchant            |   ✅ 作成: むぎぼーTシャツ (¥2,800)
ap2_merchant            |   ✅ 作成: むぎぼートートバッグ (¥1,800)
ap2_payment_processor   | {"timestamp": "2025-10-30T23:14:16.247765Z", "level": "INFO", "logger": "processor", "message": "[Payment Processor] Database initialized", "module": "processor", "function": "startup_event", "line": 100}
ap2_payment_processor   | INFO:     Application startup complete.
ap2_payment_processor   | INFO:     Uvicorn running on http://0.0.0.0:8004 (Press CTRL+C to quit)
ap2_merchant            |   ✅ 作成: むぎぼーポーチ (¥950)
ap2_merchant            |   ✅ 作成: むぎぼーぬいぐるみ（S） (¥2,200)
ap2_merchant            |   ✅ 作成: むぎぼーぬいぐるみ（L） (¥4,800)
ap2_merchant            |   ✅ 作成: むぎぼーキャップ (¥2,000)
ap2_merchant            |   ✅ 作成: むぎぼークッション (¥2,500)
ap2_merchant            |   ✅ 作成: むぎぼーノート (¥700)
ap2_merchant            |   ✅ 作成: むぎぼーボールペン (¥600)
ap2_merchant            |   ✅ 作成: むぎぼーウォーターボトル (¥2,400)
ap2_merchant            |   ✅ 作成: むぎぼー靴下 (¥850)
ap2_merchant            |   ✅ 作成: むぎぼーマウスパッド (¥900)
ap2_merchant            |   ✅ 作成: むぎぼースマホケース (¥1,800)
ap2_merchant            |   ✅ 作成: むぎぼー折りたたみ傘 (¥2,600)
ap2_merchant            |   ✅ 作成: むぎぼーエコバッグ (¥1,200)
ap2_merchant            |   ✅ 作成: むぎぼーブランケット (¥3,200)
ap2_merchant            |   ✅ 作成: むぎぼープレート皿 (¥1,900)
ap2_merchant            |   ✅ 作成: むぎぼーパーカー (¥4,500)
ap2_merchant            |   ✅ 作成: むぎぼーフェイスタオル (¥1,300)
ap2_merchant            |   ✅ 作成: むぎぼーアロマキャンドル (¥2,100)
ap2_merchant            |   ✅ 作成: むぎぼー抱き枕 (¥5,500)
ap2_merchant            |   ✅ 作成: むぎぼーポスター (¥900)
ap2_merchant            |   ✅ 作成: むぎぼーニット帽 (¥1,800)
ap2_merchant            |
ap2_merchant            | ✅ 商品データ投入完了 (28件)
ap2_merchant            |
ap2_merchant            | ============================================================
ap2_merchant            | ユーザーデータ投入中...
ap2_merchant            | ============================================================
ap2_merchant            | {"timestamp": "2025-10-30T23:14:16.644170Z", "level": "WARNING", "logger": "service", "message": "[Merchant] Sample data seeding warning: (sqlite3.IntegrityError) NOT NULL constraint failed: users.hashed_password\n[SQL: INSERT INTO users (id, display_name, email, hashed_password, is_active, created_at) VALUES (?, ?, ?, ?, ?, ?)]\n[parameters: ('user_demo_001', '山田太郎', 'yamada@example.com', None, 1, '2025-10-30 23:14:16.641195')]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "service", "function": "startup_event", "line": 116}
ap2_merchant            | INFO:     Application startup complete.
ap2_merchant            | INFO:     Uvicorn running on http://0.0.0.0:8002 (Press CTRL+C to quit)
ap2_credential_provider  | [2025-10-30 23:14:18,230] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_credential_provider  | [2025-10-30 23:14:18,230] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_credential_provider  |   Service Name: credential_provider
ap2_credential_provider  |   OTLP Endpoint: http://jaeger:4317
ap2_credential_provider  |   Insecure: True
ap2_credential_provider_2  | [2025-10-30 23:14:18,242] INFO in common.telemetry: [Telemetry] Current TracerProvider type: ProxyTracerProvider
ap2_credential_provider_2  | [2025-10-30 23:14:18,242] INFO in common.telemetry: [Telemetry] Initializing OpenTelemetry:
ap2_credential_provider_2  |   Service Name: credential_provider_2
ap2_credential_provider_2  |   OTLP Endpoint: http://jaeger:4317
ap2_credential_provider_2  |   Insecure: True
ap2_credential_provider    | [2025-10-30 23:14:18,299] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: credential_provider
ap2_credential_provider    | [2025-10-30 23:14:18,300] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 23:14:18,301] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider    | [2025-10-30 23:14:18,301] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 23:14:18,302] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider, manual instrumentation only)
ap2_credential_provider_2  | [2025-10-30 23:14:18,308] INFO in common.telemetry: [Telemetry] OpenTelemetry initialized successfully for service: credential_provider_2
ap2_credential_provider_2  | [2025-10-30 23:14:18,308] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 23:14:18,308] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:14:18,309] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 23:14:18,309] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider_2, manual instrumentation only)
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.325572Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.334047Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.336480Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:14:18,336] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.336656Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.340582Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 23:14:18,340] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.340833Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.339967Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:14:18,340] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 23:14:18,340] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,341] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider    | [2025-10-30 23:14:18,341] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,345] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider    | [2025-10-30 23:14:18,345] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider_2  | [2025-10-30 23:14:18,345] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider_2  | [2025-10-30 23:14:18,345] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.345120Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:14:18,346] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider    | [2025-10-30 23:14:18,348] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider_2  | [2025-10-30 23:14:18,347] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider_2  | [2025-10-30 23:14:18,348] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider_2  | [2025-10-30 23:14:18,351] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider_2  | [2025-10-30 23:14:18,351] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,351] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider    | [2025-10-30 23:14:18,351] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,353] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 23:14:18,353] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | [2025-10-30 23:14:18,353] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider_2  | [2025-10-30 23:14:18,354] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,356] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.357065Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.357139Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:14:18,358] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider_2  | [2025-10-30 23:14:18,359] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider_2  | [2025-10-30 23:14:18,362] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider_2  | [2025-10-30 23:14:18,362] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.365701Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.365742Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:14:18,365] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider    | [2025-10-30 23:14:18,374] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider_2  | [2025-10-30 23:14:18,381] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.430081Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Tracing enabled", "module": "langgraph_merchant", "function": "<module>", "line": 83}
ap2_merchant_agent         | [2025-10-30 23:14:18,442] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant_agent         | [2025-10-30 23:14:18,442] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant_agent'. Adding OTLP exporter to existing provider.
ap2_merchant_agent         | [2025-10-30 23:14:18,474] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant_agent         | [2025-10-30 23:14:18,475] INFO in v2.common.base_agent: [Merchant Agent] OpenTelemetry distributed tracing enabled (service: merchant_agent, manual instrumentation only)
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.545478Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider    | [2025-10-30 23:14:18,545] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.550543Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider_2  | [2025-10-30 23:14:18,550] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.577253Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.597535Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | [2025-10-30 23:14:18,597] INFO in v2.common.base_agent: [Merchant Agent] ✓ ECDSA鍵を読み込みました: merchant_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.597832Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.600751Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | [2025-10-30 23:14:18,600] INFO in v2.common.base_agent: [Merchant Agent] ✓ Ed25519鍵を読み込みました: merchant_agent
ap2_merchant_agent         | [2025-10-30 23:14:18,600] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,602] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant_agent         | [2025-10-30 23:14:18,602] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,607] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent         | [2025-10-30 23:14:18,607] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,609] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent         | [2025-10-30 23:14:18,609] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,610] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant_agent         | [2025-10-30 23:14:18,610] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,614] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant_agent         | [2025-10-30 23:14:18,614] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,615] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.615875Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.IntentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.616043Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.ProductSearch", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.616075Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.616103Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartSelection", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.616125Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | [2025-10-30 23:14:18,625] INFO in v2.common.base_agent: [Merchant Agent] Initialized: did:ap2:agent:merchant_agent
ap2_credential_provider_2  | [2025-10-30 23:14:18,665] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 23:14:18,665] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:14:18,666] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 23:14:18,666] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider_2  | [2025-10-30 23:14:18,666] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider_2'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:14:18,668] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider_2  | [2025-10-30 23:14:18,668] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider_2, manual instrumentation only)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.668602Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.671520Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.671590Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | [2025-10-30 23:14:18,671] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.673406Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider_2  | [2025-10-30 23:14:18,673] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider_2  | [2025-10-30 23:14:18,673] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,679] INFO in common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 23:14:18,679] INFO in common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:14:18,679] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_credential_provider_2  | [2025-10-30 23:14:18,680] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,681] INFO in common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 23:14:18,681] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_credential_provider    | [2025-10-30 23:14:18,681] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='credential_provider'. Adding OTLP exporter to existing provider.
ap2_credential_provider_2  | [2025-10-30 23:14:18,684] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider_2  | [2025-10-30 23:14:18,685] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json

ap2_credential_provider    | [2025-10-30 23:14:18,684] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_credential_provider    | [2025-10-30 23:14:18,684] INFO in v2.common.base_agent: [Credential Provider] OpenTelemetry distributed tracing enabled (service: credential_provider, manual instrumentation only)
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.684591Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | [2025-10-30 23:14:18,688] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider_2  | [2025-10-30 23:14:18,689] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,689] INFO in v2.common.base_agent: [Credential Provider] ✓ ECDSA鍵を読み込みました: credential_provider
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.689853Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.689955Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: credential_provider (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_credential_provider_2  | [2025-10-30 23:14:18,691] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider_2  | [2025-10-30 23:14:18,691] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.693717Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_credential_provider    | [2025-10-30 23:14:18,694] INFO in v2.common.base_agent: [Credential Provider] ✓ Ed25519鍵を読み込みました: credential_provider
ap2_credential_provider    | [2025-10-30 23:14:18,694] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json


ap2_credential_provider_2  | [2025-10-30 23:14:18,695] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 23:14:18,695] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent

ap2_credential_provider_2  | [2025-10-30 23:14:18,695] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,695] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.700189Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.700225Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:14:18,700] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider    | [2025-10-30 23:14:18,700] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_credential_provider    | [2025-10-30 23:14:18,702] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,702] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_credential_provider    | [2025-10-30 23:14:18,703] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,707] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_credential_provider    | [2025-10-30 23:14:18,707] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,709] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_credential_provider    | [2025-10-30 23:14:18,710] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_credential_provider    | [2025-10-30 23:14:18,711] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.711430Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.711463Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.AttestationRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_credential_provider_2  | [2025-10-30 23:14:18,719] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_credential_provider    | [2025-10-30 23:14:18,725] INFO in v2.common.base_agent: [Credential Provider] Initialized: did:ap2:agent:credential_provider
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.727110Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Initialized (AI Mode: True)", "module": "agent", "function": "__init__", "line": 163}
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.729594Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider_2  | [2025-10-30 23:14:18,729] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider_2  | INFO:     Started server process [1]
ap2_credential_provider_2  | INFO:     Waiting for application startup.
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.731697Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Running startup tasks...", "module": "provider", "function": "startup_event", "line": 145}
ap2_credential_provider    | [2025-10-30 23:14:18,733] INFO in common.telemetry: [Telemetry] FastAPI app instrumented successfully (with request/response body tracking)
ap2_credential_provider    | INFO:     Started server process [1]
ap2_credential_provider    | INFO:     Waiting for application startup.
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.733480Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Initialized", "module": "provider", "function": "__init__", "line": 151}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.734067Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Running startup tasks...", "module": "provider", "function": "startup_event", "line": 145}
ap2_shopping_agent         | [2025-10-30 23:14:18,755] INFO in services.shopping_agent.langgraph_shopping_flow: [Langfuse] Shopping Agent tracing enabled
ap2_merchant_agent         | [2025-10-30 23:14:18,836] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_merchant_agent         | [2025-10-30 23:14:18,836] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='merchant_agent'. Adding OTLP exporter to existing provider.
ap2_merchant_agent         | [2025-10-30 23:14:18,838] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_merchant_agent         | [2025-10-30 23:14:18,838] INFO in v2.common.base_agent: [Merchant Agent] OpenTelemetry distributed tracing enabled (service: merchant_agent, manual instrumentation only)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.838383Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.846615Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.846871Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: merchant_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_merchant_agent         | [2025-10-30 23:14:18,846] INFO in v2.common.base_agent: [Merchant Agent] ✓ ECDSA鍵を読み込みました: merchant_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.849761Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_merchant_agent         | [2025-10-30 23:14:18,851] INFO in v2.common.base_agent: [Merchant Agent] ✓ Ed25519鍵を読み込みました: merchant_agent
ap2_merchant_agent         | [2025-10-30 23:14:18,851] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,853] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_merchant_agent         | [2025-10-30 23:14:18,853] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,855] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_merchant_agent         | [2025-10-30 23:14:18,855] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,856] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_merchant_agent         | [2025-10-30 23:14:18,856] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,859] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_merchant_agent         | [2025-10-30 23:14:18,859] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_merchant_agent         | [2025-10-30 23:14:18,866] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_merchant_agent         | [2025-10-30 23:14:18,866] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.869828Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.IntentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | [2025-10-30 23:14:18,869] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.869920Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.ProductSearch", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.869958Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartRequest", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.869971Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.requests.CartSelection", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.869982Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.PaymentMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_merchant_agent         | [2025-10-30 23:14:18,877] INFO in v2.common.base_agent: [Merchant Agent] Initialized: did:ap2:agent:merchant_agent
ap2_merchant_agent         | INFO:     Started server process [1]
ap2_merchant_agent         | INFO:     Waiting for application startup.
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.884295Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Initialized (AI Mode: True)", "module": "agent", "function": "__init__", "line": 163}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.884920Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Running startup tasks...", "module": "agent", "function": "startup_event", "line": 111}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:18.905457Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Database initialized", "module": "agent", "function": "startup_event", "line": 115}
ap2_merchant_agent         |
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         | 商品データ投入中...
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーアクリルキーホルダー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー時計 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーカレンダー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーマグカップ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーステッカー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーTシャツ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼートートバッグ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーポーチ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーぬいぐるみ（S） (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーぬいぐるみ（L） (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーキャップ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼークッション (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーノート (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーボールペン (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーウォーターボトル (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー靴下 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーマウスパッド (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼースマホケース (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー折りたたみ傘 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーエコバッグ (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーブランケット (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼープレート皿 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーパーカー (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーフェイスタオル (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーアロマキャンドル (既存)
ap2_credential_provider_2  | {"timestamp": "2025-10-30T23:14:18.989079Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Database initialized", "module": "provider", "function": "startup_event", "line": 149}
ap2_credential_provider_2  | INFO:     Application startup complete.
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼー抱き枕 (既存)
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーポスター (既存)
ap2_credential_provider_2  | INFO:     Uvicorn running on http://0.0.0.0:8003 (Press CTRL+C to quit)
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:18.994644Z", "level": "INFO", "logger": "provider", "message": "[Credential Provider] Database initialized", "module": "provider", "function": "startup_event", "line": 149}
ap2_credential_provider    | INFO:     Application startup complete.
ap2_merchant_agent         |   ⏭️  スキップ: むぎぼーニット帽 (既存)
ap2_merchant_agent         |
ap2_merchant_agent         | ✅ 商品データ投入完了 (28件)
ap2_merchant_agent         |
ap2_merchant_agent         | ============================================================
ap2_merchant_agent         | ユーザーデータ投入中...
ap2_merchant_agent         | ============================================================
ap2_credential_provider    | INFO:     Uvicorn running on http://0.0.0.0:8003 (Press CTRL+C to quit)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.010760Z", "level": "WARNING", "logger": "agent", "message": "[Merchant Agent] Sample data seeding warning: (sqlite3.IntegrityError) NOT NULL constraint failed: users.hashed_password\n[SQL: INSERT INTO users (id, display_name, email, hashed_password, is_active, created_at) VALUES (?, ?, ?, ?, ?, ?)]\n[parameters: ('user_demo_001', '山田太郎', 'yamada@example.com', None, 1, '2025-10-30 23:14:19.009360')]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "agent", "function": "startup_event", "line": 123}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.010847Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Initialized: http://meilisearch:7700, index=products", "module": "search_engine", "function": "__init__", "line": 38}
ap2_meilisearch            | 2025-10-30T23:14:19.082365Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=10.6ms time.idle=9.13ms
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.085041Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Index already exists: products", "module": "search_engine", "function": "create_index", "line": 65}
ap2_meilisearch            | 2025-10-30T23:14:19.100342Z  INFO HTTP request{method=PATCH host="meilisearch:7700" route=/indexes/products/settings query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=1.16ms time.idle=4.54ms
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.102357Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Index configured: products", "module": "search_engine", "function": "configure_index", "line": 115}
ap2_meilisearch            | 2025-10-30T23:14:19.105844Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_meilisearch            | 2025-10-30T23:14:19.117051Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.


ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.147417Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Cleared index: products", "module": "search_engine", "function": "clear_index", "line": 239}
ap2_meilisearch            | 2025-10-30T23:14:19.145724Z  INFO HTTP request{method=DELETE host="meilisearch:7700" route=/indexes/products/documents query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=1.15ms time.idle=5.22ms
ap2_meilisearch            | 2025-10-30T23:14:19.158430Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_meilisearch            | 2025-10-30T23:14:19.195082Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/documents query_parameters= user_agent=python-httpx/0.28.1 status_code=202}: meilisearch: close time.busy=6.76ms time.idle=23.1ms
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.201275Z", "level": "INFO", "logger": "v2.common.search_engine", "message": "[MeilisearchClient] Added 28 documents, taskUid=3", "module": "search_engine", "function": "add_documents", "line": 144}
ap2_merchant_agent         | [2025-10-30 23:14:19,205] INFO in utils.product_helpers: [_sync_products_to_meilisearch] Synced 28 products to Meilisearch
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.213144Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] Meilisearch synchronized", "module": "agent", "function": "startup_event", "line": 129}
ap2_shopping_agent         | [2025-10-30 23:14:19,280] INFO in services.shopping_agent.langgraph_shopping_flow: [LangGraph Shopping Flow] LLM initialized: ai/qwen3 at http://host.docker.internal:12434/engines/llama.cpp/v1
ap2_shopping_agent         | [2025-10-30 23:14:19,293] INFO in services.shopping_agent.langgraph_shopping_flow: [create_shopping_flow_graph] LangGraph shopping flow compiled successfully (14 nodes, AP2 compliant, with checkpointer for trace continuity)
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.293310Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] LangGraph shopping flow graph initialized successfully (12 nodes)", "module": "agent", "function": "__init__", "line": 241}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.293514Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Initialized with database-backed risk assessment", "module": "agent", "function": "__init__", "line": 268}
ap2_shopping_agent         | [2025-10-30 23:14:19,389] INFO in v2.common.telemetry: [Telemetry] Current TracerProvider type: TracerProvider
ap2_shopping_agent         | [2025-10-30 23:14:19,389] INFO in v2.common.telemetry: [Telemetry] TracerProvider already exists (TracerProvider) with service_name='shopping_agent'. Adding OTLP exporter to existing provider.
ap2_shopping_agent         | [2025-10-30 23:14:19,393] INFO in v2.common.telemetry: [Telemetry] OTLP exporter added successfully to existing TracerProvider (endpoint: http://jaeger:4317)
ap2_shopping_agent         | [2025-10-30 23:14:19,393] INFO in v2.common.base_agent: [Shopping Agent] OpenTelemetry distributed tracing enabled (service: shopping_agent, manual instrumentation only)
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.393909Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ECDSA)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent         | [2025-10-30 23:14:19,398] INFO in v2.common.base_agent: [Shopping Agent] ✓ ECDSA鍵を読み込みました: shopping_agent
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.398245Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.398359Z", "level": "INFO", "logger": "common.crypto", "message": "Loading private key: shopping_agent (algorithm: ED25519)", "module": "crypto", "function": "load_private_key_encrypted", "line": 345}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.400838Z", "level": "INFO", "logger": "common.crypto", "message": "Private key loaded successfully", "module": "crypto", "function": "load_private_key_encrypted", "line": 367}
ap2_shopping_agent         | [2025-10-30 23:14:19,400] INFO in v2.common.base_agent: [Shopping Agent] ✓ Ed25519鍵を読み込みました: shopping_agent
ap2_shopping_agent         | [2025-10-30 23:14:19,401] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_shopping_agent         | [2025-10-30 23:14:19,401] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_shopping_agent         | [2025-10-30 23:14:19,401] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_shopping_agent         | [2025-10-30 23:14:19,404] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_shopping_agent         | [2025-10-30 23:14:19,404] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_shopping_agent         | [2025-10-30 23:14:19,406] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_shopping_agent         | [2025-10-30 23:14:19,407] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_shopping_agent         | [2025-10-30 23:14:19,408] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_shopping_agent         | [2025-10-30 23:14:19,408] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_shopping_agent         | [2025-10-30 23:14:19,411] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_shopping_agent         | [2025-10-30 23:14:19,411] INFO in common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_shopping_agent         | [2025-10-30 23:14:19,412] INFO in common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.413071Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.mandates.CartMandate", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.413121Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.ProductList", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.413144Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Registered handler for @type: ap2.responses.SignatureResponse", "module": "a2a_handler", "function": "register_handler", "line": 72}
ap2_shopping_agent         | [2025-10-30 23:14:19,422] INFO in v2.common.base_agent: [Shopping Agent] Initialized: did:ap2:agent:shopping_agent
ap2_shopping_agent         | [2025-10-30 23:14:19,427] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Initialized (database_mode=enabled)
ap2_shopping_agent         | [2025-10-30 23:14:19,428] INFO in services.shopping_agent.langgraph_shopping_flow: [LangGraph Shopping Flow] LLM initialized: ai/qwen3 at http://host.docker.internal:12434/engines/llama.cpp/v1
ap2_shopping_agent         | [2025-10-30 23:14:19,436] INFO in services.shopping_agent.langgraph_shopping_flow: [create_shopping_flow_graph] LangGraph shopping flow compiled successfully (14 nodes, AP2 compliant, with checkpointer for trace continuity)
ap2_shopping_agent         | INFO:     Started server process [1]
ap2_shopping_agent         | INFO:     Waiting for application startup.
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.436086Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] LangGraph shopping flow graph initialized successfully (12 nodes)", "module": "agent", "function": "__init__", "line": 241}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.436151Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Initialized with database-backed risk assessment", "module": "agent", "function": "__init__", "line": 268}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.437575Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Running startup tasks...", "module": "agent", "function": "startup_event", "line": 262}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:19.466896Z", "level": "INFO", "logger": "agent", "message": "[Shopping Agent] Database initialized", "module": "agent", "function": "startup_event", "line": 266}
ap2_shopping_agent         | INFO:     Application startup complete.
ap2_shopping_agent         | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.972707Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[MerchantLangGraphAgent] LLM initialized with DMR: http://host.docker.internal:12434/engines/llama.cpp/v1, model: ai/qwen3", "module": "langgraph_merchant", "function": "__init__", "line": 178}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.981264Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Initialized: http://merchant_agent_mcp:8011", "module": "mcp_client", "function": "__init__", "line": 65}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.991728Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[MerchantLangGraphAgent] Initialized with LLM: ai/qwen3, MCP: http://merchant_agent_mcp:8011", "module": "langgraph_merchant", "function": "__init__", "line": 196}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:14:19.991832Z", "level": "INFO", "logger": "agent", "message": "[Merchant Agent] LangGraph AI engine initialized", "module": "agent", "function": "startup_event", "line": 143}
ap2_merchant_agent         | INFO:     Application startup complete.
ap2_merchant_agent         | INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
ap2_meilisearch            | 2025-10-30T23:14:23.157788Z  INFO index_scheduler::batch: document indexing done indexing_result=DocumentAdditionResult { indexed_documents: 28, number_of_documents: 28 } processed_in=3.975919919s
ap2_meilisearch            | 2025-10-30T23:14:23.164155Z  INFO index_scheduler: A batch of tasks was successfully completed with 1 successful tasks and 0 failed tasks.
ap2_shopping_agent         | INFO:     172.67.69.85:46950 - "OPTIONS /auth/register HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:46.645454Z", "level": "INFO", "logger": "agent", "message": "[register_user] Validating password strength for email=tubone24@example.com", "module": "agent", "function": "register_user", "line": 321}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:46.645948Z", "level": "INFO", "logger": "agent", "message": "[register_user] Hashing password for email=tubone24@example.com", "module": "agent", "function": "register_user", "line": 325}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:46.726386Z", "level": "INFO", "logger": "agent", "message": "[register_user] Password hashed successfully (length=97)", "module": "agent", "function": "register_user", "line": 327}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:46.749398Z", "level": "INFO", "logger": "agent", "message": "[register_user] Creating user with data: id=usr_5e05dfe96b254548, email=tubone24@example.com, hashed_password_len=97", "module": "agent", "function": "register_user", "line": 347}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:46.760903Z", "level": "INFO", "logger": "agent", "message": "[Auth] User registered: user_id=usr_5e05dfe96b254548, email=tubone24@example.com", "module": "agent", "function": "register_user", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:14:46.762804Z", "level": "INFO", "logger": "v2.common.auth", "message": "[Auth] Created JWT token: user_id=usr_5e05dfe96b254548, expires=2025-10-31T23:14:46.760962+00:00", "module": "auth", "function": "create_access_token", "line": 173}
ap2_shopping_agent         | INFO:     172.67.69.85:46950 - "POST /auth/register HTTP/1.1" 200 OK
ap2_credential_provider    | INFO:     172.67.69.85:51089 - "OPTIONS /register/passkey/challenge HTTP/1.1" 200 OK
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:49.343568Z", "level": "INFO", "logger": "provider", "message": "[register_passkey_challenge] Generated challenge for user_id=usr_5e05dfe96b254548", "module": "provider", "function": "register_passkey_challenge", "line": 220}
ap2_credential_provider    | [2025-10-30 23:14:49,348] INFO in v2.common.redis_client: [RedisClient] Connected to Redis: redis://redis:6379/0
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:49.378808Z", "level": "INFO", "logger": "provider", "message": "[register_passkey_challenge] Saved challenge to Redis KV (TTL: 60s)", "module": "provider", "function": "register_passkey_challenge", "line": 236}
ap2_credential_provider    | INFO:     172.67.69.85:51089 - "POST /register/passkey/challenge HTTP/1.1" 200 OK
ap2_credential_provider    | INFO:     172.67.69.85:48587 - "OPTIONS /register/passkey HTTP/1.1" 200 OK
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:58.322849Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Registering passkey for user: usr_5e05dfe96b254548", "module": "provider", "function": "register_passkey", "line": 302}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:58.326072Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Challenge verified and deleted: OU5QRfyS48Z-R959...", "module": "provider", "function": "register_passkey", "line": 343}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:58.329991Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] COSE key length: 77 bytes", "module": "provider", "function": "register_passkey", "line": 390}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:58.330094Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] COSE key dict: {1: 2, 3: -7, -1: 1, -2: b'\\x1bj\\x03\\xea\\xaa\\x8f\\xfa)\\xd8:,\\x9d\\x01NG\\xd4\\x1f\\xd6\\xf4\\x99(\\xcb\\xdd\\xbc\\x96\\xd0\\xc6\\xb5\\x00d\\xec\\xdd', -3: b'\\xe3\\x03vg\\x08Om\\x16R\\xba\\xbe\\x02\\xbfOh#\\xe0\\x14\\x88Y\\xb8\\x18\\xf5p\\\\\\xaa8\\xdbp\\x1e\\xe19'}", "module": "provider", "function": "register_passkey", "line": 391}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:58.330117Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Extracted public key from attestationObject", "module": "provider", "function": "register_passkey", "line": 393}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:14:58.402936Z", "level": "INFO", "logger": "provider", "message": "[register_passkey] Passkey registered: p2duhMkSHYBUfJeQ...", "module": "provider", "function": "register_passkey", "line": 418}
ap2_credential_provider    | INFO:     172.67.69.85:48587 - "POST /register/passkey HTTP/1.1" 200 OK
ap2_credential_provider    | INFO:     172.67.69.85:18014 - "OPTIONS /payment-methods HTTP/1.1" 200 OK
ap2_credential_provider    | {"timestamp": "2025-10-30T23:15:26.187684Z", "level": "INFO", "logger": "provider", "message": "[add_payment_method] Saved payment method to DB: pm_0f73d52d for user: usr_5e05dfe96b254548", "module": "provider", "function": "add_payment_method", "line": 654}
ap2_credential_provider    | INFO:     172.67.69.85:53091 - "POST /payment-methods HTTP/1.1" 200 OK
ap2_shopping_agent         | INFO:     172.67.69.85:36847 - "OPTIONS /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:31.036475Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:31.037899Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: a\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:36847 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:31.094325Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Created new session in DB: session_1761866127723_ypdx0n", "module": "agent", "function": "_get_or_create_session", "line": 1965}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:31.094850Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:31.102952Z", "level": "INFO", "logger": "agent", "message": "[Langfuse] Created new handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1643}
ap2_shopping_agent         | [2025-10-30 23:15:31,130] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: initial
ap2_shopping_agent         |   user_input: a
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:33.696038Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:33.705788Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=ask_intent", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:36.539102Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:36.539520Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: かわいいグッズがほしい。5000円以内\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:51496 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:36.544299Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=ask_intent", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:36.545338Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:15:36.545454Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:15:36,548] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: ask_intent
ap2_shopping_agent         |   user_input: かわいいグッズがほしい。5000円以内
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:16:44,546] INFO in services.shopping_agent.langgraph_shopping_flow: [collect_intent_node] LLM result: {'intent': 'かわいいグッズを購入したい', 'max_amount': 5000, 'keywords': ['かわいい', 'グッズ', 'おしゃれ']}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:16:44.547797Z", "level": "INFO", "logger": "agent", "message": "[_create_intent_mandate] Reconstructed intent: かわいいグッズを購入したい。5000円以内", "module": "agent", "function": "_create_intent_mandate", "line": 1733}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:16:44.548176Z", "level": "INFO", "logger": "agent", "message": "[_build_intent_mandate_from_session] Constructed natural_language_description: かわいいグッズを購入したい。5000円以内", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1812}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:16:44.548512Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] IntentMandate created (AP2-compliant): intent='かわいいグッズを購入したい...', expiry=2025-10-31T00:16:44.547550Z", "module": "agent", "function": "_build_intent_mandate_from_session", "line": 1824}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:16:46.584461Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:16:46.589219Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=intent_complete_ask_shipping", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:08.759297Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:08.761242Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: {\"recipient\":\"a\",\"postal_code\":\"a\",\"city\":\"a\",\"region\":\"a\",\"address_line1\":\"a\",\"country\":\"a\"}\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:39430 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:08.768683Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=intent_complete_ask_shipping", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:08.770480Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:08.772013Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:17:08,823] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: intent_complete_ask_shipping
ap2_shopping_agent         |   user_input: {"recipient":"a","postal_code":"a","city":"a","region":"a","address_line1":"a","country":"a"}
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:17:09,138] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='{"recipient":"a","postal_code":"a","city":"a","region":"a","address_line1":"a","country":"a"}', session['step']='select_cp', is_digit=False
ap2_shopping_agent         | [2025-10-30 23:17:09,140] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-30 23:17:09,140] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-30 23:17:09,140] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: Presenting 2 Credential Providers to user
ap2_shopping_agent         |   User ID: usr_5e05dfe96b254548
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:10.335473Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=select_cp", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:10.338049Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=select_cp", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.187867Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.191986Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: 1\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:39430 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.197729Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=select_cp", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.199126Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.199262Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:17:11,204] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: select_cp
ap2_shopping_agent         |   user_input: 1
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:17:11,208] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] DEBUG: user_input='1', session['step']='select_cp', is_digit=True
ap2_shopping_agent         | [2025-10-30 23:17:11,208] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp, name=AP2 Demo Credential Provider, url=http://credential_provider:8003
ap2_shopping_agent         | [2025-10-30 23:17:11,208] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] Resolved CP from DID: did=did:ap2:cp:demo_cp_2, name=AP2 Demo Credential Provider 2, url=http://credential_provider_2:8003
ap2_shopping_agent         | [2025-10-30 23:17:11,208] INFO in services.shopping_agent.langgraph_shopping_flow: [select_cp_node] AP2 Step 4: User selected Credential Provider
ap2_shopping_agent         |   User ID: usr_5e05dfe96b254548
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP Name: AP2 Demo Credential Provider
ap2_shopping_agent         | [2025-10-30 23:17:11,415] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 6-7: Requesting payment methods from CP
ap2_shopping_agent         |   User ID: usr_5e05dfe96b254548
ap2_shopping_agent         |   CP ID: did:ap2:cp:demo_cp
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.415172Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment methods from Credential Provider (http://credential_provider:8003) for user: usr_5e05dfe96b254548", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2316}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.415506Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: GET http://credential_provider:8003/payment-methods", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.415568Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"GET\", \"url\": \"http://credential_provider:8003/payment-methods\", \"headers\": {}, \"body\": null}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:17:11.471795Z", "level": "INFO", "logger": "provider", "message": "[get_payment_methods] Retrieved 1 payment methods for user: usr_5e05dfe96b254548", "module": "provider", "function": "get_payment_methods", "line": 619}
ap2_credential_provider    | INFO:     172.18.0.3:32774 - "GET /payment-methods?user_id=usr_5e05dfe96b254548 HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.476195Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (60.60ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.476272Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:17:10 GMT\", \"server\": \"uvicorn\", \"content-length\": \"365\", \"content-type\": \"application/json\"}, \"body\": {\"user_id\": \"usr_5e05dfe96b254548\", \"payment_methods\": [{\"type\": \"basic-card\", \"display_name\": \"Visaカード (****1111)\", \"brand\": \"Visa\", \"last4\": \"1111\", \"card_number\": \"1111111111111111\", \"cardholder_name\": \"YUOOOO\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\", \"cvv\": \"123\", \"billing_address\": {\"country\": \"JP\", \"postal_code\": \"111-1111\"}, \"requires_step_up\": false, \"id\": \"pm_0f73d52d\"}]}, \"duration_ms\": 60.59622764587402}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:17:11,476] INFO in services.shopping_agent.langgraph_shopping_flow: [get_payment_methods_node] AP2 Step 7: Received 1 payment methods from CP
ap2_shopping_agent         |   Payment Methods: ['pm_0f73d52d']
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.476340Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Retrieved 1 payment methods from Credential Provider", "module": "agent", "function": "_get_payment_methods_from_cp", "line": 2334}
ap2_shopping_agent         | [2025-10-30 23:17:11,679] INFO in services.shopping_agent.langgraph_shopping_flow: [fetch_carts_node] AP2 Step 8-12: Fetching cart candidates from Merchant Agent
ap2_shopping_agent         | [2025-10-30 23:17:11,679] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting cart candidates from Merchant Agent for IntentMandate: intent_556a9bb4
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.682070Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.695946Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 797, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_556a9bb4\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-30T23:16:44.547550Z\",\"id\":\"intent_556a9bb4\",\"intent_expiry\":\"2025-10-31T00:1", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.696517Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.710596Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.711628Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.mandates.IntentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.711720Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.IntentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"d951fb1f-4ad8-44c6-875f-b78bda5764c0\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:17:11.680100Z\", \"nonce\": \"5131294b7525764c2b03924f553c04a612a5c0d633132a7daa17bfb43e76311f\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"intent_mandate\": {\"id\": \"intent_556a9bb4\", \"type\": \"IntentMandate\", \"user_id\": \"usr_5e05dfe96b254548\", \"user_cart_confirmation_required\": true, \"natural_language_description\": \"かわいいグッズを購入したい。5000円以内\", \"requires_refundability\": false, \"intent_expiry\": \"2025-10-31T00:16:44.547550Z\", \"created_at\": \"2025-10-30T23:16:44.547550Z\"}, \"shipping_address\": {\"recipient\": \"a\", \"postal_code\": \"a\", \"city\": \"a\", \"region\": \"a\", \"address_line1\": \"a\", \"country\": \"a\"}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_shopping_agent         | [2025-10-30 23:17:11,711] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Intent A2A message created: message_id=d951fb1f-4ad8-44c6-875f-b78bda5764c0, intent_mandate_id=intent_556a9bb4
ap2_shopping_agent         | [2025-10-30 23:17:11,711] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: d951fb1f-4ad8-44c6-875f-b78bda5764c0
ap2_shopping_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_shopping_agent         |   ペイロード: {
ap2_shopping_agent         |   "id": "intent_556a9bb4",
ap2_shopping_agent         |   "type": "IntentMandate",
ap2_shopping_agent         |   "user_id": "usr_5e05dfe96b254548",
ap2_shopping_agent         |   "user_cart_confirmation_required": true,
ap2_shopping_agent         |   "natural_language_description": "かわいいグッズを購入したい。5000円以内",
ap2_shopping_agent         |   "requires_refundability": false,
ap2_shopping_agent         |   "intent_expiry": "2025-10-31T00:16:44.547550Z",
ap2_shopping_agent         |   "created_at": "2025-10-30T23:16:44.547550Z"
ap2_shopping_agent         | }
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.713374Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent:8001/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:17:11.713427Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent:8001/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"d951fb1f-4ad8-44c6-875f-b78bda5764c0\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:17:11.680100Z\", \"nonce\": \"5131294b7525764c2b03924f553c04a612a5c0d633132a7daa17bfb43e76311f\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"KPGPtvjnHKNB/d+qdMP6eXxVTCbmhsAyp/NPRTX6uvV7qpkNEHo8jHEtfuAvxGJkCi3bZL7+gEThegNx3ULECQ==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVV5NktCOUszd054bmFuZStkTUZrLzZtekI3K3lSeHpJOFVSMFQ4eWFaclU9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:shopping_agent#key-2\", \"created\": \"2025-10-30T23:17:11.680100Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.IntentMandate\", \"id\": \"intent_556a9bb4\", \"payload\": {\"intent_mandate\": {\"id\": \"intent_556a9bb4\", \"type\": \"IntentMandate\", \"user_id\": \"usr_5e05dfe96b254548\", \"user_cart_confirmation_required\": true, \"natural_language_description\": \"かわいいグッズを購入したい。5000円以内\", \"requires_refundability\": false, \"intent_expiry\": \"2025-10-31T00:16:44.547550Z\", \"created_at\": \"2025-10-30T23:16:44.547550Z\"}, \"shipping_address\": {\"recipient\": \"a\", \"postal_code\": \"a\", \"city\": \"a\", \"region\": \"a\", \"address_line1\": \"a\", \"country\": \"a\"}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | [2025-10-30 23:17:11,762] INFO in v2.common.base_agent:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message
ap2_merchant_agent         |   受信メッセージ: ID=d951fb1f-4ad8-44c6-875f-b78bda5764c0
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.IntentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.765778Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:shopping_agent: ap2.mandates.IntentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.770718Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.IntentMandate\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"d951fb1f-4ad8-44c6-875f-b78bda5764c0\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:17:11.680100Z\", \"nonce\": \"5131294b7525764c2b03924f553c04a612a5c0d633132a7daa17bfb43e76311f\", \"schema_version\": \"0.2\"}, \"payload\": {\"intent_mandate\": {\"id\": \"intent_556a9bb4\", \"type\": \"IntentMandate\", \"user_id\": \"usr_5e05dfe96b254548\", \"user_cart_confirmation_required\": true, \"natural_language_description\": \"かわいいグッズを購入したい。5000円以内\", \"requires_refundability\": false, \"intent_expiry\": \"2025-10-31T00:16:44.547550Z\", \"created_at\": \"2025-10-30T23:16:44.547550Z\"}, \"shipping_address\": {\"recipient\": \"a\", \"postal_code\": \"a\", \"city\": \"a\", \"region\": \"a\", \"address_line1\": \"a\", \"country\": \"a\"}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.776585Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=5131294b7525764c...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.781991Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:shopping_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.787898Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.797200Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 797, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.IntentMandate\",\"id\":\"intent_556a9bb4\",\"payload\":{\"intent_mandate\":{\"created_at\":\"2025-10-30T23:16:44.547550Z\",\"id\":\"intent_556a9bb4\",\"intent_expiry\":\"2025-10-31T00:1", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.797287Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.809952Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.810278Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.810352Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.IntentMandate, from=did:ap2:agent:shopping_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.810931Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate", "module": "intent_handler", "function": "handle_intent_mandate", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.811104Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Received IntentMandate with shipping_address (AP2 v0.1 compliant)", "module": "intent_handler", "function": "handle_intent_mandate", "line": 50}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.811161Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Searching products with intent: 'かわいいグッズを購入したい。5000円以内'", "module": "intent_handler", "function": "handle_intent_mandate", "line": 54}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.811205Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using provided shipping address: a", "module": "intent_handler", "function": "handle_intent_mandate", "line": 71}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.811787Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Using LangGraph AI engine for cart generation", "module": "intent_handler", "function": "handle_intent_mandate", "line": 76}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.822731Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[Langfuse] Created new handler for session: 7ae2dd81-3a48-44ef-a149-7b371a765aa4", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 289}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.898225Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: initialize", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.898304Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"initialize\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\"}, \"arguments\": {\"protocolVersion\": \"2025-03-26\", \"clientInfo\": {\"name\": \"ap2_langgraph_client\", \"version\": \"1.0.0\"}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.899532Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:11.899748Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"initialize\", \"params\": {\"protocolVersion\": \"2025-03-26\", \"clientInfo\": {\"name\": \"ap2_langgraph_client\", \"version\": \"1.0.0\"}}, \"id\": 547954}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.8:50710 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.150428Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (251.26ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.150544Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:17:10 GMT\", \"server\": \"uvicorn\", \"mcp-session-id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\", \"content-length\": \"1145\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 547954, \"result\": {\"protocolVersion\": \"2025-03-26\", \"serverInfo\": {\"name\": \"merchant_agent_mcp\", \"version\": \"1.0.0\"}, \"capabilities\": {\"tools\": {\"search_products\": {\"description\": \"データベースから商品を検索\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"keywords\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}, \"description\": \"検索キーワードリスト\"}, \"limit\": {\"type\": \"integer\", \"description\": \"最大検索結果数\", \"default\": 20}}, \"required\": [\"keywords\"]}}, \"check_inventory\": {\"description\": \"在庫状況を確認\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"product_ids\": {\"type\": \"array\", \"items\": {\"type\": \"integer\"}, \"description\": \"商品IDリスト\"}}, \"required\": [\"product_ids\"]}}, \"build_cart_mandates\": {\"description\": \"AP2準拠のCartMandateを構築（未署名）\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"cart_plan\": {\"type\": \"object\", \"description\": \"カートプラン（optimize_cartの結果）\"}, \"products\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}, \"description\": \"商品情報リスト\"}, \"shipping_address\": {\"type\": \"object\", \"description\": \"AP2準拠のContactAddress\"}}, \"required\": [\"cart_plan\", \"products\"]}}}}}}, \"duration_ms\": 251.26338005065918}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.152086Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: initialize - SUCCESS (253.74ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.152148Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"initialize\", \"result\": {\"protocolVersion\": \"2025-03-26\", \"serverInfo\": {\"name\": \"merchant_agent_mcp\", \"version\": \"1.0.0\"}, \"capabilities\": {\"tools\": {\"search_products\": {\"description\": \"データベースから商品を検索\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"keywords\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}, \"description\": \"検索キーワードリスト\"}, \"limit\": {\"type\": \"integer\", \"description\": \"最大検索結果数\", \"default\": 20}}, \"required\": [\"keywords\"]}}, \"check_inventory\": {\"description\": \"在庫状況を確認\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"product_ids\": {\"type\": \"array\", \"items\": {\"type\": \"integer\"}, \"description\": \"商品IDリスト\"}}, \"required\": [\"product_ids\"]}}, \"build_cart_mandates\": {\"description\": \"AP2準拠のCartMandateを構築（未署名）\", \"inputSchema\": {\"type\": \"object\", \"properties\": {\"cart_plan\": {\"type\": \"object\", \"description\": \"カートプラン（optimize_cartの結果）\"}, \"products\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}, \"description\": \"商品情報リスト\"}, \"shipping_address\": {\"type\": \"object\", \"description\": \"AP2準拠のContactAddress\"}}, \"required\": [\"cart_plan\", \"products\"]}}}}}, \"error\": null, \"duration_ms\": 253.7381649017334}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.152373Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Initialized session: 52b304f5-5212-4cee-841e-77287e1a08a4", "module": "mcp_client", "function": "initialize", "line": 88}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.152612Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Server capabilities: {'tools': {'search_products': {'description': 'データベースから商品を検索', 'inputSchema': {'type': 'object', 'properties': {'keywords': {'type': 'array', 'items': {'type': 'string'}, 'description': '検索キーワードリスト'}, 'limit': {'type': 'integer', 'description': '最大検索結果数', 'default': 20}}, 'required': ['keywords']}}, 'check_inventory': {'description': '在庫状況を確認', 'inputSchema': {'type': 'object', 'properties': {'product_ids': {'type': 'array', 'items': {'type': 'integer'}, 'description': '商品IDリスト'}}, 'required': ['product_ids']}}, 'build_cart_mandates': {'description': 'AP2準拠のCartMandateを構築（未署名）', 'inputSchema': {'type': 'object', 'properties': {'cart_plan': {'type': 'object', 'description': 'カートプラン（optimize_cartの結果）'}, 'products': {'type': 'array', 'items': {'type': 'object'}, 'description': '商品情報リスト'}, 'shipping_address': {'type': 'object', 'description': 'AP2準拠のContactAddress'}}, 'required': ['cart_plan', 'products']}}}}", "module": "mcp_client", "function": "initialize", "line": 89}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:12.152691Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] MCP client initialized", "module": "intent_node", "function": "analyze_intent", "line": 35}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.147859Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.intent_node", "message": "[analyze_intent] LLM result: {'primary_need': 'かわいいグッズを5000 円以内で購入したい', 'budget_strategy': 'low', 'key_factors': ['かわいさ', '価格'], 'search_keywords': ['かわいい', 'グッズ', 'Tシャツ', 'キャラクター', 'おしゃれ']}", "module": "intent_node", "function": "analyze_intent", "line": 124}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.159490Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.159584Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"arguments\": {\"name\": \"search_products\", \"arguments\": {\"keywords\": [\" かわいい\", \"グッズ\", \"Tシャツ\", \"キャラクター\", \"おしゃれ\"], \"limit\": 20}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.159920Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.159966Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"search_products\", \"arguments\": {\"keywords\": [\"かわいい\", \"グッズ\", \"Tシャツ\", \"キャラクター\", \"おしゃれ\"], \"limit\": 20}}, \"id\": 433969}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:17:57.218693Z", "level": "INFO", "logger": "main", "message": "[search_products] Searching with query: 'かわいい グッズ Tシャツ キャラクター おしゃれ'", "module": "main", "function": "search_products", "line": 123}
ap2_meilisearch            | 2025-10-30T23:17:57.818310Z  INFO HTTP request{method=POST host="meilisearch:7700" route=/indexes/products/search query_parameters= user_agent=python-httpx/0.28.1 status_code=200}: meilisearch: close time.busy=9.26ms time.idle=47.3ms
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:17:57.827626Z", "level": "INFO", "logger": "common.search_engine", "message": "[MeilisearchClient] Search 'かわいい グッズ Tシャツ キャラクター おしゃれ' returned 6 products", "module": "search_engine", "function": "search", "line": 187}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:17:57.978062Z", "level": "INFO", "logger": "main", "message": "[search_products] Returned 6 products for keywords: ['かわいい', 'グッズ', 'Tシャツ', 'キャラクター', 'おし ゃれ']", "module": "main", "function": "search_products", "line": 148}
ap2_merchant_agent_mcp     | INFO:     172.18.0.8:35000 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.985140Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (824.60ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.985533Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:17:56 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3086\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 433969, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"products\\\": [\\n    {\\n      \\\"id\\\": \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\",\\n      \\\"sku\\\": \\\"MUGI-KEYCHAIN-001\\\",\\n      \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n      \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n      \\\"price_cents\\\": 80000,\\n      \\\"price_jpy\\\": 800.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\",\\n      \\\"sku\\\": \\\"MUGI-CLOCK-001\\\",\\n      \\\"name\\\": \\\"むぎぼー時計\\\",\\n      \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n      \\\"price_cents\\\": 350000,\\n      \\\"price_jpy\\\": 3500.0,\\n      \\\"inventory_count\\\": 30,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"8583b100-e48e-4726-ac1f-a967551e5fd2\\\",\\n      \\\"sku\\\": \\\"MUGI-POUCH-001\\\",\\n      \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n      \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n      \\\"price_cents\\\": 95000,\\n      \\\"price_jpy\\\": 950.0,\\n      \\\"inventory_count\\\": 120,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"3a4207bb-3f3b-4760-b9db-54804cac3a87\\\",\\n      \\\"sku\\\": \\\"MUGI-MUG-001\\\",\\n      \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n      \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n      \\\"price_cents\\\": 120000,\\n      \\\"price_jpy\\\": 1200.0,\\n      \\\"inventory_count\\\": 80,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\\\",\\n      \\\"sku\\\": \\\"MUGI-SOCKS-001\\\",\\n      \\\"name\\\": \\\"むぎぼー靴下\\\",\\n      \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n      \\\"price_cents\\\": 85000,\\n      \\\"price_jpy\\\": 850.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"bd495e21-8df3-4679-9c48-54bb84027698\\\",\\n      \\\"sku\\\": \\\"MUGI-PLATE-001\\\",\\n      \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n      \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n      \\\"price_cents\\\": 190000,\\n      \\\"price_jpy\\\": 1900.0,\\n      \\\"inventory_count\\\": 70,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    }\\n  ]\\n}\"}], \"isError\": false}}, \"duration_ms\": 824.6042728424072}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.985854Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (826.21ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent_mcp     | {"timestamp": "2025-10-30T23:17:57.991870Z", "level": "INFO", "logger": "main", "message": "[check_inventory] Inventory: {'6e233ec0-0871-4550-8d91-d94f5d8a0cd5': 100, '1ef314f1-8cc4-4d88-8f33-4dc68879ff29': 30, '8583b100-e48e-4726-ac1f-a967551e5fd2': 120, '3a4207bb-3f3b-4760-b9db-54804cac3a87': 80, '53b5de5f-ad48-4a05-a6f5-39cd26f8c800': 100, 'bd495e21-8df3-4679-9c48-54bb84027698': 70}", "module": "main", "function": "check_inventory", "line": 202}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.985914Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"products\\\": [\\n    {\\n      \\\"id\\\": \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\",\\n      \\\"sku\\\": \\\"MUGI-KEYCHAIN-001\\\",\\n      \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n      \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n      \\\"price_cents\\\": 80000,\\n      \\\"price_jpy\\\": 800.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\",\\n      \\\"sku\\\": \\\"MUGI-CLOCK-001\\\",\\n      \\\"name\\\": \\\"むぎぼー時計\\\",\\n      \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n      \\\"price_cents\\\": 350000,\\n      \\\"price_jpy\\\": 3500.0,\\n      \\\"inventory_count\\\": 30,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"8583b100-e48e-4726-ac1f-a967551e5fd2\\\",\\n      \\\"sku\\\": \\\"MUGI-POUCH-001\\\",\\n      \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n      \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペ ンケースとして使えます。\\\",\\n      \\\"price_cents\\\": 95000,\\n      \\\"price_jpy\\\": 950.0,\\n      \\\"inventory_count\\\": 120,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"3a4207bb-3f3b-4760-b9db-54804cac3a87\\\",\\n      \\\"sku\\\": \\\"MUGI-MUG-001\\\",\\n      \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n      \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n      \\\"price_cents\\\": 120000,\\n      \\\"price_jpy\\\": 1200.0,\\n      \\\"inventory_count\\\": 80,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\\\",\\n      \\\"sku\\\": \\\"MUGI-SOCKS-001\\\",\\n      \\\"name\\\": \\\"むぎぼー靴下\\\",\\n      \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n      \\\"price_cents\\\": 85000,\\n      \\\"price_jpy\\\": 850.0,\\n      \\\"inventory_count\\\": 100,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    },\\n    {\\n      \\\"id\\\": \\\"bd495e21-8df3-4679-9c48-54bb84027698\\\",\\n      \\\"sku\\\": \\\"MUGI-PLATE-001\\\",\\n      \\\"name\\\": \\\"むぎぼープレート皿\\\",\\n      \\\"description\\\": \\\"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\\\",\\n      \\\"price_cents\\\": 190000,\\n      \\\"price_jpy\\\": 1900.0,\\n      \\\"inventory_count\\\": 70,\\n      \\\"category\\\": null,\\n      \\\"brand\\\": null,\\n      \\\"image_url\\\": null,\\n      \\\"refund_period_days\\\": 30\\n    }\\n  ]\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 826.209545135498}", "module": "logger", "function": "log_mcp_response", "line": 328}


ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.985980Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool search_products executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.986281Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.search_node", "message": "[search_products] MCP returned 6 products", "module": "search_node", "function": "search_products", "line": 69}
ap2_merchant_agent_mcp     | INFO:     172.18.0.8:35000 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.988341Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.988369Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"arguments\": {\"name\": \"check_inventory\", \"arguments\": {\"product_ids\": [\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"bd495e21-8df3-4679-9c48-54bb84027698\"]}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.988497Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.988528Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"check_inventory\", \"arguments\": {\"product_ids\": [\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"bd495e21-8df3-4679-9c48-54bb84027698\"]}}, \"id\": 649914}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.992667Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (4.14ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.992722Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:17:57 GMT\", \"server\": \"uvicorn\", \"content-length\": \"431\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 649914, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"inventory\\\": {\\n    \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\": 100,\\n    \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\": 30,\\n    \\\"8583b100-e48e-4726-ac1f-a967551e5fd2\\\": 120,\\n    \\\"3a4207bb-3f3b-4760-b9db-54804cac3a87\\\": 80,\\n    \\\"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\\\": 100,\\n    \\\"bd495e21-8df3-4679-9c48-54bb84027698\\\": 70\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 4.14276123046875}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.992955Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (4.53ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.992981Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"inventory\\\": {\\n    \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\": 100,\\n    \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\": 30,\\n    \\\"8583b100-e48e-4726-ac1f-a967551e5fd2\\\": 120,\\n    \\\"3a4207bb-3f3b-4760-b9db-54804cac3a87\\\": 80,\\n    \\\"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\\\": 100,\\n    \\\"bd495e21-8df3-4679-9c48-54bb84027698\\\": 70\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 4.525899887084961}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.993009Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool check_inventory executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:17:57.993042Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.inventory_node", "message": "[check_inventory] MCP checked 6 products", "module": "inventory_node", "function": "check_inventory", "line": 62}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.801433Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.optimization_node", "message": "[optimize_cart] LLM generated 3 cart plans", "module": "optimization_node", "function": "optimize_cart", "line": 164}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.815522Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Creating 3 unsigned CartMandates...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 66}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.817021Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.817137Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"コスパ最強プラン (3,800円)\", \"description\": \"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\", \"items\": [{\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"quantity\": 1}, {\"product_id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"quantity\": 1}, {\"product_id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"quantity\": 1}, {\"product_id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"quantity\": 1}]}, \"products\": [{\"id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグ やポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎ ぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"bd495e21-8df3-4679-9c48-54bb84027698\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.817809Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.817895Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"コスパ最強プラン (3,800円)\", \"description\": \"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\", \"items\": [{\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"quantity\": 1}, {\"product_id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"quantity\": 1}, {\"product_id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"quantity\": 1}, {\"product_id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"quantity\": 1}]}, \"products\": [{\"id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむ ぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポー チ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなり ます。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"bd495e21-8df3-4679-9c48-54bb84027698\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 625481}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent_mcp     | INFO:     172.18.0.8:38840 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.881437Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (63.55ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.881567Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:46 GMT\", \"server\": \"uvicorn\", \"content-length\": \"4975\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 625481, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_ba8fa536\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_ba8fa536\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 800.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー マグカップ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1200.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーポーチ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 950.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー靴下\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 850.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 380.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4680.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:19:46.874749Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:19:46.874948Z\\\",\\n      \\\"cart_name\\\": \\\"コスパ最強プラン (3,800円)\\\",\\n      \\\"cart_description\\\": \\\"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\",\\n          \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n          \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"3a4207bb-3f3b-4760-b9db-54804cac3a87\\\",\\n          \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n          \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"8583b100-e48e-4726-ac1f-a967551e5fd2\\\",\\n          \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n          \\\"description\\\": \\\"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\\\",\\n          \\\"name\\\": \\\"むぎぼー靴下\\\",\\n          \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 63.5530948638916}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.882114Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (64.59ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.882176Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_ba8fa536\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_ba8fa536\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼーアクリルキーホ ルダー\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 800.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーマグカップ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 1200.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーポーチ\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 950.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼー靴下\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 850.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 380.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4680.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:19:46.874749Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:19:46.874948Z\\\",\\n      \\\"cart_name\\\": \\\"コスパ最強プラン (3,800円)\\\",\\n      \\\"cart_description\\\": \\\"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\",\\n          \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n          \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"3a4207bb-3f3b-4760-b9db-54804cac3a87\\\",\\n          \\\"name\\\": \\\"むぎぼーマグカップ\\\",\\n          \\\"description\\\": \\\"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 1200.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"8583b100-e48e-4726-ac1f-a967551e5fd2\\\",\\n          \\\"name\\\": \\\"むぎぼーポーチ\\\",\\n          \\\"description\\\": \\\"むぎぼー柄のか わいいポーチ。小物入れやペンケースとして使えます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 950.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\\\",\\n          \\\"name\\\": \\\"むぎぼー靴下\\\",\\n          \\\"description\\\": \\\"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 850.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 64.59283828735352}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.882381Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.882436Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_ba8fa536, plan=コスパ最強プラン (3,800円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.882728Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.882843Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"高品質プラン (4,300円)\", \"description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"quantity\": 1}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"quantity\": 1}]}, \"products\": [{\"id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼ ーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を 明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"bd495e21-8df3-4679-9c48-54bb84027698\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート 皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.883169Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.883295Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"高品質プラン (4,300円)\", \"description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"quantity\": 1}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"quantity\": 1}]}, \"products\": [{\"id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"bd495e21-8df3-4679-9c48-54bb84027698\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 373839}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.887758Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (4.54ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.887862Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:46 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3370\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 373839, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_1e9a114c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_1e9a114c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 800.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 430.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5230.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:19:46.885682Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:19:46.885715Z\\\",\\n      \\\"cart_name\\\": \\\"高品質プラン (4,300円)\\\",\\n      \\\"cart_description\\\": \\\"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\",\\n          \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n          \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 4.544258117675781}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.888187Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (5.29ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.888233Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_1e9a114c\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_1e9a114c\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 800.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 430.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 5230.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:19:46.885682Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:19:46.885715Z\\\",\\n      \\\"cart_name\\\": \\\"高品質プラン (4,300円)\\\",\\n      \\\"cart_description\\\": \\\"時計とキーホルダーの組み合わせで、かわい さと品質を両立したプランです。予算を少し超えても高品質を追求しました。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        },\\n        {\\n          \\\"product_id\\\": \\\"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\\\",\\n          \\\"name\\\": \\\"むぎぼーアクリルキーホルダー\\\",\\n          \\\"description\\\": \\\"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 800.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 5.29170036315918}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent_mcp     | INFO:     172.18.0.8:38840 - "POST / HTTP/1.1" 200 OK




ap2_merchant_agent_mcp     | INFO:     172.18.0.8:38840 - "POST / HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.888622Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}


ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.888750Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_1e9a114c, plan=高品質プラン (4,300円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.889959Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Request: tools/call", "module": "logger", "function": "log_mcp_request", "line": 283}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.890073Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_REQUEST_RAW: {\"type\": \"MCP_REQUEST\", \"tool_name\": \"tools/call\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"arguments\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"シンプルプラン (3,500円)\", \"description\": \"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\", \"items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"quantity\": 1}]}, \"products\": [{\"id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼ ー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"bd495e21-8df3-4679-9c48-54bb84027698\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}}", "module": "logger", "function": "log_mcp_request", "line": 294}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.890224Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent_mcp:8011/", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.890267Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent_mcp:8011/\", \"headers\": {\"Content-Type\": \"application/json\", \"Mcp-Session-Id\": \"52b304f5-5212-4cee-841e-77287e1a08a4\"}, \"body\": {\"jsonrpc\": \"2.0\", \"method\": \"tools/call\", \"params\": {\"name\": \"build_cart_mandates\", \"arguments\": {\"cart_plan\": {\"name\": \"シンプルプラン (3,500円)\", \"description\": \"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\", \"items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"quantity\": 1}]}, \"products\": [{\"id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"sku\": \"MUGI-KEYCHAIN-001\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"price_cents\": 80000, \"price_jpy\": 800.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"sku\": \"MUGI-CLOCK-001\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"price_cents\": 350000, \"price_jpy\": 3500.0, \"inventory_count\": 30, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"sku\": \"MUGI-POUCH-001\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"price_cents\": 95000, \"price_jpy\": 950.0, \"inventory_count\": 120, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"sku\": \"MUGI-MUG-001\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"price_cents\": 120000, \"price_jpy\": 1200.0, \"inventory_count\": 80, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"sku\": \"MUGI-SOCKS-001\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"price_cents\": 85000, \"price_jpy\": 850.0, \"inventory_count\": 100, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}, {\"id\": \"bd495e21-8df3-4679-9c48-54bb84027698\", \"sku\": \"MUGI-PLATE-001\", \"name\": \"むぎぼープレート皿\", \"description\": \"むぎぼーが中央に描かれた陶器プレート。食卓をかわいく演出。\", \"price_cents\": 190000, \"price_jpy\": 1900.0, \"inventory_count\": 70, \"category\": null, \"brand\": null, \"image_url\": null, \"refund_period_days\": 30}], \"shipping_address\": null}}, \"id\": 723403}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.896677Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (6.37ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.896758Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:46 GMT\", \"server\": \"uvicorn\", \"content-length\": \"2492\", \"content-type\": \"application/json\"}, \"body\": {\"jsonrpc\": \"2.0\", \"id\": 723403, \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_301f56a4\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_301f56a4\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 350.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4350.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:19:46.893746Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:19:46.893780Z\\\",\\n      \\\"cart_name\\\": \\\"シンプルプラン (3,500円)\\\",\\n      \\\"cart_description\\\": \\\"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}}, \"duration_ms\": 6.365776062011719}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.897636Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "MCP Response: tools/call - SUCCESS (7.45ms)", "module": "logger", "function": "log_mcp_response", "line": 317}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.897698Z", "level": "DEBUG", "logger": "v2.common.mcp_client", "message": "MCP_RESPONSE_RAW: {\"type\": \"MCP_RESPONSE\", \"tool_name\": \"tools/call\", \"result\": {\"content\": [{\"type\": \"text\", \"text\": \"{\\n  \\\"cart_mandate\\\": {\\n    \\\"contents\\\": {\\n      \\\"id\\\": \\\"cart_301f56a4\\\",\\n      \\\"user_cart_confirmation_required\\\": true,\\n      \\\"payment_request\\\": {\\n        \\\"method_data\\\": [],\\n        \\\"details\\\": {\\n          \\\"id\\\": \\\"cart_301f56a4\\\",\\n          \\\"display_items\\\": [\\n            {\\n              \\\"label\\\": \\\"むぎぼー時計\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 3500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 2592000\\n            },\\n            {\\n              \\\"label\\\": \\\"消費税（10%）\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 350.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            },\\n            {\\n              \\\"label\\\": \\\"送料\\\",\\n              \\\"amount\\\": {\\n                \\\"value\\\": 500.0,\\n                \\\"currency\\\": \\\"JPY\\\"\\n              },\\n              \\\"refund_period\\\": 0\\n            }\\n          ],\\n          \\\"total\\\": {\\n            \\\"label\\\": \\\"合計\\\",\\n            \\\"amount\\\": {\\n              \\\"value\\\": 4350.0,\\n              \\\"currency\\\": \\\"JPY\\\"\\n            }\\n          }\\n        },\\n        \\\"shipping_address\\\": null\\n      },\\n      \\\"cart_expiry\\\": \\\"2025-10-31T00:19:46.893746Z\\\",\\n      \\\"merchant_name\\\": \\\"Demo Merchant\\\"\\n    },\\n    \\\"merchant_authorization\\\": null,\\n    \\\"_metadata\\\": {\\n      \\\"intent_mandate_id\\\": null,\\n      \\\"merchant_id\\\": \\\"did:ap2:merchant:mugibo_merchant\\\",\\n      \\\"created_at\\\": \\\"2025-10-30T23:19:46.893780Z\\\",\\n      \\\"cart_name\\\": \\\"シンプルプラン (3,500円)\\\",\\n      \\\"cart_description\\\": \\\"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\\\",\\n      \\\"raw_items\\\": [\\n        {\\n          \\\"product_id\\\": \\\"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\\\",\\n          \\\"name\\\": \\\"むぎぼー時計\\\",\\n          \\\"description\\\": \\\"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\\\",\\n          \\\"quantity\\\": 1,\\n          \\\"unit_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"total_price\\\": {\\n            \\\"value\\\": 3500.0,\\n            \\\"currency\\\": \\\"JPY\\\"\\n          },\\n          \\\"image_url\\\": null\\n        }\\n      ]\\n    }\\n  }\\n}\"}], \"isError\": false}, \"error\": null, \"duration_ms\": 7.4520111083984375}", "module": "logger", "function": "log_mcp_response", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.897758Z", "level": "INFO", "logger": "v2.common.mcp_client", "message": "[MCPClient] Tool build_cart_mandates executed successfully", "module": "mcp_client", "function": "call_tool", "line": 139}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.897780Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created unsigned CartMandate: cart_301f56a4, plan=シンプルプラン (3,500円)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 94}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.897800Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Created 3 unsigned CartMandates, sending to Merchant for signature...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 116}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.898008Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Processing 3 CartMandates in parallel...", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 330}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.899346Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.899446Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_ba8fa536\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ba8fa536\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.874749Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.874948Z\", \"cart_name\": \"コスパ最強プラン (3,800円)\", \"cart_description\": \"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\", \"raw_items\": [{\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.900721Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.900884Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.901391Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant:8002/sign/cart", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:46.901452Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant:8002/sign/cart\", \"headers\": {}, \"body\": {\"cart_mandate\": {\"contents\": {\"id\": \"cart_301f56a4\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_301f56a4\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.893746Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": null, \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.893780Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant               | [2025-10-30 23:19:47,330] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_ba8fa536
ap2_merchant               | [2025-10-30 23:19:47,345] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_1e9a114c
ap2_merchant               | [2025-10-30 23:19:47,345] INFO in services.merchant.utils.validation_helpers: [Merchant] CartMandate validation passed: cart_301f56a4
ap2_merchant               | [2025-10-30 23:19:47,346] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_ba8fa536
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.347271Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.398689Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.425231Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=900bf1a0355f63db..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | [2025-10-30 23:19:47,479] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_1e9a114c
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.479659Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.480037Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.480334Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=b730ee3075b4bfc6..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.485862Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant               | [2025-10-30 23:19:47,485] INFO in services.merchant.utils.inventory_helpers: [Merchant] Inventory check passed for CartMandate: cart_301f56a4
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.486192Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.486796Z", "level": "INFO", "logger": "service", "message": "[_generate_merchant_authorization_jwt] Generated signed JWT for CartMandate: cart_id=None, cart_hash=819a2fc08462406d..., alg=ES256, kid=did:ap2:merchant:mugibo_merchant#key-1", "module": "service", "function": "_generate_merchant_authorization_jwt", "line": 887}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.519264Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_ba8fa536", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.519843Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_ba8fa536 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant               | INFO:     172.18.0.8:49378 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.525972Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (626.55ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.526186Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:46 GMT\", \"server\": \"uvicorn\", \"content-length\": \"4601\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_ba8fa536\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ba8fa536\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.874749Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiI1M2E0ODc1YS05ZWFjLTQzNDEtOTVkZS04N2ZiMGM0NWMxYWIiLCJjYXJ0X2hhc2giOiI5MDBiZjFhMDM1NWY2M2RiZTcxZjliMDYxMDIyNTBkMzg1MWY5OTFlZjYxODQzOTAyNjBiM2VlOTFiNTcyYTg3In0.MEUCIQDWt-0uKWIKlsM05HOBYwg_X5m5iMxVn9oIak_d655rqQIgUZrwG8YOPGaWPaSXTc37xMcEax-iDDnRLOAWlor6eJs\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.874948Z\", \"cart_name\": \"コスパ最強プラン (3,800円)\", \"cart_description\": \"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\", \"raw_items\": [{\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"name\": \"むぎぼー ポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xT2c7XVAz1R8xlSlRDlNOr15oZCaTazzUkELaJwgpTS+sRmHoLk2cbOP9Ice1UzxwtBY6OLCR2dNFlfqVwNUCQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.395344Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xT2c7XVAz1R8xlSlRDlNOr15oZCaTazzUkELaJwgpTS+sRmHoLk2cbOP9Ice1UzxwtBY6OLCR2dNFlfqVwNUCQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.395344Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiI1M2E0ODc1YS05ZWFjLTQzNDEtOTVkZS04N2ZiMGM0NWMxYWIiLCJjYXJ0X2hhc2giOiI5MDBiZjFhMDM1NWY2M2RiZTcxZjliMDYxMDIyNTBkMzg1MWY5OTFlZjYxODQzOTAyNjBiM2VlOTFiNTcyYTg3In0.MEUCIQDWt-0uKWIKlsM05HOBYwg_X5m5iMxVn9oIak_d655rqQIgUZrwG8YOPGaWPaSXTc37xMcEax-iDDnRLOAWlor6eJs\"}, \"duration_ms\": 626.5487670898438}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.526519Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_ba8fa536, plan=コスパ最強プラン (3,800円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.527021Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: コス パ最強プラン (3,800円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}


ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.531425Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_1e9a114c", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.533185Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (632.42ms)", "module": "logger", "function": "log_http_response", "line": 215}


ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.531888Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_1e9a114c (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.533439Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:46 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3744\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \" 時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\"}, \"duration_ms\": 632.4210166931152}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.537298Z", "level": "INFO", "logger": "service", "message": "[Merchant] Created new CartMandate: cart_301f56a4", "module": "service", "function": "sign_cart_mandate", "line": 221}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.533858Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_1e9a114c, plan=高品質プラン (4,300円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.533895Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: 高品 質プラン (4,300円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.538792Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (637.35ms)", "module": "logger", "function": "log_http_response", "line": 215}


ap2_merchant               | {"timestamp": "2025-10-30T23:19:47.537615Z", "level": "INFO", "logger": "service", "message": "[Merchant] Auto-signed CartMandate: cart_301f56a4 (with merchant_authorization JWT)", "module": "service", "function": "sign_cart_mandate", "line": 223}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.538935Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:46 GMT\", \"server\": \"uvicorn\", \"content-length\": \"3240\", \"content-type\": \"application/json\"}, \"body\": {\"signed_cart_mandate\": {\"contents\": {\"id\": \"cart_301f56a4\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_301f56a4\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.893746Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiJmM2VhYmVlMC0xMTc0LTRhZGQtYWI1OS1iOGIwZWVkYTJmNDUiLCJjYXJ0X2hhc2giOiI4MTlhMmZjMDg0NjI0MDZkY2M3ZGM0ZjdiMDA3ODA4NDA4ZTc2MmZiZTc2Njk2ZDMzOThkOGRlZGIzNTk1MDIxIn0.MEUCIAoEliAY__ZeEDy6KXoyzBZRuq6OXLPZexxfhclrOtEPAiEA5uAJ4tjEzbOE0Wt_cobB-sYY8EANxJn0aV8bD-8FMsY\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.893780Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"VcC0FsaEYdpsUHG3nQwWuvWjcBEHkm8hb6cfWQvFbUifIV64R6ja0WesnBYN0OryE9vY6Vk6MZVHy3K6wzZwCw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.486151Z\", \"key_id\": \"merchant\"}}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"VcC0FsaEYdpsUHG3nQwWuvWjcBEHkm8hb6cfWQvFbUifIV64R6ja0WesnBYN0OryE9vY6Vk6MZVHy3K6wzZwCw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.486151Z\", \"key_id\": \"merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiJmM2VhYmVlMC0xMTc0LTRhZGQtYWI1OS1iOGIwZWVkYTJmNDUiLCJjYXJ0X2hhc2giOiI4MTlhMmZjMDg0NjI0MDZkY2M3ZGM0ZjdiMDA3ODA4NDA4ZTc2MmZiZTc2Njk2ZDMzOThkOGRlZGIzNTk1MDIxIn0.MEUCIAoEliAY__ZeEDy6KXoyzBZRuq6OXLPZexxfhclrOtEPAiEA5uAJ4tjEzbOE0Wt_cobB-sYY8EANxJn0aV8bD-8FMsY\"}, \"duration_ms\": 637.345552444458}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant               | INFO:     172.18.0.8:49392 - "POST /sign/cart HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.539144Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] CartMandate auto-signed: cart_301f56a4, plan=シンプルプラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 173}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.539184Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built signed CartMandate for plan: シン プルプラン (3,500円)", "module": "cart_mandate_node", "function": "process_single_cart_mandate", "line": 306}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.539482Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Parallel processing complete: 3 signed, 0 pending, 0 timeout, 0 rejected", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 353}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.539510Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.cart_mandate_node", "message": "[build_cart_mandates] Built 3 signed CartMandates (pending: 0, timeout: 0)", "module": "cart_mandate_node", "function": "build_cart_mandates", "line": 373}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.543069Z", "level": "INFO", "logger": "v2.services.merchant_agent.nodes.ranking_node", "message": "[rank_and_select] Selected top 3 carts", "module": "ranking_node", "function": "rank_and_select", "line": 31}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.546543Z", "level": "INFO", "logger": "langgraph_merchant", "message": "[create_cart_candidates] 3 carts ready (pre-signed via MCP)", "module": "langgraph_merchant", "function": "create_cart_candidates", "line": 313}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.546824Z", "level": "INFO", "logger": "handlers.intent_handler", "message": "[MerchantAgent] Generated 3 cart candidates", "module": "intent_handler", "function": "handle_intent_mandate", "line": 102}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.547233Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.IntentMandate, result_type=ap2.responses.CartCandidates", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.548959Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.550189Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 8309, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.CartCandidates\",\"id\":\"ca55bb90-e1b2-4c39-bd7c-706ec2d8bd4f\",\"payload\":{\"cart_candidates\":[{\"artifactId\":\"artifact_66f10def\",\"name\":\"コスパ最強プラン (3,800円)\",\"parts\":[{\"da", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.550314Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.561769Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.562275Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:shopping_agent: ap2.responses.CartCandidates", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | [2025-10-30 23:19:47,562] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.CartCandidates, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:47.562456Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.CartCandidates\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"06c8a793-2042-444c-a2ec-9f66996be208\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:19:47.547969Z\", \"nonce\": \"2c837756d938bcf6f3b3cc663b4ca46f0097dc730d182782025c8b203d09a269\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"intent_mandate_id\": \"intent_556a9bb4\", \"cart_candidates\": [{\"artifactId\": \"artifact_66f10def\", \"name\": \"コスパ最強プラン (3,800円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_ba8fa536\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ba8fa536\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.874749Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiI1M2E0ODc1YS05ZWFjLTQzNDEtOTVkZS04N2ZiMGM0NWMxYWIiLCJjYXJ0X2hhc2giOiI5MDBiZjFhMDM1NWY2M2RiZTcxZjliMDYxMDIyNTBkMzg1MWY5OTFlZjYxODQzOTAyNjBiM2VlOTFiNTcyYTg3In0.MEUCIQDWt-0uKWIKlsM05HOBYwg_X5m5iMxVn9oIak_d655rqQIgUZrwG8YOPGaWPaSXTc37xMcEax-iDDnRLOAWlor6eJs\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.874948Z\", \"cart_name\": \"コスパ最強プラン (3,800円)\", \"cart_description\": \"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\", \"raw_items\": [{\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のテ ィータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい 履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xT2c7XVAz1R8xlSlRDlNOr15oZCaTazzUkELaJwgpTS+sRmHoLk2cbOP9Ice1UzxwtBY6OLCR2dNFlfqVwNUCQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.395344Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_a3e657fa\", \"name\": \"高品質プラン (4,300円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_b8d60d30\", \"name\": \"シンプルプラン (3,500円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_301f56a4\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_301f56a4\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.893746Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiJmM2VhYmVlMC0xMTc0LTRhZGQtYWI1OS1iOGIwZWVkYTJmNDUiLCJjYXJ0X2hhc2giOiI4MTlhMmZjMDg0NjI0MDZkY2M3ZGM0ZjdiMDA3ODA4NDA4ZTc2MmZiZTc2Njk2ZDMzOThkOGRlZGIzNTk1MDIxIn0.MEUCIAoEliAY__ZeEDy6KXoyzBZRuq6OXLPZexxfhclrOtEPAiEA5uAJ4tjEzbOE0Wt_cobB-sYY8EANxJn0aV8bD-8FMsY\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.893780Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"VcC0FsaEYdpsUHG3nQwWuvWjcBEHkm8hb6cfWQvFbUifIV64R6ja0WesnBYN0OryE9vY6Vk6MZVHy3K6wzZwCw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.486151Z\", \"key_id\": \"merchant\"}}}}]}], \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"merchant_name\": \"むぎぼーショップ\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | INFO:     172.18.0.3:35396 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:47.600815Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (155885.00ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:47.601865Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:17:11 GMT\", \"server\": \"uvicorn\", \"content-length\": \"10026\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"06c8a793-2042-444c-a2ec-9f66996be208\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:19:47.547969Z\", \"nonce\": \"2c837756d938bcf6f3b3cc663b4ca46f0097dc730d182782025c8b203d09a269\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"A2UvNg/hbLJ6I4dpi2vZSUIODvTlx9pU4UYtDUpgSoGS0JXsvo9xaT+N0Wl6DjTUAFcAPI2eKwERBID1LY9mDw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQXpLdWVDRWNyRmhCUzBaeWIzK0dwYkh2VHZYTEhGVmhWY3EvRGc2MmlGM0k9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T23:19:47.547969Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.CartCandidates\", \"id\": \"ca55bb90-e1b2-4c39-bd7c-706ec2d8bd4f\", \"payload\": {\"intent_mandate_id\": \"intent_556a9bb4\", \"cart_candidates\": [{\"artifactId\": \"artifact_66f10def\", \"name\": \"コスパ最強プラン (3,800円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_ba8fa536\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_ba8fa536\", \"display_items\": [{\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーマグカップ\", \"amount\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーポーチ\", \"amount\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼー靴下\", \"amount\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 380.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4680.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.874749Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiI1M2E0ODc1YS05ZWFjLTQzNDEtOTVkZS04N2ZiMGM0NWMxYWIiLCJjYXJ0X2hhc2giOiI5MDBiZjFhMDM1NWY2M2RiZTcxZjliMDYxMDIyNTBkMzg1MWY5OTFlZjYxODQzOTAyNjBiM2VlOTFiNTcyYTg3In0.MEUCIQDWt-0uKWIKlsM05HOBYwg_X5m5iMxVn9oIak_d655rqQIgUZrwG8YOPGaWPaSXTc37xMcEax-iDDnRLOAWlor6eJs\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.874948Z\", \"cart_name\": \"コスパ最強プラン (3,800円)\", \"cart_description\": \"かわいいキーホルダーとマグカップを含む、予算内で最も多くの商品を手に入れられるプランです。\", \"raw_items\": [{\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"か わいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"3a4207bb-3f3b-4760-b9db-54804cac3a87\", \"name\": \"むぎぼーマグカップ\", \"description\": \"むぎぼーがプリントされたかわいいマグカップ。毎日のティータイムが楽しくなります。\", \"quantity\": 1, \"unit_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 1200.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"8583b100-e48e-4726-ac1f-a967551e5fd2\", \"name\": \"むぎぼーポーチ\", \"description\": \"むぎぼー柄のかわいいポーチ。小物入れやペンケースとして使えます。\", \"quantity\": 1, \"unit_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 950.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"53b5de5f-ad48-4a05-a6f5-39cd26f8c800\", \"name\": \"むぎぼー靴下\", \"description\": \"むぎぼーがワンポイントで入ったかわいい靴下。やわらかい履き心地。\", \"quantity\": 1, \"unit_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 850.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"xT2c7XVAz1R8xlSlRDlNOr15oZCaTazzUkELaJwgpTS+sRmHoLk2cbOP9Ice1UzxwtBY6OLCR2dNFlfqVwNUCQ==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.395344Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_a3e657fa\", \"name\": \"高品質プラン (4,300円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー 。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}}]}, {\"artifactId\": \"artifact_b8d60d30\", \"name\": \"シンプルプラン (3,500円)\", \"parts\": [{\"kind\": \"data\", \"data\": {\"ap2.mandates.CartMandate\": {\"contents\": {\"id\": \"cart_301f56a4\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_301f56a4\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 350.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 4350.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.893746Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiJmM2VhYmVlMC0xMTc0LTRhZGQtYWI1OS1iOGIwZWVkYTJmNDUiLCJjYXJ0X2hhc2giOiI4MTlhMmZjMDg0NjI0MDZkY2M3ZGM0ZjdiMDA3ODA4NDA4ZTc2MmZiZTc2Njk2ZDMzOThkOGRlZGIzNTk1MDIxIn0.MEUCIAoEliAY__ZeEDy6KXoyzBZRuq6OXLPZexxfhclrOtEPAiEA5uAJ4tjEzbOE0Wt_cobB-sYY8EANxJn0aV8bD-8FMsY\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.893780Z\", \"cart_name\": \"シンプルプラン (3,500円)\", \"cart_description\": \"かわいい時計1点のみのシンプルなプラン。予算内で最大の価値を提供する高品質な商品を選びました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"VcC0FsaEYdpsUHG3nQwWuvWjcBEHkm8hb6cfWQvFbUifIV64R6ja0WesnBYN0OryE9vY6Vk6MZVHy3K6wzZwCw==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.486151Z\", \"key_id\": \"merchant\"}}}}]}], \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"merchant_name\": \"むぎぼーショップ\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 155884.99784469604}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:19:47,613] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_shopping_agent         |   Response Body: {
ap2_shopping_agent         |   "header": {
ap2_shopping_agent         |     "message_id": "06c8a793-2042-444c-a2ec-9f66996be208",
ap2_shopping_agent         |     "sender": "did:ap2:agent:merchant_agent",
ap2_shopping_agent         |     "recipient": "did:ap2:agent:shopping_agent",
ap2_shopping_agent         |     "timestamp": "2025-10-30T23:19:47.547969Z",
ap2_shopping_agent         |     "nonce": "2c837756d938bcf6f3b3cc663b4ca46f0097dc730d182782025c8b203d09a269",
ap2_shopping_agent         |     "schema_version": "0.2",
ap2_shopping_agent         |     "proof": {
ap2_shopping_agent         |       "algorithm": "ed25519",
ap2_shopping_agent         |       "signatureValue": "A2UvNg/hbLJ6I4dpi2vZSUIODvTlx9pU4UYtDUpgSoGS0JXsvo9xaT+N0Wl6DjTUAFcAPI2eKwERBID1LY9mDw==",
ap2_shopping_agent         |       "publicKey": "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQXpLdWVDRWNyRmhCUzBaeWIzK0dwYkh2VHZYTEhGVmhWY3EvRGc2MmlGM0k9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=",
ap2_shopping_agent         |       "kid": "did:ap2:agent:merchant_agent#key-2",
ap2_shopping_agent         |       "created": "2025-10-30T23:19:47.547969Z",
ap2_shopping_agent         |       "proofPurpose": "authentication"
ap2_shopping_agent         |     },
ap2_shopping_agent         |     "signature": null
ap2_shopping_agent         |   },
ap2_shopping_agent         |   "dataPart": {
ap2_shopping_agent         |     "@type": "ap2.responses.CartCandidates",
ap2_shopping_agent         |     "id": "ca55bb90-e1b2-4c39-bd7c-706ec2d8bd4f",
ap2_shopping_agent         |     "payload": {
ap2_shopping_agent         |       "intent_mandate_id": "intent_55...
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-30 23:19:47,614] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Received 3 cart candidates from Merchant Agent
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:48.360030Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:48.366937Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=cart_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.343982Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.345630Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: cart_1e9a114c\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.351984Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=cart_selection", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.352412Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.352652Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:19:51,371] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: cart_selection
ap2_shopping_agent         |   user_input: cart_1e9a114c
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.381636Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.388494Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: merchant) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.439792Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:51.447529Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "OPTIONS /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.079607Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.081045Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.081412Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] Received CartMandate signature: cart_id=None, session_id=session_1761866127723_ypdx0n", "module": "agent", "function": "submit_cart_signature", "line": 1275}
ap2_shopping_agent         | [2025-10-30 23:19:54,081] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying CartMandate WebAuthn signature: user_id=usr_5e05dfe96b254548
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.082182Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/verify/attestation", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.082315Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/verify/attestation\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキ ーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}, \"attestation\": {\"id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"rawId\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2lZMkZ5ZEY4eFpUbGhNVEUwWXlJc0luUnBiV1Z6ZEdGdGNDSTZNVGMyTVRnMk5qTTVNalV4TkgwIiwib3JpZ2luIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwIiwiY3Jvc3NPcmlnaW4iOmZhbHNlfQ\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEUCICgGQBu3tMv57PyeAOrD1C9SGvSpwMPUD8zP-E7VKDQGAiEA7JlWcI2pIhn2y0OouDNdMBthCr8h6jbbxz90W_7qfXk\", \"userHandle\": \"usr_5e05dfe96b254548\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoiY2FydF8xZTlhMTE0YyIsInRpbWVzdGFtcCI6MTc2MTg2NjM5MjUxNH0\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.161135Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: p2duhMkSHYBUfJeQ...", "module": "provider", "function": "verify_attestation", "line": 519}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.161354Z", "level": "INFO", "logger": "provider", "message": "  User: usr_5e05dfe96b254548", "module": "provider", "function": "verify_attestation", "line": 520}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.161380Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 521}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.163007Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.165063Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.165114Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.165128Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.165139Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.166855Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.166903Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.168972Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.235924Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.244216Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 539}
ap2_credential_provider    | [2025-10-30 23:19:54,245] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: None
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:54.245763Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] No payment_method.token in mandate (likely IntentMandate signature), skipping Payment Network call", "module": "provider", "function": "verify_attestation", "line": 567}
ap2_credential_provider    | [2025-10-30 23:19:54,279] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=unknown, verified=True, agent_token=None...
ap2_credential_provider    | INFO:     172.18.0.3:50518 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.299553Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (216.70ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.299796Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:53 GMT\", \"server\": \"uvicorn\", \"content-length\": \"191\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"token\": \"cred_token_1fc40a23_DMliYn9WgY6B5yFRhb_dmae2\", \"details\": {\"attestation_type\": \"passkey\", \"timestamp\": \"2025-10-30T23:19:54.279261+00:00\", \"counter\": 0, \"agent_token\": null}}, \"duration_ms\": 216.69745445251465}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:19:54,299] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Sent WebAuthn verification request to Credential Provider: user_id=usr_5e05dfe96b254548
ap2_shopping_agent         | [2025-10-30 23:19:54,300] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ WebAuthn signature verified successfully: counter=0, attestation_type=passkey
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.312358Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=cart_signature_pending", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.312626Z", "level": "INFO", "logger": "agent", "message": "[submit_cart_signature] CartMandate signed by user: cart_id=None, webauthn_assertion saved", "module": "agent", "function": "submit_cart_signature", "line": 1315}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "POST /cart/submit-signature HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.322093Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.322402Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: _cart_signature_completed\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.323747Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=cart_signature_pending", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.324051Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:54.324105Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:19:54,336] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: cart_signature_pending
ap2_shopping_agent         |   user_input: _cart_signature_completed
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:19:54,549] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 13-14: Presenting payment methods to user
ap2_shopping_agent         |   Available Methods: 1
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:55.144089Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:55.148283Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=payment_method_selection", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.336405Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.336679Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: 1\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.346176Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=payment_method_selection", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.346992Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.347068Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:19:56,358] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: payment_method_selection
ap2_shopping_agent         |   user_input: 1
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:19:56,362] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 15-18: Tokenizing payment method
ap2_shopping_agent         |   User ID: usr_5e05dfe96b254548
ap2_shopping_agent         |   Payment Method ID: pm_0f73d52d
ap2_shopping_agent         |   CP URL: http://credential_provider:8003
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.363101Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Requesting payment method tokenization for: pm_0f73d52d", "module": "agent", "function": "_tokenize_payment_method", "line": 2352}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.363213Z", "level": "INFO", "logger": "agent", "message": "\n================================================================================\n[ShoppingAgent → CredentialProvider] トークン化リクエスト送信\n  URL: http://credential_provider:8003/payment-methods/tokenize\n  User ID: usr_5e05dfe96b254548\n  Payment Method ID: pm_0f73d52d\n================================================================================", "module": "agent", "function": "_tokenize_payment_method", "line": 2356}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.363303Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/payment-methods/tokenize", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.363347Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/payment-methods/tokenize\", \"headers\": {}, \"body\": {\"user_id\": \"usr_5e05dfe96b254548\", \"payment_method_id\": \"pm_0f73d52d\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:56.378128Z", "level": "INFO", "logger": "provider", "message": "[tokenize_payment_method] Generated secure token for payment method: pm_0f73d52d", "module": "provider", "function": "tokenize_payment_method", "line": 760}
ap2_credential_provider    | INFO:     172.18.0.3:50518 - "POST /payment-methods/tokenize HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.379678Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (16.35ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.379724Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"217\", \"content-type\": \"application/json\"}, \"body\": {\"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"payment_method_id\": \"pm_0f73d52d\", \"brand\": \"Visa\", \"last4\": \"1111\", \"type\": \"basic-card\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\", \"expires_at\": \"2025-10-30T23:34:56.372586Z\"}, \"duration_ms\": 16.34693145751953}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.379771Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent ← CredentialProvider] トークン化レスポンス受信: status=200", "module": "agent", "function": "_tokenize_payment_method", "line": 2376}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.379787Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Payment method tokenized: pm_0f73d52d → tok_83fee8bb_uvvXxuA...", "module": "agent", "function": "_tokenize_payment_method", "line": 2386}
ap2_shopping_agent         | [2025-10-30 23:19:56,379] INFO in services.shopping_agent.langgraph_shopping_flow: [select_payment_method_node] AP2 Step 17-18: Received tokenized payment method
ap2_shopping_agent         |   Token: tok_83fee8bb_uvvXxuA...
ap2_shopping_agent         | [2025-10-30 23:19:56,380] INFO in services.shopping_agent.utils.payment_helpers: [_extract_payment_amount_from_cart] CartMandate structure: has_contents=True, has_payment_request=True, has_details=True, has_total=True, total_amount={'value': 5230.0, 'currency': 'JPY'}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.380930Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/passkey/get-public-key", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.380964Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/passkey/get-public-key\", \"headers\": {}, \"body\": {\"credential_id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"user_id\": \"usr_5e05dfe96b254548\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_shopping_agent         | [2025-10-30 23:19:56,380] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Retrieving public key from Credential Provider: credential_id=p2duhMkSHYBUfJeQ..., user_id=usr_5e05dfe96b254548
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:56.386667Z", "level": "INFO", "logger": "provider", "message": "[get_passkey_public_key] Public key retrieved: credential_id=p2duhMkSHYBUfJeQ..., user_id=usr_5e05dfe96b254548", "module": "provider", "function": "get_passkey_public_key", "line": 1484}
ap2_credential_provider    | INFO:     172.18.0.3:50518 - "POST /passkey/get-public-key HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.388294Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (7.31ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.388341Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:55 GMT\", \"server\": \"uvicorn\", \"content-length\": \"261\", \"content-type\": \"application/json\"}, \"body\": {\"credential_id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"public_key_cose\": \"pQECAyYgASFYIBtqA+qqj/op2DosnQFOR9Qf1vSZKMvdvJbQxrUAZOzdIlgg4wN2ZwhPbRZSur4Cv09oI+AUiFm4GPVwXKo423Ae4Tk=\", \"user_id\": \"usr_5e05dfe96b254548\"}, \"duration_ms\": 7.310390472412109}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:19:56,388] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ Public key retrieved: credential_id=p2duhMkSHYBUfJeQ...
ap2_shopping_agent         | [2025-10-30 23:19:56,389] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-30 23:19:56,390] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: b730ee3075b4bfc6...
ap2_shopping_agent         | [2025-10-30 23:19:56,390] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: 8dcb334a4ccf2716...
ap2_shopping_agent         | [2025-10-30 23:19:56,394] INFO in v2.common.user_authorization: [create_user_authorization_vp] Restored public key from COSE format (DB)
ap2_shopping_agent         | [2025-10-30 23:19:56,395] INFO in v2.common.user_authorization: [create_user_authorization_vp] cnf claim with JWK added to Issuer JWT
ap2_shopping_agent         | [2025-10-30 23:19:56,395] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2558, cart_hash=b730ee3075b4bfc6..., payment_hash=8dcb334a4ccf2716...
ap2_shopping_agent         | [2025-10-30 23:19:56,396] INFO in services.shopping_agent.utils.payment_helpers: [_generate_user_authorization_for_payment] Generated user_authorization VP: length=2558
ap2_shopping_agent         | [2025-10-30 23:19:56,396] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] transaction_type=human_not_present (no strong authentication detected)
ap2_shopping_agent         | [2025-10-30 23:19:56,397] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Performing risk assessment...
ap2_shopping_agent         | [2025-10-30 23:19:56,398] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Invalid amount value: 5230.0
ap2_shopping_agent         | [2025-10-30 23:19:56,399] WARNING in v2.common.risk_assessment: [RiskAssessmentEngine] Failed to parse amounts for constraint check
ap2_shopping_agent         | [2025-10-30 23:19:56,400] INFO in v2.common.risk_assessment: [RiskAssessmentEngine] Assessment completed: risk_score=3, recommendation=approve, fraud_indicators=['card_not_present_transaction']
ap2_shopping_agent         | [2025-10-30 23:19:56,401] INFO in services.shopping_agent.utils.payment_helpers: [ShoppingAgent] Risk assessment completed: score=3, recommendation=approve, indicators=['card_not_present_transaction']
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.401741Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created with user_authorization: has_user_auth=True", "module": "agent", "function": "_create_payment_mandate", "line": 2121}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.402038Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] PaymentMandate created: amount=5230.0 JPY, payment_method=Visa ****1111, token=tok_83fee8bb_uvvXxuA..., risk_score=3", "module": "agent", "function": "_create_payment_mandate", "line": 2126}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.436980Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:56.442622Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "OPTIONS /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.297036Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.300865Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Verifying attestation for PaymentMandate: payment_3fd665a4", "module": "agent", "function": "submit_payment_attestation", "line": 1427}
ap2_shopping_agent         | [2025-10-30 23:19:59,301] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Verifying PaymentMandate attestation: payment_id=payment_3fd665a4
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.301748Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/verify/attestation", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.302051Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/verify/attestation\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9UWXNJbVY0Y0NJNk1UYzJNVGcyTmpZNU5pd2libUptSWpveE56WXhPRFkyTXprMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpyVGpOVGRtWmtOazEwVjNaNllqbFphMDluTkZoQmVtWkhRWGROV0hjM1JGQk5kWGR0VmxSdFZHZFpJaXdpYVdGMElqb3hOell4T0RZMk16azJMQ0p6WkY5b1lYTm9Jam9pTlRaaFltRXpZekJoTjJNNFlUVTJNalU1TkRNNU5tSXlPV1JrTURrNE16azJaRGcwTXpRek5HTmlZVFpoT1RCbFpqa3pZelUyWmpRNE5UWXlOREptWXlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpoa1kySXpNelJoTkdOalpqSTNNVFl6TXpsaE1HVmtPR05qWTJWaU1XTTBZV00zWkdVelpUWTVPREUwTUdReE1qRm1OVFl3Tm1FME5UQmtOVFpqWkdZaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsWk1rWjVaRVk0ZUZwVWJHaE5WRVV3V1hsSmMwbHVVbkJpVjFaNlpFZEdkR05EU1RaTlZHTXlUVlJuTWs1cVRUVk5hbFY0VGtnd0lpd2liM0pwWjJsdUlqb2lhSFIwY0RvdkwyeHZZMkZzYUc5emREb3pNREF3SWl3aVkzSnZjM05QY21sbmFXNGlPbVpoYkhObGZRIiwiYXV0aGVudGljYXRvckRhdGEiOiJTWllONVlnT2pHaDBOQmNQWkhaZ1c0X2tycm1paGpMSG1Wenp1b01kbDJNZEFBQUFBQSIsInNpZ25hdHVyZSI6Ik1FVUNJQ2dHUUJ1M3RNdjU3UHllQU9yRDFDOVNHdlNwd01QVUQ4elAtRTdWS0RRR0FpRUE3SmxXY0kycElobjJ5ME9vdUROZE1CdGhDcjhoNmpiYnh6OTBXXzdxZlhrIiwidXNlckhhbmRsZSI6InVzcl81ZTA1ZGZlOTZiMjU0NTQ4In0sInR5cGUiOiJwdWJsaWMta2V5IiwiYXR0ZXN0YXRpb25fdHlwZSI6InBhc3NrZXkiLCJjaGFsbGVuZ2UiOiJleUp0WVc1a1lYUmxYMmxrSWpvaVkyRnlkRjh4WlRsaE1URTBZeUlzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU1qVXhOSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjhkY2IzMzRhNGNjZjI3MTYzMzlhMGVkOGNjY2ViMWM0YWM3ZGUzZTY5ODE0MGQxMjFmNTYwNmE0NTBkNTZjZGYifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"attestation\": {\"id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"rawId\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHpabVEyTmpWaE5DSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOak01TnpVNE1IMCIsIm9yaWdpbiI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImNyb3NzT3JpZ2luIjpmYWxzZX0\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEUCIQDUnOVVC11pYkm0lRuTY4PjhJYk-YsVrfnmLPJtgNE3BgIgBHEl1NwowPzVJToudTWYq5KvGUHHBXZDO5XE77Uy8-g\", \"userHandle\": \"usr_5e05dfe96b254548\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoicGF5bWVudF8zZmQ2NjVhNCIsInRpbWVzdGFtcCI6MTc2MTg2NjM5NzU4MH0\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350179Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Found passkey: p2duhMkSHYBUfJeQ...", "module": "provider", "function": "verify_attestation", "line": 519}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350418Z", "level": "INFO", "logger": "provider", "message": "  User: usr_5e05dfe96b254548", "module": "provider", "function": "verify_attestation", "line": 520}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350450Z", "level": "INFO", "logger": "provider", "message": "  Counter: 0", "module": "provider", "function": "verify_attestation", "line": 521}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350673Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Verifying WebAuthn authentication result", "module": "crypto", "function": "verify_webauthn_signature", "line": 1204}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350879Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Client Data Type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1225}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350906Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Origin: http://localhost:3000", "module": "crypto", "function": "verify_webauthn_signature", "line": 1226}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350924Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Challenge matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1238}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.350940Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "Authentication type: webauthn.get", "module": "crypto", "function": "verify_webauthn_signature", "line": 1245}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.351071Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "AuthenticatorData parsed: counter=0", "module": "crypto", "function": "verify_webauthn_signature", "line": 1258}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.351225Z", "level": "INFO", "logger": "v2.common.crypto", "message": "Signature counter: 0 (AP2 compliant: replay attacks prevented by user_authorization nonce)", "module": "crypto", "function": "verify_webauthn_signature", "line": 1264}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.351772Z", "level": "DEBUG", "logger": "v2.common.crypto", "message": "RP ID Hash matched", "module": "crypto", "function": "verify_webauthn_signature", "line": 1277}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.354399Z", "level": "INFO", "logger": "v2.common.crypto", "message": "WebAuthn signature verified successfully", "module": "crypto", "function": "verify_webauthn_signature", "line": 1329}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.360363Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] Signature counter: 0 → 0 (AP2準拠: Authenticatorがcounterを実装していない場合でも、user_authorizationのnonceによりリプレイ攻撃は防止されます)", "module": "provider", "function": "verify_attestation", "line": 539}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.361510Z", "level": "INFO", "logger": "provider", "message": "[verify_attestation] PaymentMandate contains payment_method.token, calling Payment Network (Step 23)", "module": "provider", "function": "verify_attestation", "line": 558}
ap2_credential_provider    | [2025-10-30 23:19:59,361] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Generated attestation token for user: usr_5e05dfe96b254548
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.361602Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Requesting Agent Token from Payment Network: payment_mandate_id=payment_3fd665a4", "module": "provider", "function": "_request_agent_token_from_network", "line": 1795}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.362049Z", "level": "INFO", "logger": "provider", "message": "HTTP Request: POST http://payment_network:8005/network/tokenize", "module": "logger", "function": "log_http_request", "line": 182}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.362309Z", "level": "DEBUG", "logger": "provider", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://payment_network:8005/network/tokenize\", \"headers\": {}, \"body\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9UWXNJbVY0Y0NJNk1UYzJNVGcyTmpZNU5pd2libUptSWpveE56WXhPRFkyTXprMkxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUpyVGpOVGRtWmtOazEwVjNaNllqbFphMDluTkZoQmVtWkhRWGROV0hjM1JGQk5kWGR0VmxSdFZHZFpJaXdpYVdGMElqb3hOell4T0RZMk16azJMQ0p6WkY5b1lYTm9Jam9pTlRaaFltRXpZekJoTjJNNFlUVTJNalU1TkRNNU5tSXlPV1JrTURrNE16azJaRGcwTXpRek5HTmlZVFpoT1RCbFpqa3pZelUyWmpRNE5UWXlOREptWXlJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpoa1kySXpNelJoTkdOalpqSTNNVFl6TXpsaE1HVmtPR05qWTJWaU1XTTBZV00zWkdVelpUWTVPREUwTUdReE1qRm1OVFl3Tm1FME5UQmtOVFpqWkdZaVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsWk1rWjVaRVk0ZUZwVWJHaE5WRVV3V1hsSmMwbHVVbkJpVjFaNlpFZEdkR05EU1RaTlZHTXlUVlJuTWs1cVRUVk5hbFY0VGtnd0lpd2liM0pwWjJsdUlqb2lhSFIwY0RvdkwyeHZZMkZzYUc5emREb3pNREF3SWl3aVkzSnZjM05QY21sbmFXNGlPbVpoYkhObGZRIiwiYXV0aGVudGljYXRvckRhdGEiOiJTWllONVlnT2pHaDBOQmNQWkhaZ1c0X2tycm1paGpMSG1Wenp1b01kbDJNZEFBQUFBQSIsInNpZ25hdHVyZSI6Ik1FVUNJQ2dHUUJ1M3RNdjU3UHllQU9yRDFDOVNHdlNwd01QVUQ4elAtRTdWS0RRR0FpRUE3SmxXY0kycElobjJ5ME9vdUROZE1CdGhDcjhoNmpiYnh6OTBXXzdxZlhrIiwidXNlckhhbmRsZSI6InVzcl81ZTA1ZGZlOTZiMjU0NTQ4In0sInR5cGUiOiJwdWJsaWMta2V5IiwiYXR0ZXN0YXRpb25fdHlwZSI6InBhc3NrZXkiLCJjaGFsbGVuZ2UiOiJleUp0WVc1a1lYUmxYMmxrSWpvaVkyRnlkRjh4WlRsaE1URTBZeUlzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU1qVXhOSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjhkY2IzMzRhNGNjZjI3MTYzMzlhMGVkOGNjY2ViMWM0YWM3ZGUzZTY5ODE0MGQxMjFmNTYwNmE0NTBkNTZjZGYifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"attestation\": {\"id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"rawId\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"response\": {\"clientDataJSON\": \"eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZXlKdFlXNWtZWFJsWDJsa0lqb2ljR0Y1YldWdWRGOHpabVEyTmpWaE5DSXNJblJwYldWemRHRnRjQ0k2TVRjMk1UZzJOak01TnpVNE1IMCIsIm9yaWdpbiI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImNyb3NzT3JpZ2luIjpmYWxzZX0\", \"authenticatorData\": \"SZYN5YgOjGh0NBcPZHZgW4_krrmihjLHmVzzuoMdl2MdAAAAAA\", \"signature\": \"MEUCIQDUnOVVC11pYkm0lRuTY4PjhJYk-YsVrfnmLPJtgNE3BgIgBHEl1NwowPzVJToudTWYq5KvGUHHBXZDO5XE77Uy8-g\", \"userHandle\": \"usr_5e05dfe96b254548\"}, \"type\": \"public-key\", \"attestation_type\": \"passkey\", \"challenge\": \"eyJtYW5kYXRlX2lkIjoicGF5bWVudF8zZmQ2NjVhNCIsInRpbWVzdGFtcCI6MTc2MTg2NjM5NzU4MH0\"}, \"payment_method_token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"transaction_context\": {\"credential_provider_id\": \"did:ap2:agent:credential_provider\", \"timestamp\": \"2025-10-30T23:19:59.361635+00:00\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_network        | [2025-10-30 23:19:59,531] INFO in network: [DemoPaymentNetwork] Received tokenization request: payment_mandate_id=payment_3fd665a4, payment_method_token=tok_83fee8bb_uvvXxuA...
ap2_payment_network        | [2025-10-30 23:19:59,558] INFO in common.redis_client: [RedisClient] Connected to Redis: redis://redis:6379/2
ap2_payment_network        | [2025-10-30 23:19:59,591] INFO in services.payment_network.utils.token_helpers: [DemoPaymentNetwork] Issued Agent Token (Redis): agent_tok_demopaymentnetwork_781..., expires_at=2025-10-31T00:19:59.541002+00:00, ttl=3600s
ap2_payment_network        | INFO:     172.18.0.13:49958 - "POST /network/tokenize HTTP/1.1" 200 OK
ap2_credential_provider    | [2025-10-30 23:19:59,602] INFO in httpx: HTTP Request: POST http://payment_network:8005/network/tokenize "HTTP/1.1 200 OK"
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.604801Z", "level": "INFO", "logger": "provider", "message": "HTTP Response: 200 (242.91ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.604867Z", "level": "DEBUG", "logger": "provider", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:59 GMT\", \"server\": \"uvicorn\", \"content-length\": \"186\", \"content-type\": \"application/json\"}, \"body\": {\"agent_token\": \"agent_tok_demopaymentnetwork_781445e5_H-71doZ2zSdmVrgkOZFfp6lZ\", \"expires_at\": \"2025-10-31T00:19:59.541002Z\", \"network_name\": \"DemoPaymentNetwork\", \"token_type\": \"agent_token\"}, \"duration_ms\": 242.9065704345703}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.604900Z", "level": "INFO", "logger": "provider", "message": "[CredentialProvider] Received Agent Token from Payment Network: agent_tok_demopaymentnetwork_781..., network_name=DemoPaymentNetwork", "module": "provider", "function": "_request_agent_token_from_network", "line": 1819}
ap2_credential_provider    | [2025-10-30 23:19:59,609] INFO in services.credential_provider.utils.token_helpers: [CredentialProvider] Saved attestation: user=usr_5e05dfe96b254548, verified=True, agent_token=agent_tok_demopaymentnetwork_781...
ap2_credential_provider    | INFO:     172.18.0.3:50518 - "POST /verify/attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.612639Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (310.95ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.612695Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:58 GMT\", \"server\": \"uvicorn\", \"content-length\": \"251\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"token\": \"cred_token_54a10c77_OT5EwW49Lbqroclca7VCruZg\", \"details\": {\"attestation_type\": \"passkey\", \"timestamp\": \"2025-10-30T23:19:59.609375+00:00\", \"counter\": 0, \"agent_token\": \"agent_tok_demopaymentnetwork_781445e5_H-71doZ2zSdmVrgkOZFfp6lZ\"}}, \"duration_ms\": 310.95218658447266}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:19:59,612] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ PaymentMandate attestation verified: payment_id=payment_3fd665a4
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.612785Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] Attestation verified, processing payment...", "module": "agent", "function": "submit_payment_attestation", "line": 1447}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.612850Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://credential_provider:8003/passkey/get-public-key", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | [2025-10-30 23:19:59,612] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] Retrieving public key from Credential Provider: credential_id=p2duhMkSHYBUfJeQ..., user_id=usr_5e05dfe96b254548
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.612889Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/passkey/get-public-key\", \"headers\": {}, \"body\": {\"credential_id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"user_id\": \"usr_5e05dfe96b254548\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.616079Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (3.20ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.616113Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:58 GMT\", \"server\": \"uvicorn\", \"content-length\": \"261\", \"content-type\": \"application/json\"}, \"body\": {\"credential_id\": \"p2duhMkSHYBUfJeQxHxa3cU_zPPPzwB5Ag6avQvOArolziwqqbX-dGaOM8i06DpxonwRs5CMV8X5-DCUxq4\", \"public_key_cose\": \"pQECAyYgASFYIBtqA+qqj/op2DosnQFOR9Qf1vSZKMvdvJbQxrUAZOzdIlgg4wN2ZwhPbRZSur4Cv09oI+AUiFm4GPVwXKo423Ae4Tk=\", \"user_id\": \"usr_5e05dfe96b254548\"}, \"duration_ms\": 3.2002925872802734}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in services.shopping_agent.utils.signature_handlers: [SignatureHandlers] ✅ Public key retrieved: credential_id=p2duhMkSHYBUfJeQ...
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in v2.common.user_authorization: [create_user_authorization_vp] WebAuthn challenge from assertion: eyJtYW5kYXRlX2lk...
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in v2.common.user_authorization: [create_user_authorization_vp] cart_hash: b730ee3075b4bfc6...
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in v2.common.user_authorization: [create_user_authorization_vp] payment_hash: 5580d30cb0bf5f6b...
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in v2.common.user_authorization: [create_user_authorization_vp] Restored public key from COSE format (DB)
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in v2.common.user_authorization: [create_user_authorization_vp] cnf claim with JWK added to Issuer JWT
ap2_shopping_agent         | [2025-10-30 23:19:59,616] INFO in v2.common.user_authorization: [create_user_authorization_vp] Generated user_authorization VP: length=2570, cart_hash=b730ee3075b4bfc6..., payment_hash=5580d30cb0bf5f6b...
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.616974Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] SD-JWT-VC user_authorization generated: user_id=usr_5e05dfe96b254548, vp_length=2570", "module": "agent", "function": "submit_payment_attestation", "line": 1491}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:19:59.615038Z", "level": "INFO", "logger": "provider", "message": "[get_passkey_public_key] Public key retrieved: credential_id=p2duhMkSHYBUfJeQ..., user_id=usr_5e05dfe96b254548", "module": "provider", "function": "get_passkey_public_key", "line": 1484}
ap2_credential_provider    | INFO:     172.18.0.3:50518 - "POST /passkey/get-public-key HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.630706Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=webauthn_signature_requested", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.630964Z", "level": "INFO", "logger": "agent", "message": "[submit_payment_attestation] PaymentMandate signed by user: payment_id=payment_3fd665a4, next_step=payment_execution", "module": "agent", "function": "submit_payment_attestation", "line": 1512}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "POST /payment/submit-attestation HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.638605Z", "level": "DEBUG", "logger": "v2.common.auth", "message": "[Auth] Authenticated user: tubone24@example.com", "module": "auth", "function": "get_current_user", "line": 284}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.638801Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Received request\n  session_id: session_1761866127723_ypdx0n\n  user_id: usr_5e05dfe96b254548\n  user_input: _payment_signature_completed\n  is_step_up_completion: False", "module": "agent", "function": "chat_stream", "line": 1058}
ap2_shopping_agent         | INFO:     172.67.69.85:40062 - "POST /chat/stream HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.639918Z", "level": "INFO", "logger": "agent", "message": "[ShoppingAgent] Loaded session from DB: session_1761866127723_ypdx0n, step=webauthn_signature_requested", "module": "agent", "function": "_get_or_create_session", "line": 1943}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.640167Z", "level": "INFO", "logger": "agent", "message": "[chat_stream] Using LangGraph shopping flow (session_id=session_1761866127723_ypdx0n)", "module": "agent", "function": "event_generator", "line": 1073}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.640227Z", "level": "DEBUG", "logger": "agent", "message": "[Langfuse] Reusing existing handler for session: session_1761866127723_ypdx0n", "module": "agent", "function": "_generate_fixed_response_langgraph", "line": 1646}
ap2_shopping_agent         | [2025-10-30 23:19:59,651] INFO in services.shopping_agent.langgraph_shopping_flow: [route_by_step] Routing decision
ap2_shopping_agent         |   current_step: webauthn_signature_requested
ap2_shopping_agent         |   user_input: _payment_signature_completed
ap2_shopping_agent         |   is_step_up_completion: False
ap2_shopping_agent         | [2025-10-30 23:19:59,675] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Requesting payment processing via Merchant Agent for PaymentMandate: payment_3fd665a4
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.679099Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.679501Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 6420, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_3fd665a4\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\",\"cart_na", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.679603Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: shopping_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.682200Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: shopping_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.682396Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.682644Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"c2f59c4f-2399-455f-aa2a-90b549c55e15\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:19:59.676023Z\", \"nonce\": \"4f242ab201c636bfd59bba977ee07683b87c2a375d48dd74aa847217c7787922\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9Ua3NJbVY0Y0NJNk1UYzJNVGcyTmpZNU9Td2libUptSWpveE56WXhPRFkyTXprNUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUkxVkd0SmRuY3pWSFpSTjFGc2RtbENNbHBPWnpSSlUxSk9ZbTU2ZDJ3ek9HaEZRamwxUkRSUWFrUlpJaXdpYVdGMElqb3hOell4T0RZMk16azVMQ0p6WkY5b1lYTm9Jam9pTW1JeVpURmtNalEwTkRNME9UVm1NakF3TldRd01qSXdPRE0xWldaak5EYzRaamhsT0daaU9EUTJNR1JsTlRSbFltWm1NVEZtTW1VME5tSmhORFV5WkNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpVMU9EQmtNekJqWWpCaVpqVm1ObUkwTURsaE1UZG1PVGt6WlROaE9XVTROak0yWVdJd01tRmpNVEpqWVRsaU1EVXpOV1F6WXpsa1ptUTVNams0WkRraVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IcGFiVkV5VG1wV2FFNURTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVp6Sk9hazAxVG5wVk5FMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVVQ0lRRFVuT1ZWQzExcFlrbTBsUnVUWTRQamhKWWstWXNWcmZubUxQSnRnTkUzQmdJZ0JIRWwxTndvd1B6VkpUb3VkVFdZcTVLdkdVSEhCWFpETzVYRTc3VXk4LWciLCJ1c2VySGFuZGxlIjoidXNyXzVlMDVkZmU5NmIyNTQ1NDgifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pY0dGNWJXVnVkRjh6Wm1RMk5qVmhOQ0lzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU56VTRNSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjU1ODBkMzBjYjBiZjVmNmI0MDlhMTdmOTkzZTNhOWU4NjM2YWIwMmFjMTJjYTliMDUzNWQzYzlkZmQ5Mjk4ZDkifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_shopping_agent         | [2025-10-30 23:19:59,682] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent → MerchantAgent] A2Aメッセージ送信（PaymentRequest）
ap2_shopping_agent         |   URL: http://merchant_agent:8001/a2a/message
ap2_shopping_agent         |   メッセージID: c2f59c4f-2399-455f-aa2a-90b549c55e15
ap2_shopping_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_shopping_agent         |   PaymentMandate ID: payment_3fd665a4
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.683633Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://merchant_agent:8001/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:19:59.683732Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://merchant_agent:8001/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"c2f59c4f-2399-455f-aa2a-90b549c55e15\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:19:59.676023Z\", \"nonce\": \"4f242ab201c636bfd59bba977ee07683b87c2a375d48dd74aa847217c7787922\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"eMBq/ByrzmCPggsfH8dAlzR2wI8kfZ5X9OMGlBjDIXe1fEQZmitbuDioSwW956MMY2sbwAWYMiYDlCwSGOuRAw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQVV5NktCOUszd054bmFuZStkTUZrLzZtekI3K3lSeHpJOFVSMFQ4eWFaclU9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:shopping_agent#key-2\", \"created\": \"2025-10-30T23:19:59.676023Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.PaymentMandate\", \"id\": \"payment_3fd665a4\", \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9Ua3NJbVY0Y0NJNk1UYzJNVGcyTmpZNU9Td2libUptSWpveE56WXhPRFkyTXprNUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUkxVkd0SmRuY3pWSFpSTjFGc2RtbENNbHBPWnpSSlUxSk9ZbTU2ZDJ3ek9HaEZRamwxUkRSUWFrUlpJaXdpYVdGMElqb3hOell4T0RZMk16azVMQ0p6WkY5b1lYTm9Jam9pTW1JeVpURmtNalEwTkRNME9UVm1NakF3TldRd01qSXdPRE0xWldaak5EYzRaamhsT0daaU9EUTJNR1JsTlRSbFltWm1NVEZtTW1VME5tSmhORFV5WkNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpVMU9EQmtNekJqWWpCaVpqVm1ObUkwTURsaE1UZG1PVGt6WlROaE9XVTROak0yWVdJd01tRmpNVEpqWVRsaU1EVXpOV1F6WXpsa1ptUTVNams0WkRraVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IcGFiVkV5VG1wV2FFNURTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVp6Sk9hazAxVG5wVk5FMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVVQ0lRRFVuT1ZWQzExcFlrbTBsUnVUWTRQamhKWWstWXNWcmZubUxQSnRnTkUzQmdJZ0JIRWwxTndvd1B6VkpUb3VkVFdZcTVLdkdVSEhCWFpETzVYRTc3VXk4LWciLCJ1c2VySGFuZGxlIjoidXNyXzVlMDVkZmU5NmIyNTQ1NDgifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pY0dGNWJXVnVkRjh6Wm1RMk5qVmhOQ0lzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU56VTRNSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjU1ODBkMzBjYjBiZjVmNmI0MDlhMTdmOTkzZTNhOWU4NjM2YWIwMmFjMTJjYTliMDUzNWQzYzlkZmQ5Mjk4ZDkifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_merchant_agent         | [2025-10-30 23:19:59,701] INFO in v2.common.base_agent:
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | [Merchant Agent] A2Aエンドポイント: POST /a2a/message
ap2_merchant_agent         |   受信メッセージ: ID=c2f59c4f-2399-455f-aa2a-90b549c55e15
ap2_merchant_agent         |   送信元: did:ap2:agent:shopping_agent
ap2_merchant_agent         |   タイプ: ap2.mandates.PaymentMandate
ap2_merchant_agent         | ================================================================================
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.702766Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:shopping_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.704391Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"c2f59c4f-2399-455f-aa2a-90b549c55e15\", \"sender\": \"did:ap2:agent:shopping_agent\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:19:59.676023Z\", \"nonce\": \"4f242ab201c636bfd59bba977ee07683b87c2a375d48dd74aa847217c7787922\", \"schema_version\": \"0.2\"}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9Ua3NJbVY0Y0NJNk1UYzJNVGcyTmpZNU9Td2libUptSWpveE56WXhPRFkyTXprNUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUkxVkd0SmRuY3pWSFpSTjFGc2RtbENNbHBPWnpSSlUxSk9ZbTU2ZDJ3ek9HaEZRamwxUkRSUWFrUlpJaXdpYVdGMElqb3hOell4T0RZMk16azVMQ0p6WkY5b1lYTm9Jam9pTW1JeVpURmtNalEwTkRNME9UVm1NakF3TldRd01qSXdPRE0xWldaak5EYzRaamhsT0daaU9EUTJNR1JsTlRSbFltWm1NVEZtTW1VME5tSmhORFV5WkNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpVMU9EQmtNekJqWWpCaVpqVm1ObUkwTURsaE1UZG1PVGt6WlROaE9XVTROak0yWVdJd01tRmpNVEpqWVRsaU1EVXpOV1F6WXpsa1ptUTVNams0WkRraVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IcGFiVkV5VG1wV2FFNURTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVp6Sk9hazAxVG5wVk5FMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVVQ0lRRFVuT1ZWQzExcFlrbTBsUnVUWTRQamhKWWstWXNWcmZubUxQSnRnTkUzQmdJZ0JIRWwxTndvd1B6VkpUb3VkVFdZcTVLdkdVSEhCWFpETzVYRTc3VXk4LWciLCJ1c2VySGFuZGxlIjoidXNyXzVlMDVkZmU5NmIyNTQ1NDgifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pY0dGNWJXVnVkRjh6Wm1RMk5qVmhOQ0lzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU56VTRNSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjU1ODBkMzBjYjBiZjVmNmI0MDlhMTdmOTkzZTNhOWU4NjM2YWIwMmFjMTJjYTliMDUzNWQzYzlkZmQ5Mjk4ZDkifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プ ラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付け て持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.707596Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=4f242ab201c636bf...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.708559Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:shopping_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.709433Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.710204Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 6420, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_3fd665a4\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\",\"cart_na", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.710269Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.712312Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:shopping_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.712427Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:shopping_agent, alg=ed25519, kid=did:ap2:agent:shopping_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.712509Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:shopping_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.712969Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Received PaymentRequest from Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 32}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.713033Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Forwarding PaymentMandate to Payment Processor: payment_mandate_id=payment_3fd665a4", "module": "payment_handler", "function": "handle_payment_request", "line": 51}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.713807Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.714074Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 6423, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_3fd665a4\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\",\"cart_na", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.714130Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.715204Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.715530Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:payment_processor: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.715750Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:payment_processor\", \"headers\": {\"message_id\": \"72dccffa-e101-416e-a389-dd8a8197c5fe\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T23:19:59.713094Z\", \"nonce\": \"ec5ce426313dd45dfd1b0a60f0e4bffbe7f81dbc0b0e81c75c004bc6ab8ef53b\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9Ua3NJbVY0Y0NJNk1UYzJNVGcyTmpZNU9Td2libUptSWpveE56WXhPRFkyTXprNUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUkxVkd0SmRuY3pWSFpSTjFGc2RtbENNbHBPWnpSSlUxSk9ZbTU2ZDJ3ek9HaEZRamwxUkRSUWFrUlpJaXdpYVdGMElqb3hOell4T0RZMk16azVMQ0p6WkY5b1lYTm9Jam9pTW1JeVpURmtNalEwTkRNME9UVm1NakF3TldRd01qSXdPRE0xWldaak5EYzRaamhsT0daaU9EUTJNR1JsTlRSbFltWm1NVEZtTW1VME5tSmhORFV5WkNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpVMU9EQmtNekJqWWpCaVpqVm1ObUkwTURsaE1UZG1PVGt6WlROaE9XVTROak0yWVdJd01tRmpNVEpqWVRsaU1EVXpOV1F6WXpsa1ptUTVNams0WkRraVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IcGFiVkV5VG1wV2FFNURTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVp6Sk9hazAxVG5wVk5FMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVVQ0lRRFVuT1ZWQzExcFlrbTBsUnVUWTRQamhKWWstWXNWcmZubUxQSnRnTkUzQmdJZ0JIRWwxTndvd1B6VkpUb3VkVFdZcTVLdkdVSEhCWFpETzVYRTc3VXk4LWciLCJ1c2VySGFuZGxlIjoidXNyXzVlMDVkZmU5NmIyNTQ1NDgifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pY0dGNWJXVnVkRjh6Wm1RMk5qVmhOQ0lzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU56VTRNSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjU1ODBkMzBjYjBiZjVmNmI0MDlhMTdmOTkzZTNhOWU4NjM2YWIwMmFjMTJjYTliMDUzNWQzYzlkZmQ5Mjk4ZDkifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.716360Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent → PaymentProcessor] A2Aメッセージ転送\n  URL: http://payment_processor:8004/a2a/message\n  メッセージID: 72dccffa-e101-416e-a389-dd8a8197c5fe\n  タイプ: ap2.mandates.PaymentMandate\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 69}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.716675Z", "level": "INFO", "logger": "agent", "message": "HTTP Request: POST http://payment_processor:8004/a2a/message", "module": "logger", "function": "log_http_request", "line": 182}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:19:59.717109Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://payment_processor:8004/a2a/message\", \"headers\": {}, \"body\": {\"header\": {\"message_id\": \"72dccffa-e101-416e-a389-dd8a8197c5fe\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T23:19:59.713094Z\", \"nonce\": \"ec5ce426313dd45dfd1b0a60f0e4bffbe7f81dbc0b0e81c75c004bc6ab8ef53b\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"RvJyA9zgZgzAOpmj5VPUvwx6UUls9lbzTjMa+cTOAvMbetH/OzuQrp+toRAo8ZazwkWQmAyBw4JF29kMtuhwCA==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQXpLdWVDRWNyRmhCUzBaeWIzK0dwYkh2VHZYTEhGVmhWY3EvRGc2MmlGM0k9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T23:19:59.713094Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.mandates.PaymentMandate\", \"id\": \"payment_3fd665a4\", \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9Ua3NJbVY0Y0NJNk1UYzJNVGcyTmpZNU9Td2libUptSWpveE56WXhPRFkyTXprNUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUkxVkd0SmRuY3pWSFpSTjFGc2RtbENNbHBPWnpSSlUxSk9ZbTU2ZDJ3ek9HaEZRamwxUkRSUWFrUlpJaXdpYVdGMElqb3hOell4T0RZMk16azVMQ0p6WkY5b1lYTm9Jam9pTW1JeVpURmtNalEwTkRNME9UVm1NakF3TldRd01qSXdPRE0xWldaak5EYzRaamhsT0daaU9EUTJNR1JsTlRSbFltWm1NVEZtTW1VME5tSmhORFV5WkNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpVMU9EQmtNekJqWWpCaVpqVm1ObUkwTURsaE1UZG1PVGt6WlROaE9XVTROak0yWVdJd01tRmpNVEpqWVRsaU1EVXpOV1F6WXpsa1ptUTVNams0WkRraVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IcGFiVkV5VG1wV2FFNURTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVp6Sk9hazAxVG5wVk5FMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVVQ0lRRFVuT1ZWQzExcFlrbTBsUnVUWTRQamhKWWstWXNWcmZubUxQSnRnTkUzQmdJZ0JIRWwxTndvd1B6VkpUb3VkVFdZcTVLdkdVSEhCWFpETzVYRTc3VXk4LWciLCJ1c2VySGFuZGxlIjoidXNyXzVlMDVkZmU5NmIyNTQ1NDgifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pY0dGNWJXVnVkRjh6Wm1RMk5qVmhOQ0lzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU56VTRNSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjU1ODBkMzBjYjBiZjVmNmI0MDlhMTdmOTkzZTNhOWU4NjM2YWIwMmFjMTJjYTliMDUzNWQzYzlkZmQ5Mjk4ZDkifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しま した。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}, \"kind\": null, \"artifact\": null}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_payment_processor      | [2025-10-30 23:20:00,041] INFO in v2.common.base_agent:
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | [Payment Processor] A2Aエンドポイント: POST /a2a/message
ap2_payment_processor      |   受信メッセージ: ID=72dccffa-e101-416e-a389-dd8a8197c5fe
ap2_payment_processor      |   送信元: did:ap2:agent:merchant_agent
ap2_payment_processor      |   タイプ: ap2.mandates.PaymentMandate
ap2_payment_processor      | ================================================================================
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.045447Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message received to/from did:ap2:agent:merchant_agent: ap2.mandates.PaymentMandate", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.045765Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"received\", \"message_type\": \"ap2.mandates.PaymentMandate\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"72dccffa-e101-416e-a389-dd8a8197c5fe\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:payment_processor\", \"timestamp\": \"2025-10-30T23:19:59.713094Z\", \"nonce\": \"ec5ce426313dd45dfd1b0a60f0e4bffbe7f81dbc0b0e81c75c004bc6ab8ef53b\", \"schema_version\": \"0.2\"}, \"payload\": {\"payment_mandate\": {\"payment_mandate_contents\": {\"payment_mandate_id\": \"payment_3fd665a4\", \"payment_details_id\": \"order_6f7d38ab\", \"payment_details_total\": {\"label\": \"Total\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}, \"payment_response\": {\"methodName\": \"basic-card\", \"details\": {\"cardholderName\": \"Demo User\", \"cardNumber\": \"****1111\", \"cardSecurityCode\": \"***\", \"cardBrand\": \"Visa\", \"expiryMonth\": \"03\", \"expiryYear\": \"2029\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"tokenized\": true}}, \"merchant_agent\": \"did:ap2:merchant:mugibo_merchant\", \"timestamp\": \"2025-10-30T23:19:56.380606Z\"}, \"user_authorization\": \"eyJpc3N1ZXJfand0IjoiZXlKaGJHY2lPaUpGVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKa2FXUTZZWEF5T25WelpYSTZkWE55WHpWbE1EVmtabVU1Tm1JeU5UUTFORGdpTENKemRXSWlPaUprYVdRNllYQXlPblZ6WlhJNmRYTnlYelZsTURWa1ptVTVObUl5TlRRMU5EZ2lMQ0pwWVhRaU9qRTNOakU0TmpZek9Ua3NJbVY0Y0NJNk1UYzJNVGcyTmpZNU9Td2libUptSWpveE56WXhPRFkyTXprNUxDSmpibVlpT25zaWFuZHJJanA3SW10MGVTSTZJa1ZESWl3aVkzSjJJam9pVUMweU5UWWlMQ0o0SWpvaVJ6SnZSRFp4Y1ZBdGFXNVpUMmw1WkVGVk5VZ3hRbDlYT1VwcmIzazVNamhzZEVSSGRGRkNhemRPTUNJc0lua2lPaUkwZDA0eVduZG9VR0pTV2xOMWNqUkRkakE1YjBrdFFWVnBSbTAwUjFCV2QxaExielF5TTBGbE5GUnJJbjE5ZlEiLCJrYl9qd3QiOiJleUpoYkdjaU9pSkZVekkxTmlJc0luUjVjQ0k2SW10aUsycDNkQ0o5LmV5SmhkV1FpT2lKa2FXUTZZWEF5T21GblpXNTBPbkJoZVcxbGJuUmZjSEp2WTJWemMyOXlJaXdpYm05dVkyVWlPaUkxVkd0SmRuY3pWSFpSTjFGc2RtbENNbHBPWnpSSlUxSk9ZbTU2ZDJ3ek9HaEZRamwxUkRSUWFrUlpJaXdpYVdGMElqb3hOell4T0RZMk16azVMQ0p6WkY5b1lYTm9Jam9pTW1JeVpURmtNalEwTkRNME9UVm1NakF3TldRd01qSXdPRE0xWldaak5EYzRaamhsT0daaU9EUTJNR1JsTlRSbFltWm1NVEZtTW1VME5tSmhORFV5WkNJc0luUnlZVzV6WVdOMGFXOXVYMlJoZEdFaU9sc2lZamN6TUdWbE16QTNOV0kwWW1aak5tWmtaRFJqTWprME9UUTVaak16WldOaU5qQXlOV05qWWpBM05USXhPV0V3TkRnNU5EQmpZMkZoWW1OalpHUXpZeUlzSWpVMU9EQmtNekJqWWpCaVpqVm1ObUkwTURsaE1UZG1PVGt6WlROaE9XVTROak0yWVdJd01tRmpNVEpqWVRsaU1EVXpOV1F6WXpsa1ptUTVNams0WkRraVhYMCIsIndlYmF1dGhuX2Fzc2VydGlvbiI6eyJpZCI6InAyZHVoTWtTSFlCVWZKZVF4SHhhM2NVX3pQUFB6d0I1QWc2YXZRdk9Bcm9seml3cXFiWC1kR2FPTThpMDZEcHhvbndSczVDTVY4WDUtRENVeHE0IiwicmF3SWQiOiJwMmR1aE1rU0hZQlVmSmVReEh4YTNjVV96UFBQendCNUFnNmF2UXZPQXJvbHppd3FxYlgtZEdhT004aTA2RHB4b253UnM1Q01WOFg1LURDVXhxNCIsInJlc3BvbnNlIjp7ImNsaWVudERhdGFKU09OIjoiZXlKMGVYQmxJam9pZDJWaVlYVjBhRzR1WjJWMElpd2lZMmhoYkd4bGJtZGxJam9pWlhsS2RGbFhOV3RaV0ZKc1dESnNhMGxxYjJsalIwWTFZbGRXZFdSR09IcGFiVkV5VG1wV2FFNURTWE5KYmxKd1lsZFdlbVJIUm5SalEwazJUVlJqTWsxVVp6Sk9hazAxVG5wVk5FMUlNQ0lzSW05eWFXZHBiaUk2SW1oMGRIQTZMeTlzYjJOaGJHaHZjM1E2TXpBd01DSXNJbU55YjNOelQzSnBaMmx1SWpwbVlXeHpaWDAiLCJhdXRoZW50aWNhdG9yRGF0YSI6IlNaWU41WWdPakdoME5CY1BaSFpnVzRfa3JybWloakxIbVZ6enVvTWRsMk1kQUFBQUFBIiwic2lnbmF0dXJlIjoiTUVVQ0lRRFVuT1ZWQzExcFlrbTBsUnVUWTRQamhKWWstWXNWcmZubUxQSnRnTkUzQmdJZ0JIRWwxTndvd1B6VkpUb3VkVFdZcTVLdkdVSEhCWFpETzVYRTc3VXk4LWciLCJ1c2VySGFuZGxlIjoidXNyXzVlMDVkZmU5NmIyNTQ1NDgifSwidHlwZSI6InB1YmxpYy1rZXkiLCJhdHRlc3RhdGlvbl90eXBlIjoicGFzc2tleSIsImNoYWxsZW5nZSI6ImV5SnRZVzVrWVhSbFgybGtJam9pY0dGNWJXVnVkRjh6Wm1RMk5qVmhOQ0lzSW5ScGJXVnpkR0Z0Y0NJNk1UYzJNVGcyTmpNNU56VTRNSDAifSwiY2FydF9oYXNoIjoiYjczMGVlMzA3NWI0YmZjNmZkZDRjMjk0OTQ5ZjMzZWNiNjAyNWNjYjA3NTIxOWEwNDg5NDBjY2FhYmNjZGQzYyIsInBheW1lbnRfaGFzaCI6IjU1ODBkMzBjYjBiZjVmNmI0MDlhMTdmOTkzZTNhOWU4NjM2YWIwMmFjMTJjYTliMDUzNWQzYzlkZmQ5Mjk4ZDkifQ\", \"agent_involved\": true, \"transaction_type\": \"human_not_present\", \"id\": \"payment_3fd665a4\", \"cart_mandate_id\": \"cart_1e9a114c\", \"intent_mandate_id\": \"intent_556a9bb4\", \"payer_id\": \"usr_5e05dfe96b254548\", \"payee_id\": \"did:ap2:merchant:mugibo_merchant\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"payment_method\": {\"type\": \"basic-card\", \"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"last4\": \"1111\", \"brand\": \"Visa\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}, \"risk_score\": 3, \"fraud_indicators\": [\"card_not_present_transaction\"]}, \"cart_mandate\": {\"contents\": {\"id\": \"cart_1e9a114c\", \"user_cart_confirmation_required\": true, \"payment_request\": {\"method_data\": [], \"details\": {\"id\": \"cart_1e9a114c\", \"display_items\": [{\"label\": \"むぎぼー時計\", \"amount\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"むぎぼーアクリルキーホルダー\", \"amount\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"refund_period\": 2592000}, {\"label\": \"消費税（10%）\", \"amount\": {\"value\": 430.0, \"currency\": \"JPY\"}, \"refund_period\": 0}, {\"label\": \"送料\", \"amount\": {\"value\": 500.0, \"currency\": \"JPY\"}, \"refund_period\": 0}], \"total\": {\"label\": \"合計\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}, \"shipping_address\": null}, \"cart_expiry\": \"2025-10-31T00:19:46.885682Z\", \"merchant_name\": \"Demo Merchant\"}, \"merchant_authorization\": \"eyJhbGciOiJFUzI1NiIsImtpZCI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50I2tleS0xIiwidHlwIjoiSldUIn0.eyJpc3MiOiJkaWQ6YXAyOm1lcmNoYW50Om11Z2lib19tZXJjaGFudCIsInN1YiI6ImRpZDphcDI6bWVyY2hhbnQ6bXVnaWJvX21lcmNoYW50IiwiYXVkIjoiZGlkOmFwMjphZ2VudDpwYXltZW50X3Byb2Nlc3NvciIsImlhdCI6MTc2MTg2NjM4NywiZXhwIjoxNzYxODY5OTg3LCJqdGkiOiIyN2I1YTg2Mi1iMDY0LTRmMGEtYTAyYS1lN2Y4M2E3YzhiMzYiLCJjYXJ0X2hhc2giOiJiNzMwZWUzMDc1YjRiZmM2ZmRkNGMyOTQ5NDlmMzNlY2I2MDI1Y2NiMDc1MjE5YTA0ODk0MGNjYWFiY2NkZDNjIn0.MEUCIFvhi1vewo0etpV1XaSO76nvI_BRBezxnT_g8wFrB0UQAiEAqreSLAkRYV231jGphYwxcQx050RKbjAl4u5iyedbrcw\", \"_metadata\": {\"intent_mandate_id\": null, \"merchant_id\": \"did:ap2:merchant:mugibo_merchant\", \"created_at\": \"2025-10-30T23:19:46.885715Z\", \"cart_name\": \"高品質プラン (4,300円)\", \"cart_description\": \"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\", \"raw_items\": [{\"product_id\": \"1ef314f1-8cc4-4d88-8f33-4dc68879ff29\", \"name\": \"むぎぼー時計\", \"description\": \"むぎぼーデザインのかわいい壁掛け時計。お部屋を明るく彩ります。\", \"quantity\": 1, \"unit_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 3500.0, \"currency\": \"JPY\"}, \"image_url\": null}, {\"product_id\": \"6e233ec0-0871-4550-8d91-d94f5d8a0cd5\", \"name\": \"むぎぼーアクリルキーホルダー\", \"description\": \"かわいいむぎぼーのアクリルキーホルダー。バッグやポーチに付 けて持ち歩けます。\", \"quantity\": 1, \"unit_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"total_price\": {\"value\": 800.0, \"currency\": \"JPY\"}, \"image_url\": null}]}, \"merchant_signature\": {\"algorithm\": \"ED25519\", \"value\": \"FxYh+9KQWmh2UkrC9iJ9Ex9hLr0qaPbRXSrRNLM65lWzeUnlSOYDrfOcv/XOI13JS+L5xPh2HyDjWEXOgom+CA==\", \"public_key\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTh2NUZjclFYdk80Mnd3cmZreEV1SEhVNFlTcEQ3VHhaMXk1d2E1VEJVMWM9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"signed_at\": \"2025-10-30T23:19:47.479998Z\", \"key_id\": \"merchant\"}}}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.047537Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Nonce validation successful: nonce=ec5ce426313dd45d...", "module": "a2a_handler", "function": "verify_message_signature", "line": 156}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.049124Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] Using DID-resolved public key for verification: kid=did:ap2:agent:merchant_agent#key-2", "module": "a2a_handler", "function": "verify_message_signature", "line": 184}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.057493Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying A2A message signature", "module": "crypto", "function": "verify_a2a_message_signature", "line": 827}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.062917Z", "level": "DEBUG", "logger": "common.crypto", "message": "[VERIFY] Canonical JSON length: 6423, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.mandates.PaymentMandate\",\"id\":\"payment_3fd665a4\",\"payload\":{\"cart_mandate\":{\"_metadata\":{\"cart_description\":\"時計とキーホルダーの組み合わせで、かわいさと品質を両立したプランです。予算を少し超えても高品質を追求しました。\",\"cart_na", "module": "crypto", "function": "verify_a2a_message_signature", "line": 831}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.062990Z", "level": "DEBUG", "logger": "common.crypto", "message": "Verifying signature (algorithm: ED25519)", "module": "crypto", "function": "verify_signature", "line": 661}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.085791Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto VERIFY: ED25519 (key: did:ap2:agent:merchant_agent#key-2) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.087850Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2AHandler] proof署名検証成功: sender=did:ap2:agent:merchant_agent, alg=ed25519, kid=did:ap2:agent:merchant_agent#key-2, public_key_source=DID-resolved", "module": "a2a_handler", "function": "verify_message_signature", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.088236Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー実行中: type=ap2.mandates.PaymentMandate, from=did:ap2:agent:merchant_agent", "module": "a2a_handler", "function": "handle_message", "line": 328}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.089085Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Received PaymentMandate", "module": "processor", "function": "handle_payment_mandate", "line": 366}
ap2_payment_processor      | [2025-10-30 23:20:00,090] INFO in services.payment_processor.utils.mandate_helpers: [PaymentProcessor] PaymentMandate validation passed: payment_3fd665a4, user_authorization present: eyJpc3N1ZXJfand0Ijoi...
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.091207Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation: PaymentMandate(payment_3fd665a4) → CartMandate(cart_1e9a114c)", "module": "processor", "function": "_validate_mandate_chain", "line": 631}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.101845Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying SD-JWT-VC user_authorization: cart_hash=b730ee3075b4bfc6..., payment_hash=5580d30cb0bf5f6b...", "module": "processor", "function": "_validate_mandate_chain", "line": 648}
ap2_payment_processor      | [2025-10-30 23:20:00,103] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Decoded VP successfully
ap2_payment_processor      | [2025-10-30 23:20:00,103] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Hash verification passed: cart_hash=b730ee3075b4bfc6..., payment_hash=5580d30cb0bf5f6b...
ap2_payment_processor      | [2025-10-30 23:20:00,114] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ WebAuthn signature verified successfully
ap2_payment_processor      | [2025-10-30 23:20:00,115] INFO in v2.common.user_authorization: [verify_user_authorization_vp] Key-binding JWT payload verified
ap2_payment_processor      | [2025-10-30 23:20:00,116] INFO in v2.common.user_authorization: [verify_user_authorization_vp] ✓ VP verification passed
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.116304Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ SD-JWT-VC user_authorization verified: cart_hash_match=True, payment_hash_match=True, webauthn_signature_verified=True", "module": "processor", "function": "_validate_mandate_chain", "line": 661}
ap2_payment_processor      | [2025-10-30 23:20:00,123] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/shopping_agent_did.json
ap2_payment_processor      | [2025-10-30 23:20:00,125] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:shopping_agent
ap2_payment_processor      | [2025-10-30 23:20:00,125] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_agent_did.json
ap2_payment_processor      | [2025-10-30 23:20:00,126] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:merchant_agent
ap2_payment_processor      | [2025-10-30 23:20:00,126] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/merchant_did.json
ap2_payment_processor      | [2025-10-30 23:20:00,127] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:merchant:mugibo_merchant
ap2_payment_processor      | [2025-10-30 23:20:00,129] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_did.json
ap2_payment_processor      | [2025-10-30 23:20:00,131] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp
ap2_payment_processor      | [2025-10-30 23:20:00,132] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/credential_provider_2_did.json
ap2_payment_processor      | [2025-10-30 23:20:00,133] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:cp:demo_cp_2
ap2_payment_processor      | [2025-10-30 23:20:00,133] INFO in v2.common.did_resolver: [DIDResolver] 永続化されたDIDドキュメントを読み込み中: /app/v2/data/did_documents/payment_processor_did.json
ap2_payment_processor      | [2025-10-30 23:20:00,134] INFO in v2.common.did_resolver: [DIDResolver] ✓ 永続化DIDドキュメントを登録: did:ap2:agent:payment_processor
ap2_payment_processor      | [2025-10-30 23:20:00,134] INFO in services.payment_processor.utils.jwt_helpers: [_verify_jwt_signature] ✓ JWT signature verified successfully
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135017Z", "level": "INFO", "logger": "processor", "message": "[_verify_merchant_authorization_jwt] JWT validation passed: iss=did:ap2:merchant:mugibo_merchant, exp=1761869987, jti=27b5a862-b064-4f..., cart_hash=b730ee3075b4bfc6...", "module": "processor", "function": "_verify_merchant_authorization_jwt", "line": 573}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135071Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] merchant_authorization JWT verified: iss=did:ap2:merchant:mugibo_merchant", "module": "processor", "function": "_validate_mandate_chain", "line": 685}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135086Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] CartMandate hash in merchant_authorization: b730ee3075b4bfc6...", "module": "processor", "function": "_validate_mandate_chain", "line": 693}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135233Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] ✓ CartMandate hash verified (merchant_authorization): b730ee3075b4bfc6...", "module": "processor", "function": "_validate_mandate_chain", "line": 710}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135250Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Mandate chain validation passed", "module": "processor", "function": "_validate_mandate_chain", "line": 742}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135819Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Processing payment (mock): txn_73f06d67084d", "module": "processor", "function": "_process_payment_mock", "line": 761}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.135879Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Verifying credential with Credential Provider: token=tok_83fee8bb_uvvXxuA...", "module": "processor", "function": "_verify_credential_with_cp", "line": 876}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.138477Z", "level": "INFO", "logger": "processor", "message": "HTTP Request: POST http://credential_provider:8003/credentials/verify", "module": "logger", "function": "log_http_request", "line": 182}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.138722Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/credentials/verify\", \"headers\": {}, \"body\": {\"token\": \"tok_83fee8bb_uvvXxuAob1OgNtJEEo9vKLlB\", \"payer_id\": \"usr_5e05dfe96b254548\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:20:00.192925Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Verifying token for payer: usr_5e05dfe96b254548", "module": "provider", "function": "verify_credentials", "line": 1559}
ap2_credential_provider    | {"timestamp": "2025-10-30T23:20:00.195093Z", "level": "INFO", "logger": "provider", "message": "[verify_credentials] Token verified: payment_method_id=pm_0f73d52d, user_id=usr_5e05dfe96b254548", "module": "provider", "function": "verify_credentials", "line": 1596}
ap2_credential_provider    | INFO:     172.18.0.10:46470 - "POST /credentials/verify HTTP/1.1" 200 OK
ap2_payment_processor      | [2025-10-30 23:20:00,202] INFO in httpx: HTTP Request: POST http://credential_provider:8003/credentials/verify "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.204971Z", "level": "INFO", "logger": "processor", "message": "HTTP Response: 200 (66.39ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.205143Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:59 GMT\", \"server\": \"uvicorn\", \"content-length\": \"186\", \"content-type\": \"application/json\"}, \"body\": {\"verified\": true, \"credential_info\": {\"payment_method_id\": \"pm_0f73d52d\", \"type\": \"basic-card\", \"brand\": \"Visa\", \"last4\": \"1111\", \"holder_name\": \"Unknown\", \"expiry_month\": \"03\", \"expiry_year\": \"2029\"}}, \"duration_ms\": 66.3907527923584}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.206558Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verification succeeded: payment_method_id=pm_0f73d52d", "module": "processor", "function": "_verify_credential_with_cp", "line": 911}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.206603Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Credential verified: pm_0f73d52d", "module": "processor", "function": "_process_payment_mock", "line": 784}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.206640Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Risk assessment: score=3, indicators=['card_not_present_transaction']", "module": "processor", "function": "_process_payment_mock", "line": 799}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.206686Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Payment succeeded: txn_73f06d67084d, amount={'value': 5230.0, 'currency': 'JPY'}, risk_score=3", "module": "processor", "function": "_process_payment_mock", "line": 833}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.424139Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Transaction saved: txn_73f06d67084d", "module": "processor", "function": "_save_transaction", "line": 860}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.764054Z", "level": "WARNING", "logger": "processor", "message": "[PaymentProcessor] User not found for payer_id: usr_5e05dfe96b254548, using default name", "module": "processor", "function": "_generate_receipt", "line": 1067}
ap2_payment_processor      | [2025-10-30 23:20:00,764] INFO in v2.common.receipt_generator: [ReceiptGenerator] Generating PDF receipt for transaction: txn_73f06d67084d
ap2_payment_processor      | [2025-10-30 23:20:00,768] INFO in v2.common.receipt_generator: [ReceiptGenerator] PDF receipt generated successfully
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.769911Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Generated receipt PDF: /app/v2/data/receipts/txn_73f06d67084d.pdf", "module": "processor", "function": "_generate_receipt", "line": 1088}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.774723Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt record saved to database: txn_73f06d67084d", "module": "processor", "function": "_generate_receipt", "line": 1107}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.774943Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Sending receipt notification to Credential Provider: transaction_id=txn_73f06d67084d, payer_id=usr_5e05dfe96b254548", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 940}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.775076Z", "level": "INFO", "logger": "processor", "message": "HTTP Request: POST http://credential_provider:8003/receipts", "module": "logger", "function": "log_http_request", "line": 182}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.775101Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_REQUEST_RAW: {\"type\": \"HTTP_REQUEST\", \"method\": \"POST\", \"url\": \"http://credential_provider:8003/receipts\", \"headers\": {}, \"body\": {\"transaction_id\": \"txn_73f06d67084d\", \"receipt_url\": \"http://localhost:8004/receipts/txn_73f06d67084d.pdf\", \"payer_id\": \"usr_5e05dfe96b254548\", \"amount\": {\"value\": 5230.0, \"currency\": \"JPY\"}, \"timestamp\": \"2025-10-30T23:20:00.775057Z\"}}", "module": "logger", "function": "log_http_request", "line": 193}
ap2_credential_provider    | [2025-10-30 23:20:00,786] INFO in services.credential_provider.utils.receipt_helpers: [CredentialProvider] Receipt received and stored to DB: transaction_id=txn_73f06d67084d, payer_id=usr_5e05dfe96b254548, receipt_url=http://localhost:8004/receipts/txn_73f06d67084d.pdf
ap2_credential_provider    | INFO:     172.18.0.10:46470 - "POST /receipts HTTP/1.1" 200 OK
ap2_payment_processor      | [2025-10-30 23:20:00,786] INFO in httpx: HTTP Request: POST http://credential_provider:8003/receipts "HTTP/1.1 200 OK"
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.787160Z", "level": "INFO", "logger": "processor", "message": "HTTP Response: 200 (12.06ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.787190Z", "level": "DEBUG", "logger": "processor", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:20:00 GMT\", \"server\": \"uvicorn\", \"content-length\": \"97\", \"content-type\": \"application/json\"}, \"body\": {\"status\": \"received\", \"message\": \"Receipt stored successfully\", \"transaction_id\": \"txn_73f06d67084d\"}, \"duration_ms\": 12.063264846801758}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.787256Z", "level": "INFO", "logger": "processor", "message": "[PaymentProcessor] Receipt notification sent successfully: transaction_id=txn_73f06d67084d, status=200", "module": "processor", "function": "_send_receipt_to_credential_provider", "line": 971}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.787308Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.788987Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.789049Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 521, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"4e8a440c-c795-4a3b-86ca-1f3cd656a696\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_73f06d67084d.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.789389Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: payment_processor, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.793856Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: payment_processor) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.795589Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:merchant_agent: ap2.responses.PaymentResult", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_payment_processor      | {"timestamp": "2025-10-30T23:20:00.796254Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.PaymentResult\", \"peer\": \"did:ap2:agent:merchant_agent\", \"headers\": {\"message_id\": \"a6f593db-78f7-4074-b27f-bafa7bcf5d33\", \"sender\": \"did:ap2:agent:payment_processor\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:20:00.787354Z\", \"nonce\": \"6a302a1af91df015bea147d862db85cac38f0614ddadd1cf4f9788406bd4d20f\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"transaction_id\": \"txn_73f06d67084d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_73f06d67084d.pdf\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_payment_processor      | [2025-10-30 23:20:00,796] INFO in v2.common.base_agent: [Payment Processor] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:merchant_agent
ap2_payment_processor      | INFO:     172.18.0.8:40464 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.804989Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (1088.27ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.805090Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:58 GMT\", \"server\": \"uvicorn\", \"content-length\": \"991\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"a6f593db-78f7-4074-b27f-bafa7bcf5d33\", \"sender\": \"did:ap2:agent:payment_processor\", \"recipient\": \"did:ap2:agent:merchant_agent\", \"timestamp\": \"2025-10-30T23:20:00.787354Z\", \"nonce\": \"6a302a1af91df015bea147d862db85cac38f0614ddadd1cf4f9788406bd4d20f\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"RzueSdwbXsf9xSJbUr/ZDAMdT3CSm69gE088DiY1yFNzB9oR/Ihn19mEIn5+LQ1RRc/O60GspEPQ8yiMs1gABg==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTVwSzJ5VTdZVlJkdjgyeGdOQXgwYUVVWVRlSjlzWDVGU1RndWFpVXIrMWc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:payment_processor#key-2\", \"created\": \"2025-10-30T23:20:00.787354Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.PaymentResult\", \"id\": \"4e8a440c-c795-4a3b-86ca-1f3cd656a696\", \"payload\": {\"transaction_id\": \"txn_73f06d67084d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_73f06d67084d.pdf\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 1088.266372680664}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.805276Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "\n================================================================================\n[MerchantAgent ← PaymentProcessor] A2Aレスポンス受信\n  Status: 200\n  Response Body: {\n  \"header\": {\n    \"message_id\": \"a6f593db-78f7-4074-b27f-bafa7bcf5d33\",\n    \"sender\": \"did:ap2:agent:payment_processor\",\n    \"recipient\": \"did:ap2:agent:merchant_agent\",\n    \"timestamp\": \"2025-10-30T23:20:00.787354Z\",\n    \"nonce\": \"6a302a1af91df015bea147d862db85cac38f0614ddadd1cf4f9788406bd4d20f\",\n    \"schema_version\": \"0.2\",\n    \"proof\": {\n      \"algorithm\": \"ed25519\",\n      \"signatureValue\": \"RzueSdwbXsf9xSJbUr/ZDAMdT3CSm69gE088DiY1yFNzB9oR/Ihn19mEIn5+LQ1RRc/O60GspEPQ8yiMs1gABg==\",\n      \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTVwSzJ5VTdZVlJkdjgyeGdOQXgwYUVVWVRlSjlzWDVGU1RndWFpVXIrMWc9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\",\n      \"kid\": \"did:ap2:agent:payment_processor#key-2\",\n      \"created\": \"2025-10-30T23:20:00.787354Z\",\n      \"proofPurpose\": \"authentication\"\n    },\n    \"signature\": null\n  },\n  \"dataPart\": {\n    \"@type\": \"ap2.responses.PaymentResult\",\n    \"id\": \"4e8a440c-c795-4a3b-86ca-1f3cd656a696\",\n    \"payload\": {\n      \"transaction_id\": \"txn_73f06d67084d\",\n      \"status\": \"captured\",\n      \"receipt_url\": \"http://localhost:8004/receipts/txn_73f06d67084d.pdf\"\n    },\n    \"kind\": null,\n    \"artifact\": null\n  }\n}\n================================================================================", "module": "payment_handler", "function": "handle_payment_request", "line": 86}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.805309Z", "level": "INFO", "logger": "handlers.payment_handler", "message": "[MerchantAgent] Payment processing completed, forwarding result to Shopping Agent", "module": "payment_handler", "function": "handle_payment_request", "line": 101}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.806722Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "[A2A処理] ハンドラー完了: type=ap2.mandates.PaymentMandate, result_type=ap2.responses.PaymentResult", "module": "a2a_handler", "function": "handle_message", "line": 336}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.807958Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing A2A message (sender: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_a2a_message", "line": 799}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.808066Z", "level": "DEBUG", "logger": "common.crypto", "message": "[SIGN] Canonical JSON length: 518, first 200 chars: {\"dataPart\":{\"@type\":\"ap2.responses.PaymentResult\",\"id\":\"4e8a440c-c795-4a3b-86ca-1f3cd656a696\",\"payload\":{\"receipt_url\":\"http://localhost:8004/receipts/txn_73f06d67084d.pdf\",\"status\":\"captured\",\"trans", "module": "crypto", "function": "sign_a2a_message", "line": 803}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.808097Z", "level": "DEBUG", "logger": "common.crypto", "message": "Signing data (key_id: merchant_agent, algorithm: ED25519)", "module": "crypto", "function": "sign_data", "line": 598}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.809468Z", "level": "INFO", "logger": "common.crypto", "message": "Crypto SIGN: ED25519 (key: merchant_agent) - SUCCESS", "module": "logger", "function": "log_crypto_operation", "line": 350}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.809572Z", "level": "INFO", "logger": "v2.common.a2a_handler", "message": "A2A Message sent to/from did:ap2:agent:shopping_agent: ap2.responses.PaymentResult", "module": "logger", "function": "log_a2a_message", "line": 250}
ap2_merchant_agent         | {"timestamp": "2025-10-30T23:20:00.809614Z", "level": "DEBUG", "logger": "v2.common.a2a_handler", "message": "A2A_MESSAGE_RAW: {\"type\": \"A2A_MESSAGE\", \"direction\": \"sent\", \"message_type\": \"ap2.responses.PaymentResult\", \"peer\": \"did:ap2:agent:shopping_agent\", \"headers\": {\"message_id\": \"bc596928-5e00-4172-b4d9-a157c62894fe\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:20:00.806811Z\", \"nonce\": \"5c4fe971ff0d54bdd9e2bf63a5a7deed6a863675d7b9d93cd036f33d02025c7b\", \"schema_version\": \"0.2\", \"signed\": true}, \"payload\": {\"transaction_id\": \"txn_73f06d67084d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_73f06d67084d.pdf\"}}", "module": "logger", "function": "log_a2a_message", "line": 262}
ap2_merchant_agent         | [2025-10-30 23:20:00,809] INFO in v2.common.base_agent: [Merchant Agent] A2Aレスポンス返却: type=ap2.responses.PaymentResult, to=did:ap2:agent:shopping_agent
ap2_merchant_agent         | INFO:     172.18.0.3:47548 - "POST /a2a/message HTTP/1.1" 200 OK
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:20:00.815493Z", "level": "INFO", "logger": "agent", "message": "HTTP Response: 200 (1131.82ms)", "module": "logger", "function": "log_http_response", "line": 215}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:20:00.815575Z", "level": "DEBUG", "logger": "agent", "message": "HTTP_RESPONSE_RAW: {\"type\": \"HTTP_RESPONSE\", \"status_code\": 200, \"headers\": {\"date\": \"Thu, 30 Oct 2025 23:19:59 GMT\", \"server\": \"uvicorn\", \"content-length\": \"985\", \"content-type\": \"application/json\"}, \"body\": {\"header\": {\"message_id\": \"bc596928-5e00-4172-b4d9-a157c62894fe\", \"sender\": \"did:ap2:agent:merchant_agent\", \"recipient\": \"did:ap2:agent:shopping_agent\", \"timestamp\": \"2025-10-30T23:20:00.806811Z\", \"nonce\": \"5c4fe971ff0d54bdd9e2bf63a5a7deed6a863675d7b9d93cd036f33d02025c7b\", \"schema_version\": \"0.2\", \"proof\": {\"algorithm\": \"ed25519\", \"signatureValue\": \"w95+V/O1B4dHLaRZcjWJKsW66OTQfTBAyaxAvqfk1H9tkP9gdfMdgzRzHwfHiEt/38FJ8L1GZD8SrO5HQ9HBBw==\", \"publicKey\": \"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQXpLdWVDRWNyRmhCUzBaeWIzK0dwYkh2VHZYTEhGVmhWY3EvRGc2MmlGM0k9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=\", \"kid\": \"did:ap2:agent:merchant_agent#key-2\", \"created\": \"2025-10-30T23:20:00.806811Z\", \"proofPurpose\": \"authentication\"}, \"signature\": null}, \"dataPart\": {\"@type\": \"ap2.responses.PaymentResult\", \"id\": \"4e8a440c-c795-4a3b-86ca-1f3cd656a696\", \"payload\": {\"transaction_id\": \"txn_73f06d67084d\", \"status\": \"captured\", \"receipt_url\": \"http://localhost:8004/receipts/txn_73f06d67084d.pdf\"}, \"kind\": null, \"artifact\": null}}, \"duration_ms\": 1131.819248199463}", "module": "logger", "function": "log_http_response", "line": 226}
ap2_shopping_agent         | [2025-10-30 23:20:00,815] INFO in services.shopping_agent.utils.merchant_integration:
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [ShoppingAgent ← MerchantAgent] A2Aレスポンス受信
ap2_shopping_agent         |   Status: 200
ap2_shopping_agent         |   Response Type: ap2.responses.PaymentResult
ap2_shopping_agent         | ================================================================================
ap2_shopping_agent         | [2025-10-30 23:20:00,816] INFO in services.shopping_agent.utils.merchant_integration: [MerchantIntegration] Payment processing completed: status=captured
ap2_shopping_agent         | [2025-10-30 23:20:00,816] INFO in services.shopping_agent.langgraph_shopping_flow: [execute_payment_node] Payment successful: status=captured, transaction_id=txn_73f06d67084d
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:20:00.869631Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=completed", "module": "agent", "function": "_update_session", "line": 1978}
ap2_shopping_agent         | {"timestamp": "2025-10-30T23:20:00.877582Z", "level": "DEBUG", "logger": "agent", "message": "[ShoppingAgent] Updated session in DB: session_1761866127723_ypdx0n, step=completed", "module": "agent", "function": "_update_session", "line": 1978}

